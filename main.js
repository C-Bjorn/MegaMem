"use strict";var Ja=Object.defineProperty;var Qa=(n,e,t)=>e in n?Ja(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var Rn=(n,e,t)=>(Qa(n,typeof e!="symbol"?e+"":e,t),t);const P=require("obsidian"),Ge=require("path"),pt=require("fs"),Za=require("events"),Nt=require("child_process"),yn=require("perf_hooks"),Xa=require("os"),el=require("crypto"),tl=require("util");function ti(n){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(n){for(const t in n)if(t!=="default"){const i=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(e,t,i.get?i:{enumerable:!0,get:()=>n[t]})}}return e.default=n,Object.freeze(e)}const Ke=ti(Ge),nl=ti(Xa),il=ti(el),Nr=class Yn{constructor(e,t=!1){this.consolidatedLogPath="",this.consolePrefix="MegaMem:",this.plugin=e,this.debugMode=t}init(){this.initializeConsolidatedLog()}initializeConsolidatedLog(){try{if(!this.plugin.app||!this.plugin.app.vault)throw console.error(`${this.consolePrefix} [ERROR] this.plugin.app.vault is undefined during logger initialization.`),new Error("Plugin app.vault not available during logger initialization");const t=this.plugin.app.vault.adapter.basePath,i=Ge.join(t,".obsidian","plugins","megamem-mcp"),s=Ge.join(i,"logs");pt.existsSync(s)||pt.mkdirSync(s,{recursive:!0}),this.consolidatedLogPath=Ge.join(s,"consolidated.log"),this.truncateLogIfNeeded(),Yn.sessionHeaderWritten||(this.writeToConsolidatedLog(`
`+"=".repeat(80)),this.writeToConsolidatedLog(`NEW SESSION: ${new Date().toISOString()}`),this.writeToConsolidatedLog("=".repeat(80)),Yn.sessionHeaderWritten=!0)}catch(e){console.error(`${this.consolePrefix} Failed to initialize consolidated log:`,e)}}truncateLogIfNeeded(){try{if(!pt.existsSync(this.consolidatedLogPath))return;const{readFileSync:e,writeFileSync:t}=require("fs"),s=e(this.consolidatedLogPath,"utf-8").split(`
`);if(s.length>1e4){const r=s.slice(-1e4);t(this.consolidatedLogPath,r.join(`
`))}}catch(e){}}writeToFile(e){try{const t=new Date().toISOString();this.writeToConsolidatedLog(`[${t}] ${e}`)}catch(t){console.error(`${this.consolePrefix} Failed to write to log file:`,t)}}writeToConsolidatedLog(e){try{this.consolidatedLogPath&&pt.appendFileSync(this.consolidatedLogPath,e+`
`)}catch(t){}}formatMessage(e,t,i){let s=`[${e}] ${t}`;return i!==void 0&&(i instanceof Error?s+=`
  Error: ${i.message}
  Stack: ${i.stack}`:typeof i=="object"?s+=`
  Data: ${JSON.stringify(i,null,2)}`:s+=`
  Data: ${i}`),s}info(e,t){const i=this.formatMessage("INFO",e,t);t!==void 0?console.log(`${this.consolePrefix} ${e}`,t):console.log(`${this.consolePrefix} ${e}`),this.writeToFile(i)}debug(e,t){if(!this.debugMode)return;const i=this.formatMessage("DEBUG",e,t);t!==void 0?console.debug(`${this.consolePrefix} [DEBUG] ${e}`,t):console.debug(`${this.consolePrefix} [DEBUG] ${e}`),this.writeToFile(i)}warn(e,t){const i=this.formatMessage("WARN",e,t);t!==void 0?console.warn(`${this.consolePrefix} [WARN] ${e}`,t):console.warn(`${this.consolePrefix} [WARN] ${e}`),this.writeToFile(i)}error(e,t){const i=this.formatMessage("ERROR",e,t);t!==void 0?console.error(`${this.consolePrefix} [ERROR] ${e}`,t):console.error(`${this.consolePrefix} [ERROR] ${e}`),this.writeToFile(i)}setDebug(e){this.debugMode=e}getLogFilePath(){return this.consolidatedLogPath}logPythonOutput(e,t){const i=t.split(`
`).filter(s=>s.trim());for(const s of i){if(e==="stderr"&&this.shouldFilterErrorLine(s))continue;const r=s.length>1e3?s.substring(0,1e3)+"[TRUNCATED]":s;this.writeToFile(`[PYTHON-${e.toUpperCase()}] ${r}`)}}shouldFilterErrorLine(e){return e.includes("LLM generation failed parsing as JSON")?(this.writeToFile("[PYTHON-STDERR] [ERROR] LLM JSON parsing failed - object dump filtered for log readability"),!1):!!(e.includes("Input messages:")||e.includes('"parts":')||e.includes('"video_metadata":')||e.includes('"thought":')||e.includes('"inline_data":')||e.includes('"file_data":')||e.includes('"function_call":')||e.includes('"function_response":')||e.trim().startsWith("{")&&e.includes('"')||e.trim().startsWith("[")&&e.includes('"'))}logSystemInfo(){try{this.getGraphitiVersion().then(e=>{var t;this.debug("System Information:",{platform:process.platform,nodeVersion:process.version,obsidianVersion:((t=this.plugin.app.vault.config)==null?void 0:t.version)||"unknown",pluginVersion:this.plugin.manifest.version,pluginId:this.plugin.manifest.id,GraphitiVersion:e})}).catch(e=>{var t;this.debug("System Information:",{platform:process.platform,nodeVersion:process.version,obsidianVersion:((t=this.plugin.app.vault.config)==null?void 0:t.version)||"unknown",pluginVersion:this.plugin.manifest.version,pluginId:this.plugin.manifest.id,GraphitiVersion:"detection failed"}),this.error("Failed to detect graphiti version",e)})}catch(e){this.error("Failed to log system info",e)}}async getGraphitiVersion(){return new Promise((e,t)=>{var i,s;try{const{spawn:r}=require("child_process"),a=r("python",["-c",`
import sys
version = None

try:
    import importlib.metadata
    version = importlib.metadata.version('graphiti-core')
except:
    pass

if not version:
    try:
        import pkg_resources
        version = pkg_resources.get_distribution('graphiti-core').version
    except:
        pass

if not version:
    try:
        import graphiti_core
        version = getattr(graphiti_core, '__version__', None)
        if not version:
            version = '0.18.0'
    except:
        pass

if not version:
    version = 'unknown'

# Print only the final version result
print(version)
`],{stdio:["pipe","pipe","pipe"]});let l="",d="";(i=a.stdout)==null||i.on("data",p=>{l+=p.toString()}),(s=a.stderr)==null||s.on("data",p=>{d+=p.toString()}),a.on("close",p=>{p===0&&l.trim()?e(l.trim()):t(new Error(`Python process failed (code ${p}): ${d||"No output"}`))}),a.on("error",p=>{t(new Error(`Failed to start Python process: ${p.message}`))})}catch(r){t(new Error(`Exception in getGraphitiVersion: ${r instanceof Error?r.message:String(r)}`))}})}};Nr.sessionHeaderWritten=!1;let Gt=Nr;function sl(n,e){let t;return(...i)=>{t&&clearTimeout(t),t=setTimeout(()=>n(...i),e)}}const Ar=n=>{var e;try{if(n&&n.plugins&&n.plugins.plugins){const t=n.plugins.plugins["megamem-mcp"];if(t){const i=((e=t.settings)==null?void 0:e.enableDebugLogging)||!1;return new Gt(t,i)}}}catch(t){console.error("Failed to initialize GraphitiLogger in PluginDetectionHelper:",t)}return{info:()=>{},debug:()=>{},warn:()=>{},error:()=>{}}};function Or(n){return`.obsidian/plugins/${n}/data.json`}async function Ir(n,e,t){try{if(!await n.exists(e))return t.debug(`[PluginDetection] file not found: ${e}`),null;const s=await n.read(e);try{return JSON.parse(s)}catch(r){return t.warn(`[PluginDetection] Failed to parse JSON at ${e}: ${String(r)}`),null}}catch(i){return t.error(`[PluginDetection] Error reading ${e}: ${String(i)}`),null}}async function rl(n){const e=Ar(n),t=n.vault&&n.vault.adapter,i="templater-obsidian",s=Or(i),r={detected:!1,enabled:!1,useTemplateFolders:!1,templatesFolder:null,folderTemplates:{},raw:null};if(!t)return e.warn("[PluginDetection] app.vault.adapter not available when reading Templater config"),r;const o=await Ir(t,s,e);if(!o)return r;const a=o,l=a.folder_templates||a.settings&&a.settings.folder_templates||a.folderTemplates||a.folder_templates_array||null,d=c=>c?(c.split("/").pop()||c).replace(/\.md$/i,"").trim().toLowerCase():"",p={};if(l&&typeof l=="object"&&!Array.isArray(l))for(const[c,v]of Object.entries(l)){const w=d(c);w&&(p[w]=typeof v=="string"?v:String(v||""))}if(Array.isArray(l))for(const c of l)try{const v=(c==null?void 0:c.folder)||(c==null?void 0:c.folderPath)||"",w=(c==null?void 0:c.template)||(c==null?void 0:c.templatePath)||"",_=d(w);_&&(p[_]=v)}catch(v){}const g=a.templates_folder||a.settings&&a.settings.templates_folder||null,m=!!Object.keys(p||{}).length||!!(a.settings&&a.settings.use_templates_folder);let h=!1;try{const c=n.plugins&&n.plugins.plugins;c&&c[i]&&(h=!!c[i].enabled)}catch(c){e.debug(`[PluginDetection] could not determine templater enabled state: ${String(c)}`)}const b={detected:!0,enabled:h,useTemplateFolders:m,templatesFolder:g||null,folderTemplates:p||{},raw:o};return e.debug("[PluginDetection] readTemplaterConfig result",{...b,raw:void 0}),b}async function ol(n){const e=Ar(n),t=n.vault&&n.vault.adapter,i="periodic-notes",s=Or(i),r={detected:!1,enabled:!1,raw:null};if(!t)return e.warn("[PluginDetection] app.vault.adapter not available when reading Periodic Notes config"),r;const o=await Ir(t,s,e);if(!o)return r;const a=o;function l(b){return b?{enabled:!!b.enabled,folder:b.folder||null,format:b.format||null}:{enabled:!1,folder:null,format:null}}const d=l(a.daily),p=l(a.weekly),g=l(a.monthly);let m=!!(d.enabled||p.enabled||g.enabled);try{const b=n.plugins&&n.plugins.plugins;b&&b[i]&&(m=m||!!b[i].enabled)}catch(b){e.debug(`[PluginDetection] could not determine periodic-notes enabled state: ${String(b)}`)}const h={detected:!0,enabled:m,daily:d,weekly:p,monthly:g,raw:o};return e.debug("[PluginDetection] readPeriodicNotesConfig result",{detected:!0,enabled:m,daily:d,weekly:p,monthly:g}),h}const al=rl,ll=ol;class cl{constructor(e,t,i,s){this.client=null,this.reconnectAttempts=0,this.baseReconnectDelay=1e3,this.maxReconnectDelay=3e4,this.isRetrying=!1,this.lastConnectionStatus=null,this.plugin=e,this.settings=t,this.syncRegistryService=i,this.vaultRegistryService=s,this.logger=new Gt(e,t.enableDebugLogging)}sleep(e){return new Promise(t=>setTimeout(t,e))}calculateBackoffDelay(e){const t=this.reconnectAttempts;let i=this.baseReconnectDelay;(e==null?void 0:e.code)==="ECONNREFUSED"?i=this.baseReconnectDelay*2:((e==null?void 0:e.code)==="ECONNRESET"||(e==null?void 0:e.code)==="EPIPE")&&(i=this.baseReconnectDelay*.5);const s=i*Math.pow(1.5,Math.min(t,10)),r=Math.random()*.3+.85,o=Math.min(s*r,this.maxReconnectDelay);return Math.floor(o)}async connectWithRetry(){for(this.isRetrying=!0;this.settings.wsEnabled&&!this.client;)try{await this.connectOnce(),this.reconnectAttempts=0,this.isRetrying=!1;return}catch(e){if(this.reconnectAttempts++,(this.reconnectAttempts===1||this.reconnectAttempts%20===0)&&this.logger.error(`[WEBSOCKET] Connection failed (attempt ${this.reconnectAttempts}):`,e),!this.settings.wsEnabled){this.isRetrying=!1;return}const t=this.calculateBackoffDelay(e);await this.sleep(t)}this.isRetrying=!1}async connectOnce(){return new Promise((e,t)=>{try{const i=`ws://localhost:${this.settings.wsPort}?token=${this.settings.wsAuthToken}`;this.client=new WebSocket(i);const s=setTimeout(()=>{this.client&&(this.client.close(),this.client=null),t(new Error("Connection timeout"))},1e4);this.client.onopen=async()=>{if(clearTimeout(s),this.logger.debug("[WEBSOCKET] Connection established successfully"),this.lastConnectionStatus=!0,await new Promise(r=>setTimeout(r,100)),this.vaultRegistryService){this.logger.debug("[WEBSOCKET] Triggering vault auto-registration...");const r=await this.vaultRegistryService.autoRegisterCurrentVault(!1,this);r?this.logger.debug(`[WEBSOCKET] Vault auto-registration successful: ${r.name} (${r.id})`):this.logger.error("[WEBSOCKET] Vault auto-registration failed")}else this.logger.warn("[WEBSOCKET] No vault registry service available");e()},this.client.onmessage=r=>{this.handleMessage(r.data)},this.client.onclose=r=>{if(clearTimeout(s),this.client=null,this.vaultRegistryService&&this.lastConnectionStatus!==!1){const o=this.vaultRegistryService.getActiveVaultId();o&&(this.vaultRegistryService.updateVaultConnection(o,!1),this.lastConnectionStatus=!1)}r.code!==1e3&&this.settings.wsEnabled&&!this.isRetrying&&this.connectWithRetry()},this.client.onerror=r=>{clearTimeout(s),this.client&&(this.client.close(),this.client=null),t(r)}}catch(i){t(i)}})}async start(){if(!this.settings.wsEnabled){this.logger.debug("[WEBSOCKET] Service disabled in settings");return}this.logger.debug("[WEBSOCKET] Service enabled in settings - connecting..."),this.connect()}connect(){this.isRetrying||this.connectWithRetry()}async stop(){this.logger.debug("[WEBSOCKET] Stopping WebSocket service"),this.isRetrying=!1,this.reconnectTimer&&(window.clearTimeout(this.reconnectTimer),this.reconnectTimer=void 0),this.client&&(this.logger.debug("[WEBSOCKET] Closing WebSocket connection"),this.client.close(1e3,"Client shutdown"),this.client=null),this.reconnectAttempts=0}sendMessage(e){if(!this.client){this.logger.error("[WEBSOCKET] ERROR: No WebSocket client instance");return}if(this.client.readyState===WebSocket.OPEN)try{const t=JSON.stringify(e);this.logger.debug(`[WEBSOCKET] Sending message type: ${e.type}`),this.client.send(t)}catch(t){this.logger.error("[WEBSOCKET] ERROR sending message:",t)}else this.logger.warn(`[WEBSOCKET] Cannot send message - WebSocket not connected. ReadyState: ${this.client.readyState}`)}sendVaultRegistration(e){if(!this.client||this.client.readyState!==WebSocket.OPEN)return this.logger.warn("[WEBSOCKET] Cannot send vault registration - WebSocket not connected"),!1;const t={type:"register",payload:{vaultName:e.name,vaultPath:e.path,vaultId:e.id,pluginVersion:this.plugin.manifest.version,authToken:this.settings.wsAuthToken}};return this.logger.debug(`[WEBSOCKET] Sending vault registration to server: ${e.name} (${e.id})`),this.sendMessage(t),!0}isConnected(){return this.client!==null&&this.client.readyState===WebSocket.OPEN}async handleMessage(e){try{const t=JSON.parse(e);switch(this.logger.debug("Received WebSocket message:",t.type),t.type){case"connected":this.handleConnected(t);break;case"registered":this.handleRegistered(t);break;case"file:read":await this.handleFileRead(t);break;case"file:write":await this.handleFileWrite(t);break;case"file:create":await this.handleFileCreate(t);break;case"file:delete":await this.handleFileDelete(t);break;case"file:rename":await this.handleFileRename(t);break;case"file:search":this.handleFileSearch(t);break;case"vault:list":this.handleVaultList(t);break;case"vault:info":this.handleVaultInfo(t);break;case"ping":this.handlePing(t);break;case"folder:explore":await this.handleFolderExplore(t);break;case"folder:create":await this.handleFolderCreate(t);break;case"folder:rename":await this.handleFolderRename(t);break;case"folder:delete":await this.handleFolderDelete(t);break;case"templater:check":await this.handleTemplaterCheck(t);break;case"file:create_with_template":await this.handleCreateWithTemplate(t);break;case"file:frontmatter_edit":await this.handleFrontmatterEdit(t);break;case"file:append":await this.handleAppendEdit(t);break;case"file:range_edit":await this.handleRangeEdit(t);break;case"file:editor_edit":await this.handleEditorEdit(t);break;case"error":this.handleError(t);break;default:this.handleUnknownMessage(t)}}catch(t){this.logger.error("Error handling WebSocket message:",t),this.sendErrorResponse("error","Invalid message format")}}async handleFileRead(e){this.logger.debug("Handling file:read request",{path:e.payload.path});try{const t=e.payload;if(!(t!=null&&t.path)){this.sendErrorResponse("file:read:response","Missing file path parameter",e.id);return}const i=this.plugin.app.vault.getAbstractFileByPath(t.path);if(!i||!(i instanceof P.TFile)){this.sendErrorResponse("file:read:response","File not found",e.id);return}const s=await this.plugin.app.vault.read(i),r={id:e.id,type:"file:read:response",success:!0,timestamp:new Date().toISOString(),payload:{content:s,path:t.path,metadata:{size:s.length,lastModified:new Date().toISOString()}}};this.sendMessage(r)}catch(t){this.sendErrorResponse("file:read:response","Failed to read file",e.id)}}async handleFileWrite(e){this.logger.debug("Handling file:write request",{path:e.payload.path});try{const t=e.payload;if(!(t!=null&&t.path)||t.content===void 0){this.sendErrorResponse("file:write:response","Missing file path or content parameter",e.id);return}const i=this.plugin.app.vault.getAbstractFileByPath(t.path);if(!i||!(i instanceof P.TFile)){this.sendErrorResponse("file:write:response","File not found",e.id);return}await this.plugin.app.vault.modify(i,t.content);const s={id:e.id,type:"file:write:response",success:!0,timestamp:new Date().toISOString(),payload:{path:t.path,message:"File successfully written"}};this.sendMessage(s)}catch(t){this.sendErrorResponse("file:write:response","Failed to write file",e.id)}}async handleFileCreate(e){this.logger.debug("Handling file:create request",{path:e.payload.path});try{const t=e.payload;if(!(t!=null&&t.path)||t.content===void 0){this.sendErrorResponse("file:create:response","Missing file path or content parameter",e.id);return}await this.plugin.app.vault.create(t.path,t.content);const i={id:e.id,type:"file:create:response",success:!0,timestamp:new Date().toISOString(),payload:{path:t.path,created:!0,message:"File successfully created"}};this.sendMessage(i)}catch(t){this.sendErrorResponse("file:create:response","Failed to create file",e.id)}}async handleFileDelete(e){this.logger.debug("Handling file:delete request",{path:e.payload.path});try{const t=e.payload;if(!(t!=null&&t.path)){this.sendErrorResponse("file:delete:response","Missing file path parameter",e.id);return}const i=this.plugin.app.vault.getAbstractFileByPath(t.path);if(!i){this.sendErrorResponse("file:delete:response","File not found",e.id);return}await this.plugin.app.vault.delete(i,!1);const s={id:e.id,type:"file:delete:response",success:!0,timestamp:new Date().toISOString(),payload:{path:t.path,message:"File successfully deleted"}};this.sendMessage(s)}catch(t){this.sendErrorResponse("file:delete:response","Failed to delete file",e.id)}}async handleFileRename(e){this.logger.debug("Handling file:rename request",{oldPath:e.payload.path,newPath:e.payload.newPath});try{const t=e.payload;if(!(t!=null&&t.path)||!(t!=null&&t.newPath)){this.sendErrorResponse("file:rename:response","Missing file path or newPath parameter",e.id);return}const i=this.plugin.app.vault.getAbstractFileByPath(t.path);if(!i){this.sendErrorResponse("file:rename:response","File not found",e.id);return}await this.plugin.app.fileManager.renameFile(i,t.newPath);const s={id:e.id,type:"file:rename:response",success:!0,timestamp:new Date().toISOString(),payload:{oldPath:t.path,newPath:t.newPath,message:"File successfully renamed"}};this.sendMessage(s)}catch(t){this.sendErrorResponse("file:rename:response","Failed to rename file",e.id)}}async handleFileSearch(e){var t,i,s,r;this.logger.debug("[WEBSOCKET] Handling file:search request",{query:(t=e.payload)==null?void 0:t.query});try{const o=e.payload||{},a=(o.query||"").toString();if(!a){this.sendErrorResponse("file:search:response","Missing search query parameter",e.id);return}const l=(o.search_mode||o.searchMode||"both").toString().toLowerCase(),d=Number((s=(i=o.max_results)!=null?i:o.maxResults)!=null?s:100),p=o.include_context!==void 0?!!o.include_context:o.includeContext!==void 0?!!o.includeContext:!0,g=Number((r=o.contextRadius)!=null?r:50),h=new Set(["filename","content","both"]).has(l)?l:"both";this.logger.debug("[WEBSOCKET] Search parameters",{query:a,mode:h,maxResults:d,includeContext:p});const b=[],c=this.plugin.app.vault.getMarkdownFiles();if(h==="filename"||h==="both"){const w=a.toLowerCase(),_=c.filter(C=>C.path.toLowerCase().includes(w)||C.basename.toLowerCase().includes(w));for(const C of _)if(b.push({path:C.path,name:C.name,basename:C.basename,extension:C.extension,matchType:"filename",score:100}),b.length>=d&&h==="filename")break}if((h==="content"||h==="both")&&Math.max(0,d-b.length)>0){let _=null;try{_=window.prepareSimpleSearch?window.prepareSimpleSearch(a):null}catch(x){_=null}const C=new Set(b.map(x=>x.path));for(const x of c)if(!C.has(x.path))try{const N=typeof this.plugin.app.vault.cachedRead=="function"?await this.plugin.app.vault.cachedRead(x):await this.plugin.app.vault.read(x);let k=!1,T=0,D;if(_)try{const A=_(N);A&&A.score>0&&(k=!0,T=Number(A.score)||1,A.matches&&(D=Array.isArray(A.matches)?A.matches:void 0))}catch(A){this.logger.warn("[WEBSOCKET] prepareSimpleSearch failed, falling back",{file:x.path,error:A})}if(k||N&&N.toLowerCase().includes(a.toLowerCase())&&(k=!0,T=10),k){const A={path:x.path,name:x.name,basename:x.basename,extension:x.extension,matchType:"content",score:T};if(p)try{const O=this.extractContextFromMatches(N,D||this._findAllMatches(N,a),a,g);O&&O.length&&(A.matches=O)}catch(O){this.logger.warn("[WEBSOCKET] Context extraction failed",{file:x.path,error:O})}if(b.push(A),C.add(x.path),b.length>=d)break}}catch(N){this.logger.warn("[WEBSOCKET] Failed to search content of file",{path:x.path,error:N})}}b.sort((w,_)=>{const C=Number(w.score||0),x=Number(_.score||0);return x!==C?x-C:w.matchType==="filename"&&_.matchType!=="filename"?-1:_.matchType==="filename"&&w.matchType!=="filename"?1:w.path.localeCompare(_.path)});const v={id:e.id,type:"file:search:response",success:!0,timestamp:new Date().toISOString(),payload:{results:b.slice(0,d),totalResults:b.length,query:a,searchMode:h}};this.sendMessage(v)}catch(o){this.logger.error("[WEBSOCKET] file:search handler error",{error:o}),this.sendErrorResponse("file:search:response","Failed to search files",e.id)}}_findAllMatches(e,t){const i=[];if(!e||!t)return i;const s=e.toLowerCase(),r=t.toLowerCase();let o=0;for(;;){const a=s.indexOf(r,o);if(a===-1)break;i.push([a,a+r.length]),o=a+r.length}return i}extractContextFromMatches(e,t,i,s=50){const r=(e||"").split(`
`),o=[],a=new Set;for(const[l,d]of t){let p=0,g=0;for(let C=0;C<r.length;C++){const x=r[C].length+1;if(p+x>l){g=C;break}p+=x}if(a.has(g))continue;a.add(g);const m=r[g]||"",h=p,b=Math.max(0,l-h),c=Math.min(m.length,d-h),v=Math.max(0,b-s),w=Math.min(m.length,c+s);let _=m.substring(v,w);if(v>0&&(_="..."+_),w<m.length&&(_=_+"..."),o.push({line:g+1,text:_.trim(),highlight:m.substring(b,c)}),o.length>=5)break}return o}handleVaultList(e){var t;this.logger.debug("Handling vault:list request");try{const i=((t=this.vaultRegistryService)==null?void 0:t.getAllVaults())||[],s={id:e.id,type:"vault:list:response",success:!0,timestamp:new Date().toISOString(),payload:{vaults:i,totalVaults:i.length}};this.sendMessage(s)}catch(i){this.sendErrorResponse("vault:list:response","Failed to list vaults",e.id)}}handleVaultInfo(e){var t,i;this.logger.debug("Handling vault:info request",{vaultId:e.payload.vaultId});try{const r={id:((t=e.payload)==null?void 0:t.vaultId)||((i=this.vaultRegistryService)==null?void 0:i.getActiveVaultId())||this.plugin.app.vault.getName(),name:this.plugin.app.vault.getName(),path:this.plugin.app.vault.adapter.basePath||"",files:this.plugin.app.vault.getMarkdownFiles().length},o={id:e.id,type:"vault:info:response",success:!0,timestamp:new Date().toISOString(),payload:r};this.sendMessage(o)}catch(s){this.sendErrorResponse("vault:info:response","Failed to get vault info",e.id)}}handlePing(e){this.logger.debug("Handling ping request");const t={id:e.id,type:"pong",success:!0,timestamp:new Date().toISOString(),payload:{vaultName:this.plugin.app.vault.getName(),version:this.plugin.manifest.version,timestamp:new Date().toISOString()}};this.sendMessage(t)}handleError(e){var r,o;if(!e||!e.payload){this.logger.error("Received malformed error message from server",e);return}this.logger.error("Received error message from server",{error:e.payload.error});const t=e.error||((r=e.payload)==null?void 0:r.error)||"Unknown error from server",i=e.errorCode||((o=e.payload)==null?void 0:o.errorCode)||"UNKNOWN_ERROR",s=e.id||"no-id";this.logger.error(`WebSocket server error (ID: ${s}, Code: ${i}): ${t}`,e)}handleUnknownMessage(e){this.logger.warn("Received unknown message type:",e.type)}async handleFolderExplore(e){try{this.logger.debug("Handling folder:explore request",{payload:e.payload});const t=e.payload||{},i=this.plugin;if(i&&typeof i.exploreVaultFoldersHandler=="function"){const a=await i.exploreVaultFoldersHandler({query:t.query,path:t.path,depth:typeof t.depth=="number"?t.depth:-1,format:t.format||"smart"}),l={id:e.id,type:"folder:explore:response",success:!0,timestamp:new Date().toISOString(),payload:a};this.sendMessage(l);return}const s=this.plugin.app.vault.getRoot();if(!s){this.sendErrorResponse("folder:explore:response","Vault root not available",e.id);return}const r=(s.children||[]).filter(a=>a&&a.constructor&&a.constructor.name==="TFolder").map(a=>({path:a.path,name:a.name})),o={id:e.id,type:"folder:explore:response",success:!0,timestamp:new Date().toISOString(),payload:{results:r,totalFolders:r.length,searchQuery:t.query||null,format:t.format||"flat"}};this.sendMessage(o)}catch(t){this.logger.error("[WEBSOCKET] folder:explore handler error",{error:t}),this.sendErrorResponse("folder:explore:response","Failed to explore folders",e.id)}}async handleFolderCreate(e){this.logger.debug("[WEBSOCKET] Handling folder:create request",{payload:e.payload});try{const t=e.payload||{},i=t.folderPath||t.path;if(!i||typeof i!="string"){this.sendErrorResponse("folder:create:response","Missing or invalid folder path parameter",e.id);return}const s=P.normalizePath(i.trim());if(this.plugin.app.vault.getAbstractFileByPath(s)){this.sendErrorResponse("folder:create:response","Folder already exists",e.id);return}await this.plugin.app.vault.createFolder(s);const o={id:e.id,type:"folder:create:response",success:!0,timestamp:new Date().toISOString(),payload:{path:s,created:!0,message:"Folder successfully created"}};this.sendMessage(o)}catch(t){this.logger.error("[WEBSOCKET] folder:create handler error",{error:t}),this.sendErrorResponse("folder:create:response","Failed to create folder",e.id)}}async handleFolderRename(e){this.logger.debug("[WEBSOCKET] Handling folder:rename request",{payload:e.payload});try{const t=e.payload||{},i=t.oldPath||t.sourcePath,s=t.newPath||t.targetPath;if(!i||typeof i!="string"){this.sendErrorResponse("folder:rename:response","Missing or invalid oldPath parameter",e.id);return}if(!s||typeof s!="string"){this.sendErrorResponse("folder:rename:response","Missing or invalid newPath parameter",e.id);return}const r=P.normalizePath(i.trim()),o=P.normalizePath(s.trim()),a=this.plugin.app.vault.getAbstractFileByPath(r);if(!a||!(a instanceof P.TFolder)){this.sendErrorResponse("folder:rename:response","Source folder not found",e.id);return}if(this.plugin.app.vault.getAbstractFileByPath(o)){this.sendErrorResponse("folder:rename:response","Target path already exists",e.id);return}await this.plugin.app.fileManager.renameFile(a,o);const d={id:e.id,type:"folder:rename:response",success:!0,timestamp:new Date().toISOString(),payload:{oldPath:r,newPath:o,renamed:!0,message:"Folder successfully renamed/moved"}};this.sendMessage(d)}catch(t){this.logger.error("[WEBSOCKET] folder:rename handler error",{error:t}),this.sendErrorResponse("folder:rename:response","Failed to rename folder",e.id)}}async handleFolderDelete(e){this.logger.debug("[WEBSOCKET] Handling folder:delete request",{payload:e.payload});try{const t=e.payload||{},i=t.folderPath||t.path,s=t.force||!1;if(!i||typeof i!="string"){this.sendErrorResponse("folder:delete:response","Missing or invalid folder path parameter",e.id);return}const r=P.normalizePath(i.trim()),o=this.plugin.app.vault.getAbstractFileByPath(r);if(!o||!(o instanceof P.TFolder)){this.sendErrorResponse("folder:delete:response","Folder not found",e.id);return}if(!s&&o.children&&o.children.length>0){this.sendErrorResponse("folder:delete:response","Folder is not empty. Use force=true to delete non-empty folders",e.id);return}await this.plugin.app.vault.delete(o,s);const a={id:e.id,type:"folder:delete:response",success:!0,timestamp:new Date().toISOString(),payload:{path:r,deleted:!0,message:"Folder successfully deleted"}};this.sendMessage(a)}catch(t){this.logger.error("[WEBSOCKET] folder:delete handler error",{error:t}),this.sendErrorResponse("folder:delete:response","Failed to delete folder",e.id)}}async handleTemplaterCheck(e){var t,i,s,r,o,a,l,d;try{const p=(i=(t=this.plugin.app.plugins)==null?void 0:t.plugins)==null?void 0:i["templater-obsidian"];if(!p)return this.sendMessage({id:e.id,type:"templater:check:response",success:!0,payload:{isInstalled:!1,templates:[],templateMappings:{}}});const g=((s=p.settings)==null?void 0:s.templates_folder)||"";if(!g)return this.sendMessage({id:e.id,type:"templater:check:response",success:!0,payload:{isInstalled:!0,templateFolder:"",templates:[],templateMappings:{}}});const m=P.normalizePath(g),b=this.plugin.app.vault.getMarkdownFiles().filter(O=>O.path.startsWith(m)).map(O=>({path:O.path,name:O.name,basename:O.basename})),c={},v=await al(this.plugin.app),w=await ll(this.plugin.app),_=window.moment,C=_?_():new Date,x=(O,B,R)=>{if(!O)return"";if(!B)return O;const F=R||(_?_():null);try{const L=O.replace(/\/+$/g,""),V=(B||"").split("/").map(W=>W.trim()).filter(Boolean),Y=[];if(V.length>1){const W=V.slice(0,V.length-1);for(const K of W){let H=N(K,F);H&&Y.push(H)}}else{const W=V[0]||B;if(/YYYY/.test(W)){const K=N("YYYY",F);if(K&&Y.push(K),/MM/.test(W)){const H=N("MM",F);H&&Y.push(H)}}}return Y.length>0?`${L}/${Y.join("/")}`:L}catch(L){return this.logger.warn("Error calculating periodic path",{error:L,baseFolder:O,format:B}),O}},N=(O,B)=>{if(!O)return"";let R=O;if(B&&typeof B.format=="function")try{R=B.format(O)}catch(F){R=k(O)}else R=k(O);return R=R.replace(/\[.*?\]/g,"").trim(),R=R.replace(/[<>:"|?*]/g,"").trim(),R},k=O=>{const B=new Date,R=B.getFullYear().toString(),F=String(B.getMonth()+1).padStart(2,"0");return O.replace(/YYYY/g,R).replace(/yyyy/g,R).replace(/MM/g,F).replace(/gggg/g,R)},T=((o=(r=this.settings.mcpTools)==null?void 0:r.defaults)==null?void 0:o.inboxFolder)||g||"",D=O=>O?((O||"").toString().split("/").pop()||O).replace(/\.md$/i,"").trim().toLowerCase():"";for(const O of b){const B=O.basename,R=D(B);v.detected&&v.folderTemplates&&v.folderTemplates[R]?c[B]=v.folderTemplates[R]:c[B]=T}if(w.detected&&w.enabled){if((a=w.daily)!=null&&a.enabled&&w.daily.folder){const O=x(w.daily.folder,w.daily.format||"YYYY-MM-DD");c["TPL Daily Note"]=O}if((l=w.weekly)!=null&&l.enabled&&w.weekly.folder){const O=x(w.weekly.folder,w.weekly.format||"YYYY-[W]ww");c["TPL Weekly Note"]=O}if((d=w.monthly)!=null&&d.enabled&&w.monthly.folder){const O=x(w.monthly.folder,w.monthly.format||"YYYY-MM");c["TPL Monthly Note"]=O}}const A={id:e.id,type:"templater:check:response",success:!0,timestamp:new Date().toISOString(),payload:{isInstalled:!0,templateFolder:m,templates:b,templateMappings:c}};this.sendMessage(A)}catch(p){this.logger.error("[WEBSOCKET] templater:check handler error",{error:p}),this.sendErrorResponse("templater:check:response","Failed to check templater",e.id)}}async handleCreateWithTemplate(e){var t,i,s;try{const r=e.payload||{},o=(r.searchTerm||"").toString().trim(),a=(r.fileName||"").toString().trim(),l=(r.targetFolder||"").toString(),d=(r.userContent||"").toString();if(!a){this.sendErrorResponse("file:create_with_template:response","Missing fileName",e.id);return}const p=(i=(t=this.plugin.app.plugins)==null?void 0:t.plugins)==null?void 0:i["templater-obsidian"];if(!p||!((s=p.settings)!=null&&s.templates_folder)){this.sendErrorResponse("file:create_with_template:response","Templater not configured",e.id);return}const g=this.plugin.app.vault.getMarkdownFiles().filter(b=>b.path.startsWith(p.settings.templates_folder));if(g.length===0){this.sendErrorResponse("file:create_with_template:response","No templates found",e.id);return}const m=o.toLowerCase();let h=g.find(b=>b.basename.toLowerCase()===m);if(!h){const b=g.map(c=>c.basename).sort();this.sendMessage({id:e.id,type:"file:create_with_template:response",success:!1,timestamp:new Date().toISOString(),requiresSelection:!0,availableTemplates:b,error:`No exact match for '${o}'. Please specify exact template name from availableTemplates.`,payload:{availableTemplates:b,searchTerm:o}});return}try{const b=p.templater;if(b&&b.create_new_note_from_template){const c=l||"",v=a.replace(/\.md$/,""),w=await b.create_new_note_from_template(h,c,v);if(w){const _=await this.plugin.app.vault.read(w);if(_.trim()===h.path)throw await this.plugin.app.vault.delete(w),new Error("Templater API returned path instead of content");d&&await this.plugin.app.vault.modify(w,_+`

`+d),this.sendMessage({id:e.id,type:"file:create_with_template:response",success:!0,timestamp:new Date().toISOString(),payload:{path:w.path,templateUsed:h.basename,message:"Created file using Templater API"}});return}}throw new Error("Templater API not available")}catch(b){this.logger.warn("[WEBSOCKET] Templater API failed, using fallback",{error:b});const c=await this.plugin.app.vault.read(h),v=a.endsWith(".md")?a:`${a}.md`,w=l?`${l.replace(/\/$/,"")}/${v}`:v;let _=c;d&&(_=_+`

`+d);const C=await this.plugin.app.vault.create(w,_);this.sendMessage({id:e.id,type:"file:create_with_template:response",success:!0,timestamp:new Date().toISOString(),payload:{path:C.path,templateUsed:h.basename,message:"Created file by copying template (Templater syntax not processed)",warning:"Templater commands were not processed"}})}}catch(r){this.logger.error("[WEBSOCKET] file:create_with_template handler error",{error:r}),this.sendErrorResponse("file:create_with_template:response","Failed to create file with template",e.id)}}async handleFrontmatterEdit(e){var t;this.logger.debug("Handling file:frontmatter_edit request",{path:(t=e.payload)==null?void 0:t.path});try{const i=e.payload;if(!(i!=null&&i.path)){this.sendErrorResponse("file:frontmatter_edit:response","Missing file path parameter",e.id);return}const s=this.plugin.app.vault.getAbstractFileByPath(i.path);if(!s||!(s instanceof P.TFile)){this.sendErrorResponse("file:frontmatter_edit:response","File not found",e.id);return}const r=await this.plugin.app.vault.read(s),o=i.frontmatterChanges||{};if(this.logger.debug("[FRONTMATTER] Processing updates:",o),!o||Object.keys(o).length===0){this.sendErrorResponse("file:frontmatter_edit:response","No frontmatter changes provided",e.id);return}let a=r;const l=r.split(`
`);let d=-1,p=-1;for(let c=0;c<l.length;c++)if(l[c].trim()==="---")if(d===-1)d=c;else{p=c;break}let g=[],m=[];d===0&&p>0?(g=l.slice(d+1,p),m=l.slice(p+1)):(g=[],m=l);for(const[c,v]of Object.entries(o)){const w=g.findIndex(x=>{const N=x.indexOf(":");return N>0&&x.substring(0,N).trim()===c});let _;Array.isArray(v)?_=JSON.stringify(v):typeof v=="string"?_=`"${v}"`:_=String(v);const C=`${c}: ${_}`;w>=0?g[w]=C:g.push(C)}a=["---",...g,"---",...m].join(`
`),this.logger.debug(`[FRONTMATTER] Updated content length: ${a.length} (was ${r.length})`),await this.plugin.app.vault.modify(s,a);const b={id:e.id,type:"file:frontmatter_edit:response",success:!0,timestamp:new Date().toISOString(),payload:{path:i.path,message:"Frontmatter updated successfully"}};this.sendMessage(b)}catch(i){this.sendErrorResponse("file:frontmatter_edit:response","Failed to edit frontmatter",e.id)}}async handleAppendEdit(e){var t;this.logger.debug("Handling file:append request",{path:(t=e.payload)==null?void 0:t.path});try{const i=e.payload;if(!(i!=null&&i.path)||i.appendContent===void 0){this.sendErrorResponse("file:append:response","Missing file path or content parameter",e.id);return}const s=this.plugin.app.vault.getAbstractFileByPath(i.path);if(!s||!(s instanceof P.TFile)){this.sendErrorResponse("file:append:response","File not found",e.id);return}const o=await this.plugin.app.vault.read(s)+`
`+i.appendContent;await this.plugin.app.vault.modify(s,o);const a={id:e.id,type:"file:append:response",success:!0,timestamp:new Date().toISOString(),payload:{path:i.path,message:"Content appended successfully"}};this.sendMessage(a)}catch(i){this.sendErrorResponse("file:append:response","Failed to append content",e.id)}}async handleRangeEdit(e){var t;this.logger.debug("Handling file:range_edit request",{path:(t=e.payload)==null?void 0:t.path});try{const i=e.payload;if(!(i!=null&&i.path)||i.replacementContent===void 0){this.sendErrorResponse("file:range_edit:response","Missing file path or content parameter",e.id);return}const s=this.plugin.app.vault.getAbstractFileByPath(i.path);if(!s||!(s instanceof P.TFile)){this.sendErrorResponse("file:range_edit:response","File not found",e.id);return}const o=(await this.plugin.app.vault.read(s)).split(`
`),a=Math.max(0,(i.rangeStartLine||1)-1),l=Math.min(o.length,i.rangeEndLine||a+1),d=i.replacementContent.split(`
`);o.splice(a,l-a,...d);const p=o.join(`
`);await this.plugin.app.vault.modify(s,p);const g={id:e.id,type:"file:range_edit:response",success:!0,timestamp:new Date().toISOString(),payload:{path:i.path,message:"Range edited successfully"}};this.sendMessage(g)}catch(i){this.sendErrorResponse("file:range_edit:response","Failed to edit range",e.id)}}async handleEditorEdit(e){var t,i;this.logger.debug("Handling file:editor_edit request",{path:(t=e.payload)==null?void 0:t.path});try{const s=e.payload;if(!(s!=null&&s.path)){this.sendErrorResponse("file:editor_edit:response","Missing file path parameter",e.id);return}const r=this.plugin.app.vault.getAbstractFileByPath(s.path);if(!r||!(r instanceof P.TFile)){this.sendErrorResponse("file:editor_edit:response","File not found",e.id);return}const o=this.plugin.app.workspace.getActiveViewOfType(P.MarkdownView);let a=!1;if(o&&((i=o.file)==null?void 0:i.path)===s.path){const d=o.editor,p=s.editorMethod||"replace";switch(this.logger.debug(`[EDITOR] Processing editor operation: ${p} with payload:`,s),p){case"replace":s.content!==void 0&&(d.setValue(s.content),a=!0);break;case"append":if(s.content!==void 0){const g=d.lastLine();d.replaceRange(`
`+s.content,{line:g,ch:d.getLine(g).length}),a=!0}break;case"prepend":s.content!==void 0&&(d.replaceRange(s.content+`
`,{line:0,ch:0}),a=!0);break;case"insert":if(s.content!==void 0&&s.line!==void 0){const g=Math.max(0,s.line-1);d.replaceRange(s.content+`
`,{line:g,ch:0}),a=!0}break;case"replace_line":if(s.content!==void 0&&s.line!==void 0){const g=Math.max(0,s.line-1);g<d.lineCount()?(d.setLine(g,s.content),a=!0,this.logger.debug(`[EDITOR] Replaced line ${s.line} with new content`)):this.logger.warn(`[EDITOR] Line ${s.line} does not exist (file has ${d.lineCount()} lines)`)}break;case"replace_selection":s.content!==void 0&&(d.getSelection()?(d.replaceSelection(s.content),a=!0,this.logger.debug("[EDITOR] Replaced selected text with new content")):this.logger.warn("[EDITOR] No text currently selected for replacement"));break;case"insert_at":if(s.content!==void 0&&s.line!==void 0&&s.char!==void 0){const g={line:s.line-1,ch:s.char};d.replaceRange(s.content,g),a=!0,this.logger.debug(`[EDITOR] Inserted content at position ${s.line}:${s.char}`)}break;case"replace_range":if(s.content!==void 0&&s.fromLine!==void 0&&s.fromChar!==void 0&&s.toLine!==void 0&&s.toChar!==void 0){const g={line:s.fromLine-1,ch:s.fromChar},m={line:s.toLine-1,ch:s.toChar};d.replaceRange(s.content,g,m),a=!0,this.logger.debug(`[EDITOR] Replaced range from ${s.fromLine}:${s.fromChar} to ${s.toLine}:${s.toChar}`)}break;case"insert_after_heading":if(s.content!==void 0&&s.heading!==void 0){const g=s.heading,m=d.lineCount();let h=-1;for(let b=0;b<m;b++){const c=d.getLine(b);if(c.startsWith("#")&&c.includes(g)){h=b+1;break}if(c.toLowerCase().includes(g.toLowerCase())){h=b+1;break}}if(h>=0&&h<=m)d.replaceRange(`
`+s.content+`
`,{line:h,ch:0}),a=!0,this.logger.debug(`[EDITOR] Inserted content after heading "${g}" at line ${h}`);else{this.logger.warn(`[EDITOR] Heading "${g}" not found in document`);const b=d.lastLine();d.replaceRange(`

`+s.content,{line:b,ch:d.getLine(b).length}),a=!0,this.logger.debug("[EDITOR] Heading not found, appended content to end instead")}}break}}if(!a){const d=await this.plugin.app.vault.read(r);let p=d;const g=s.editorMethod||"replace";switch(this.logger.debug(`[EDITOR] Fallback to vault API for operation: ${g} with payload:`,s),g){case"replace":s.content!==void 0&&(p=s.content);break;case"append":s.content!==void 0&&(p=d+`
`+s.content);break;case"prepend":s.content!==void 0&&(p=s.content+`
`+d);break;case"insert":if(s.content!==void 0&&s.line!==void 0){const m=d.split(`
`),h=Math.max(0,s.line-1);m.splice(h,0,s.content),p=m.join(`
`)}break;case"insert_after_heading":if(s.content!==void 0&&s.heading!==void 0){const m=d.split(`
`),h=s.heading;let b=-1;for(let c=0;c<m.length;c++){const v=m[c];if(v.startsWith("#")&&v.includes(h)){b=c+1;break}if(v.toLowerCase().includes(h.toLowerCase())){b=c+1;break}}b>=0?(m.splice(b,0,"",s.content),p=m.join(`
`),this.logger.debug(`[EDITOR] Inserted content after heading "${h}" at line ${b}`)):(p=d+`

`+s.content,this.logger.debug(`[EDITOR] Heading "${h}" not found, appended to end instead`))}case"insert_at":if(s.content!==void 0&&s.line!==void 0&&s.char!==void 0){const m=d.split(`
`),h=Math.max(0,s.line-1);if(h<m.length){const b=m[h],c=b.substring(0,s.char),v=b.substring(s.char);m[h]=c+s.content+v,p=m.join(`
`),this.logger.debug(`[EDITOR] Vault API: Inserted content at position ${s.line}:${s.char}`)}else this.logger.warn(`[EDITOR] Line ${s.line} does not exist (file has ${m.length} lines)`)}break;case"replace_range":if(s.content!==void 0&&s.fromLine!==void 0&&s.fromChar!==void 0&&s.toLine!==void 0&&s.toChar!==void 0){const m=d.split(`
`),h=Math.max(0,s.fromLine-1),b=Math.max(0,s.toLine-1);if(h===b){const c=m[h]||"",v=c.substring(0,s.fromChar),w=c.substring(s.toChar);m[h]=v+s.content+w}else{const c=m[h]||"",v=m[b]||"",w=c.substring(0,s.fromChar),_=v.substring(s.toChar),C=s.content.split(`
`);C[0]=w+C[0],C[C.length-1]=C[C.length-1]+_,m.splice(h,b-h+1,...C)}p=m.join(`
`),this.logger.debug(`[EDITOR] Vault API: Replaced range from ${s.fromLine}:${s.fromChar} to ${s.toLine}:${s.toChar}`)}break;case"replace_line":if(s.content!==void 0&&s.line!==void 0){const m=d.split(`
`),h=Math.max(0,s.line-1);h<m.length?(m[h]=s.content,p=m.join(`
`),this.logger.debug(`[EDITOR] Vault API: Replaced line ${s.line} with new content`)):this.logger.warn(`[EDITOR] Line ${s.line} does not exist (file has ${m.length} lines)`)}break;case"replace_selection":s.content!==void 0&&(p=s.content,this.logger.debug("[EDITOR] Vault API: Replace selection fallback - replaced entire content (no active editor)"));break}await this.plugin.app.vault.modify(r,p)}const l={id:e.id,type:"file:editor_edit:response",success:!0,timestamp:new Date().toISOString(),payload:{path:s.path,operation:s.editorMethod||"replace",message:"Editor edit completed successfully"}};this.sendMessage(l)}catch(s){this.sendErrorResponse("file:editor_edit:response","Failed to perform editor edit",e.id)}}handleConnected(e){}handleRegistered(e){if(this.logger.info("[WEBSOCKET] Successfully registered with server"),this.vaultRegistryService){const t=this.vaultRegistryService.getActiveVaultId();t&&this.vaultRegistryService.updateVaultConnection(t,!0)}}sendErrorResponse(e,t,i){const s={id:i,type:e,success:!1,timestamp:new Date().toISOString(),error:t,errorCode:"OPERATION_FAILED"};this.sendMessage(s)}getStatus(){return this.settings.wsEnabled?this.client&&this.client.readyState===WebSocket.OPEN?`Connected to port ${this.settings.wsPort}`:this.reconnectTimer?`Reconnecting... (attempt ${this.reconnectAttempts})`:"Disconnected":"Disabled"}async restart(){this.logger.debug("[WEBSOCKET] Restarting WebSocket service..."),await this.stop(),this.settings.wsEnabled?(this.logger.debug("[WEBSOCKET] Settings enabled - starting WebSocket service"),await this.start()):this.logger.debug("[WEBSOCKET] Settings disabled - WebSocket service will remain stopped")}updateSettings(e){this.settings=e,this.logger.setDebug(e.enableDebugLogging),this.logger.debug("[WEBSOCKET] Updating service settings")}}class dl extends P.Events{constructor(e,t,i){super(),this.syncRecords=[],this.isLoaded=!1,this.saveTimeout=null,this.SAVE_DEBOUNCE_MS=300,this.app=e,this.plugin=t,this.logger=i,this.registryPath=P.normalizePath(Ge.join(t.manifest.dir||".obsidian/plugins/megamem-mcp","sync.json"))}async load(){if(!await this.app.vault.adapter.exists(this.registryPath)){this.logger.debug("[DEBUG] sync.json does not exist, creating new one"),this.logger.info("[SYNC-REGISTRY] No existing sync registry found, creating new one"),this.syncRecords=[],await this.save(),this.isLoaded=!0;return}try{const t=await this.app.vault.adapter.read(this.registryPath),s=JSON.parse(t);this.syncRecords=s.sync_records||[],this.logger.info(`[SYNC-REGISTRY] Loaded sync registry with ${this.syncRecords.length} records.`),this.isLoaded=!0}catch(t){this.logger.error("[DEBUG] Error loading sync.json:",t),this.logger.error("[SYNC-REGISTRY] CRITICAL ERROR: Registry file is corrupt and cannot be parsed. Loading empty registry in memory without overwriting file.",t),this.syncRecords=[],this.isLoaded=!0}}async save(){return this.saveTimeout&&clearTimeout(this.saveTimeout),new Promise((e,t)=>{this.saveTimeout=setTimeout(async()=>{try{await this.performSave(),e()}catch(i){t(i)}finally{this.saveTimeout=null}},this.SAVE_DEBOUNCE_MS)})}async saveImmediate(){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null),await this.performSave()}async performSave(){try{const e={version:"1.0",sync_records:this.syncRecords},t=JSON.stringify(e,null,2);await this.app.vault.adapter.write(this.registryPath,t),this.trigger("changed")}catch(e){const t=e instanceof Error?e.message:String(e);throw this.logger.error("[SYNC-REGISTRY] Failed to save sync registry:",{error:t,path:this.registryPath,timestamp:new Date().toISOString()}),new Error(`Failed to save sync registry: ${t}`)}}getSyncRecord(e,t,i){if(!e||typeof e!="string"){this.logger.warn("[SYNC-REGISTRY] getSyncRecord called without mm_uid",{vaultId:t,context:i});return}return this.syncRecords.find(r=>r.mm_uid===e&&r.vault_id===t)}getSyncRecordByPath(e,t){if(!(!e||typeof e!="string"))return this.syncRecords.find(i=>i.vault_id===t&&i.note_path===e)}async addOrUpdateSyncRecord(e){const{mmUid:t,notePath:i,vaultId:s,syncEntry:r}=e;if(!t||typeof t!="string")throw this.logger.error("[SYNC-REGISTRY] addOrUpdateSyncRecord missing mm_uid",{notePath:i,vaultId:s}),new Error("mm_uid is required to add or update a sync record");if(!this.isValidUUID(t))throw this.logger.error("[SYNC-REGISTRY] addOrUpdateSyncRecord received invalid mm_uid format",{mmUid:t,notePath:i,vaultId:s}),new Error("Invalid mm_uid format - must be a valid UUID");let o=this.getSyncRecord(t,s);if(o){const a=o.syncs.findIndex(l=>l.database_id===r.database_id);a>=0?(o.syncs[a]=r,this.logger.info("[SYNC-REGISTRY] Updated sync entry",{mm_uid:t,vault_id:s,database:r.database_id})):(o.syncs.push(r),this.logger.info("[SYNC-REGISTRY] Added new sync entry",{mm_uid:t,vault_id:s,database:r.database_id})),o.note_modified=new Date().toISOString(),i&&typeof i=="string"&&(o.note_path=i)}else{const a={mm_uid:t,note_path:i||"",vault_id:s,note_modified:new Date().toISOString(),syncs:[r]};this.syncRecords.push(a),this.logger.info("[SYNC-REGISTRY] Created new sync record",{mm_uid:t,vault_id:s})}await this.save()}findNoteByEpisodeUuid(e){for(const t of this.syncRecords)for(const i of t.syncs)if(i.episode_uuid===e)return{record:t,entry:i}}async generateGroupId(e,t){var r,o;const i=this.plugin.settings;let s=e.replace(/\\/g,"/");try{const a=(o=(r=this.app.vault.adapter)==null?void 0:r.basePath)!=null?o:"";a&&Ge.isAbsolute(e)&&(s=Ge.relative(a,e).replace(/\\/g,"/"))}catch(a){s=e.replace(/\\/g,"/")}if(i.enablePropertyNamespacing){const a=this.app.metadataCache.getCache(s),l=a==null?void 0:a.frontmatter,d=l==null?void 0:l.g_group_id;if(typeof d=="string"&&d.trim().length>0)return d.trim();if(typeof d=="number")return String(d)}if(i.enableFolderNamespacing){const a=this.getCustomGroupId(s,i.folderNamespaceMappings||[]);if(a)return a}return i.namespaceStrategy==="custom"&&i.defaultNamespace||t}getCustomGroupId(e,t){if(!t||t.length===0)return null;const i=[...t].sort((a,l)=>l.folderPath.length-a.folderPath.length),r=e.replace(/\\/g,"/").split("/").filter(a=>a.length>0),o=r.length>1?r.slice(0,-1).join("/"):"";for(const a of i){const l=a.folderPath.replace(/\\/g,"/");if(l&&(o===l||o.startsWith(l+"/")))return a.groupId}return null}getVaultSyncRecords(e){return this.syncRecords.filter(t=>t.vault_id===e)}getDatabaseSyncRecords(e){return this.syncRecords.filter(t=>t.syncs.some(i=>i.database_id===e))}getGroupIdSyncRecords(e){return this.syncRecords.filter(t=>t.syncs.some(i=>i.group_id===e))}async removeSyncRecord(e,t){if(!e||typeof e!="string")return!1;const i=this.syncRecords.length;return this.syncRecords=this.syncRecords.filter(s=>!(s.mm_uid===e&&s.vault_id===t)),this.syncRecords.length<i?(await this.save(),this.logger.info("[SYNC-REGISTRY] Removed sync record",{mm_uid:e,vault_id:t}),!0):!1}async removeSyncEntry(e,t,i){const s=this.getSyncRecord(e,t);if(!s)return!1;const r=s.syncs.length;return s.syncs=s.syncs.filter(o=>o.database_id!==i),s.syncs.length<r?(s.syncs.length===0?await this.removeSyncRecord(e,t):await this.save(),this.logger.info("[SYNC-REGISTRY] Removed sync entry",{mm_uid:e,vault_id:t,database:i}),!0):!1}getSyncStats(e){const t=e?this.getVaultSyncRecords(e):this.syncRecords,i={};let s=0,r;for(const o of t)for(const a of o.syncs)i[a.database_id]=(i[a.database_id]||0)+1,s++,(!r||a.last_sync>r)&&(r=a.last_sync);return{totalRecords:t.length,totalSyncs:s,databaseCounts:i,lastSync:r}}validateSyncRecord(e){if(!e||typeof e!="object")return!1;if(!e.mm_uid||typeof e.mm_uid!="string"){if(!e.note_path||typeof e.note_path!="string")return!1}else if(!this.isValidUUID(e.mm_uid))return!1;if(!e.vault_id||typeof e.vault_id!="string"||!Array.isArray(e.syncs))return!1;for(const t of e.syncs)if(!this.validateSyncEntry(t))return!1;return!(e.note_modified&&!this.isValidISODate(e.note_modified))}validateSyncEntry(e){return!(!e||typeof e!="object"||!e.database_id||typeof e.database_id!="string"||!e.group_id||typeof e.group_id!="string"||!e.episode_uuid||typeof e.episode_uuid!="string"||e.episode_uuid!==null&&!this.isValidUUID(e.episode_uuid)||!e.last_sync||typeof e.last_sync!="string"||!this.isValidISODate(e.last_sync)||e.sync_hash&&typeof e.sync_hash!="string")}isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}isValidISODate(e){try{return new Date(e).toISOString()===e}catch(t){return!1}}removeDuplicateRecords(e){const t=new Set,i=[];for(const s of e){const r=s.mm_uid?`${s.vault_id}:mm:${s.mm_uid}`:`${s.vault_id}:path:${s.note_path}`;t.has(r)?this.logger.warn("[SYNC-REGISTRY] Removing duplicate record",{vault_id:s.vault_id,mm_uid:s.mm_uid,note_path:s.note_path}):(t.add(r),i.push(s))}return i}isRegistryLoaded(){return this.isLoaded}getVaultIds(){const e=new Set(this.syncRecords.map(t=>t.vault_id));return Array.from(e)}getDatabaseIds(){const e=new Set;for(const t of this.syncRecords)for(const i of t.syncs)e.add(i.database_id);return Array.from(e)}getGroupIds(){const e=new Set;for(const t of this.syncRecords)for(const i of t.syncs)e.add(i.group_id);return Array.from(e)}getAllSyncRecords(){return[...this.syncRecords]}async reload(){await this.load(),this.trigger("changed")}}class ul extends Za.EventEmitter{constructor(e,t,i){super(),this.isLoaded=!1,this.activeVaultId=null,this.app=e,this.plugin=t,this.logger=i,this.registry=new Map,this.registryPath=P.normalizePath(Ge.join(t.manifest.dir||".obsidian/plugins/megamem-mcp","vaults.json"))}async load(){if(!await this.app.vault.adapter.exists(this.registryPath)){this.logger.debug("[VAULT-REGISTRY] No existing vault registry found, creating new one"),this.registry=new Map,await this.save(),this.isLoaded=!0;return}try{const t=await this.app.vault.adapter.read(this.registryPath);if(!t||t.trim()===""||t.trim()==="{}"){this.logger.info("[VAULT-REGISTRY] Empty registry file found, populating from settings"),this.registry=new Map,await this.save(),this.isLoaded=!0;return}const i=JSON.parse(t);this.registry.clear();for(const[s,r]of Object.entries(i))this.registry.set(s,r);this.logger.info(`[VAULT-REGISTRY] Loaded vault registry with ${this.registry.size} vaults.`),this.isLoaded=!0}catch(t){this.logger.error("[VAULT-REGISTRY] Registry file contains invalid JSON. Loading empty registry.",t),this.registry=new Map,this.isLoaded=!0}}async save(){try{const e=Object.fromEntries(this.registry),t=JSON.stringify(e,null,2);await this.app.vault.adapter.write(this.registryPath,t),this.emit("registry-update")}catch(e){const t=e instanceof Error?e.message:String(e);throw this.logger.error("[VAULT-REGISTRY] Failed to save vault registry:",{error:t,path:this.registryPath,timestamp:new Date().toISOString()}),new Error(`Failed to save vault registry: ${t}`)}}async addVault(e){const t={...e,id:e.name};return this.registry.set(e.name,t),await this.save(),this.logger.info(`[VAULT-REGISTRY] Added vault: ${e.name}.`),t}getVault(e){return this.registry.get(e)}getAllVaults(){return Array.from(this.registry.values())}async removeVault(e){if(this.registry.has(e)){const t=this.registry.get(e);return this.registry.delete(e),await this.save(),this.logger.info(`[VAULT-REGISTRY] Removed vault: ${t==null?void 0:t.name}.`),!0}return!1}async updateVaultStatus(e,t){const i=this.registry.get(e);return i?(i.status={...i.status,...t},await this.save(),!0):!1}queryVaults(e){let t=Array.from(this.registry.values());return e.vault_id&&(t=t.filter(i=>i.id===e.vault_id)),e.status!==void 0&&(t=t.filter(i=>i.status.connected===e.status)),t}getVaultStats(){const e=this.getAllVaults();return{total_connected:e.filter(t=>t.status.connected).length,total_syncing:e.filter(t=>t.status.syncing).length,total_errors:e.filter(t=>t.status.error_message).length,last_sync:e.reduce((t,i)=>i.status.last_sync>t?i.status.last_sync:t,"")}}isRegistryLoaded(){return this.isLoaded}getActiveVaultId(){return this.isLoaded||this.loadRegistrySynchronously(),this.activeVaultId||this.ensureActiveVault(),this.activeVaultId}loadRegistrySynchronously(){try{const e=require("fs");if(e.existsSync(this.registryPath)){const t=e.readFileSync(this.registryPath,"utf8"),i=JSON.parse(t);if(this.registry.clear(),typeof i=="object"&&!Array.isArray(i))for(const[s,r]of Object.entries(i))this.registry.set(s,r);this.isLoaded=!0,this.logger.debug(`[VAULT-REGISTRY] Loaded registry synchronously with ${this.registry.size} vaults`)}}catch(e){this.logger.warn("[VAULT-REGISTRY] Failed to load registry synchronously",e)}}setActiveVaultId(e){if(e&&!this.registry.has(e))return this.logger.warn(`[VAULT-REGISTRY] Cannot set active vault - vault not found: ${e}`),!1;const t=this.activeVaultId;return this.activeVaultId=e,t!==e&&this.emit("active-vault-change",e),!0}getActiveVault(){return this.activeVaultId&&this.getVault(this.activeVaultId)||null}ensureActiveVault(){if(!this.activeVaultId){const e=this.app.vault.getName(),t=this.app.vault.adapter.basePath||"";let i=null;for(const[s,r]of this.registry.entries())if(r.name===e||this.pathsMatch(r.path,t)){i=s;break}this.activeVaultId=i||e,this.logger.info(`[VAULT-REGISTRY] Auto-set active vault to: ${this.activeVaultId}${i?" (found in registry)":" (fallback to name)"}`)}}pathsMatch(e,t){const i=s=>s.replace(/\\\\/g,"/").toLowerCase().replace(/\/$/,"");return i(e)===i(t)}async autoRegisterCurrentVault(e=!1,t){var l,d;const i=this.app.vault.getName(),s=this.app.vault.adapter.basePath||"",r=this.registry.get(i);if(r&&r.path===s){this.setActiveVaultId(i);const p=this.createVaultDatabaseConfig();return JSON.stringify(r.configuration.database)!==JSON.stringify(p)?(this.logger.info(`[VAULT-REGISTRY] Updating database configuration for existing vault: ${i}`),r.configuration.database=p,await this.save(),this.logger.debug("[VAULT-REGISTRY] Database configuration updated for existing vault.",{vaultName:i,newConfig:p})):this.logger.debug("[VAULT-REGISTRY] Existing vault database configuration is already up-to-date.",{vaultName:i}),t&&t.isConnected()&&(t.sendVaultRegistration({name:r.name,path:r.path,id:r.name})?await this.updateVaultConnection(i,!0,(d=(l=r.connection)==null?void 0:l.auth)==null?void 0:d.token):this.logger.warn("[VAULT-REGISTRY] Failed to send existing vault registration to MCP server.")),r}const o=new Date().toISOString(),a={name:i,description:`Auto-registered vault: ${i}`,path:s,type:"obsidian",connection:{host:"localhost",port:this.plugin.settings.wsPort,auth:{token:""}},configuration:{database:this.createVaultDatabaseConfig(),sync:{enabled:!0,interval:300,last_sync:o}},status:{connected:!1,syncing:!1,last_sync:o}};try{const p=await this.addVault(a);return this.setActiveVaultId(i),this.logger.info(`[VAULT-REGISTRY] Created local vault registry entry for: ${i}.`),t&&t.isConnected()&&(t.sendVaultRegistration({name:p.name,path:p.path,id:i})?await this.updateVaultConnection(i,!0,a.connection.auth.token):this.logger.warn("[VAULT-REGISTRY] Failed to send vault registration to MCP server.")),p}catch(p){return this.logger.error(`[VAULT-REGISTRY] Failed to auto-register current vault: ${i}`,p),null}}onActiveVaultChange(e){this.on("active-vault-change",e)}onRegistryUpdate(e){this.on("registry-update",e)}async updateVaultConnection(e,t,i){const s=this.registry.get(e);return s?(s.status.connected=t,s.status.last_sync=new Date().toISOString(),i&&(s.connection.auth.token=i),t||(s.status.syncing=!1,s.status.error_message=void 0),await this.save(),this.logger.info(`[VAULT-REGISTRY] Updated vault connection status for ${s.name}: Connected: ${t}.`),!0):!1}async updateVaultEmbeddingModel(e,t,i,s){const r=this.registry.get(e);if(!r)return this.logger.warn(`[VAULT-REGISTRY] Cannot update embedding model - vault not found: ${e}`),!1;r.configuration.embedding||(r.configuration.embedding={}),r.configuration.embedding.model=t,i!==void 0&&(r.configuration.embedding.dimensions=i),s!==void 0&&(r.configuration.embedding.provider=s),await this.save();const o=s?` (${s})`:"",a=i?` (${i}d)`:"";return this.logger.info(`[VAULT-REGISTRY] Updated embedding model for vault ${e}: ${t}${o}${a}`),!0}getVaultEmbeddingModel(e){const t=this.registry.get(e);return t?t.configuration.embedding||{}:null}hasEmbeddingModelChanged(e,t,i,s){const r=this.getVaultEmbeddingModel(e);return!r||!r.model?!1:r.model!==t||s!==void 0&&r.provider!==void 0&&r.provider!==s||i!==void 0&&r.dimensions!==void 0&&r.dimensions!==i}validateEmbeddingModelConfig(e){const t=this.getVaultEmbeddingModel(e);return!t||!t.model?{isValid:!1}:{isValid:!0,config:t}}getEmbeddingModelMismatchDetails(e,t,i,s){const r=this.getVaultEmbeddingModel(e);return{hasChanged:this.hasEmbeddingModelChanged(e,t,i,s),storedProvider:r==null?void 0:r.provider,storedModel:r==null?void 0:r.model,storedDimensions:r==null?void 0:r.dimensions,currentProvider:s,currentModel:t,currentDimensions:i}}createVaultDatabaseConfig(){var i,s;const e=this.plugin.settings,t=e.databaseType||"neo4j";if(t==="neo4j"&&((i=e.databaseConfigs)!=null&&i.neo4j)){const r=e.databaseConfigs.neo4j;if(r.uri){const l=r.uri.match(/bolt:\/\/([^:]+):(\d+)/);if(l){const d=parseInt(l[2]);return{type:"neo4j",host:l[1]||"localhost",port:d||7687,database:r.database||"neo4j",username:r.username,password:r.password}}}const o="localhost",a=7687;return this.logger.warn("[VAULT-REGISTRY] URI match failed or URI not provided for Neo4j. Using defaults/fallback values."),{type:"neo4j",host:o,port:a,database:r.database||"neo4j",username:r.username,password:r.password}}else if(t==="falkordb"&&((s=e.databaseConfigs)!=null&&s.falkordb)){const r=e.databaseConfigs.falkordb;return this.logger.debug("[VAULT-REGISTRY] FalkorDB config found in settings.databaseConfigs:",{host:r.host,port:r.port,database:r.database}),{type:"neo4j",host:r.host||"localhost",port:r.port||6379,database:r.database||"falkor",username:r.username,password:r.password}}return this.logger.warn(`[VAULT-REGISTRY] No database configuration found for type: ${t}. Using final defaults.`),{type:"neo4j",host:"localhost",port:7687,database:"neo4j"}}}const pl=["id","uuid","name","type","subtype","summary","description","created_at","updated_at","fact_uuid","fact_name","fact_type","fact_subtype","fact_summary","fact_description","fact_created_at","fact_updated_at","edge_uuid","edge_name","edge_type","edge_subtype","edge_summary","edge_description","edge_created_at","edge_updated_at","source_uuid","target_uuid","source_name","target_name","source_type","target_type","valid_at","invalid_at","metadata"],bn={Person:"Individual human being with personal and professional attributes, relationships, and activities within the knowledge domain.",Organization:"Business entity, company, institution, or group with structured operations and relationships within the professional ecosystem.",Technology:"Software, programming language, framework, tool, or technical system used in development and business operations.",Product:"Software product, service, platform, or offering created by organizations for users and customers.",Project:"Organized effort with defined goals, timeline, and deliverables undertaken by individuals or organizations.",WebPage:"Individual web page or URL with specific content, purpose, and relationships within the broader web ecosystem.",Website:"Complete web domain or site containing multiple pages and serving as a unified web presence.",Note:"Personal knowledge note, documentation, or idea captured for reference and knowledge management purposes.",Article:"Published content piece such as blog post, tutorial, or informational article with specific topic focus.",Music:"Musical work, song, album, or audio content with artistic and cultural significance, including metadata about creation and performance.",Film:"Movie, video content, or visual media production with narrative or documentary purpose, including cast, crew, and production details.",Event:"Organized gathering, conference, meeting, or occasion with specific time, location, and participants for knowledge sharing or collaboration.",Place:"Physical location, venue, or geographic entity with address and spatial context relevant to activities and relationships.",Quote:"Memorable statement, saying, or excerpt attributed to a specific source with context and meaning for reference and inspiration.",Expression:"Idiom, concept, principle, or linguistic construct that conveys meaning within cultural or professional contexts.",Personal:"Private individual content including goals, identity information, preferences, and personal development material for self-organization.",Journal:"Time-based personal entry or log recording thoughts, experiences, and reflections for tracking personal growth and memories.",Book:"Published literary work, reference material, or educational text with structured content for knowledge sharing and learning.",ProjectDoc:"Technical documentation, specifications, or project-related materials that support project development and collaboration."},vn={duration:'Length of the art work in minutes and seconds, typically formatted as "MM:SS" (e.g., "3:42", "1:15:30")',record_label:"Music label or company responsible for producing, distributing, or promoting the musical work",artist:"Musical performer, band, or creator responsible for the artistic creation and performance of the musical work",album:"Collection or record release that contains this musical work as part of a larger artistic statement",track_number:"Position of this song within an album or collection for organization and reference",composer:"Person who created the musical composition, melody, and structure of the work",lyricist:"Person who wrote the words, lyrics, or text content of the musical work",director:"Primary director or filmmaker credited as the main creative leader of the film or video content",cast:"List of actors and performers who appeared in the film or video content",studio:"Production studio or company responsible for creating and distributing the film",date_start:"Starting date of the event or scheduled activity in YYYY-MM-DD format",date_end:"Ending date of the event or scheduled activity in YYYY-MM-DD format",location:'Physical venue, address, or virtual platform where the event takes place (e.g., "Madison Square Garden", "Zoom", "123 Main St")',organizer:"Person, organization, or entity responsible for planning and hosting the event",event_type:`Classification of the event's purpose and format (e.g., "conference", "meeting", "celebration", "workshop", "webinar")`,coordinates:'Geographic coordinates in latitude, longitude format for precise location identification (e.g., "37.7749, -122.4194")',city:"Municipality, city, or urban area that contains or represents the place for regional identification",postal_code:"ZIP code, postal code, or area code for mail delivery and regional classification",place_type:`Classification of the place's purpose and characteristics (e.g., "venue", "office", "landmark", "residential", "commercial")`,region:"Geographic region, state, or province where the place is located for broader geographic context",title:"Primary name, headline, or official title that identifies and represents the entity",c_name:"Complete legal name, official title, or canonical name as formally recognized",aliases:"Alternative names, nicknames, abbreviations, or other identifiers by which this entity is also known",url:"Complete web address or URL where this entity can be accessed or referenced online",same_as:"URIs or URLs that identify this same entity on other platforms, databases, or knowledge systems for linking",tags:"Keywords, labels, or categorical markers used for organizing, filtering, and discovering related content",author:"Person or organization who created, wrote, or is primarily responsible for this content",organization:"Company, institution, or group associated with or responsible for this entity",about:"Subject matter, topic, or theme that this content covers or discusses in detail",category:"Primary classification, type, or domain that categorizes this entity's purpose and characteristics",status:'Current state, phase, or condition of the entity in its lifecycle (e.g., "active", "completed", "planning")',date_published:"Date when this article or content was officially published or released in YYYY-MM-DD format",identity_type:`Classification of the person's identity status (e.g., "natural_person", "public_figure", "pseudonym", "character")`,given_name:"First name or given name as commonly used for personal identification and introductions",family_name:"Last name, surname, or family name used for formal identification and heritage",date_of_birth:"Date when the person was born, formatted as YYYY-MM-DD for biographical reference",date_of_death:"Date when the person passed away, formatted as YYYY-MM-DD if applicable for biographical completion",address:"Physical address, location, or primary residence where the person is based",email:"Primary email address for professional or personal communication and contact",works_for:"Organization, company, or institution where the person is currently employed",job_title:"Professional role, position, or title that describes the person's current responsibilities",needs:"Resources, skills, connections, or support that the person requires to achieve their goals",offers:"Skills, services, knowledge, or value that the person can provide to others or contribute to projects",links:"URLs or web addresses associated with the person's online presence or professional profiles",relationship_type:"Nature of the relationship or connection this person has to other entities or people",date_founded:"Date when the organization was officially established, incorporated, or founded in YYYY-MM-DD format",org_type:'Legal structure or classification of the organization (e.g., "LLC", "Corporation", "Non-profit", "Partnership")',project_type:`Classification of the project's nature, scope, and methodology (e.g., "software", "research", "startup", "community")`,collaborators:"People, teams, or organizations working together on this project or contributing to its development",public_repo:"URL or reference to the public code repository where the project's source code is hosted and accessible",offering_type:'Business model and delivery method of the product (e.g., "SaaS", "API", "physical_product", "service", "platform")',article_type:'Genre or format classification of the article (e.g., "blog_post", "tutorial", "analysis", "news", "review")',note_type:`Classification of the note's purpose and content type (e.g., "idea", "meeting_notes", "reference", "analysis")`,subtitle:"Secondary title or explanatory subtitle that provides additional context about the book's content",categories:"Subject categories, genres, or classification tags that describe the book's content and target audience",authors:"List of people who wrote, edited, or contributed to the creation of the book",published_on:"Date when the book was officially published or released in YYYY-MM-DD format",link:"URL or web address where the book can be accessed, purchased, or referenced online",project:"Name or identifier of the project that this documentation relates to or supports",team:"Group of people or organizational unit responsible for creating and maintaining this documentation",genre:"Category, style, or classification that describes the artistic approach, subject matter, or target audience",country:"Nation or country of origin where the entity was created, produced, or primarily operates"};class Lr{constructor(e,t){this.app=e,this.plugin=t}get logger(){try{return this.plugin&&this.plugin.logger?this.plugin.logger:void 0}catch(e){return}}isProtectedAttribute(e){return pl.includes(e.toLowerCase())}convertToSnakeCase(e){return e.replace(/([A-Z])/g,"_$1").toLowerCase().replace(/^_/,"")}validateEntityTypeName(e){const t=[];let i=e;/^[A-Z][a-zA-Z0-9]*$/.test(e)||(t.push("Entity type should be PascalCase (e.g., Person, TechCompany)"),i=e.charAt(0).toUpperCase()+e.slice(1).replace(/[^a-zA-Z0-9]/g,""));const s=t.length===0?"excellent":"needs_improvement";return{isValid:t.length===0,issues:t,suggestedName:i,complianceLevel:s}}analyzeProperty(e,t){const i=this.convertToSnakeCase(e),s=this.isProtectedAttribute(e),r=[];s&&r.push("Uses protected attribute name reserved by Graphiti"),e!==i&&!s&&r.push("Should use snake_case naming convention");const o=s?"protected":r.length>0?"warning":"valid";return{originalName:e,suggestedName:s?`${i}_custom`:i,isProtected:s,namingIssues:r,complianceStatus:o}}applyPropertyMapping(e,t){return this.plugin&&this.plugin.getPropertyMapping(e,t)||t}async savePropertyMapping(e,t,i){this.plugin&&await this.plugin.savePropertyMapping(e,t,i)}async removePropertyMapping(e,t){this.plugin&&await this.plugin.removePropertyMapping(e,t)}async savePropertySelection(e,t,i){this.plugin&&await this.plugin.savePropertySelection(e,t,i)}getPropertySelection(e,t){if(this.plugin)return this.plugin.getPropertySelection(e,t)}getDefaultEntityDescription(e){return bn[e]||null}hasDefaultEntityDescription(e){return e in bn}getAvailableDefaultEntityTypes(){return Object.keys(bn)}getDefaultPropertyDescription(e){return vn[e]||null}hasDefaultPropertyDescription(e){return e in vn}get defaultPropertyDescriptions(){return vn}getAvailableDefaultProperties(){return Object.keys(vn)}getAvailableDefaultEdgeTypes(){return{WorksFor:"Person employed by Organization",Uses:"Person/Organization uses Technology/Product",Creates:"Person/Organization creates Technology/Product/Project",Knows:"Person knows Person (personal or professional relationship)",MemberOf:"Person/Organization is member of Organization",PartnersWith:"Person/Organization partners with Person/Organization",DependsOn:"Technology/Product depends on Technology",IntegratedWith:"Product/Technology has built-in integration with Product/Technology",About:"WebPage/Note/Article about Entity",IsPartOf:"WebPage part of Website/Domain",Tags:"Entity is tagged with another Entity",PerformedBy:"Musical work performed by Artist/Person",InfluencedBy:"Entity influenced or inspired by another Entity",CollaboratesWith:"Person/Organization actively collaborates with Person/Organization",OrganizedBy:"Event organized and managed by Person/Organization",AttendedBy:"Event attended or participated in by Person",PartOfSeries:"Entity that belongs to or continues a series/sequence",LeadBy:"Project/Organization/Initiative led or directed by Person",SponsoredBy:"Entity sponsored, funded, or supported by Organization",CompetesWith:"Organization/Product in competition or rivalry with Organization/Product"}}getDefaultEdgeTypeProperties(){return{WorksFor:{job_title:{description:"Current professional role, position, or title that describes responsibilities and level within an organization",fieldType:"str",required:!1},employment_type:{description:"Employment classification such as full-time, part-time, contractor, consultant, advisor, or intern",fieldType:"str",required:!1},start_date:{description:"Date when the employment relationship began in YYYY-MM-DD format",fieldType:"datetime",required:!1}},Uses:{sentiment:{description:"User's attitude or feeling toward the technology (positive, negative, neutral, love, hate)",fieldType:"str",required:!1},proficiency:{description:"User's skill level or expertise with the technology (beginner, intermediate, advanced, expert)",fieldType:"str",required:!1},usage_context:{description:"Context or environment where the technology is used (development, production, personal, testing)",fieldType:"str",required:!1},status:{description:"Current usage status (active, inactive, trial, paid_account, evaluating)",fieldType:"str",required:!1},start_date:{description:"Date when usage began in YYYY-MM-DD format",fieldType:"datetime",required:!1}},Creates:{role:{description:"Creator's role in the creation process (founder, lead_developer, contributor, designer, architect)",fieldType:"str",required:!1},contribution_type:{description:"Type of contribution made (code, design, strategy, funding, documentation, testing)",fieldType:"str",required:!1}},Knows:{relationship_type:{description:"Nature of the relationship (colleague, mentor, friend, collaborator, acquaintance)",fieldType:"str",required:!1},context:{description:"Context or setting where they know each other (work, school, industry, personal)",fieldType:"str",required:!1}},MemberOf:{role:{description:"Member's role or position within the organization (employee, volunteer, board_member, customer, partner)",fieldType:"str",required:!1},start_date:{description:"Date when membership began in YYYY-MM-DD format",fieldType:"datetime",required:!1},status:{description:"Current membership status (active, inactive, suspended, trial, paid)",fieldType:"str",required:!1}},PartnersWith:{partnership_type:{description:"Type of partnership (strategic, supplier, investment, consulting, advisory, joint_venture)",fieldType:"str",required:!1},start_date:{description:"Date when partnership began in YYYY-MM-DD format",fieldType:"datetime",required:!1},status:{description:"Current partnership status (active, inactive, completed, negotiating)",fieldType:"str",required:!1}},DependsOn:{dependency_type:{description:"Type of dependency (runtime, build_time, development, infrastructure, optional)",fieldType:"str",required:!1},version:{description:"Required version or version range for the dependency",fieldType:"str",required:!1}},IntegratedWith:{integration_type:{description:"Type of integration (native, plugin, API, webhook, SDK, embedded)",fieldType:"str",required:!1},bidirectional:{description:"Whether the integration works in both directions between the technologies",fieldType:"bool",required:!1}},About:{coverage_type:{description:"Depth of coverage (comprehensive, mention, analysis, tutorial, review)",fieldType:"str",required:!1},authority:{description:"Source authority level (official, community, expert_analysis, user_generated)",fieldType:"str",required:!1}},IsPartOf:{relationship_type:{description:"Type of relationship (page, article, documentation, section, subdomain)",fieldType:"str",required:!1}},Tags:{},PerformedBy:{performance_type:{description:"Type of performance relationship (original_artist, cover_version, live_performance, collaboration, featured_artist)",fieldType:"str",required:!1},role:{description:"Specific role in the performance (lead_vocals, instrumentalist, producer, featured, backing_vocals)",fieldType:"str",required:!1},performance_date:{description:"Date when this performance or recording took place in YYYY-MM-DD format",fieldType:"datetime",required:!1}},InfluencedBy:{influence_type:{description:"Nature of the influence relationship (artistic, intellectual, methodological, philosophical, technical)",fieldType:"str",required:!1},description:{description:"Specific ways this entity was influenced, including concepts, techniques, or approaches adopted",fieldType:"str",required:!1},strength:{description:"Degree of influence impact (minor, moderate, major, foundational, transformative)",fieldType:"str",required:!1}},CollaboratesWith:{collaboration_type:{description:"Nature of the collaborative relationship (project_partner, co_author, joint_venture, research_partner, creative_partner)",fieldType:"str",required:!1},collaboration_status:{description:"Current state of the collaboration (active, completed, planned, on_hold, recurring)",fieldType:"str",required:!1},start_date:{description:"Date when the collaboration began in YYYY-MM-DD format",fieldType:"datetime",required:!1}},OrganizedBy:{organizational_role:{description:"Specific role in organizing the event (lead_organizer, co_organizer, event_manager, logistics_coordinator, program_director)",fieldType:"str",required:!1},responsibilities:{description:"Specific duties and areas of responsibility in event organization (logistics, programming, marketing, sponsorships)",fieldType:"str",required:!1}},AttendedBy:{attendance_type:{description:"Nature of attendance or participation (presenter, attendee, keynote_speaker, panelist, sponsor, volunteer)",fieldType:"str",required:!1},participation_level:{description:"Degree of involvement in the event (active_participant, passive_attendee, featured_speaker, organizer)",fieldType:"str",required:!1}},PartOfSeries:{sequence_position:{description:"Position or order within the series (episode_1, part_2, volume_3, season_1_episode_5)",fieldType:"str",required:!1},series_relationship:{description:"Type of relationship to the series (sequel, prequel, spin_off, continuation, part_of_collection)",fieldType:"str",required:!1}},LeadBy:{leadership_role:{description:"Specific leadership position and authority (ceo, project_manager, team_lead, creative_director, principal_investigator)",fieldType:"str",required:!1},leadership_start_date:{description:"Date when leadership role began in YYYY-MM-DD format",fieldType:"datetime",required:!1},leadership_scope:{description:"Areas of responsibility and decision-making authority (strategic, operational, creative, technical, administrative)",fieldType:"str",required:!1}},SponsoredBy:{sponsorship_type:{description:"Nature of sponsorship relationship (financial, in_kind, promotional, strategic, title_sponsor, presenting_sponsor)",fieldType:"str",required:!1},sponsorship_level:{description:"Degree or tier of sponsorship support (platinum, gold, silver, bronze, major, minor)",fieldType:"str",required:!1},support_details:{description:"Specific ways sponsor provides support (funding, resources, expertise, marketing, venue)",fieldType:"str",required:!1}},CompetesWith:{competition_type:{description:"Nature of competitive relationship (direct_competitor, market_rival, alternative_solution, industry_peer)",fieldType:"str",required:!1},market_context:{description:"Market or domain where competition occurs (same_market, adjacent_market, substitute_product, feature_competition)",fieldType:"str",required:!1},competitive_advantage:{description:"Key differentiating factors in the competitive relationship (price, features, market_share, brand_recognition)",fieldType:"str",required:!1}}}}getUnusedDefaultEdgeTypes(e){const t=this.getAvailableDefaultEdgeTypes(),i={};return Object.entries(t).forEach(([s,r])=>{e[s]||(i[s]=r)}),i}getSuggestedDefaultMappings(e,t){const i=[],s=new Set(t.map(o=>`${o.sourceEntity}->${o.targetEntity}`));return e.includes("Person")&&(e.includes("Organization")&&!s.has("Person->Organization")&&i.push({sourceEntity:"Person",targetEntity:"Organization",allowedEdges:["WorksFor","MemberOf","PartnersWith"],description:"People working for or being members of organizations"}),e.includes("Technology")&&!s.has("Person->Technology")&&i.push({sourceEntity:"Person",targetEntity:"Technology",allowedEdges:["Creates","Uses"],description:"People creating or using technologies"}),e.includes("Product")&&!s.has("Person->Product")&&i.push({sourceEntity:"Person",targetEntity:"Product",allowedEdges:["Creates","Uses"],description:"People creating or using products"}),e.includes("Project")&&!s.has("Person->Project")&&i.push({sourceEntity:"Person",targetEntity:"Project",allowedEdges:["Creates","MemberOf"],description:"People creating or being part of projects"}),s.has("Person->Person")||i.push({sourceEntity:"Person",targetEntity:"Person",allowedEdges:["Knows"],description:"Professional and personal relationships between people"})),e.includes("Organization")&&(e.includes("Technology")&&!s.has("Organization->Technology")&&i.push({sourceEntity:"Organization",targetEntity:"Technology",allowedEdges:["Creates","Uses","DependsOn"],description:"Organizations creating, using, or depending on technologies"}),e.includes("Product")&&!s.has("Organization->Product")&&i.push({sourceEntity:"Organization",targetEntity:"Product",allowedEdges:["Creates","Uses","DependsOn"],description:"Organizations creating, using, or depending on products"}),s.has("Organization->Organization")||i.push({sourceEntity:"Organization",targetEntity:"Organization",allowedEdges:["PartnersWith","MemberOf"],description:"Partnerships and memberships between organizations"})),e.includes("Technology")&&(s.has("Technology->Technology")||i.push({sourceEntity:"Technology",targetEntity:"Technology",allowedEdges:["DependsOn","IntegratedWith"],description:"Dependencies and integrations between technologies"}),e.includes("Product")&&!s.has("Technology->Product")&&i.push({sourceEntity:"Technology",targetEntity:"Product",allowedEdges:["IntegratedWith"],description:"Technologies integrated with products"})),["WebPage","Note","Article"].filter(o=>e.includes(o)).forEach(o=>{s.has(`${o}->Entity`)||i.push({sourceEntity:o,targetEntity:"Entity",allowedEdges:["About"],description:`${o} content about other entities`})}),e.includes("Person")&&e.includes("Music")&&!s.has("Person->Music")&&i.push({sourceEntity:"Person",targetEntity:"Music",allowedEdges:["PerformedBy","InfluencedBy","Creates"],description:"People performing, creating, or influenced by musical works"}),e.includes("Person")&&e.includes("Film")&&!s.has("Person->Film")&&i.push({sourceEntity:"Person",targetEntity:"Film",allowedEdges:["PerformedBy","InfluencedBy","Creates"],description:"People acting in, creating, or influenced by films"}),e.includes("Person")&&e.includes("Event")&&!s.has("Person->Event")&&i.push({sourceEntity:"Person",targetEntity:"Event",allowedEdges:["OrganizedBy","AttendedBy","LeadBy"],description:"People organizing, attending, or leading events"}),e.includes("Person")&&e.includes("Place")&&!s.has("Person->Place")&&i.push({sourceEntity:"Person",targetEntity:"Place",allowedEdges:["Tags","About"],description:"People associated with or documenting places"}),e.includes("Music")&&!s.has("Music->Music")&&i.push({sourceEntity:"Music",targetEntity:"Music",allowedEdges:["InfluencedBy","PartOfSeries"],description:"Musical works influenced by or part of series with other music"}),e.includes("Film")&&!s.has("Film->Film")&&i.push({sourceEntity:"Film",targetEntity:"Film",allowedEdges:["InfluencedBy","PartOfSeries","CompetesWith"],description:"Films influenced by, part of series, or competing with other films"}),e.includes("Organization")&&e.includes("Event")&&!s.has("Organization->Event")&&i.push({sourceEntity:"Organization",targetEntity:"Event",allowedEdges:["OrganizedBy","SponsoredBy"],description:"Organizations organizing or sponsoring events"}),e.includes("Organization")&&e.includes("Music")&&!s.has("Organization->Music")&&i.push({sourceEntity:"Organization",targetEntity:"Music",allowedEdges:["SponsoredBy","Creates"],description:"Organizations sponsoring or creating musical works (labels, studios)"}),e.includes("Organization")&&e.includes("Film")&&!s.has("Organization->Film")&&i.push({sourceEntity:"Organization",targetEntity:"Film",allowedEdges:["SponsoredBy","Creates"],description:"Organizations sponsoring or creating films (studios, distributors)"}),e.includes("Quote")&&e.includes("Person")&&!s.has("Quote->Person")&&i.push({sourceEntity:"Quote",targetEntity:"Person",allowedEdges:["About","Tags"],description:"Quotes attributed to or about specific people"}),e.includes("Expression")&&!s.has("Expression->Expression")&&i.push({sourceEntity:"Expression",targetEntity:"Expression",allowedEdges:["InfluencedBy","Tags"],description:"Expressions influenced by or related to other expressions"}),e.includes("Personal")&&e.includes("Person")&&!s.has("Personal->Person")&&i.push({sourceEntity:"Personal",targetEntity:"Person",allowedEdges:["About","Tags"],description:"Personal content about or relating to specific people"}),e.includes("Journal")&&e.includes("Person")&&!s.has("Journal->Person")&&i.push({sourceEntity:"Journal",targetEntity:"Person",allowedEdges:["About","Tags"],description:"Journal entries about or mentioning specific people"}),e.includes("Project")&&e.includes("Event")&&!s.has("Project->Event")&&i.push({sourceEntity:"Project",targetEntity:"Event",allowedEdges:["OrganizedBy","PartOfSeries"],description:"Projects organizing events or as part of event series"}),e.includes("Technology")&&e.includes("Music")&&!s.has("Technology->Music")&&i.push({sourceEntity:"Technology",targetEntity:"Music",allowedEdges:["Creates","Uses"],description:"Technologies used to create or distribute music"}),e.includes("Technology")&&e.includes("Film")&&!s.has("Technology->Film")&&i.push({sourceEntity:"Technology",targetEntity:"Film",allowedEdges:["Creates","Uses"],description:"Technologies used in film production or distribution"}),i.length===0&&!s.has("Entity->Entity")&&i.push({sourceEntity:"Entity",targetEntity:"Entity",allowedEdges:["Tags"],description:"Generic tagging relationships between any entities"}),i}async discoverAllSchemas(){const e=new Map,t=this.app.vault.getMarkdownFiles();for(const i of t){const s=this.app.metadataCache.getFileCache(i),r=s==null?void 0:s.frontmatter;if(!(r!=null&&r.type))continue;const o=r.type;e.has(o)||e.set(o,{properties:new Map,files:[]});const a=e.get(o);a.files.push(i.path),Object.entries(r).forEach(([l,d])=>{l!=="type"&&(a.properties.has(l)||a.properties.set(l,[]),a.properties.get(l).push(d))})}return Array.from(e.entries()).map(([i,s])=>({typeName:i,fileCount:s.files.length,files:s.files,properties:Array.from(s.properties.entries()).map(([r,o])=>{const a=this.analyzeProperty(r,o),l=this.applyPropertyMapping(i,r),d=l!==r,p=d?l:r,g=d?[]:a.namingIssues,m=d?"valid":a.complianceStatus,h=this.getPropertySelection(i,r),b=!a.isProtected,c=h!==void 0?h:b;return{name:p,inferredType:this.inferType(o),isOptional:o.some(v=>v==null),description:this.generateDescription(r,i),examples:Array.from(new Set(o)).slice(0,3),enabled:c,isProtected:a.isProtected,namingIssues:g,suggestedName:a.suggestedName,complianceStatus:m}})}))}inferType(e){const t=e.filter(s=>s!=null);if(t.length===0)return"string";const i=t[0];return Array.isArray(i)?"array":typeof i=="boolean"?"boolean":typeof i=="number"?"number":this.isDateLike(i)?"date":typeof i=="object"?"object":"string"}isDateLike(e){return typeof e!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(e)||!isNaN(Date.parse(e))}generateDescription(e,t){const i={c_name:"Complete legal name or official title as recognized by authorities or in formal documentation",given_name:"Given name or first name as commonly used in introductions and personal identification",family_name:"Family name, surname, or last name used for formal identification and family lineage",aliases:"Alternative names, nicknames, professional names, or pseudonyms by which the entity is also known",url:"Complete web address or URL where the resource can be accessed on the internet",same_as:"URIs or URLs that identify the same entity on other platforms, databases, or knowledge systems for entity linking",permalink:"Permanent link or stable identifier that remains constant over time",created:"Timestamp when the note or entity record was first created in the Obsidian vault for tracking and organizational purposes",created_date:"Date when the content was originally created or when the ideas were first captured in YYYY-MM-DD format",published_date:"Date when the content was officially published or made publicly available in YYYY-MM-DD format",birth_date:"Date when the person was born in YYYY-MM-DD format for biographical and age calculation purposes",founding_date:"Date when the organization was officially established, incorporated, or founded in YYYY-MM-DD format",title:"Primary title, headline, or name that identifies and represents the entity",description:"Detailed explanation or summary that describes the purpose, content, or characteristics of the entity",abstract:"Brief summary or overview that captures the essential points and main ideas",summary:"Concise overview that highlights the key information and important details",type:"Entity type classification (WebPage, Person, Organization, Product, Technology, Project, Article, Film, Music, Book, Event, Note, etc.)",category:"Primary classification or market segment that describes the entity's purpose and target domain",tags:"Topic keywords, classification labels, or categorical tags used for organizing and filtering content within the knowledge base",status:"Current state or phase in the entity's lifecycle (active, completed, planning, etc.)",author:'Person or organization who created, wrote, or is credited as the primary creator of the content (e.g., "Jane Smith", "MIT Research Lab")',job_title:'Current professional role, position, or title that describes responsibilities and level within an organization (e.g., "CEO", "Senior Developer", "Research Scientist")',works_for:'Organization where person is employed (e.g., "Apple Inc.", "Google", "Stanford University")',org_type:'Legal or Lawful structure and registration type of the organization (e.g., "LLC", "Inc", "Partnership", "501c3", "Government Agency")',email:"Primary email address used for professional or personal communication and contact purposes",address:"Physical address, city, state, or geographic location where the entity is primarily based or located",needs:"Specific resources, skills, connections, or support that the entity requires to achieve goals or be successful",offers:"Skills, services, knowledge, resources, or value that the entity can provide to others or contribute to projects",project_type:"Classification of the project's primary purpose and methodology (research, development, initiative, startup, etc.)",article_type:"Genre or format classification of the published content (essay, blog_post, analysis, tutorial, whitepaper, etc.)",note_type:"Classification of the note's purpose and content structure (idea, analysis, reflection, meeting_notes, etc.)",offering_type:"Primary business model and delivery method of the offering (product, service, platform, SaaS, API, etc.)",identity_type:"Classification of person's legal and social identity status (natural_person, national_identity, pseudonym)",thumbnail:"Thumbnail or preview image URL that provides a visual representation of the content",primary_image:"Primary image URL that serves as the main visual element for the entity"};if(i[e])return i[e];if(e.includes("date")||e.includes("time"))return`Date or timestamp for ${t} entities (e.g., "2024-01-15", "2023-12-31T10:30:00Z")`;if(e.includes("url")||e.includes("link"))return`Web address or URL associated with ${t} entities (e.g., "https://example.com", "https://docs.company.com")`;if(e.includes("name")||e.includes("title"))return`Name or title that identifies ${t} entities (e.g., "John Smith", "Project Alpha", "Company Inc.")`;if(e.includes("type")||e.includes("category"))return`Classification that categorizes ${t} entities (e.g., "software", "hardware", "service")`;const s=e.replace(/_/g," ");return`${s.charAt(0).toUpperCase()+s.slice(1)} associated with ${t} entities`}async generatePydanticModels(e){const t=`"""
Pydantic models for Obsidian-Graphiti knowledge graph entities.

This module contains automatically generated Pydantic models based on schema discovery
from Obsidian vault notes. These models are designed to work with the Graphiti
knowledge graph framework for entity extraction and relationship mapping.

Generated models inherit from BaseEntity which provides core properties required
by Graphiti for knowledge graph processing including type classification, tags,
and creation timestamps.

Usage:
    from graphiti_models import Person, Organization, Project

    # Create entity instances
    person = Person(
        c_name="John Doe",
        job_title="Software Engineer",
        email="john@example.com"
    )

    # All entities have core BaseEntity properties
    person.type = "Person"
    person.tags = ["professional", "contact"]
    person.created = datetime.now()

Note: This file is automatically generated. Manual edits will be overwritten
during the next schema discovery process.
"""`,i=["from typing import Optional, List, Dict, Any","from pydantic import BaseModel, Field","from datetime import datetime",""],s=`class BaseEntity(BaseModel):
    """
    Base class for all Graphiti knowledge graph entities.

    Provides core properties required by Graphiti for entity processing,
    relationship mapping, and knowledge graph construction.
    """
    tags: Optional[List[str]] = Field(None, description="Topic keywords, classification labels, or categorical tags used for organizing and filtering content within the knowledge base")
`,r=[];for(let d=0;d<e.length;d+=50){e.slice(d,d+50).forEach(g=>r.push(this.generateSingleModel(g)));try{await new Promise(g=>setTimeout(g,0))}catch(g){}}const a=this.generateEdgeTypes(),l=this.generateEdgeTypeMap(e);return[t,"",...i,s,...r,a,l].join(`
`)}generateSingleModel(e){const t=e.typeName.replace(/\s+/g,"").replace(/[^a-zA-Z0-9]/g,""),i=e.properties.filter(d=>d.enabled!==!1&&!d.isProtected).map(d=>{const p=this.getPythonType(d),g=d.suggestedName||d.name,m=this.generateDescription(d.name,e.typeName);return`    ${g}: Optional[${p}] = Field(None, description="${m}")`}),s=e.properties.filter(d=>d.isProtected).map(d=>`    # SKIPPED: '${d.name}' - protected attribute (use '${d.suggestedName}' instead)`),r=[...i,...s],o=r.length>0?r.join(`
`):"    pass",l=bn[t]||`Custom ${t} entity.
    
    Use this entity type for ${t} content that doesn't match
    the standard entity types in your knowledge domain.`;return`class ${t}(BaseEntity):
    """
    ${l}
    """
${o}

`}generateEdgeTypes(){return`
# Edge Types - Relationship Models
class WorksFor(BaseModel):
    """Person employed by Organization"""
    job_title: Optional[str] = Field(None, description="Current professional role, position, or title that describes responsibilities and level within an organization")
    employment_type: Optional[str] = Field(None, description="Employment classification such as full-time, part-time, contractor, consultant, advisor, or intern")
    start_date: Optional[datetime] = Field(None, description="Date when the employment relationship began in YYYY-MM-DD format")

class Uses(BaseModel):
    """Person/Organization uses Technology/Product"""
    sentiment: Optional[str] = Field(None, description="User's attitude or feeling toward the technology (positive, negative, neutral, love, hate)")
    proficiency: Optional[str] = Field(None, description="User's skill level or expertise with the technology (beginner, intermediate, advanced, expert)")
    usage_context: Optional[str] = Field(None, description="Context or environment where the technology is used (development, production, personal, testing)")
    status: Optional[str] = Field(None, description="Current usage status (active, inactive, trial, paid_account, evaluating)")
    start_date: Optional[datetime] = Field(None, description="Date when usage began in YYYY-MM-DD format")

class Creates(BaseModel):
    """Person/Organization creates Technology/Product/Project"""
    role: Optional[str] = Field(None, description="Creator's role in the creation process (founder, lead_developer, contributor, designer, architect)")
    contribution_type: Optional[str] = Field(None, description="Type of contribution made (code, design, strategy, funding, documentation, testing)")

class Knows(BaseModel):
    """Person knows Person (personal or professional relationship)"""
    relationship_type: Optional[str] = Field(None, description="Nature of the relationship (colleague, mentor, friend, collaborator, acquaintance)")
    context: Optional[str] = Field(None, description="Context or setting where they know each other (work, school, industry, personal)")

class MemberOf(BaseModel):
    """Person/Organization is member of Organization"""
    role: Optional[str] = Field(None, description="Member's role or position within the organization (employee, volunteer, board_member, customer, partner)")
    start_date: Optional[datetime] = Field(None, description="Date when membership began in YYYY-MM-DD format")
    status: Optional[str] = Field(None, description="Current membership status (active, inactive, suspended, trial, paid)")

class PartnersWith(BaseModel):
    """Person/Organization partners with Person/Organization"""
    partnership_type: Optional[str] = Field(None, description="Type of partnership (strategic, supplier, investment, consulting, advisory, joint_venture)")
    start_date: Optional[datetime] = Field(None, description="Date when partnership began in YYYY-MM-DD format")
    status: Optional[str] = Field(None, description="Current partnership status (active, inactive, completed, negotiating)")

class DependsOn(BaseModel):
    """Technology/Product depends on Technology"""
    dependency_type: Optional[str] = Field(None, description="Type of dependency (runtime, build_time, development, infrastructure, optional)")
    version: Optional[str] = Field(None, description="Required version or version range for the dependency")

class IntegratedWith(BaseModel):
    """Product/Technology has built-in integration with Product/Technology"""
    integration_type: Optional[str] = Field(None, description="Type of integration (native, plugin, API, webhook, SDK, embedded)")
    bidirectional: Optional[bool] = Field(None, description="Whether the integration works in both directions between the technologies")

class About(BaseModel):
    """WebPage/Note/Article about Entity"""
    coverage_type: Optional[str] = Field(None, description="Depth of coverage (comprehensive, mention, analysis, tutorial, review)")
    authority: Optional[str] = Field(None, description="Source authority level (official, community, expert_analysis, user_generated)")

class IsPartOf(BaseModel):
    """WebPage part of Website/Domain"""
    relationship_type: Optional[str] = Field(None, description="Type of relationship (page, article, documentation, section, subdomain)")

class Tags(BaseModel):
    """Entity is tagged with another Entity"""
    pass

# New edge types
class PerformedBy(BaseModel):
    """Musical work performed by Artist/Person"""
    performance_type: Optional[str] = Field(None, description="Type of performance relationship (original_artist, cover_version, live_performance, collaboration, featured_artist)")
    role: Optional[str] = Field(None, description="Specific role in the performance (lead_vocals, instrumentalist, producer, featured, backing_vocals)")
    performance_date: Optional[datetime] = Field(None, description="Date when this performance or recording took place in YYYY-MM-DD format")

class InfluencedBy(BaseModel):
    """Entity influenced or inspired by another Entity"""
    influence_type: Optional[str] = Field(None, description="Nature of the influence relationship (artistic, intellectual, methodological, philosophical, technical)")
    description: Optional[str] = Field(None, description="Specific ways this entity was influenced, including concepts, techniques, or approaches adopted")
    strength: Optional[str] = Field(None, description="Degree of influence impact (minor, moderate, major, foundational, transformative)")

class CollaboratesWith(BaseModel):
    """Person/Organization actively collaborates with Person/Organization"""
    collaboration_type: Optional[str] = Field(None, description="Nature of the collaborative relationship (project_partner, co_author, joint_venture, research_partner, creative_partner)")
    collaboration_status: Optional[str] = Field(None, description="Current state of the collaboration (active, completed, planned, on_hold, recurring)")
    start_date: Optional[datetime] = Field(None, description="Date when the collaboration began in YYYY-MM-DD format")

class OrganizedBy(BaseModel):
    """Event organized and managed by Person/Organization"""
    organizational_role: Optional[str] = Field(None, description="Specific role in organizing the event (lead_organizer, co_organizer, event_manager, logistics_coordinator, program_director)")
    responsibilities: Optional[str] = Field(None, description="Specific duties and areas of responsibility in event organization (logistics, programming, marketing, sponsorships)")

class AttendedBy(BaseModel):
    """Event attended or participated in by Person"""
    attendance_type: Optional[str] = Field(None, description="Nature of attendance or participation (presenter, attendee, keynote_speaker, panelist, sponsor, volunteer)")
    participation_level: Optional[str] = Field(None, description="Degree of involvement in the event (active_participant, passive_attendee, featured_speaker, organizer)")

class PartOfSeries(BaseModel):
    """Entity that belongs to or continues a series/sequence"""
    sequence_position: Optional[str] = Field(None, description="Position or order within the series (episode_1, part_2, volume_3, season_1_episode_5)")
    series_relationship: Optional[str] = Field(None, description="Type of relationship to the series (sequel, prequel, spin_off, continuation, part_of_collection)")

class LeadBy(BaseModel):
    """Project/Organization/Initiative led or directed by Person"""
    leadership_role: Optional[str] = Field(None, description="Specific leadership position and authority (ceo, project_manager, team_lead, creative_director, principal_investigator)")
    leadership_start_date: Optional[datetime] = Field(None, description="Date when leadership role began in YYYY-MM-DD format")
    leadership_scope: Optional[str] = Field(None, description="Areas of responsibility and decision-making authority (strategic, operational, creative, technical, administrative)")

class SponsoredBy(BaseModel):
    """Entity sponsored, funded, or supported by Organization"""
    sponsorship_type: Optional[str] = Field(None, description="Nature of sponsorship relationship (financial, in_kind, promotional, strategic, title_sponsor, presenting_sponsor)")
    sponsorship_level: Optional[str] = Field(None, description="Degree or tier of sponsorship support (platinum, gold, silver, bronze, major, minor)")
    support_details: Optional[str] = Field(None, description="Specific ways sponsor provides support (funding, resources, expertise, marketing, venue)")

class CompetesWith(BaseModel):
    """Organization/Product in competition or rivalry with Organization/Product"""
    competition_type: Optional[str] = Field(None, description="Nature of competitive relationship (direct_competitor, market_rival, alternative_solution, industry_peer)")
    market_context: Optional[str] = Field(None, description="Market or domain where competition occurs (same_market, adjacent_market, substitute_product, feature_competition)")
    competitive_advantage: Optional[str] = Field(None, description="Key differentiating factors in the competitive relationship (price, features, market_share, brand_recognition)")

`}generateEdgeTypeMap(e){const t=e.map(r=>r.typeName.replace(/\s+/g,"").replace(/[^a-zA-Z0-9]/g,"")),i=[];return t.forEach(r=>{r==="Person"&&(i.push('    ("Person", "Organization"): ["WorksFor", "MemberOf", "PartnersWith"],'),i.push('    ("Person", "Technology"): ["Creates", "Uses"],'),i.push('    ("Person", "Product"): ["Creates", "Uses"],'),i.push('    ("Person", "Project"): ["Creates", "MemberOf"],'),i.push('    ("Person", "Person"): ["Knows", "CollaboratesWith"],'),i.push('    ("Person", "Music"): ["PerformedBy"],')),r==="Music"&&(i.push('    ("Music", "Person"): ["PerformedBy", "CreatedBy", "InfluencedBy"],'),i.push('    ("Music", "Music"): ["InfluencedBy", "PartOfSeries"],')),r==="Film"&&i.push('    ("Film", "Person"): ["CreatedBy", "PerformedBy", "InfluencedBy"],'),r==="Organization"&&(i.push('    ("Organization", "Organization"): ["PartnersWith", "MemberOf"],'),i.push('    ("Organization", "Technology"): ["Creates", "Uses", "DependsOn"],'),i.push('    ("Organization", "Product"): ["Creates", "Uses", "DependsOn"],'),i.push('    ("Organization", "Project"): ["Creates", "PartnersWith"],'),i.push('    ("Organization", "Person"): ["PartnersWith"],')),r==="Technology"&&(i.push('    ("Technology", "Technology"): ["DependsOn", "IntegratedWith"],'),i.push('    ("Technology", "Product"): ["IntegratedWith"],'),i.push('    ("Technology", "Project"): ["IntegratedWith"],')),r==="Product"&&(i.push('    ("Product", "Technology"): ["IntegratedWith", "Uses", "DependsOn"],'),i.push('    ("Product", "Product"): ["IntegratedWith"],'),i.push('    ("Product", "Organization"): ["MemberOf"],'),i.push('    ("Product", "Project"): ["IntegratedWith"],')),r==="Project"&&(i.push('    ("Project", "Technology"): ["Uses", "Creates", "DependsOn"],'),i.push('    ("Project", "Product"): ["Creates", "Uses"],'),i.push('    ("Project", "Organization"): ["PartnersWith"],'),i.push('    ("Project", "Project"): ["PartnersWith", "DependsOn"],')),["WebPage","Note","Article"].includes(r)&&i.push(`    ("${r}", "Entity"): ["About"],`)}),i.push('    ("Entity", "Entity"): ["Tags", "Knows"],'),`
# Edge Type Map - Defines allowed relationships between entity types
edge_type_map = {
${Array.from(new Set(i)).join(`
`)}
}`}getPythonType(e){switch(e.inferredType){case"string":return"str";case"number":return"float";case"boolean":return"bool";case"date":return"datetime";case"array":return"List[str]";case"object":return"Dict[str, Any]";default:return"str"}}async generateAndSaveModels(e){try{const t=await this.discoverAllSchemas();if(t.length===0)return{success:!1,modelPath:"",message:'No schemas found in vault. Add frontmatter with "type" field to your notes.'};const i=await this.generatePydanticModels(t),s=Ge.join(e,"graphiti_bridge","models"),r=Ge.join(s,"graphiti_models.py");try{await this.app.vault.adapter.mkdir(s)}catch(o){}return await this.app.vault.adapter.write(r,i),{success:!0,modelPath:r,message:`Generated ${t.length} entity models and saved to ${r}`}}catch(t){return{success:!1,modelPath:"",message:`Failed to generate models: ${t instanceof Error?t.message:String(t)}`}}}getModelsPath(e){return Ge.join(e,"graphiti_bridge","models","graphiti_models.py")}async checkModelsStatus(e){try{const t=this.getModelsPath(e),i=await this.app.vault.adapter.stat(t);if(i){const r=(await this.app.vault.adapter.read(t)).match(/class\s+\w+\(BaseEntity\):/g);return{exists:!0,modelsCount:r?r.length:0,lastModified:i.mtime}}else return{exists:!1,modelsCount:0}}catch(t){return{exists:!1,modelsCount:0}}}}class gl{constructor(e,t,i){this.selectedNotes=new Set,this.app=e,this.plugin=t,this.logger=i}getSettings(){var e;return((e=this.plugin)==null?void 0:e.settings)||null}shouldIncludeFile(e,t,i){if(i.length>0){for(const s of i)if(e.startsWith(s+"/")||e===s)return!1}if(t.length>0){let s=!1;for(const r of t)if(e.startsWith(r+"/")||e===r){s=!0;break}return s}return!0}async getAllSyncableNotes(){const e=this.app.vault.getMarkdownFiles(),t=[],i=this.getSettings();for(const s of e){const r=this.app.metadataCache.getFileCache(s),o=(r==null?void 0:r.frontmatter)||{};if(!o.type||!this.shouldIncludeFile(s.path,(i==null?void 0:i.includedFolders)||[],(i==null?void 0:i.excludedFolders)||[]))continue;const a=this.extractTags(r),l=await this.app.vault.read(s);t.push({file:s,path:s.path,type:o.type,tags:a,frontmatter:o,contentLength:l.length,created:new Date(s.stat.ctime),modified:new Date(s.stat.mtime),selected:this.selectedNotes.has(s.path)})}return t.sort((s,r)=>s.modified.getTime()-r.modified.getTime())}async getFilteredSyncableNotes(){return this.getAllSyncableNotes()}async getNotesForAutoSync(e){const t=this.getSettings();if(!t)return this.getAllSyncableNotes();const i=await this.getAllSyncableNotes(),s=e||t.syncOptions||"new_and_updated";if(console.debug(`[NoteSelection] Auto-sync filtering: ${s}, total notes: ${i.length}`),s==="new_only"){const r=this.filterNewNotesOnly(i);return console.debug(`[NoteSelection] New-only filtering: ${r.length} new notes found`),r}if(s==="new_and_updated"){const r=this.filterNewNotesOnly(i),o=await this.getUpdatedNotes(i),a=new Set,l=[];return r.forEach(d=>{a.add(d.path),l.push(d)}),o.forEach(d=>{a.has(d.path)||(a.add(d.path),l.push(d))}),console.debug(`[NoteSelection] New+Updated filtering: ${r.length} new, ${o.length} updated, ${l.length} total after dedup`),l.sort((d,p)=>d.modified.getTime()-p.modified.getTime())}return i}filterNewNotesOnly(e){var r;const t=(r=this.plugin)==null?void 0:r.syncRegistryService;if(!t)return e;const i=this.app.vault.getName(),s=this.getCurrentDatabaseType();return e.filter(o=>{const a=t.getSyncRecord(o.path,i);return!a||!a.syncs.find(d=>d.database_id===s)})}async getUpdatedNotes(e){var r;const t=(r=this.plugin)==null?void 0:r.syncRegistryService;if(!t)return[];const i=this.app.vault.getName(),s=this.getCurrentDatabaseType();return e.filter(o=>{var c;const a=this.app.metadataCache.getFileCache(o.file),l=(c=a==null?void 0:a.frontmatter)==null?void 0:c.mm_uid;if(!l||typeof l!="string")return!1;const d=t.getSyncRecord(l,i);if(!d)return!1;const p=d.syncs.find(v=>v.database_id===s);if(!p)return!1;const g=new Date(p.last_sync),m=o.modified,h=5*60*1e3;return m.getTime()>g.getTime()+h})}getCurrentDatabaseType(){const e=this.getSettings();return(e==null?void 0:e.databaseType)||"neo4j"}shouldIncludeInAutoSync(e,t="new_and_updated"){var i;if(t==="new_and_updated")return!0;if(t==="new_only"){const s=(i=this.plugin)==null?void 0:i.syncRegistryService;if(!s)return!0;const r=this.app.vault.getName(),o=this.getCurrentDatabaseType(),a=s.getSyncRecord(e,r);return a?!a.syncs.find(d=>d.database_id===o):!0}return!0}async getPrivateNotesByFolder(){const e=this.app.vault.getMarkdownFiles(),t=[],i=this.getSettings();for(const s of e)if(s instanceof P.TFile&&!this.shouldIncludeFile(s.path,(i==null?void 0:i.includedFolders)||[],(i==null?void 0:i.excludedFolders)||[])){const r=this.app.metadataCache.getFileCache(s),o=(r==null?void 0:r.frontmatter)||{},a=this.extractTags(r),l=await this.app.vault.read(s);t.push({file:s,path:s.path,type:o.type,tags:a,frontmatter:o,contentLength:l.length,created:new Date(s.stat.ctime),modified:new Date(s.stat.mtime),selected:!1})}return t.sort((s,r)=>s.path.localeCompare(r.path))}createSettingsBasedCriteria(){const e=this.getSettings();if(!e)return{};const t={};return e.includedFolders.length>0&&(t.includePaths=e.includedFolders),e.excludedFolders.length>0&&(t.excludePaths=e.excludedFolders),t}async filterNotes(e){return(await this.getAllSyncableNotes()).filter(i=>!(e.includeTypes&&e.includeTypes.length>0&&(!i.type||!e.includeTypes.includes(i.type))||e.excludeTypes&&e.excludeTypes.length>0&&i.type&&e.excludeTypes.includes(i.type)||e.includeTags&&e.includeTags.length>0&&!e.includeTags.some(r=>i.tags.includes(r))||e.excludeTags&&e.excludeTags.length>0&&e.excludeTags.some(r=>i.tags.includes(r))||e.createdAfter&&i.created<e.createdAfter||e.createdBefore&&i.created>e.createdBefore||e.modifiedAfter&&i.modified<e.modifiedAfter||e.modifiedBefore&&i.modified>e.modifiedBefore||e.includePaths&&e.includePaths.length>0&&!e.includePaths.some(r=>i.path.toLowerCase().includes(r.toLowerCase()))||e.excludePaths&&e.excludePaths.length>0&&e.excludePaths.some(r=>i.path.toLowerCase().includes(r.toLowerCase()))||e.hasType!==void 0&&e.hasType&&!i.type||e.hasFrontmatter!==void 0&&e.hasFrontmatter&&Object.keys(i.frontmatter).length===0||e.minContentLength!==void 0&&i.contentLength<e.minContentLength||e.maxContentLength!==void 0&&i.contentLength>e.maxContentLength))}async getAvailableTypes(){const e=await this.getAllSyncableNotes(),t=new Set;return e.forEach(i=>{i.type&&t.add(i.type)}),Array.from(t).sort()}async getAvailableTags(){const e=await this.getAllSyncableNotes(),t=new Set;return e.forEach(i=>{i.tags.forEach(s=>t.add(s))}),Array.from(t).sort()}selectNotes(e){e.forEach(t=>this.selectedNotes.add(t))}deselectNotes(e){e.forEach(t=>this.selectedNotes.delete(t))}toggleNoteSelection(e){return this.selectedNotes.has(e)?(this.selectedNotes.delete(e),!1):(this.selectedNotes.add(e),!0)}async selectAllMatching(e){const i=(await this.filterNotes(e)).map(s=>s.path);return this.selectNotes(i),i.length}clearSelection(){this.selectedNotes.clear()}getSelectedNotePaths(){return Array.from(this.selectedNotes)}async getSelectionSummary(){const e=await this.getAllSyncableNotes(),t=this.getSelectedNotePaths(),i={},s={};e.forEach(l=>{l.type&&(i[l.type]=(i[l.type]||0)+1,t.includes(l.path)&&(s[l.type]=(s[l.type]||0)+1))});const r=t.length,o=Math.ceil(r*1.5/60),a=r===0?"0 seconds":o<1?`${r*1.5} seconds`:o===1?"1 minute":`${o} minutes`;return{totalNotes:e.length,selectedNotes:r,notesByType:i,selectedByType:s,estimatedSyncTime:a}}async getNotesByType(){const e=await this.getAllSyncableNotes(),t={};return e.forEach(i=>{i.type&&(t[i.type]||(t[i.type]=[]),t[i.type].push(i))}),t}async createSelectionPresets(){const e=await this.getAvailableTypes(),t={"All Notes":{},"Recently Modified":{modifiedAfter:new Date(Date.now()-7*24*60*60*1e3)},"Recent Content":{createdAfter:new Date(Date.now()-30*24*60*60*1e3)}};return e.forEach(i=>{t[`${i} Only`]={includeTypes:[i]}}),t}async validateSelection(){const e=this.getSelectedNotePaths(),t=[],i=[];if(e.length===0)return i.push("No notes selected for sync"),{isValid:!1,warnings:t,errors:i};const s=[];for(const a of e){const l=this.app.vault.getAbstractFileByPath(a);(!l||!(l instanceof P.TFile))&&s.push(a)}s.length>0&&(i.push(`Missing files: ${s.join(", ")}`),this.deselectNotes(s)),e.length>100&&t.push(`Large selection (${e.length} notes) may take significant time to sync`);const r=[];return(await this.getAllSyncableNotes()).forEach(a=>{e.includes(a.path)&&a.contentLength>5e4&&r.push(`${a.path} (${Math.round(a.contentLength/1e3)}KB)`)}),r.length>0&&t.push(`Large files detected: ${r.join(", ")}`),{isValid:i.length===0,warnings:t,errors:i}}extractTags(e){var i;if(!e)return[];const t=[];if((i=e.frontmatter)!=null&&i.tags){const s=Array.isArray(e.frontmatter.tags)?e.frontmatter.tags:[e.frontmatter.tags];t.push(...s.map(r=>String(r)))}return e.tags&&t.push(...e.tags.map(s=>s.tag.replace("#",""))),[...new Set(t)].filter(s=>s.trim().length>0)}}/*! js-yaml 4.1.0 https://github.com/nodeca/js-yaml @license MIT */function Rr(n){return typeof n=="undefined"||n===null}function fl(n){return typeof n=="object"&&n!==null}function hl(n){return Array.isArray(n)?n:Rr(n)?[]:[n]}function ml(n,e){var t,i,s,r;if(e)for(r=Object.keys(e),t=0,i=r.length;t<i;t+=1)s=r[t],n[s]=e[s];return n}function yl(n,e){var t="",i;for(i=0;i<e;i+=1)t+=n;return t}function bl(n){return n===0&&Number.NEGATIVE_INFINITY===1/n}var vl=Rr,_l=fl,wl=hl,Sl=yl,xl=bl,kl=ml,ut={isNothing:vl,isObject:_l,toArray:wl,repeat:Sl,isNegativeZero:xl,extend:kl};function Fr(n,e){var t="",i=n.reason||"(unknown reason)";return n.mark?(n.mark.name&&(t+='in "'+n.mark.name+'" '),t+="("+(n.mark.line+1)+":"+(n.mark.column+1)+")",!e&&n.mark.snippet&&(t+=`

`+n.mark.snippet),i+" "+t):i}function cn(n,e){Error.call(this),this.name="YAMLException",this.reason=n,this.mark=e,this.message=Fr(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack||""}cn.prototype=Object.create(Error.prototype);cn.prototype.constructor=cn;cn.prototype.toString=function(e){return this.name+": "+Fr(this,e)};var yt=cn;function Fn(n,e,t,i,s){var r="",o="",a=Math.floor(s/2)-1;return i-e>a&&(r=" ... ",e=i-a+r.length),t-i>a&&(o=" ...",t=i+a-o.length),{str:r+n.slice(e,t).replace(/\t/g,"")+o,pos:i-e+r.length}}function $n(n,e){return ut.repeat(" ",e-n.length)+n}function El(n,e){if(e=Object.create(e||null),!n.buffer)return null;e.maxLength||(e.maxLength=79),typeof e.indent!="number"&&(e.indent=1),typeof e.linesBefore!="number"&&(e.linesBefore=3),typeof e.linesAfter!="number"&&(e.linesAfter=2);for(var t=/\r?\n|\r|\0/g,i=[0],s=[],r,o=-1;r=t.exec(n.buffer);)s.push(r.index),i.push(r.index+r[0].length),n.position<=r.index&&o<0&&(o=i.length-2);o<0&&(o=i.length-1);var a="",l,d,p=Math.min(n.line+e.linesAfter,s.length).toString().length,g=e.maxLength-(e.indent+p+3);for(l=1;l<=e.linesBefore&&!(o-l<0);l++)d=Fn(n.buffer,i[o-l],s[o-l],n.position-(i[o]-i[o-l]),g),a=ut.repeat(" ",e.indent)+$n((n.line-l+1).toString(),p)+" | "+d.str+`
`+a;for(d=Fn(n.buffer,i[o],s[o],n.position,g),a+=ut.repeat(" ",e.indent)+$n((n.line+1).toString(),p)+" | "+d.str+`
`,a+=ut.repeat("-",e.indent+p+3+d.pos)+`^
`,l=1;l<=e.linesAfter&&!(o+l>=s.length);l++)d=Fn(n.buffer,i[o+l],s[o+l],n.position-(i[o]-i[o+l]),g),a+=ut.repeat(" ",e.indent)+$n((n.line+l+1).toString(),p)+" | "+d.str+`
`;return a.replace(/\n$/,"")}var Cl=El,Pl=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],Dl=["scalar","sequence","mapping"];function Tl(n){var e={};return n!==null&&Object.keys(n).forEach(function(t){n[t].forEach(function(i){e[String(i)]=t})}),e}function Ml(n,e){if(e=e||{},Object.keys(e).forEach(function(t){if(Pl.indexOf(t)===-1)throw new yt('Unknown option "'+t+'" is met in definition of "'+n+'" YAML type.')}),this.options=e,this.tag=n,this.kind=e.kind||null,this.resolve=e.resolve||function(){return!0},this.construct=e.construct||function(t){return t},this.instanceOf=e.instanceOf||null,this.predicate=e.predicate||null,this.represent=e.represent||null,this.representName=e.representName||null,this.defaultStyle=e.defaultStyle||null,this.multi=e.multi||!1,this.styleAliases=Tl(e.styleAliases||null),Dl.indexOf(this.kind)===-1)throw new yt('Unknown kind "'+this.kind+'" is specified for "'+n+'" YAML type.')}var gt=Ml;function Si(n,e){var t=[];return n[e].forEach(function(i){var s=t.length;t.forEach(function(r,o){r.tag===i.tag&&r.kind===i.kind&&r.multi===i.multi&&(s=o)}),t[s]=i}),t}function Nl(){var n={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}},e,t;function i(s){s.multi?(n.multi[s.kind].push(s),n.multi.fallback.push(s)):n[s.kind][s.tag]=n.fallback[s.tag]=s}for(e=0,t=arguments.length;e<t;e+=1)arguments[e].forEach(i);return n}function qn(n){return this.extend(n)}qn.prototype.extend=function(e){var t=[],i=[];if(e instanceof gt)i.push(e);else if(Array.isArray(e))i=i.concat(e);else if(e&&(Array.isArray(e.implicit)||Array.isArray(e.explicit)))e.implicit&&(t=t.concat(e.implicit)),e.explicit&&(i=i.concat(e.explicit));else throw new yt("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");t.forEach(function(r){if(!(r instanceof gt))throw new yt("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(r.loadKind&&r.loadKind!=="scalar")throw new yt("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(r.multi)throw new yt("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")}),i.forEach(function(r){if(!(r instanceof gt))throw new yt("Specified list of YAML types (or a single Type object) contains a non-Type object.")});var s=Object.create(qn.prototype);return s.implicit=(this.implicit||[]).concat(t),s.explicit=(this.explicit||[]).concat(i),s.compiledImplicit=Si(s,"implicit"),s.compiledExplicit=Si(s,"explicit"),s.compiledTypeMap=Nl(s.compiledImplicit,s.compiledExplicit),s};var Al=qn,Ol=new gt("tag:yaml.org,2002:str",{kind:"scalar",construct:function(n){return n!==null?n:""}}),Il=new gt("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(n){return n!==null?n:[]}}),Ll=new gt("tag:yaml.org,2002:map",{kind:"mapping",construct:function(n){return n!==null?n:{}}}),Rl=new Al({explicit:[Ol,Il,Ll]});function Fl(n){if(n===null)return!0;var e=n.length;return e===1&&n==="~"||e===4&&(n==="null"||n==="Null"||n==="NULL")}function $l(){return null}function Ul(n){return n===null}var jl=new gt("tag:yaml.org,2002:null",{kind:"scalar",resolve:Fl,construct:$l,predicate:Ul,represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});function zl(n){if(n===null)return!1;var e=n.length;return e===4&&(n==="true"||n==="True"||n==="TRUE")||e===5&&(n==="false"||n==="False"||n==="FALSE")}function Bl(n){return n==="true"||n==="True"||n==="TRUE"}function Vl(n){return Object.prototype.toString.call(n)==="[object Boolean]"}var Gl=new gt("tag:yaml.org,2002:bool",{kind:"scalar",resolve:zl,construct:Bl,predicate:Vl,represent:{lowercase:function(n){return n?"true":"false"},uppercase:function(n){return n?"TRUE":"FALSE"},camelcase:function(n){return n?"True":"False"}},defaultStyle:"lowercase"});function Yl(n){return 48<=n&&n<=57||65<=n&&n<=70||97<=n&&n<=102}function ql(n){return 48<=n&&n<=55}function Wl(n){return 48<=n&&n<=57}function Kl(n){if(n===null)return!1;var e=n.length,t=0,i=!1,s;if(!e)return!1;if(s=n[t],(s==="-"||s==="+")&&(s=n[++t]),s==="0"){if(t+1===e)return!0;if(s=n[++t],s==="b"){for(t++;t<e;t++)if(s=n[t],s!=="_"){if(s!=="0"&&s!=="1")return!1;i=!0}return i&&s!=="_"}if(s==="x"){for(t++;t<e;t++)if(s=n[t],s!=="_"){if(!Yl(n.charCodeAt(t)))return!1;i=!0}return i&&s!=="_"}if(s==="o"){for(t++;t<e;t++)if(s=n[t],s!=="_"){if(!ql(n.charCodeAt(t)))return!1;i=!0}return i&&s!=="_"}}if(s==="_")return!1;for(;t<e;t++)if(s=n[t],s!=="_"){if(!Wl(n.charCodeAt(t)))return!1;i=!0}return!(!i||s==="_")}function Hl(n){var e=n,t=1,i;if(e.indexOf("_")!==-1&&(e=e.replace(/_/g,"")),i=e[0],(i==="-"||i==="+")&&(i==="-"&&(t=-1),e=e.slice(1),i=e[0]),e==="0")return 0;if(i==="0"){if(e[1]==="b")return t*parseInt(e.slice(2),2);if(e[1]==="x")return t*parseInt(e.slice(2),16);if(e[1]==="o")return t*parseInt(e.slice(2),8)}return t*parseInt(e,10)}function Jl(n){return Object.prototype.toString.call(n)==="[object Number]"&&n%1===0&&!ut.isNegativeZero(n)}var Ql=new gt("tag:yaml.org,2002:int",{kind:"scalar",resolve:Kl,construct:Hl,predicate:Jl,represent:{binary:function(n){return n>=0?"0b"+n.toString(2):"-0b"+n.toString(2).slice(1)},octal:function(n){return n>=0?"0o"+n.toString(8):"-0o"+n.toString(8).slice(1)},decimal:function(n){return n.toString(10)},hexadecimal:function(n){return n>=0?"0x"+n.toString(16).toUpperCase():"-0x"+n.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),Zl=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");function Xl(n){return!(n===null||!Zl.test(n)||n[n.length-1]==="_")}function ec(n){var e,t;return e=n.replace(/_/g,"").toLowerCase(),t=e[0]==="-"?-1:1,"+-".indexOf(e[0])>=0&&(e=e.slice(1)),e===".inf"?t===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:e===".nan"?NaN:t*parseFloat(e,10)}var tc=/^[-+]?[0-9]+e/;function nc(n,e){var t;if(isNaN(n))switch(e){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===n)switch(e){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===n)switch(e){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(ut.isNegativeZero(n))return"-0.0";return t=n.toString(10),tc.test(t)?t.replace("e",".e"):t}function ic(n){return Object.prototype.toString.call(n)==="[object Number]"&&(n%1!==0||ut.isNegativeZero(n))}var sc=new gt("tag:yaml.org,2002:float",{kind:"scalar",resolve:Xl,construct:ec,predicate:ic,represent:nc,defaultStyle:"lowercase"}),rc=Rl.extend({implicit:[jl,Gl,Ql,sc]}),oc=rc,$r=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),Ur=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");function ac(n){return n===null?!1:$r.exec(n)!==null||Ur.exec(n)!==null}function lc(n){var e,t,i,s,r,o,a,l=0,d=null,p,g,m;if(e=$r.exec(n),e===null&&(e=Ur.exec(n)),e===null)throw new Error("Date resolve error");if(t=+e[1],i=+e[2]-1,s=+e[3],!e[4])return new Date(Date.UTC(t,i,s));if(r=+e[4],o=+e[5],a=+e[6],e[7]){for(l=e[7].slice(0,3);l.length<3;)l+="0";l=+l}return e[9]&&(p=+e[10],g=+(e[11]||0),d=(p*60+g)*6e4,e[9]==="-"&&(d=-d)),m=new Date(Date.UTC(t,i,s,r,o,a,l)),d&&m.setTime(m.getTime()-d),m}function cc(n){return n.toISOString()}var dc=new gt("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:ac,construct:lc,instanceOf:Date,represent:cc});function uc(n){return n==="<<"||n===null}var pc=new gt("tag:yaml.org,2002:merge",{kind:"scalar",resolve:uc}),ni=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`;function gc(n){if(n===null)return!1;var e,t,i=0,s=n.length,r=ni;for(t=0;t<s;t++)if(e=r.indexOf(n.charAt(t)),!(e>64)){if(e<0)return!1;i+=6}return i%8===0}function fc(n){var e,t,i=n.replace(/[\r\n=]/g,""),s=i.length,r=ni,o=0,a=[];for(e=0;e<s;e++)e%4===0&&e&&(a.push(o>>16&255),a.push(o>>8&255),a.push(o&255)),o=o<<6|r.indexOf(i.charAt(e));return t=s%4*6,t===0?(a.push(o>>16&255),a.push(o>>8&255),a.push(o&255)):t===18?(a.push(o>>10&255),a.push(o>>2&255)):t===12&&a.push(o>>4&255),new Uint8Array(a)}function hc(n){var e="",t=0,i,s,r=n.length,o=ni;for(i=0;i<r;i++)i%3===0&&i&&(e+=o[t>>18&63],e+=o[t>>12&63],e+=o[t>>6&63],e+=o[t&63]),t=(t<<8)+n[i];return s=r%3,s===0?(e+=o[t>>18&63],e+=o[t>>12&63],e+=o[t>>6&63],e+=o[t&63]):s===2?(e+=o[t>>10&63],e+=o[t>>4&63],e+=o[t<<2&63],e+=o[64]):s===1&&(e+=o[t>>2&63],e+=o[t<<4&63],e+=o[64],e+=o[64]),e}function mc(n){return Object.prototype.toString.call(n)==="[object Uint8Array]"}var yc=new gt("tag:yaml.org,2002:binary",{kind:"scalar",resolve:gc,construct:fc,predicate:mc,represent:hc}),bc=Object.prototype.hasOwnProperty,vc=Object.prototype.toString;function _c(n){if(n===null)return!0;var e=[],t,i,s,r,o,a=n;for(t=0,i=a.length;t<i;t+=1){if(s=a[t],o=!1,vc.call(s)!=="[object Object]")return!1;for(r in s)if(bc.call(s,r))if(!o)o=!0;else return!1;if(!o)return!1;if(e.indexOf(r)===-1)e.push(r);else return!1}return!0}function wc(n){return n!==null?n:[]}var Sc=new gt("tag:yaml.org,2002:omap",{kind:"sequence",resolve:_c,construct:wc}),xc=Object.prototype.toString;function kc(n){if(n===null)return!0;var e,t,i,s,r,o=n;for(r=new Array(o.length),e=0,t=o.length;e<t;e+=1){if(i=o[e],xc.call(i)!=="[object Object]"||(s=Object.keys(i),s.length!==1))return!1;r[e]=[s[0],i[s[0]]]}return!0}function Ec(n){if(n===null)return[];var e,t,i,s,r,o=n;for(r=new Array(o.length),e=0,t=o.length;e<t;e+=1)i=o[e],s=Object.keys(i),r[e]=[s[0],i[s[0]]];return r}var Cc=new gt("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:kc,construct:Ec}),Pc=Object.prototype.hasOwnProperty;function Dc(n){if(n===null)return!0;var e,t=n;for(e in t)if(Pc.call(t,e)&&t[e]!==null)return!1;return!0}function Tc(n){return n!==null?n:{}}var Mc=new gt("tag:yaml.org,2002:set",{kind:"mapping",resolve:Dc,construct:Tc}),ii=oc.extend({implicit:[dc,pc],explicit:[yc,Sc,Cc,Mc]}),Ut=Object.prototype.hasOwnProperty,kn=1,jr=2,zr=3,En=4,Un=1,Nc=2,xi=3,Ac=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,Oc=/[\x85\u2028\u2029]/,Ic=/[,\[\]\{\}]/,Br=/^(?:!|!!|![a-z\-]+!)$/i,Vr=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function ki(n){return Object.prototype.toString.call(n)}function Et(n){return n===10||n===13}function Vt(n){return n===9||n===32}function bt(n){return n===9||n===32||n===10||n===13}function Xt(n){return n===44||n===91||n===93||n===123||n===125}function Lc(n){var e;return 48<=n&&n<=57?n-48:(e=n|32,97<=e&&e<=102?e-97+10:-1)}function Rc(n){return n===120?2:n===117?4:n===85?8:0}function Fc(n){return 48<=n&&n<=57?n-48:-1}function Ei(n){return n===48?"\0":n===97?"\x07":n===98?"\b":n===116||n===9?"	":n===110?`
`:n===118?"\v":n===102?"\f":n===114?"\r":n===101?"\x1B":n===32?" ":n===34?'"':n===47?"/":n===92?"\\":n===78?"":n===95?"":n===76?"\u2028":n===80?"\u2029":""}function $c(n){return n<=65535?String.fromCharCode(n):String.fromCharCode((n-65536>>10)+55296,(n-65536&1023)+56320)}var Gr=new Array(256),Yr=new Array(256);for(var Wt=0;Wt<256;Wt++)Gr[Wt]=Ei(Wt)?1:0,Yr[Wt]=Ei(Wt);function Uc(n,e){this.input=n,this.filename=e.filename||null,this.schema=e.schema||ii,this.onWarning=e.onWarning||null,this.legacy=e.legacy||!1,this.json=e.json||!1,this.listener=e.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=n.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function qr(n,e){var t={name:n.filename,buffer:n.input.slice(0,-1),position:n.position,line:n.line,column:n.position-n.lineStart};return t.snippet=Cl(t),new yt(e,t)}function ke(n,e){throw qr(n,e)}function Cn(n,e){n.onWarning&&n.onWarning.call(null,qr(n,e))}var Ci={YAML:function(e,t,i){var s,r,o;e.version!==null&&ke(e,"duplication of %YAML directive"),i.length!==1&&ke(e,"YAML directive accepts exactly one argument"),s=/^([0-9]+)\.([0-9]+)$/.exec(i[0]),s===null&&ke(e,"ill-formed argument of the YAML directive"),r=parseInt(s[1],10),o=parseInt(s[2],10),r!==1&&ke(e,"unacceptable YAML version of the document"),e.version=i[0],e.checkLineBreaks=o<2,o!==1&&o!==2&&Cn(e,"unsupported YAML version of the document")},TAG:function(e,t,i){var s,r;i.length!==2&&ke(e,"TAG directive accepts exactly two arguments"),s=i[0],r=i[1],Br.test(s)||ke(e,"ill-formed tag handle (first argument) of the TAG directive"),Ut.call(e.tagMap,s)&&ke(e,'there is a previously declared suffix for "'+s+'" tag handle'),Vr.test(r)||ke(e,"ill-formed tag prefix (second argument) of the TAG directive");try{r=decodeURIComponent(r)}catch(o){ke(e,"tag prefix is malformed: "+r)}e.tagMap[s]=r}};function $t(n,e,t,i){var s,r,o,a;if(e<t){if(a=n.input.slice(e,t),i)for(s=0,r=a.length;s<r;s+=1)o=a.charCodeAt(s),o===9||32<=o&&o<=1114111||ke(n,"expected valid JSON character");else Ac.test(a)&&ke(n,"the stream contains non-printable characters");n.result+=a}}function Pi(n,e,t,i){var s,r,o,a;for(ut.isObject(t)||ke(n,"cannot merge mappings; the provided source object is unacceptable"),s=Object.keys(t),o=0,a=s.length;o<a;o+=1)r=s[o],Ut.call(e,r)||(e[r]=t[r],i[r]=!0)}function en(n,e,t,i,s,r,o,a,l){var d,p;if(Array.isArray(s))for(s=Array.prototype.slice.call(s),d=0,p=s.length;d<p;d+=1)Array.isArray(s[d])&&ke(n,"nested arrays are not supported inside keys"),typeof s=="object"&&ki(s[d])==="[object Object]"&&(s[d]="[object Object]");if(typeof s=="object"&&ki(s)==="[object Object]"&&(s="[object Object]"),s=String(s),e===null&&(e={}),i==="tag:yaml.org,2002:merge")if(Array.isArray(r))for(d=0,p=r.length;d<p;d+=1)Pi(n,e,r[d],t);else Pi(n,e,r,t);else!n.json&&!Ut.call(t,s)&&Ut.call(e,s)&&(n.line=o||n.line,n.lineStart=a||n.lineStart,n.position=l||n.position,ke(n,"duplicated mapping key")),s==="__proto__"?Object.defineProperty(e,s,{configurable:!0,enumerable:!0,writable:!0,value:r}):e[s]=r,delete t[s];return e}function si(n){var e;e=n.input.charCodeAt(n.position),e===10?n.position++:e===13?(n.position++,n.input.charCodeAt(n.position)===10&&n.position++):ke(n,"a line break is expected"),n.line+=1,n.lineStart=n.position,n.firstTabInLine=-1}function lt(n,e,t){for(var i=0,s=n.input.charCodeAt(n.position);s!==0;){for(;Vt(s);)s===9&&n.firstTabInLine===-1&&(n.firstTabInLine=n.position),s=n.input.charCodeAt(++n.position);if(e&&s===35)do s=n.input.charCodeAt(++n.position);while(s!==10&&s!==13&&s!==0);if(Et(s))for(si(n),s=n.input.charCodeAt(n.position),i++,n.lineIndent=0;s===32;)n.lineIndent++,s=n.input.charCodeAt(++n.position);else break}return t!==-1&&i!==0&&n.lineIndent<t&&Cn(n,"deficient indentation"),i}function Nn(n){var e=n.position,t;return t=n.input.charCodeAt(e),!!((t===45||t===46)&&t===n.input.charCodeAt(e+1)&&t===n.input.charCodeAt(e+2)&&(e+=3,t=n.input.charCodeAt(e),t===0||bt(t)))}function ri(n,e){e===1?n.result+=" ":e>1&&(n.result+=ut.repeat(`
`,e-1))}function jc(n,e,t){var i,s,r,o,a,l,d,p,g=n.kind,m=n.result,h;if(h=n.input.charCodeAt(n.position),bt(h)||Xt(h)||h===35||h===38||h===42||h===33||h===124||h===62||h===39||h===34||h===37||h===64||h===96||(h===63||h===45)&&(s=n.input.charCodeAt(n.position+1),bt(s)||t&&Xt(s)))return!1;for(n.kind="scalar",n.result="",r=o=n.position,a=!1;h!==0;){if(h===58){if(s=n.input.charCodeAt(n.position+1),bt(s)||t&&Xt(s))break}else if(h===35){if(i=n.input.charCodeAt(n.position-1),bt(i))break}else{if(n.position===n.lineStart&&Nn(n)||t&&Xt(h))break;if(Et(h))if(l=n.line,d=n.lineStart,p=n.lineIndent,lt(n,!1,-1),n.lineIndent>=e){a=!0,h=n.input.charCodeAt(n.position);continue}else{n.position=o,n.line=l,n.lineStart=d,n.lineIndent=p;break}}a&&($t(n,r,o,!1),ri(n,n.line-l),r=o=n.position,a=!1),Vt(h)||(o=n.position+1),h=n.input.charCodeAt(++n.position)}return $t(n,r,o,!1),n.result?!0:(n.kind=g,n.result=m,!1)}function zc(n,e){var t,i,s;if(t=n.input.charCodeAt(n.position),t!==39)return!1;for(n.kind="scalar",n.result="",n.position++,i=s=n.position;(t=n.input.charCodeAt(n.position))!==0;)if(t===39)if($t(n,i,n.position,!0),t=n.input.charCodeAt(++n.position),t===39)i=n.position,n.position++,s=n.position;else return!0;else Et(t)?($t(n,i,s,!0),ri(n,lt(n,!1,e)),i=s=n.position):n.position===n.lineStart&&Nn(n)?ke(n,"unexpected end of the document within a single quoted scalar"):(n.position++,s=n.position);ke(n,"unexpected end of the stream within a single quoted scalar")}function Bc(n,e){var t,i,s,r,o,a;if(a=n.input.charCodeAt(n.position),a!==34)return!1;for(n.kind="scalar",n.result="",n.position++,t=i=n.position;(a=n.input.charCodeAt(n.position))!==0;){if(a===34)return $t(n,t,n.position,!0),n.position++,!0;if(a===92){if($t(n,t,n.position,!0),a=n.input.charCodeAt(++n.position),Et(a))lt(n,!1,e);else if(a<256&&Gr[a])n.result+=Yr[a],n.position++;else if((o=Rc(a))>0){for(s=o,r=0;s>0;s--)a=n.input.charCodeAt(++n.position),(o=Lc(a))>=0?r=(r<<4)+o:ke(n,"expected hexadecimal character");n.result+=$c(r),n.position++}else ke(n,"unknown escape sequence");t=i=n.position}else Et(a)?($t(n,t,i,!0),ri(n,lt(n,!1,e)),t=i=n.position):n.position===n.lineStart&&Nn(n)?ke(n,"unexpected end of the document within a double quoted scalar"):(n.position++,i=n.position)}ke(n,"unexpected end of the stream within a double quoted scalar")}function Vc(n,e){var t=!0,i,s,r,o=n.tag,a,l=n.anchor,d,p,g,m,h,b=Object.create(null),c,v,w,_;if(_=n.input.charCodeAt(n.position),_===91)p=93,h=!1,a=[];else if(_===123)p=125,h=!0,a={};else return!1;for(n.anchor!==null&&(n.anchorMap[n.anchor]=a),_=n.input.charCodeAt(++n.position);_!==0;){if(lt(n,!0,e),_=n.input.charCodeAt(n.position),_===p)return n.position++,n.tag=o,n.anchor=l,n.kind=h?"mapping":"sequence",n.result=a,!0;t?_===44&&ke(n,"expected the node content, but found ','"):ke(n,"missed comma between flow collection entries"),v=c=w=null,g=m=!1,_===63&&(d=n.input.charCodeAt(n.position+1),bt(d)&&(g=m=!0,n.position++,lt(n,!0,e))),i=n.line,s=n.lineStart,r=n.position,sn(n,e,kn,!1,!0),v=n.tag,c=n.result,lt(n,!0,e),_=n.input.charCodeAt(n.position),(m||n.line===i)&&_===58&&(g=!0,_=n.input.charCodeAt(++n.position),lt(n,!0,e),sn(n,e,kn,!1,!0),w=n.result),h?en(n,a,b,v,c,w,i,s,r):g?a.push(en(n,null,b,v,c,w,i,s,r)):a.push(c),lt(n,!0,e),_=n.input.charCodeAt(n.position),_===44?(t=!0,_=n.input.charCodeAt(++n.position)):t=!1}ke(n,"unexpected end of the stream within a flow collection")}function Gc(n,e){var t,i,s=Un,r=!1,o=!1,a=e,l=0,d=!1,p,g;if(g=n.input.charCodeAt(n.position),g===124)i=!1;else if(g===62)i=!0;else return!1;for(n.kind="scalar",n.result="";g!==0;)if(g=n.input.charCodeAt(++n.position),g===43||g===45)Un===s?s=g===43?xi:Nc:ke(n,"repeat of a chomping mode identifier");else if((p=Fc(g))>=0)p===0?ke(n,"bad explicit indentation width of a block scalar; it cannot be less than one"):o?ke(n,"repeat of an indentation width identifier"):(a=e+p-1,o=!0);else break;if(Vt(g)){do g=n.input.charCodeAt(++n.position);while(Vt(g));if(g===35)do g=n.input.charCodeAt(++n.position);while(!Et(g)&&g!==0)}for(;g!==0;){for(si(n),n.lineIndent=0,g=n.input.charCodeAt(n.position);(!o||n.lineIndent<a)&&g===32;)n.lineIndent++,g=n.input.charCodeAt(++n.position);if(!o&&n.lineIndent>a&&(a=n.lineIndent),Et(g)){l++;continue}if(n.lineIndent<a){s===xi?n.result+=ut.repeat(`
`,r?1+l:l):s===Un&&r&&(n.result+=`
`);break}for(i?Vt(g)?(d=!0,n.result+=ut.repeat(`
`,r?1+l:l)):d?(d=!1,n.result+=ut.repeat(`
`,l+1)):l===0?r&&(n.result+=" "):n.result+=ut.repeat(`
`,l):n.result+=ut.repeat(`
`,r?1+l:l),r=!0,o=!0,l=0,t=n.position;!Et(g)&&g!==0;)g=n.input.charCodeAt(++n.position);$t(n,t,n.position,!1)}return!0}function Di(n,e){var t,i=n.tag,s=n.anchor,r=[],o,a=!1,l;if(n.firstTabInLine!==-1)return!1;for(n.anchor!==null&&(n.anchorMap[n.anchor]=r),l=n.input.charCodeAt(n.position);l!==0&&(n.firstTabInLine!==-1&&(n.position=n.firstTabInLine,ke(n,"tab characters must not be used in indentation")),!(l!==45||(o=n.input.charCodeAt(n.position+1),!bt(o))));){if(a=!0,n.position++,lt(n,!0,-1)&&n.lineIndent<=e){r.push(null),l=n.input.charCodeAt(n.position);continue}if(t=n.line,sn(n,e,zr,!1,!0),r.push(n.result),lt(n,!0,-1),l=n.input.charCodeAt(n.position),(n.line===t||n.lineIndent>e)&&l!==0)ke(n,"bad indentation of a sequence entry");else if(n.lineIndent<e)break}return a?(n.tag=i,n.anchor=s,n.kind="sequence",n.result=r,!0):!1}function Yc(n,e,t){var i,s,r,o,a,l,d=n.tag,p=n.anchor,g={},m=Object.create(null),h=null,b=null,c=null,v=!1,w=!1,_;if(n.firstTabInLine!==-1)return!1;for(n.anchor!==null&&(n.anchorMap[n.anchor]=g),_=n.input.charCodeAt(n.position);_!==0;){if(!v&&n.firstTabInLine!==-1&&(n.position=n.firstTabInLine,ke(n,"tab characters must not be used in indentation")),i=n.input.charCodeAt(n.position+1),r=n.line,(_===63||_===58)&&bt(i))_===63?(v&&(en(n,g,m,h,b,null,o,a,l),h=b=c=null),w=!0,v=!0,s=!0):v?(v=!1,s=!0):ke(n,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),n.position+=1,_=i;else{if(o=n.line,a=n.lineStart,l=n.position,!sn(n,t,jr,!1,!0))break;if(n.line===r){for(_=n.input.charCodeAt(n.position);Vt(_);)_=n.input.charCodeAt(++n.position);if(_===58)_=n.input.charCodeAt(++n.position),bt(_)||ke(n,"a whitespace character is expected after the key-value separator within a block mapping"),v&&(en(n,g,m,h,b,null,o,a,l),h=b=c=null),w=!0,v=!1,s=!1,h=n.tag,b=n.result;else if(w)ke(n,"can not read an implicit mapping pair; a colon is missed");else return n.tag=d,n.anchor=p,!0}else if(w)ke(n,"can not read a block mapping entry; a multiline key may not be an implicit key");else return n.tag=d,n.anchor=p,!0}if((n.line===r||n.lineIndent>e)&&(v&&(o=n.line,a=n.lineStart,l=n.position),sn(n,e,En,!0,s)&&(v?b=n.result:c=n.result),v||(en(n,g,m,h,b,c,o,a,l),h=b=c=null),lt(n,!0,-1),_=n.input.charCodeAt(n.position)),(n.line===r||n.lineIndent>e)&&_!==0)ke(n,"bad indentation of a mapping entry");else if(n.lineIndent<e)break}return v&&en(n,g,m,h,b,null,o,a,l),w&&(n.tag=d,n.anchor=p,n.kind="mapping",n.result=g),w}function qc(n){var e,t=!1,i=!1,s,r,o;if(o=n.input.charCodeAt(n.position),o!==33)return!1;if(n.tag!==null&&ke(n,"duplication of a tag property"),o=n.input.charCodeAt(++n.position),o===60?(t=!0,o=n.input.charCodeAt(++n.position)):o===33?(i=!0,s="!!",o=n.input.charCodeAt(++n.position)):s="!",e=n.position,t){do o=n.input.charCodeAt(++n.position);while(o!==0&&o!==62);n.position<n.length?(r=n.input.slice(e,n.position),o=n.input.charCodeAt(++n.position)):ke(n,"unexpected end of the stream within a verbatim tag")}else{for(;o!==0&&!bt(o);)o===33&&(i?ke(n,"tag suffix cannot contain exclamation marks"):(s=n.input.slice(e-1,n.position+1),Br.test(s)||ke(n,"named tag handle cannot contain such characters"),i=!0,e=n.position+1)),o=n.input.charCodeAt(++n.position);r=n.input.slice(e,n.position),Ic.test(r)&&ke(n,"tag suffix cannot contain flow indicator characters")}r&&!Vr.test(r)&&ke(n,"tag name cannot contain such characters: "+r);try{r=decodeURIComponent(r)}catch(a){ke(n,"tag name is malformed: "+r)}return t?n.tag=r:Ut.call(n.tagMap,s)?n.tag=n.tagMap[s]+r:s==="!"?n.tag="!"+r:s==="!!"?n.tag="tag:yaml.org,2002:"+r:ke(n,'undeclared tag handle "'+s+'"'),!0}function Wc(n){var e,t;if(t=n.input.charCodeAt(n.position),t!==38)return!1;for(n.anchor!==null&&ke(n,"duplication of an anchor property"),t=n.input.charCodeAt(++n.position),e=n.position;t!==0&&!bt(t)&&!Xt(t);)t=n.input.charCodeAt(++n.position);return n.position===e&&ke(n,"name of an anchor node must contain at least one character"),n.anchor=n.input.slice(e,n.position),!0}function Kc(n){var e,t,i;if(i=n.input.charCodeAt(n.position),i!==42)return!1;for(i=n.input.charCodeAt(++n.position),e=n.position;i!==0&&!bt(i)&&!Xt(i);)i=n.input.charCodeAt(++n.position);return n.position===e&&ke(n,"name of an alias node must contain at least one character"),t=n.input.slice(e,n.position),Ut.call(n.anchorMap,t)||ke(n,'unidentified alias "'+t+'"'),n.result=n.anchorMap[t],lt(n,!0,-1),!0}function sn(n,e,t,i,s){var r,o,a,l=1,d=!1,p=!1,g,m,h,b,c,v;if(n.listener!==null&&n.listener("open",n),n.tag=null,n.anchor=null,n.kind=null,n.result=null,r=o=a=En===t||zr===t,i&&lt(n,!0,-1)&&(d=!0,n.lineIndent>e?l=1:n.lineIndent===e?l=0:n.lineIndent<e&&(l=-1)),l===1)for(;qc(n)||Wc(n);)lt(n,!0,-1)?(d=!0,a=r,n.lineIndent>e?l=1:n.lineIndent===e?l=0:n.lineIndent<e&&(l=-1)):a=!1;if(a&&(a=d||s),(l===1||En===t)&&(kn===t||jr===t?c=e:c=e+1,v=n.position-n.lineStart,l===1?a&&(Di(n,v)||Yc(n,v,c))||Vc(n,c)?p=!0:(o&&Gc(n,c)||zc(n,c)||Bc(n,c)?p=!0:Kc(n)?(p=!0,(n.tag!==null||n.anchor!==null)&&ke(n,"alias node should not have any properties")):jc(n,c,kn===t)&&(p=!0,n.tag===null&&(n.tag="?")),n.anchor!==null&&(n.anchorMap[n.anchor]=n.result)):l===0&&(p=a&&Di(n,v))),n.tag===null)n.anchor!==null&&(n.anchorMap[n.anchor]=n.result);else if(n.tag==="?"){for(n.result!==null&&n.kind!=="scalar"&&ke(n,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+n.kind+'"'),g=0,m=n.implicitTypes.length;g<m;g+=1)if(b=n.implicitTypes[g],b.resolve(n.result)){n.result=b.construct(n.result),n.tag=b.tag,n.anchor!==null&&(n.anchorMap[n.anchor]=n.result);break}}else if(n.tag!=="!"){if(Ut.call(n.typeMap[n.kind||"fallback"],n.tag))b=n.typeMap[n.kind||"fallback"][n.tag];else for(b=null,h=n.typeMap.multi[n.kind||"fallback"],g=0,m=h.length;g<m;g+=1)if(n.tag.slice(0,h[g].tag.length)===h[g].tag){b=h[g];break}b||ke(n,"unknown tag !<"+n.tag+">"),n.result!==null&&b.kind!==n.kind&&ke(n,"unacceptable node kind for !<"+n.tag+'> tag; it should be "'+b.kind+'", not "'+n.kind+'"'),b.resolve(n.result,n.tag)?(n.result=b.construct(n.result,n.tag),n.anchor!==null&&(n.anchorMap[n.anchor]=n.result)):ke(n,"cannot resolve a node with !<"+n.tag+"> explicit tag")}return n.listener!==null&&n.listener("close",n),n.tag!==null||n.anchor!==null||p}function Hc(n){var e=n.position,t,i,s,r=!1,o;for(n.version=null,n.checkLineBreaks=n.legacy,n.tagMap=Object.create(null),n.anchorMap=Object.create(null);(o=n.input.charCodeAt(n.position))!==0&&(lt(n,!0,-1),o=n.input.charCodeAt(n.position),!(n.lineIndent>0||o!==37));){for(r=!0,o=n.input.charCodeAt(++n.position),t=n.position;o!==0&&!bt(o);)o=n.input.charCodeAt(++n.position);for(i=n.input.slice(t,n.position),s=[],i.length<1&&ke(n,"directive name must not be less than one character in length");o!==0;){for(;Vt(o);)o=n.input.charCodeAt(++n.position);if(o===35){do o=n.input.charCodeAt(++n.position);while(o!==0&&!Et(o));break}if(Et(o))break;for(t=n.position;o!==0&&!bt(o);)o=n.input.charCodeAt(++n.position);s.push(n.input.slice(t,n.position))}o!==0&&si(n),Ut.call(Ci,i)?Ci[i](n,i,s):Cn(n,'unknown document directive "'+i+'"')}if(lt(n,!0,-1),n.lineIndent===0&&n.input.charCodeAt(n.position)===45&&n.input.charCodeAt(n.position+1)===45&&n.input.charCodeAt(n.position+2)===45?(n.position+=3,lt(n,!0,-1)):r&&ke(n,"directives end mark is expected"),sn(n,n.lineIndent-1,En,!1,!0),lt(n,!0,-1),n.checkLineBreaks&&Oc.test(n.input.slice(e,n.position))&&Cn(n,"non-ASCII line breaks are interpreted as content"),n.documents.push(n.result),n.position===n.lineStart&&Nn(n)){n.input.charCodeAt(n.position)===46&&(n.position+=3,lt(n,!0,-1));return}if(n.position<n.length-1)ke(n,"end of the stream or a document separator is expected");else return}function Wr(n,e){n=String(n),e=e||{},n.length!==0&&(n.charCodeAt(n.length-1)!==10&&n.charCodeAt(n.length-1)!==13&&(n+=`
`),n.charCodeAt(0)===65279&&(n=n.slice(1)));var t=new Uc(n,e),i=n.indexOf("\0");for(i!==-1&&(t.position=i,ke(t,"null byte is not allowed in input")),t.input+="\0";t.input.charCodeAt(t.position)===32;)t.lineIndent+=1,t.position+=1;for(;t.position<t.length-1;)Hc(t);return t.documents}function Jc(n,e,t){e!==null&&typeof e=="object"&&typeof t=="undefined"&&(t=e,e=null);var i=Wr(n,t);if(typeof e!="function")return i;for(var s=0,r=i.length;s<r;s+=1)e(i[s])}function Qc(n,e){var t=Wr(n,e);if(t.length!==0){if(t.length===1)return t[0];throw new yt("expected a single document in the stream, but found more")}}var Zc=Jc,Xc=Qc,ed={loadAll:Zc,load:Xc},Kr=Object.prototype.toString,Hr=Object.prototype.hasOwnProperty,oi=65279,td=9,dn=10,nd=13,id=32,sd=33,rd=34,Wn=35,od=37,ad=38,ld=39,cd=42,Jr=44,dd=45,Pn=58,ud=61,pd=62,gd=63,fd=64,Qr=91,Zr=93,hd=96,Xr=123,md=124,eo=125,ft={};ft[0]="\\0";ft[7]="\\a";ft[8]="\\b";ft[9]="\\t";ft[10]="\\n";ft[11]="\\v";ft[12]="\\f";ft[13]="\\r";ft[27]="\\e";ft[34]='\\"';ft[92]="\\\\";ft[133]="\\N";ft[160]="\\_";ft[8232]="\\L";ft[8233]="\\P";var yd=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],bd=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function vd(n,e){var t,i,s,r,o,a,l;if(e===null)return{};for(t={},i=Object.keys(e),s=0,r=i.length;s<r;s+=1)o=i[s],a=String(e[o]),o.slice(0,2)==="!!"&&(o="tag:yaml.org,2002:"+o.slice(2)),l=n.compiledTypeMap.fallback[o],l&&Hr.call(l.styleAliases,a)&&(a=l.styleAliases[a]),t[o]=a;return t}function _d(n){var e,t,i;if(e=n.toString(16).toUpperCase(),n<=255)t="x",i=2;else if(n<=65535)t="u",i=4;else if(n<=4294967295)t="U",i=8;else throw new yt("code point within a string may not be greater than 0xFFFFFFFF");return"\\"+t+ut.repeat("0",i-e.length)+e}var wd=1,un=2;function Sd(n){this.schema=n.schema||ii,this.indent=Math.max(1,n.indent||2),this.noArrayIndent=n.noArrayIndent||!1,this.skipInvalid=n.skipInvalid||!1,this.flowLevel=ut.isNothing(n.flowLevel)?-1:n.flowLevel,this.styleMap=vd(this.schema,n.styles||null),this.sortKeys=n.sortKeys||!1,this.lineWidth=n.lineWidth||80,this.noRefs=n.noRefs||!1,this.noCompatMode=n.noCompatMode||!1,this.condenseFlow=n.condenseFlow||!1,this.quotingType=n.quotingType==='"'?un:wd,this.forceQuotes=n.forceQuotes||!1,this.replacer=typeof n.replacer=="function"?n.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function Ti(n,e){for(var t=ut.repeat(" ",e),i=0,s=-1,r="",o,a=n.length;i<a;)s=n.indexOf(`
`,i),s===-1?(o=n.slice(i),i=a):(o=n.slice(i,s+1),i=s+1),o.length&&o!==`
`&&(r+=t),r+=o;return r}function Kn(n,e){return`
`+ut.repeat(" ",n.indent*e)}function xd(n,e){var t,i,s;for(t=0,i=n.implicitTypes.length;t<i;t+=1)if(s=n.implicitTypes[t],s.resolve(e))return!0;return!1}function Dn(n){return n===id||n===td}function pn(n){return 32<=n&&n<=126||161<=n&&n<=55295&&n!==8232&&n!==8233||57344<=n&&n<=65533&&n!==oi||65536<=n&&n<=1114111}function Mi(n){return pn(n)&&n!==oi&&n!==nd&&n!==dn}function Ni(n,e,t){var i=Mi(n),s=i&&!Dn(n);return(t?i:i&&n!==Jr&&n!==Qr&&n!==Zr&&n!==Xr&&n!==eo)&&n!==Wn&&!(e===Pn&&!s)||Mi(e)&&!Dn(e)&&n===Wn||e===Pn&&s}function kd(n){return pn(n)&&n!==oi&&!Dn(n)&&n!==dd&&n!==gd&&n!==Pn&&n!==Jr&&n!==Qr&&n!==Zr&&n!==Xr&&n!==eo&&n!==Wn&&n!==ad&&n!==cd&&n!==sd&&n!==md&&n!==ud&&n!==pd&&n!==ld&&n!==rd&&n!==od&&n!==fd&&n!==hd}function Ed(n){return!Dn(n)&&n!==Pn}function an(n,e){var t=n.charCodeAt(e),i;return t>=55296&&t<=56319&&e+1<n.length&&(i=n.charCodeAt(e+1),i>=56320&&i<=57343)?(t-55296)*1024+i-56320+65536:t}function to(n){var e=/^\n* /;return e.test(n)}var no=1,Hn=2,io=3,so=4,Qt=5;function Cd(n,e,t,i,s,r,o,a){var l,d=0,p=null,g=!1,m=!1,h=i!==-1,b=-1,c=kd(an(n,0))&&Ed(an(n,n.length-1));if(e||o)for(l=0;l<n.length;d>=65536?l+=2:l++){if(d=an(n,l),!pn(d))return Qt;c=c&&Ni(d,p,a),p=d}else{for(l=0;l<n.length;d>=65536?l+=2:l++){if(d=an(n,l),d===dn)g=!0,h&&(m=m||l-b-1>i&&n[b+1]!==" ",b=l);else if(!pn(d))return Qt;c=c&&Ni(d,p,a),p=d}m=m||h&&l-b-1>i&&n[b+1]!==" "}return!g&&!m?c&&!o&&!s(n)?no:r===un?Qt:Hn:t>9&&to(n)?Qt:o?r===un?Qt:Hn:m?so:io}function Pd(n,e,t,i,s){n.dump=function(){if(e.length===0)return n.quotingType===un?'""':"''";if(!n.noCompatMode&&(yd.indexOf(e)!==-1||bd.test(e)))return n.quotingType===un?'"'+e+'"':"'"+e+"'";var r=n.indent*Math.max(1,t),o=n.lineWidth===-1?-1:Math.max(Math.min(n.lineWidth,40),n.lineWidth-r),a=i||n.flowLevel>-1&&t>=n.flowLevel;function l(d){return xd(n,d)}switch(Cd(e,a,n.indent,o,l,n.quotingType,n.forceQuotes&&!i,s)){case no:return e;case Hn:return"'"+e.replace(/'/g,"''")+"'";case io:return"|"+Ai(e,n.indent)+Oi(Ti(e,r));case so:return">"+Ai(e,n.indent)+Oi(Ti(Dd(e,o),r));case Qt:return'"'+Td(e)+'"';default:throw new yt("impossible error: invalid scalar style")}}()}function Ai(n,e){var t=to(n)?String(e):"",i=n[n.length-1]===`
`,s=i&&(n[n.length-2]===`
`||n===`
`),r=s?"+":i?"":"-";return t+r+`
`}function Oi(n){return n[n.length-1]===`
`?n.slice(0,-1):n}function Dd(n,e){for(var t=/(\n+)([^\n]*)/g,i=function(){var d=n.indexOf(`
`);return d=d!==-1?d:n.length,t.lastIndex=d,Ii(n.slice(0,d),e)}(),s=n[0]===`
`||n[0]===" ",r,o;o=t.exec(n);){var a=o[1],l=o[2];r=l[0]===" ",i+=a+(!s&&!r&&l!==""?`
`:"")+Ii(l,e),s=r}return i}function Ii(n,e){if(n===""||n[0]===" ")return n;for(var t=/ [^ ]/g,i,s=0,r,o=0,a=0,l="";i=t.exec(n);)a=i.index,a-s>e&&(r=o>s?o:a,l+=`
`+n.slice(s,r),s=r+1),o=a;return l+=`
`,n.length-s>e&&o>s?l+=n.slice(s,o)+`
`+n.slice(o+1):l+=n.slice(s),l.slice(1)}function Td(n){for(var e="",t=0,i,s=0;s<n.length;t>=65536?s+=2:s++)t=an(n,s),i=ft[t],!i&&pn(t)?(e+=n[s],t>=65536&&(e+=n[s+1])):e+=i||_d(t);return e}function Md(n,e,t){var i="",s=n.tag,r,o,a;for(r=0,o=t.length;r<o;r+=1)a=t[r],n.replacer&&(a=n.replacer.call(t,String(r),a)),(Ot(n,e,a,!1,!1)||typeof a=="undefined"&&Ot(n,e,null,!1,!1))&&(i!==""&&(i+=","+(n.condenseFlow?"":" ")),i+=n.dump);n.tag=s,n.dump="["+i+"]"}function Li(n,e,t,i){var s="",r=n.tag,o,a,l;for(o=0,a=t.length;o<a;o+=1)l=t[o],n.replacer&&(l=n.replacer.call(t,String(o),l)),(Ot(n,e+1,l,!0,!0,!1,!0)||typeof l=="undefined"&&Ot(n,e+1,null,!0,!0,!1,!0))&&((!i||s!=="")&&(s+=Kn(n,e)),n.dump&&dn===n.dump.charCodeAt(0)?s+="-":s+="- ",s+=n.dump);n.tag=r,n.dump=s||"[]"}function Nd(n,e,t){var i="",s=n.tag,r=Object.keys(t),o,a,l,d,p;for(o=0,a=r.length;o<a;o+=1)p="",i!==""&&(p+=", "),n.condenseFlow&&(p+='"'),l=r[o],d=t[l],n.replacer&&(d=n.replacer.call(t,l,d)),Ot(n,e,l,!1,!1)&&(n.dump.length>1024&&(p+="? "),p+=n.dump+(n.condenseFlow?'"':"")+":"+(n.condenseFlow?"":" "),Ot(n,e,d,!1,!1)&&(p+=n.dump,i+=p));n.tag=s,n.dump="{"+i+"}"}function Ad(n,e,t,i){var s="",r=n.tag,o=Object.keys(t),a,l,d,p,g,m;if(n.sortKeys===!0)o.sort();else if(typeof n.sortKeys=="function")o.sort(n.sortKeys);else if(n.sortKeys)throw new yt("sortKeys must be a boolean or a function");for(a=0,l=o.length;a<l;a+=1)m="",(!i||s!=="")&&(m+=Kn(n,e)),d=o[a],p=t[d],n.replacer&&(p=n.replacer.call(t,d,p)),Ot(n,e+1,d,!0,!0,!0)&&(g=n.tag!==null&&n.tag!=="?"||n.dump&&n.dump.length>1024,g&&(n.dump&&dn===n.dump.charCodeAt(0)?m+="?":m+="? "),m+=n.dump,g&&(m+=Kn(n,e)),Ot(n,e+1,p,!0,g)&&(n.dump&&dn===n.dump.charCodeAt(0)?m+=":":m+=": ",m+=n.dump,s+=m));n.tag=r,n.dump=s||"{}"}function Ri(n,e,t){var i,s,r,o,a,l;for(s=t?n.explicitTypes:n.implicitTypes,r=0,o=s.length;r<o;r+=1)if(a=s[r],(a.instanceOf||a.predicate)&&(!a.instanceOf||typeof e=="object"&&e instanceof a.instanceOf)&&(!a.predicate||a.predicate(e))){if(t?a.multi&&a.representName?n.tag=a.representName(e):n.tag=a.tag:n.tag="?",a.represent){if(l=n.styleMap[a.tag]||a.defaultStyle,Kr.call(a.represent)==="[object Function]")i=a.represent(e,l);else if(Hr.call(a.represent,l))i=a.represent[l](e,l);else throw new yt("!<"+a.tag+'> tag resolver accepts not "'+l+'" style');n.dump=i}return!0}return!1}function Ot(n,e,t,i,s,r,o){n.tag=null,n.dump=t,Ri(n,t,!1)||Ri(n,t,!0);var a=Kr.call(n.dump),l=i,d;i&&(i=n.flowLevel<0||n.flowLevel>e);var p=a==="[object Object]"||a==="[object Array]",g,m;if(p&&(g=n.duplicates.indexOf(t),m=g!==-1),(n.tag!==null&&n.tag!=="?"||m||n.indent!==2&&e>0)&&(s=!1),m&&n.usedDuplicates[g])n.dump="*ref_"+g;else{if(p&&m&&!n.usedDuplicates[g]&&(n.usedDuplicates[g]=!0),a==="[object Object]")i&&Object.keys(n.dump).length!==0?(Ad(n,e,n.dump,s),m&&(n.dump="&ref_"+g+n.dump)):(Nd(n,e,n.dump),m&&(n.dump="&ref_"+g+" "+n.dump));else if(a==="[object Array]")i&&n.dump.length!==0?(n.noArrayIndent&&!o&&e>0?Li(n,e-1,n.dump,s):Li(n,e,n.dump,s),m&&(n.dump="&ref_"+g+n.dump)):(Md(n,e,n.dump),m&&(n.dump="&ref_"+g+" "+n.dump));else if(a==="[object String]")n.tag!=="?"&&Pd(n,n.dump,e,r,l);else{if(a==="[object Undefined]")return!1;if(n.skipInvalid)return!1;throw new yt("unacceptable kind of an object to dump "+a)}n.tag!==null&&n.tag!=="?"&&(d=encodeURI(n.tag[0]==="!"?n.tag.slice(1):n.tag).replace(/!/g,"%21"),n.tag[0]==="!"?d="!"+d:d.slice(0,18)==="tag:yaml.org,2002:"?d="!!"+d.slice(18):d="!<"+d+">",n.dump=d+" "+n.dump)}return!0}function Od(n,e){var t=[],i=[],s,r;for(Jn(n,t,i),s=0,r=i.length;s<r;s+=1)e.duplicates.push(t[i[s]]);e.usedDuplicates=new Array(r)}function Jn(n,e,t){var i,s,r;if(n!==null&&typeof n=="object")if(s=e.indexOf(n),s!==-1)t.indexOf(s)===-1&&t.push(s);else if(e.push(n),Array.isArray(n))for(s=0,r=n.length;s<r;s+=1)Jn(n[s],e,t);else for(i=Object.keys(n),s=0,r=i.length;s<r;s+=1)Jn(n[i[s]],e,t)}function Id(n,e){e=e||{};var t=new Sd(e);t.noRefs||Od(n,t);var i=n;return t.replacer&&(i=t.replacer.call({"":i},"",i)),Ot(t,0,i,!0,!0)?t.dump+`
`:""}var Ld=Id,Rd={dump:Ld},Fd=ii,$d=ed.load,Ud=Rd.dump;const Qn="mm_uid",Ft={error:(...n)=>{console.error("[ERROR]",...n)},warn:(...n)=>{console.warn("[WARN]",...n)},info:(...n)=>{console.info("[INFO]",...n)},debug:(...n)=>{console.debug("[DEBUG]",...n)}};function ro(n){if(n.startsWith("---")){const e=n.indexOf(`
---`,3);if(e!==-1){const t=n.slice(3,e+1),i=n.slice(e+4);return{frontmatter:t,body:i}}}return{frontmatter:null,body:n}}function oo(n){if(!n)return null;try{const e=$d(n);return typeof e=="object"&&e!==null?e:{}}catch(e){throw Ft.error("[FrontmatterUtils] YAML parse failed:",String(e)),new Error("Malformed frontmatter: "+String(e))}}function jd(n){return Ud(n,{schema:Fd,noRefs:!0,sortKeys:!1})}async function _n(n,e){try{try{const o=n.metadataCache.getFileCache(e);if(o&&o.frontmatter&&typeof o.frontmatter=="object"){const a=o.frontmatter[Qn];if(typeof a=="string")return a;if(a!=null)return String(a)}}catch(o){Ft.debug("[FrontmatterUtils] metadataCache read failed, falling back to file read.",String(o))}const t=await n.vault.read(e),{frontmatter:i}=ro(t);if(!i)return null;const s=oo(i);if(!s)return null;const r=s[Qn];return typeof r=="string"?r:r!=null?String(r):null}catch(t){return Ft.error("[FrontmatterUtils] Failed to read mm_uid for file:",e.path,String(t)),null}}async function zd(n,e,t){try{const i=await n.vault.read(e),{frontmatter:s,body:r}=ro(i);let o={};if(s)try{o=oo(s)||{}}catch(d){throw Ft.error("[FrontmatterUtils] Malformed frontmatter when writing mm_uid for",e.path,String(d)),d}o[Qn]=t;const l=`---
${jd(o).trimEnd()}
---
${r}`;if(n.vault&&typeof n.vault.modify=="function"){await n.vault.modify(e,l),Ft.info("[FrontmatterUtils] Wrote mm_uid to",e.path);return}if(n.vault&&n.vault.adapter&&typeof n.vault.adapter.write=="function"){await n.vault.adapter.write(e.path,l),Ft.info("[FrontmatterUtils] Wrote mm_uid to (adapter) ",e.path);return}await pt.promises.writeFile(e.path,l,{encoding:"utf8"}),Ft.info("[FrontmatterUtils] Wrote mm_uid to (fs) ",e.path)}catch(i){throw Ft.error("[FrontmatterUtils] Failed to write mm_uid for file:",e.path,String(i)),i}}var Mt=(n=>(n.NOT_SYNCED="not-synced",n.SYNCED="synced",n.PRIVATE="private",n.SYNCING="syncing",n.ERROR="error",n))(Mt||{});class Bd{constructor(e,t,i,s,r){this.activeSyncs=new Map,this.syncQueue=[],this.isProcessingQueue=!1,this.app=e,this.settings=t,this.graphitiService=i,this.syncRegistryService=s,this.logger=r,this.logger.info("SyncStatusManager initialized")}async enqueue(e,t="obsidian_mm_individual"){return new Promise((i,s)=>{const r={file:e,source_description:t,resolve:i,reject:s};this.syncQueue.push(r),this.syncQueue.length===1?this.logger.info(`Starting sync for ${e.name}`):this.logger.info(`Sync queued for ${e.name} (position ${this.syncQueue.length} in queue)`),this.processQueue()})}async processQueue(){if(!(this.isProcessingQueue||this.syncQueue.length===0)){for(this.isProcessingQueue=!0;this.syncQueue.length>0;){const e=this.syncQueue.shift();try{const t=await this.syncNote(e.file,e.source_description);e.resolve(t)}catch(t){e.reject(t)}}this.isProcessingQueue=!1}}updateSettings(e){this.settings=e,this.logger.setDebug(e.enableDebugLogging)}async getNoteSyncStatus(e){var t;try{if(this.activeSyncs.has(e.path))return{status:Mt.SYNCING,reason:"Sync operation in progress"};if(this.isNotePrivate(e))return{status:Mt.PRIVATE,reason:"Note is marked private or in excluded folder"};const i=await _n(this.app,e);if(!i)return{status:Mt.NOT_SYNCED,reason:"Note has no mm_uid - has not been synced to Graphiti"};const s=this.app.vault.getName(),r=this.getCurrentDatabaseType(),o=this.syncRegistryService.getSyncRecord(i,s);if(o){const a=o.syncs.find(d=>d.database_id===r);if(a){if(a.error_message)return{status:Mt.ERROR,reason:`Last sync failed: ${a.error_message}`,lastSynced:a.last_sync,episodeId:a.episode_uuid,syncType:a.source_description};const d=(t=a.source_description)!=null&&t.includes("individual")?"individual sync":"sync";return{status:Mt.SYNCED,reason:`Note has been synced to Graphiti (${d})`,lastSynced:a.last_sync,episodeId:a.episode_uuid,syncType:a.source_description}}const l=o.syncs.map(d=>d.database_id).join(", ");return{status:Mt.NOT_SYNCED,reason:`Note was synced to other databases (${l}) but not current database (${r})`}}return{status:Mt.NOT_SYNCED,reason:`Note has mm_uid (${i}) but no sync record found - may need re-sync`}}catch(i){return this.logger.error("Error determining sync status",{file:e.path,error:i}),{status:Mt.ERROR,reason:`Error determining status: ${i instanceof Error?i.message:String(i)}`}}}getStatus(e){var t;try{if(this.activeSyncs.has(e.path))return"SYNCING";if(this.isNotePrivate(e))return"PRIVATE";const i=this.app.metadataCache.getFileCache(e),s=(t=i==null?void 0:i.frontmatter)==null?void 0:t.mm_uid;if(!s||typeof s!="string")return"NOT_SYNCED";const r=this.app.vault.getName(),o=this.getCurrentDatabaseType(),a=this.syncRegistryService.getSyncRecord(s,r);if(a){const l=a.syncs.find(d=>d.database_id===o);return l?l.error_message?"ERROR":"SYNCED":"NOT_SYNCED"}return"NOT_SYNCED"}catch(i){return this.logger.error("Error getting sync status",{file:e.path,error:i}),"ERROR"}}extractMmUidFromSyncResult(e){var t,i,s,r;try{if(e.episode_uuid&&typeof e.episode_uuid=="string")return this.logger.debug(`Extracted mm_uid from top-level episode_uuid: ${e.episode_uuid}`),e.episode_uuid;if(e.notes&&Array.isArray(e.notes))for(const o of e.notes){if(o.episode_uuid&&typeof o.episode_uuid=="string")return this.logger.debug("Extracted mm_uid from notes array episode_uuid",{mmUid:o.episode_uuid}),o.episode_uuid;if((i=(t=o.graphiti_response)==null?void 0:t.episode)!=null&&i.uuid&&typeof o.graphiti_response.episode.uuid=="string")return this.logger.debug("Extracted mm_uid from graphiti_response.episode.uuid",{mmUid:o.graphiti_response.episode.uuid}),o.graphiti_response.episode.uuid}if(e.pythonStdout&&typeof e.pythonStdout=="string"){const o=e.pythonStdout.split(`
`);for(const a of o)if(a.trim())try{const l=JSON.parse(a);if(l.episode_uuid&&typeof l.episode_uuid=="string")return this.logger.debug("Extracted mm_uid from Python stdout top-level",{mmUid:l.episode_uuid}),l.episode_uuid;if(l.notes&&Array.isArray(l.notes))for(const d of l.notes){if(d.episode_uuid&&typeof d.episode_uuid=="string")return this.logger.debug(`Extracted mm_uid from Python stdout notes array: ${d.episode_uuid}`),d.episode_uuid;if((r=(s=d.graphiti_response)==null?void 0:s.episode)!=null&&r.uuid&&typeof d.graphiti_response.episode.uuid=="string")return this.logger.debug(`Extracted mm_uid from Python stdout graphiti_response: ${d.graphiti_response.episode.uuid}`),d.graphiti_response.episode.uuid}}catch(l){continue}}return this.logger.warn("Could not extract mm_uid from sync result",{result:e}),null}catch(o){return this.logger.error("Error extracting mm_uid from sync result",{error:o,result:e}),null}}isNotePrivate(e){var t;try{if(this.settings.excludedFolders.some(r=>e.path.startsWith(r.endsWith("/")?r:r+"/")))return this.logger.debug("Note is in excluded folder",{file:e.path,excludedFolders:this.settings.excludedFolders}),!0;if(this.settings.includedFolders.length>0&&!this.settings.includedFolders.some(o=>e.path.startsWith(o.endsWith("/")?o:o+"/")))return this.logger.debug("Note is not in included folders",{file:e.path,includedFolders:this.settings.includedFolders}),!0;const s=this.app.metadataCache.getFileCache(e);return((t=s==null?void 0:s.frontmatter)==null?void 0:t.private)===!0?(this.logger.debug("Note marked as private in frontmatter",{file:e.path}),!0):!1}catch(i){return this.logger.error("Error checking if note is private",{file:e.path,error:i}),!1}}getCurrentDatabaseType(){return this.settings.databaseType||"neo4j"}async syncNote(e,t="obsidian_mm_individual"){this.logger.debug("[SYNC-DIAGNOSIS] SyncStatusManager.syncNote() called - this path INCLUDES registry recording");const i=e.path;try{if(this.activeSyncs.has(i))throw new Error("Note is already being synced");if(this.isNotePrivate(e))throw new Error("Cannot sync private note");this.logger.info(`Starting sync for file: ${i}`),this.activeSyncs.set(i,!0);const r=this.app.vault.adapter.basePath,o=this.normalizeNotePath(i,r);this.logger.debug("[SYNC-DIAGNOSIS] Initiating individual note sync",{file:o,vaultPath:r});const a=await this.graphitiService.testManualSync(o,t);if(a.status==="success"){const l=this.extractMmUidFromSyncResult(a);l||this.logger.warn("Sync completed but no mm_uid extracted from result",{file:i,result:a}),await this.updateNoteProperties(e,a,t,l||void 0),this.settings.showNotifications&&new P.Notice(`[SUCCESS] ${e.name} synced successfully`)}else{const l=await _n(this.app,e),d=this.app.vault.getName(),p=this.getCurrentDatabaseType(),g=a.message||"Sync failed";try{l?await this.syncRegistryService.addOrUpdateSyncRecord({mmUid:l,notePath:e.path,vaultId:d,syncEntry:{database_id:p,group_id:await this.syncRegistryService.generateGroupId(e.path,d),episode_uuid:l,last_sync:new Date().toISOString(),source_description:t,error_message:g}}):await this.syncRegistryService.addOrUpdateSyncRecord({mmUid:`error-${Date.now()}`,notePath:e.path,vaultId:d,syncEntry:{database_id:p,group_id:await this.syncRegistryService.generateGroupId(e.path,d),episode_uuid:`error-${Date.now()}`,last_sync:new Date().toISOString(),source_description:t,error_message:g}})}catch(m){this.logger.error("Failed to record sync error in registry",{error:m,file:i,mmUid:l||"none"})}this.settings.showNotifications&&new P.Notice(`[ERROR] Failed to sync ${e.name}: ${g}`),this.logger.error(`Note sync failed for ${i}: ${a.message||"Unknown error"}`,{mmUid:l||"none"})}return a}catch(s){const r=s instanceof Error?s.message:String(s);return this.settings.showNotifications&&new P.Notice(`[ERROR] Sync error for ${e.name}: ${r}`),this.logger.error("Note sync error",{file:i,error:s}),{status:"error",processed:0,skipped:0,total:1,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:r}}finally{this.activeSyncs.has(i)&&(this.activeSyncs.delete(i),this.logger.debug("[RACE-FIX] Cleaned up activeSyncs in finally block (error case)",{file:i}))}}async updateNoteProperties(e,t,i="obsidian_manual",s){const r=e.path;try{const o=await _n(this.app,e),a=s||this.extractMmUidFromSyncResult(t);if(!a){this.logger.warn("No mm_uid found in sync result for note properties update",{file:e.path,result:t});return}this.activeSyncs.delete(r);const l=this.app.vault.getName(),d=this.getCurrentDatabaseType(),p=new Date().toISOString();o?(this.logger.debug(`Note already has mm_uid in frontmatter: ${o}, preserving original`),await this.syncRegistryService.addOrUpdateSyncRecord({mmUid:o,notePath:e.path,vaultId:l,syncEntry:{database_id:d,group_id:await this.syncRegistryService.generateGroupId(e.path,l),episode_uuid:a,last_sync:p,source_description:i}}),this.logger.info(`Updated existing sync record for ${e.path} with preserved mm_uid: ${o}`)):(await zd(this.app,e,a),this.logger.debug(`Written mm_uid to frontmatter: ${e.path} -> ${a}`),await this.syncRegistryService.addOrUpdateSyncRecord({mmUid:a,notePath:e.path,vaultId:l,syncEntry:{database_id:d,group_id:await this.syncRegistryService.generateGroupId(e.path,l),episode_uuid:a,last_sync:p,source_description:i}}),this.logger.info(`Created new sync record and frontmatter for ${e.path} with mm_uid: ${a}`))}catch(o){throw this.logger.error(`Failed to update note properties for ${e.path}`,{error:o,mmUid:s||this.extractMmUidFromSyncResult(t)||"none"}),o}}generateEpisodeId(e){if(e.episode_uuid)return this.logger.debug("Generated Episode ID: Top-level episode_uuid found.",{episodeId:e.episode_uuid}),e.episode_uuid;if(e.notes&&Array.isArray(e.notes))for(const r of e.notes){if(r.episode_uuid)return this.logger.debug("Extracted episode UUID from result.notes",{episodeId:r.episode_uuid}),r.episode_uuid;if(r.graphiti_response&&r.graphiti_response.episode&&r.graphiti_response.episode.uuid)return this.logger.debug("Extracted episode UUID from graphiti_response.episode.uuid",{episodeId:r.graphiti_response.episode.uuid}),r.graphiti_response.episode.uuid}if(e.pythonStdout)try{const r=e.pythonStdout.split(`
`);for(const o of r)if(o.trim())try{const a=JSON.parse(o);if(a.notes&&Array.isArray(a.notes))for(const l of a.notes){if(l.episode_uuid)return this.logger.debug("Generated Episode ID: Extracted from Python stdout notes array.",{episodeId:l.episode_uuid}),l.episode_uuid;if(l.graphiti_response&&l.graphiti_response.episode&&l.graphiti_response.episode.uuid)return this.logger.debug("Generated Episode ID: Extracted from Python stdout graphiti_response.episode.uuid in notes array.",{episodeId:l.graphiti_response.episode.uuid}),l.graphiti_response.episode.uuid}if(a.episode_uuid||a.episodeId){const l=a.episode_uuid||a.episodeId;return this.logger.debug("Generated Episode ID: Extracted from Python stdout top-level.",{episodeId:l}),l}}catch(a){this.logger.debug("generateEpisodeId: Could not parse Python stdout line as JSON (skipping)",{line:o});continue}}catch(r){this.logger.debug("generateEpisodeId: Could not parse episode UUID from Python stdout (overall error).",{error:r})}const t=Date.now(),i=Math.random().toString(36).substring(2,8),s=`episode-${t}-${i}`;return this.logger.warn("Generated Episode ID: Fallback ID generated (UUID not found in result).",{fallbackId:s,originalResult:e}),s}updateFrontmatter(e,t){const i=e.split(`
`);if(i[0]==="---"){let r=-1;for(let o=1;o<i.length;o++)if(i[o]==="---"){r=o;break}if(r!==-1){const o=i.slice(r+1).join(`
`);return`---
${this.serializeFrontmatter(t)}---
${o}`}}return`---
${this.serializeFrontmatter(t)}---
${e}`}serializeFrontmatter(e){let t="";for(const[i,s]of Object.entries(e))typeof s=="string"?t+=`${i}: "${s}"
`:t+=`${i}: ${s}
`;return t}getActiveSync(e){return this.activeSyncs.has(e)}getActiveSyncs(){return Array.from(this.activeSyncs.keys())}normalizeNotePath(e,t=null){let i=Ke.normalize(e);process.platform==="win32"&&i.startsWith("/")&&(i=i.substring(1)),i=i.replace(/\\/g,"/");const s=this.app.vault.getName();if(i.startsWith(s+"/")&&(i=i.substring(s.length+1)),t){let r=Ke.resolve(t,i);r=r.replace(/\\/g,"/");const o=r.split("/"),a=[],l=new Set;for(const d of o)d!==""&&(l.has(d)?a[a.length-1]!==d&&a.push(d):(a.push(d),l.add(d)));return r=a.join("/"),process.platform!=="win32"&&!r.startsWith("/")?r=`/${r}`:process.platform==="win32"&&/^[a-zA-Z]:\//.test(r),Ke.normalize(r).replace(/\\/g,"/")}return i}destroy(){this.activeSyncs.clear(),this.logger.info("SyncStatusManager destroyed")}}class Vd{constructor(e,t,i){this.settings=e,this.app=t,this.logger=i}async resolveFolderForNote(e,t,i){try{if(i){const o=await this.validateAndCreateFolder(i,this.app.vault);return{success:o,folderPath:i,message:o?"Target folder validated":"Failed to validate target folder",created:!1}}const s=this.settings.mcpTools.defaults.inboxFolder||"",r=await this.validateAndCreateFolder(s,this.app.vault);return{success:r,folderPath:s,message:r?"Default folder resolved":"Failed to resolve default folder",created:!1}}catch(s){return this.logger.error("Error resolving folder for note",s),{success:!1,folderPath:"",message:`Error: ${s instanceof Error?s.message:String(s)}`}}}async validateAndCreateFolder(e,t){try{if(!e||e.trim()==="")return this.logger.debug("validateAndCreateFolder: empty folderPath, using vault root"),!0;const i=e.replace(/\\/g,"/").replace(/^\/+|\/+$/g,""),s=t==null?void 0:t.adapter;let r=!1;if(s&&typeof s.exists=="function")try{r=await s.exists(i)}catch(d){this.logger.warn("validateAndCreateFolder: adapter.exists threw, falling back to vault.getAbstractFileByPath",d),r=!1}if(!r)try{r=!!t.getAbstractFileByPath(i)}catch(d){r=!1}if(r)return this.logger.debug("validateAndCreateFolder: folder exists",{folderPath:i}),!0;const o=i.split("/").filter(Boolean);let a="",l=!1;for(const d of o){a=a?`${a}/${d}`:d;try{let p=!1;s&&typeof s.exists=="function"&&(p=await s.exists(a)),p||(typeof t.createFolder=="function"?(await t.createFolder(a),l=!0,this.logger.info("validateAndCreateFolder: created folder",{path:a})):s&&typeof s.mkdir=="function"?(await s.mkdir(a),l=!0,this.logger.info("validateAndCreateFolder: created folder via adapter.mkdir",{path:a})):this.logger.warn("validateAndCreateFolder: no method to create folder found",{path:a}))}catch(p){return this.logger.error("validateAndCreateFolder: failed to create folder segment",{path:a,error:p}),!1}}return this.logger.debug("validateAndCreateFolder: validation complete",{folderPath:i,created:l}),!0}catch(i){return this.logger.error("validateAndCreateFolder: unexpected error",i),!1}}generatePeriodicNotePath(e,t){const i=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${i}-${s}-${r}.md`}}const Kt="0.9.5",Gd={win32:{x64:`https://github.com/astral-sh/uv/releases/download/${Kt}/uv-x86_64-pc-windows-msvc.zip`,arm64:`https://github.com/astral-sh/uv/releases/download/${Kt}/uv-aarch64-pc-windows-msvc.zip`},darwin:{x64:`https://github.com/astral-sh/uv/releases/download/${Kt}/uv-x86_64-apple-darwin.tar.gz`,arm64:`https://github.com/astral-sh/uv/releases/download/${Kt}/uv-aarch64-apple-darwin.tar.gz`},linux:{x64:`https://github.com/astral-sh/uv/releases/download/${Kt}/uv-x86_64-unknown-linux-gnu.tar.gz`,arm64:`https://github.com/astral-sh/uv/releases/download/${Kt}/uv-aarch64-unknown-linux-gnu.tar.gz`}},Yd={win32:{x64:"",arm64:""},darwin:{x64:"",arm64:""},linux:{x64:"",arm64:""}};class gn{constructor(e,t,i){this.plugin=e,this.pluginDir=t,this.settings=i,this.installInProgress=!1,this.logger=new Gt(e,!1),this.logger.init()}async checkAllDependencies(){const e=this.getAppDataPath(),t=Ke.join(e,"venv"),i=this.getVenvPython(t),s=await this.findSystemPython(),r=await this.isUvInstalled(),o=this.settings.pythonPath||null,a=await this.pathExists(t),l=a?await this.testVenv(i):!1,d=l;let p=null;if(l)try{p=await this.exec(i,["-c","import importlib.metadata; print(importlib.metadata.version('graphiti-core'))"]),p=p.trim()}catch(m){p=null}const g=this.detectMismatch({dataJsonPython:o,venvExists:a,venvValid:l,venvPath:i});return{systemPython:s,uvInstalled:r,uvPythonPath:null,dataJsonPython:o,dataJsonMethod:null,venvPath:t,venvExists:a,venvPythonPath:i,venvValid:l,graphitiInstalled:d,graphitiVersion:p,mismatch:g}}async installDependencies(e,t){if(this.installInProgress)throw new Error("Installation already in progress");this.installInProgress=!0;try{const i=this.getAppDataPath(),s=Ke.join(i,"venv");this.logger.info("[INFO] Checking disk space",{path:i,requiredMB:500});const r=await this.checkDiskSpace(i,500);if(this.logger.info("[INFO] Disk space check result",{hasSpace:r,path:i}),!r)throw new Error("Insufficient disk space (500MB required)");if(await pt.promises.mkdir(i,{recursive:!0}),e==="system"){t==null||t("Finding system Python...",10);const l=await this.findSystemPython();if(!l)throw new Error("No Python 3.11+ found on system");this.logger.info("[INFO] Using system Python",{path:l.path,version:l.version}),t==null||t("Creating virtual environment...",30),await this.createVenv(l.path,s)}else t==null||t("Downloading uv package manager...",10),await this.installUv(i),t==null||t("Installing Python 3.11 via uv...",30),await this.runUv(i,["python","install","3.11"]),t==null||t("Creating virtual environment...",50),await this.runUv(i,["venv",s,"--python","3.11","--clear"]);const o=this.getVenvPython(s);if(t==null||t("Installing dependencies...",70),await this.installDeps(e,i,o),t==null||t("Verifying installation...",90),!await this.testVenv(o))throw new Error("Installation validation failed");return t==null||t("Installation complete!",100),this.logger.info("[SUCCESS] Python environment installed",{path:o}),o}catch(i){const s=Ke.join(this.getAppDataPath(),"venv");throw await this.pathExists(s)&&(await pt.promises.rm(s,{recursive:!0,force:!0}),this.logger.info("[INFO] Cleaned up partial installation")),this.logger.error("[ERROR] Installation failed",i),i}finally{this.installInProgress=!1}}async findSystemPython(){const e=this.getPythonCandidates();for(const t of e)try{const i=await this.exec(t,["--version"]),s=i.match(/Python (\d+)\.(\d+)\.(\d+)/);if(s){const[,r,o]=s.map(Number);if(r===3&&o>=11)return{path:t,version:i.trim()}}}catch(i){continue}return null}async testVenv(e){try{return(await this.exec(e,["-c",'import graphiti_core; print("OK")'])).trim()==="OK"}catch(t){return!1}}async createVenv(e,t){await this.exec(e,["-m","venv",t])}getVenvPython(e){return process.platform==="win32"?Ke.join(e,"Scripts","python.exe"):Ke.join(e,"bin","python")}getAppDataPath(){const e=nl.homedir(),t=process.platform;let i;return t==="win32"?i=process.env.LOCALAPPDATA||Ke.join(e,"AppData","Local"):t==="darwin"?i=Ke.join(e,"Library","Application Support"):i=Ke.join(e,".local","share"),Ke.join(i,"MegaMem","python")}async isUvInstalled(){const e=this.getAppDataPath(),t=this.getUvPath(e);return await this.pathExists(t)}async installUv(e){var d,p;const t=Ke.join(e,"bin");await pt.promises.mkdir(t,{recursive:!0});const i=process.platform,s=process.arch==="arm64"?"arm64":"x64",r=(d=Gd[i])==null?void 0:d[s];if(!r)throw new Error(`Unsupported platform: ${i} ${s}`);const o=r.endsWith(".zip"),a=Ke.join(e,o?"uv.zip":"uv.tar.gz");this.logger.info("[INFO] Downloading uv",{url:r}),await this.downloadFile(r,a);const l=(p=Yd[i])==null?void 0:p[s];if(l){if(!await this.verifyChecksum(a,l))throw await pt.promises.unlink(a),new Error("Checksum verification failed for uv download");this.logger.info("[SUCCESS] UV checksum verified")}else this.logger.warn("[WARNING] UV checksum not configured - skipping verification (security risk)");if(o?await this.extractZip(a,t):await this.extractTar(a,t),await pt.promises.unlink(a),i!=="win32"){const g=this.getUvPath(e);await pt.promises.chmod(g,493)}this.logger.info("[SUCCESS] uv installed")}async runUv(e,t){const i=this.getUvPath(e);return await this.exec(i,t)}getUvPath(e){const t=process.platform,i=Ke.join(e,"bin");return t==="win32"?Ke.join(i,"uv.exe"):Ke.join(i,"uv")}async exec(e,t){return new Promise((i,s)=>{var l,d;const r=Nt.spawn(e,t,{stdio:["ignore","pipe","pipe"]});let o="",a="";(l=r.stdout)==null||l.on("data",p=>{o+=p.toString()}),(d=r.stderr)==null||d.on("data",p=>{a+=p.toString()}),r.on("close",p=>{p===0?i(o):s(new Error(`Command failed: ${e} ${t.join(" ")}
${a}`))}),r.on("error",p=>{s(p)})})}async pathExists(e){try{return await pt.promises.access(e),!0}catch(t){return!1}}detectMismatch(e){return e.venvExists?e.venvValid?e.dataJsonPython&&e.dataJsonPython!==e.venvPath?{detected:!0,description:"Configured Python path does not match venv path"}:{detected:!1,description:""}:{detected:!0,description:"Virtual environment exists but is invalid"}:{detected:!1,description:""}}getPythonCandidates(){return process.platform==="win32"?["py","python","python3"]:["python3","python"]}async downloadFile(e,t){const i=require("https"),s=require("fs");return new Promise((r,o)=>{i.get(e,a=>{if(a.statusCode===301||a.statusCode===302)return this.downloadFile(a.headers.location,t).then(r).catch(o);const l=s.createWriteStream(t);a.pipe(l),l.on("finish",()=>{l.close(),r()}),l.on("error",d=>{s.unlink(t,()=>{}),o(d)})}).on("error",o)})}async extractZip(e,t){const{exec:i}=require("child_process"),{promisify:s}=require("util"),r=s(i);if(process.platform==="win32"){const a=Ke.join(Ke.dirname(t),"uv-temp");await r(`powershell -command "Expand-Archive -Path '${e}' -DestinationPath '${a}' -Force"`);const d=(await pt.promises.readdir(a,{withFileTypes:!0})).find(p=>p.isDirectory());if(d){const p=Ke.join(a,d.name,"uv.exe"),g=Ke.join(t,"uv.exe");await pt.promises.rename(p,g),await pt.promises.rm(a,{recursive:!0,force:!0})}else{const p=Ke.join(a,"uv.exe"),g=Ke.join(t,"uv.exe");await pt.promises.rename(p,g),await pt.promises.rm(a,{recursive:!0,force:!0})}}else await r(`unzip -jo "${e}" "*/uv" -d "${t}"`)}async extractTar(e,t){const{exec:i}=require("child_process"),{promisify:s}=require("util");await s(i)(`tar -xzf "${e}" -C "${t}" --strip-components=1`)}async verifyChecksum(e,t){return new Promise((i,s)=>{const r=il.createHash("sha256"),a=require("fs").createReadStream(e);a.on("data",l=>r.update(l)),a.on("end",()=>i(r.digest("hex")===t)),a.on("error",s)})}async checkDiskSpace(e,t){try{const i=process.platform,r=await pt.promises.stat(e).catch(()=>null)?e:Ke.dirname(e);if(i==="win32"){const o=await this.exec("wmic",["logicaldisk","get","freespace,caption"]),a=r.charAt(0).toUpperCase();this.logger.info("[INFO] Checking disk space on Windows",{drive:a,checkPath:r});const l=o.split(`
`);for(const d of l)if(d.includes(a+":")){const p=d.trim().split(/\s+/);this.logger.info("[INFO] Found drive line",{line:d,parts:p});const g=parseInt(p[p.length===2?1:0]),m=g>=t*1024*1024;return this.logger.info("[INFO] Disk space calculation",{freeSpace:g,requiredBytes:t*1024*1024,hasEnoughSpace:m}),m}}else{const a=(await this.exec("df",["-k",r])).split(`
`);if(a.length>1){const l=a[1].trim().split(/\s+/);return parseInt(l[3])>=t*1024}}}catch(i){this.logger.warn("[WARNING] Could not check disk space",{error:i})}return!0}async installDeps(e,t,i){const s=Ke.resolve(this.pluginDir,"mcp-server","requirements.txt");this.logger.info("[INFO] Installing dependencies",{reqPath:s,pythonPath:i,method:e}),e==="uv"?await this.runUv(t,["pip","install","--python",i,"-r",s]):(await this.exec(i,["-m","pip","install","--upgrade","pip"]),await this.exec(i,["-m","pip","install","-r",s]));try{const r=await this.exec(i,["-c","import importlib.metadata; print(importlib.metadata.version('graphiti-core'))"]);this.logger.info("[SUCCESS] graphiti-core installed",{version:r.trim()})}catch(r){this.logger.warn("[WARNING] Could not determine graphiti-core version")}}getPythonEnv(){const e=this.getAppDataPath(),t=Ke.join(e,"venv"),i=process.platform==="win32"?Ke.join(t,"Scripts"):Ke.join(t,"bin"),s=this.pluginDir+Ke.delimiter+(process.env.PYTHONPATH||"");return{...process.env,PATH:`${i}${Ke.delimiter}${process.env.PATH}`,PYTHONPATH:s,PYTHON_EXECUTABLE:this.getVenvPython(t)}}getPythonExecutable(){const e=this.getAppDataPath(),t=Ke.join(e,"venv");return this.getVenvPython(t)}}class ao{constructor(e,t,i,s,r){this.pythonProcess=null,this.mcpServerProcess=null,this.activeProcesses=new Set,this.isCancelled=!1,this.pathCache=new Map,this.cacheHits=0,this.cacheMisses=0,this.lastCacheLogTime=0,this.plugin=e,this.settings=t,this.schemaService=new Lr(e.app),this.logger=new Gt(e,t.enableDebugLogging),this.noteSelectionService=new gl(e.app,e,this.logger),this.syncRegistryService=i,this.syncStatusManager=s,this.vaultRegistryService=r,this.pythonInstaller=new gn(e,this.getPluginDirectory(),{pythonPath:t.pythonPath}),this.logger.info("GraphitiService initialized"),this.logger.logSystemInfo()}invalidatePathCache(e){e?(this.pathCache.delete(e),this.logger.debug(`[PATHS] Invalidated cache for vault: ${e}`)):(this.pathCache.clear(),this.logger.debug("[PATHS] Cleared entire path cache"))}updateSettings(e){this.settings=e,this.logger.setDebug(e.enableDebugLogging),this.logger.debug("Settings updated in GraphitiService",{debugMode:e.enableDebugLogging})}getCurrentEmbeddingDimensions(){return this.settings.embedderProvider==="ollama"?String(this.settings.ollamaEmbeddingDim||768):"1536"}async initialize(){this.vaultRegistryService.onActiveVaultChange(t=>{t?this.invalidatePathCache(t):this.invalidatePathCache(),this.getVaultAwarePaths(t)}),this.vaultRegistryService.onRegistryUpdate(()=>{this.invalidatePathCache()});const e=this.vaultRegistryService.getActiveVaultId();e?this.getVaultAwarePaths(e):this.getVaultAwarePaths(null),this.initializeMCPToolsServices()}initializeMCPToolsServices(){this.mcpFolderResolver=new Vd(this.settings,this.plugin.app,this.logger),this.logger.debug("MCP tools services initialized")}getPythonExecutable(){return this.pythonInstaller.getPythonEnv().PYTHON_EXECUTABLE||"python"}getPythonEnv(){return this.pythonInstaller.getPythonEnv()}async resolveMCPNoteFolder(e,t,i){return this.mcpFolderResolver||this.initializeMCPToolsServices(),await this.mcpFolderResolver.resolveFolderForNote(e,t,i)}async syncNotesWithSettings(e,t,i="obsidian_mm_individual"){try{let s;if(e?s=e:this.settings.syncOptions==="new_only"?s=(await this.noteSelectionService.getNotesForAutoSync()).map(l=>l.path):s=(await this.noteSelectionService.getFilteredSyncableNotes()).map(l=>l.path),s.length===0)return{status:"error",processed:0,skipped:0,total:0,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:"No notes available for sync after applying settings filters"};const r={notesPaths:s,batchSize:this.settings.batchSize||10,debug:this.settings.enableDebugLogging,source_description:i,crossEncoderClient:this.settings.crossEncoderClient,crossEncoderModel:this.settings.crossEncoderModel,use_custom_ontology:this.settings.useCustomOntology};this.logger.info("Starting settings-based sync",{totalNotes:s.length,batchSize:r.batchSize,includedFolders:this.settings.includedFolders,excludedFolders:this.settings.excludedFolders});const o=await this.syncNotes(r,t,i);return this.logger.debug(`SYNC_COMPLETE: syncNotesWithSettings() finished - status: ${o.status}, processed: ${o.processed}, skipped: ${o.skipped}, total: ${o.total}, batches: ${o.batchCount}`),o}catch(s){return this.logger.error("Settings-based sync failed",s),{status:"error",processed:0,skipped:0,total:0,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:s instanceof Error?s.message:String(s)}}}async autoSync(e){if(!this.settings.autoSync&&e!=="manual")return{status:"error",processed:0,skipped:0,total:0,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:"Auto-sync is disabled in settings"};let t;e==="manual"?t="obsidian_mm_individual":this.settings.syncOptions==="new_only"?t="obsidian_auto_new":t="obsidian_auto_updated",this.logger.debug("Enhanced auto-sync triggered",{triggerType:e,source_description:t,autoSyncEnabled:this.settings.autoSync,syncOptions:this.settings.syncOptions,syncInterval:this.settings.syncInterval});const i=await this.noteSelectionService.getNotesForAutoSync(this.settings.syncOptions);if(i.length===0)return this.logger.debug("No notes found for auto-sync based on current sync options",{syncOptions:this.settings.syncOptions,triggerType:e,source_description:t}),{status:"success",processed:0,skipped:0,total:0,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:"No notes to sync based on current sync options"};const s=i.map(r=>r.path);return this.logger.debug("Auto-sync processing notes",{triggerType:e,source_description:t,totalNotes:s.length,syncOptions:this.settings.syncOptions,notesSample:s.slice(0,3)}),await this.noteSelectionService.selectNotes(s),this.logger.debug("Auto-sync selected notes into queue for sequential processing",{selectedCount:s.length}),await this.syncSelectedNotes(r=>{this.logger.debug("Enhanced auto-sync progress",{triggerType:e,source_description:t,syncOptions:this.settings.syncOptions,progress:r})},t)}async testConnection(){try{const e=await this.executePythonCommand(["-c",'import sys; import graphiti_core; print(f"Python {sys.version_info.major}.{sys.version_info.minor}, Graphiti installed")']);return e.success&&e.output?{success:!0,message:` Connection successful: ${e.output.trim()}`}:{success:!1,message:` Connection failed: ${e.error||"Unknown error"}`}}catch(e){return{success:!1,message:` Connection test failed: ${e instanceof Error?e.message:String(e)}`}}}async installDependencies(e){return new Promise(t=>{var i,s;try{this.logger.info("Starting dependency installation process");const{pluginDir:r,bridgeDir:o}=this.getVaultAwarePaths(),a=Ge.join(o,"install.py");if(this.logger.debug("Installation paths:",{pluginDir:r,bridgePath:o,installPath:a}),!require("fs").existsSync(a)){const C=`Install script not found at: ${a}`;this.logger.error(C),t({success:!1,message:` ${C}`});return}e==null||e("Starting Python dependency installation..."),this.logger.info("Executing Python install script");const d="python",p=[a,"--llm-provider",this.settings.llmProvider,"--embedder-provider",this.settings.embedderProvider];this.logger.debug("Command:",{command:d,args:p});const{spawn:g}=require("child_process"),m=this.getPythonExecutable(),h=this.getPythonEnv(),b=g(m,p,{stdio:["pipe","pipe","pipe"],cwd:o,env:h});let c="",v="",w=Date.now();(i=b.stdout)==null||i.on("data",C=>{const x=C.toString();c+=x,this.logger.logPythonOutput("stdout",x);const N=x.split(`
`);for(const k of N)if(k.trim()){const T=Date.now();T-w>100&&(k.includes("Installing")?e==null||e(`Installing: ${k.trim()}`):k.includes("Downloading")?e==null||e(`Downloading: ${k.trim()}`):k.includes("Collecting")?e==null||e(`Collecting: ${k.trim()}`):k.includes("Building")?e==null||e(`Building: ${k.trim()}`):k.includes("Successfully")?e==null||e(` ${k.trim()}`):k.includes("Requirement already satisfied")?e==null||e(` ${k.trim()}`):k.trim().length>0&&(e==null||e(` ${k.trim()}`)),w=T)}}),(s=b.stderr)==null||s.on("data",C=>{const x=C.toString();v+=x,this.logger.logPythonOutput("stderr",x),x.includes("%")||x.includes("Downloading")||x.includes("Installing")?e==null||e(` ${x.trim()}`):(x.includes("ERROR")||x.includes("error"))&&(this.logger.error("Python error output:",x),e==null||e(` Error: ${x.trim()}`))}),b.on("close",C=>{if(this.logger.debug("Process closed",{exitCode:C}),C===0)e==null||e(" Installation completed successfully!"),this.logger.info("Installation completed successfully"),t({success:!0,message:" Dependencies installed successfully"});else{const x=`Installation failed with code ${C}`;this.logger.error(x,{exitCode:C,stderr:v,stdout:c}),t({success:!1,message:` ${x}: ${v||c||"Unknown error"}`})}}),b.on("error",C=>{this.logger.error("Failed to start Python process",C);let x=C.message;C.message.includes("ENOENT")&&(x="Python not found. Please ensure Python 3.10+ is installed and in your PATH."),t({success:!1,message:` Failed to start installation: ${x}`})});const _=setTimeout(()=>{b.killed||(this.logger.error("Installation timeout - killing process"),b.kill(),t({success:!1,message:" Installation timed out after 10 minutes"}))},6e5);b.on("exit",()=>{clearTimeout(_)})}catch(r){this.logger.error("Installation exception",r),t({success:!1,message:` Installation error: ${r instanceof Error?r.message:String(r)}`})}})}async syncNotes(e,t,i){try{this.logger.debug("SYNC_START: syncNotes() called",{notesCount:e.notesPaths.length,batchSize:e.batchSize,debugMode:e.debug,notesSample:e.notesPaths.slice(0,3),fullNotesPathsCount:e.notesPaths.length});try{const l=this.settings.embeddingModel,d=this.getCurrentEmbeddingDimensions();if(await this.vaultRegistryService.hasEmbeddingModelChanged(l,d)){const g=await this.vaultRegistryService.getEmbeddingModelMismatchDetails(l,d);this.logger.warn("[SYNC] Embedding model change detected before sync",{currentModel:l,currentDimensions:d,storedModel:g==null?void 0:g.storedModel,storedDimensions:g==null?void 0:g.storedDimensions})}}catch(l){this.logger.debug("[SYNC] Embedding model validation error (continuing)",l)}const s=this.validateSyncConfig(e);if(!s.isValid)throw new Error(`Configuration error: ${s.errors.join(", ")}`);const{vaultPath:r}=this.getVaultAwarePaths();this.settings.useCustomOntology?t==null||t({current:5,total:100,message:"Preparing dynamic custom ontology sync...",percentage:5}):t==null||t({current:5,total:100,message:"Using generic episode sync (custom ontology disabled)...",percentage:5});const o=await this.prepareSyncConfig(e,r,i),a=await this.executePythonSync(o,t);return this.logger.debug(`SYNC_COMPLETE: syncNotes() finished - status: ${a.status}, processed: ${a.processed}, skipped: ${a.skipped}, total: ${a.total}, batches: ${a.batchCount}`),a}catch(s){return{status:"error",processed:0,skipped:0,total:e.notesPaths.length,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:s instanceof Error?s.message:String(s)}}}getNoteSelectionService(){return this.noteSelectionService}async syncNotesSequentially(e,t="obsidian_mm_individual"){this.logger.debug("Starting sequential sync"),this.isCancelled=!1;const i=this.noteSelectionService.getSelectedNotePaths();if(!i||i.length===0)return this.logger.warn("No notes found in selection"),{status:"error",processed:0,skipped:0,total:0,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:"No notes selected for sync"};this.logger.debug(`Processing ${i.length} notes sequentially`);let s=0,r=0;const o=[],a=[],{vaultPath:l}=this.getVaultAwarePaths();for(let m=0;m<i.length;m++){if(this.isCancelled)return this.logger.info("[CANCEL] Sequential sync cancelled by user"),{status:"error",processed:s,skipped:r+(i.length-m),total:i.length,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:"Sync cancelled by user"};const h=i[m];e==null||e({current:m,total:i.length,message:`Processing note ${m+1}/${i.length}: ${h}`,percentage:m/i.length*100});try{this.logger.debug(`Processing note ${m+1}/${i.length}: ${h}`);const c=require("path").join(l,h),v=this.plugin.app.vault.getAbstractFileByPath(h);if(!v||!(v instanceof P.TFile)){this.logger.error(`Could not find TFile for path: ${h}`),r++;continue}const w=await this.syncStatusManager.syncNote(v,t);o.push(w),w.status==="success"?(s++,this.logger.info(`Successfully synced note: ${h}`),this.noteSelectionService.deselectNotes([h])):(r++,this.logger.warn(`Failed to sync note: ${h}. Status: ${w.status}, Message: ${w.message}`),w.message&&a.push(`Note '${h}': ${w.message}`))}catch(b){r++;const c=b instanceof Error?b.message:String(b);a.push(`Note '${h}': ${c}`),this.logger.error(`Error syncing note ${h}`,b)}e==null||e({current:m+1,total:i.length,message:`Completed ${h}`,percentage:(m+1)/i.length*100})}const d=s>0?"success":"error",p={status:d,processed:s,skipped:r,total:i.length,batchCount:i.length,nodeTypesLoaded:0,edgeTypesLoaded:0,notes:o,errors:a,hasErrors:a.length>0,message:`Sequential sync completed. Processed: ${s}, Skipped: ${r}.`},g=o.slice(0,5).map(m=>{var v,w,_,C,x;const h=(w=(v=m==null?void 0:m.note_path)!=null?v:m==null?void 0:m.path)!=null?w:"",b=(_=m==null?void 0:m.status)!=null?_:"unknown",c=(x=(C=m==null?void 0:m.episode_uuid)!=null?C:m==null?void 0:m.episode_id)!=null?x:"";return{note:h,status:b,episode_uuid:c}});return this.logger.debug("Sequential auto-sync completed",{finalStatus:d,processed:s,skipped:r,total:i.length,notesSample:g}),p}async syncSelectedNotes(e,t="obsidian_mm_quicksync"){this.logger.debug("SYNC_START: syncSelectedNotes() called",{selectedPaths:this.noteSelectionService.getSelectedNotePaths()});const i=this.noteSelectionService.getSelectedNotePaths(),s=await this.noteSelectionService.validateSelection();if(!s.isValid)return{status:"error",processed:0,skipped:i.length,total:i.length,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:`Selection validation failed: ${s.errors.join(", ")}`};const r=await this.syncNotesSequentially(e,t);return this.logger.debug(`SYNC_COMPLETE: syncSelectedNotes() finished - status: ${r.status}, processed: ${r.processed}, skipped: ${r.skipped}, total: ${r.total}`),r}async quickSync(e,t){try{return await this.noteSelectionService.selectAllMatching(e)===0?{status:"error",processed:0,skipped:0,total:0,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:"No notes matched the filter criteria"}:this.syncSelectedNotes(t)}catch(i){return{status:"error",processed:0,skipped:0,total:0,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:i instanceof Error?i.message:String(i)}}}async getSyncStatistics(){const[e,t,i,s]=await Promise.all([this.noteSelectionService.getSelectionSummary(),this.noteSelectionService.validateSelection(),this.noteSelectionService.getAvailableTypes(),this.noteSelectionService.getAvailableTags()]);return{summary:e,validation:t,availableTypes:i,availableTags:s}}cancelSync(){this.logger.info("[CANCEL] Cancelling sync operation - killing all Python processes"),this.isCancelled=!0,this.activeProcesses.forEach(e=>{e.killed||(this.logger.debug("[CANCEL] Killing tracked Python process",{pid:e.pid}),e.kill("SIGTERM"))}),this.activeProcesses.clear(),this.pythonProcess&&(this.logger.debug("[CANCEL] Killing main Python process",{pid:this.pythonProcess.pid}),this.pythonProcess.kill("SIGTERM"),this.pythonProcess=null)}getPluginDirectory(){return this.getVaultAwarePaths().pluginDir}findDuplicatePathSegments(e){const t=Math.floor(e.length/2);if(t>0){let i=!0;for(let s=0;s<t;s++)if(e[s]!==e[s+t]){i=!1;break}if(i)return t}for(let i=1;i<e.length;i++)for(let s=i+1;s<e.length;s++)if(e[i]===e[s]){let r=1;for(;i+r<s&&s+r<e.length&&e[i+r]===e[s+r];)r++;if(r>=2&&s+r>=e.length)return s}return-1}getVaultPathFallback(){const e=this.getVaultAwarePaths(null);return this.logger.debug("Vault Path Fallback Resolution",{vaultPath:e.vaultPath,pluginDir:e.pluginDir,resolvedAt:e.resolvedAt}),e.vaultPath}getVaultAwarePaths(e){const t=yn.performance.now(),i=e||this.vaultRegistryService.getActiveVaultId()||"default";if(this.pathCache.has(i)){const o=this.pathCache.get(i);return this.cacheHits++,(yn.performance.now()-t).toFixed(2),this.logCacheMetrics(i),o}this.cacheMisses++;const s=this.resolvePathsForVault(i);this.pathCache.set(i,s);const r=(yn.performance.now()-t).toFixed(2);return this.logger.debug(`[CACHE_MISS] Vault: ${i}, Time: ${r}ms. Paths resolved.`),this.logCacheMetrics(i),s}resolvePathsForVault(e){const t=require("fs"),i=require("path"),s=this.plugin.app.vault.adapter.basePath;let r=i.normalize(s);const o=r.split(i.sep),a=this.findDuplicatePathSegments(o);a!==-1&&(r=o.slice(0,a).join(i.sep),this.logger.warn(" Fixed duplicated vault path during resolution",{original:s,normalized:r,fixed:r,duplicateStartIndex:a}));let l=null,d=null;const p=this.plugin.manifest.id||"megamem-mcp",g=Ge.join(r,".obsidian","plugins",p),m=Ge.join(g,"graphiti_bridge");if(t.existsSync(m)&&(l=g,d=m),!l){const b=i.resolve(r,".."),c=Ge.join(b,"graphiti_bridge");t.existsSync(c)&&(l=b,d=c)}if(!l){const b=Ge.join(r,"graphiti_bridge");t.existsSync(b)&&(l=r,d=b)}if(!l){const b=this.plugin.manifest.dir||"";if(b){const c=b,v=Ge.join(c,"graphiti_bridge");t.existsSync(v)&&(l=c,d=v)}}if(!l||!d){const b=`Critical path resolution failure for vault ID "${e}". Could not locate required plugin or bridge directories.`;throw this.logger.error(b,{vaultPath:r,pluginManifestDir:this.plugin.manifest.dir,pluginId:p}),new Error(b)}return t.existsSync(r)||this.logger.warn("[PATHS] Vault path does not exist resolved during final check",{vaultPath:r}),t.existsSync(l)||this.logger.warn("[PATHS] Plugin directory does not exist resolved during final check",{pluginDir:l}),t.existsSync(d)||this.logger.warn("[PATHS] Bridge directory does not exist resolved during final check",{bridgeDir:d}),{pluginDir:l,vaultPath:r,bridgeDir:d,resolvedAt:new Date().toISOString()}}sanitizeConfigForLogging(e){const t={...e};return t.llm_api_key&&(t.llm_api_key="***"),t.embedder_api_key&&(t.embedder_api_key="***"),t.api_keys&&(t.api_keys=Object.keys(t.api_keys).reduce((i,s)=>(i[s]=t.api_keys[s]?"***":null,i),{})),t.database_password&&(t.database_password="***"),t}getApiKeyForProvider(e){switch(e){case"openai":return this.settings.apiKeys.openai;case"anthropic":return this.settings.apiKeys.anthropic;case"google":return this.settings.apiKeys.google;case"azure":return this.settings.apiKeys.azure;case"groq":return this.settings.apiKeys.groq;case"voyage":return this.settings.apiKeys.voyage;case"venice":return this.settings.apiKeys.venice;case"openrouter":return this.settings.apiKeys.openrouter;case"ollama":return"not-required";default:return}}getDatabaseConfig(){return this.settings.databaseType==="neo4j"?this.settings.databaseConfigs.neo4j:this.settings.databaseType==="falkordb"?this.settings.databaseConfigs.falkordb:null}prepareDatabaseConfig(){const e=this.getDatabaseConfig();if(!e)throw new Error(`No database configuration found for type: ${this.settings.databaseType}`);if(this.settings.databaseType==="neo4j")return{database_url:e.uri,database_username:e.username,database_password:e.password,database_name:e.database};if(this.settings.databaseType==="falkordb")return{database_url:`redis://${e.host}:${e.port}`,database_username:e.username||null,database_password:e.password||null,database_name:e.database};throw new Error(`Unsupported database type: ${this.settings.databaseType}`)}validateSyncConfig(e){const t=[];(!e.notesPaths||e.notesPaths.length===0)&&t.push("No notes selected for sync"),e.batchSize<=0&&t.push("Batch size must be greater than 0"),this.settings.llmProvider||t.push("LLM provider not configured"),this.getApiKeyForProvider(this.settings.llmProvider)||t.push(`API key not configured for LLM provider: ${this.settings.llmProvider}`),this.settings.embedderProvider||t.push("Embedder provider not configured");const s=this.getDatabaseConfig();return s?this.settings.databaseType==="neo4j"?s.uri||t.push("Neo4j URI not configured"):this.settings.databaseType==="falkordb"&&(s.host||t.push("FalkorDB host not configured"),s.port||t.push("FalkorDB port not configured")):t.push(`Database configuration not found for type: ${this.settings.databaseType}`),{isValid:t.length===0,errors:t}}async prepareSyncConfig(e,t,i){const s=t||this.getVaultPathFallback(),r=this.plugin.settings,o=[];for(const l of e.notesPaths)try{const d=this.plugin.app.vault.getName();let p=this.syncStatusManager.normalizeNotePath(l,s);Ke.isAbsolute(p)&&s?p=Ke.relative(s,p).replace(/\\/g,"/"):p=p.replace(/\\/g,"/");const g=this.plugin.app.vault.getAbstractFileByPath(p);if(g&&g instanceof P.TFile){const m=await _n(this.plugin.app,g);if(m){o.push(m),this.logger.debug("Retrieved previous episode UUID from frontmatter",{notePath:l,vaultRelativePath:p,mmUid:m});continue}}this.logger.debug("No previous episode UUID found - new note will get fresh episode",{notePath:l,vaultRelativePath:p})}catch(d){this.logger.debug("Error retrieving episode UUID for note",{notePath:l,error:d})}const a={llm_provider:r.llmProvider,llm_api_key:this.getApiKeyForProvider(r.llmProvider),llm_model:r.llmModel,llm_small_model:r.llmSmallModel,azure_endpoint:r.azureEndpoint,azure_api_version:r.azureApiVersion,ollama_base_url:r.ollamaBaseUrl,openrouter_preset_slug:r.openrouterPresetSlug,openrouter_use_preset_with_custom_model:r.openrouterUsePresetWithCustomModel,embedder_provider:r.embedderProvider,embedder_api_key:this.getApiKeyForProvider(r.embedderProvider),embedding_model:r.embeddingModel,api_keys:r.apiKeys,database_type:r.databaseType,...this.prepareDatabaseConfig(),use_custom_ontology:r.useCustomOntology,default_namespace:r.defaultNamespace,enable_folder_namespacing:r.enableFolderNamespacing,enable_property_namespacing:r.enablePropertyNamespacing,namespace_strategy:r.namespaceStrategy,folder_namespace_mappings:r.folderNamespaceMappings,notes:e.notesPaths,batch_size:e.batchSize,debug:r.enableDebugLogging,vault_path:s,source_description:i||e.source_description||"obsidian_mm_individual",cross_encoder_client:e.crossEncoderClient||r.crossEncoderClient||"none",cross_encoder_model:r.crossEncoderClient==="bge"||r.crossEncoderClient==="none"?void 0:e.crossEncoderModel||r.crossEncoderModel,previous_episode_uuids:o};return this.logger.info(`Sync configuration prepared: Total notes: ${e.notesPaths.length}, Previous episodes: ${o.length}, First time sync: ${e.notesPaths.length-o.length}`),a}async executePythonSync(e,t){if(this.settings.experimentalDaemonMode&&this.plugin.pythonDaemonBridge)return this.logger.info("Using daemon mode for sync"),await this.executeDaemonSync(e,t);this.logger.info("Using traditional sync mode");const{bridgeDir:i}=this.getVaultAwarePaths();Ge.join(i,"sync.py");let s=[];Array.isArray(e.notes)&&e.notes.length>0?s=e.notes:Array.isArray(e.notesPaths)&&e.notesPaths.length>0?s=e.notesPaths:typeof e.notes=="string"&&(s=[e.notes]);const r=h=>new Promise(b=>{var c,v,w,_;try{const{pluginDir:C}=this.getVaultAwarePaths(),x=this.getPythonExecutable(),N=this.getPythonEnv();this.pythonProcess=Nt.spawn(x,["-m","graphiti_bridge.sync","--vault-path",h.vault_path,"--plugin-data-path",C],{cwd:C,stdio:["pipe","pipe","pipe"],env:N}),this.activeProcesses.add(this.pythonProcess),(c=this.pythonProcess.stdin)==null||c.write(JSON.stringify(h)),(v=this.pythonProcess.stdin)==null||v.end();let k="",T="";(w=this.pythonProcess.stdout)==null||w.on("data",D=>{const A=D.toString();k+=A,this.settings.enableDebugLogging&&this.logger.logPythonOutput("stdout",A)}),(_=this.pythonProcess.stderr)==null||_.on("data",D=>{const A=D.toString();T+=A,this.logger.logPythonOutput("stderr",A)}),this.pythonProcess.on("close",D=>{if(this.activeProcesses.delete(this.pythonProcess),this.pythonProcess=null,D===0)try{const A=JSON.parse(k.trim());if(A._diagnostics&&Array.isArray(A._diagnostics))for(const O of A._diagnostics)this.logger.info(`[PYTHON-DIAGNOSTICS] ${O}`);b({success:!0,result:A,stdout:k,stderr:T,exitCode:D})}catch(A){b({success:!1,stdout:k,stderr:T||String(A),exitCode:D})}else b({success:!1,stdout:k,stderr:T,exitCode:D})}),this.pythonProcess.on("error",D=>{this.pythonProcess&&this.activeProcesses.delete(this.pythonProcess),this.pythonProcess=null,b({success:!1,stdout:void 0,stderr:D.message,exitCode:-1})})}catch(C){this.pythonProcess=null,b({success:!1,stdout:void 0,stderr:C instanceof Error?C.message:String(C),exitCode:-1})}});if(s.length<=1){const h=s.length===1?s[0]:Array.isArray(e.notes)&&e.notes.length>0?e.notes[0]:void 0;let b;if(h)try{b=await this.syncRegistryService.generateGroupId(h,this.plugin.app.vault.getName())}catch(w){}const c={...e,...b?{group_id:b}:{},notes:s.length===1?s:e.notes},v=await r(c);if(v.success&&v.result){if(v.result.status==="rate_limited"){const w=v.result.retry_after||60,_=v.result.reset_time,C=v.result.provider_message||"API rate limit exceeded";let x="Rate limit exceeded - sync paused";if(_){const N=new Date(_);x+=` until ${N.toLocaleString()}`}else x+=` for ${Math.round(w/60)} minutes`;return this.logger.warn("Rate limit detected in single sync - pausing",{retryAfter:w,resetTime:_,providerMessage:C,pauseMessage:x}),{status:"error",processed:0,skipped:1,total:1,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:x}}return v.result}else{const w=`Python sync failed${v.exitCode!==void 0?` with exit code ${v.exitCode}`:""}: ${v.stderr||v.stdout||"Unknown error"}`,_=v.stderr?v.stderr.split(`
`)[0]:"Unknown error";return this.logger.error("Python sync process failed",{exitCode:v.exitCode,stderr:_,stderrLength:v.stderr?v.stderr.length:0}),{status:"error",processed:0,skipped:s.length||1,total:s.length||1,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:w}}}let o=0,a=0,l=0,d=0;const p=[],g=[];for(let h=0;h<s.length;h++){if(this.isCancelled)return this.logger.info("[CANCEL] Sequential sync cancelled by user"),{status:"error",processed:o,skipped:a+(s.length-h),total:s.length,batchCount:s.length,nodeTypesLoaded:l,edgeTypesLoaded:d,errors:[...p,"Sync cancelled by user"],hasErrors:!0,notes:g};const b=s[h];t==null||t({current:h,total:s.length,message:`Processing note ${h+1}/${s.length}: ${b}`,percentage:h/s.length*100});let c;try{c=await this.syncRegistryService.generateGroupId(b,this.plugin.app.vault.getName())}catch(_){}const v={...e,...c?{group_id:c}:{},notes:[b],batch_size:1,notesPaths:[b]},w=await r(v);if(w.success&&w.result){const _=w.result;if(_.status==="rate_limited"){a++;const C=_.retry_after||60,x=_.reset_time,N=_.provider_message||"API rate limit exceeded";let k="Rate limit exceeded - sync paused";if(x){const D=new Date(x);k+=` until ${D.toLocaleString()}`}else k+=` for ${Math.round(C/60)} minutes`;p.push(`Note ${b}: ${k}`),this.logger.warn("Rate limit detected - sync pausing",{note:b,retryAfter:C,resetTime:x,providerMessage:N,pauseMessage:k}),t==null||t({current:h,total:s.length,message:k,percentage:h/s.length*100}),g.push(_);const T=C>300?3e4:Math.min(C*1e3,1e4);await new Promise(D=>setTimeout(D,T)),t==null||t({current:h,total:s.length,message:"Resuming sync after rate limit pause...",percentage:h/s.length*100})}else _.status==="success"?o++:(a++,p.push(`Note ${b}: ${_.message||"failed"}`));typeof _.nodeTypesLoaded=="number"&&(l+=_.nodeTypesLoaded),typeof _.edgeTypesLoaded=="number"&&(d+=_.edgeTypesLoaded),g.push(_)}else{a++;const _=`Python sync failed for note ${b} (exitCode=${w.exitCode}): ${w.stderr||w.stdout||""}`;p.push(_);const C=w.stderr?w.stderr.split(`
`)[0]:"Unknown error";this.logger.error("Python sync failed for note",{note:b,exitCode:w.exitCode,stderr:C,stderrLength:w.stderr?w.stderr.length:0})}t==null||t({current:h+1,total:s.length,message:`Completed ${b}`,percentage:(h+1)/s.length*100}),await new Promise(_=>setTimeout(_,500))}return{status:o>0?"success":"error",processed:o,skipped:a,total:s.length,batchCount:s.length,nodeTypesLoaded:l,edgeTypesLoaded:d,errors:p,hasErrors:p.length>0,notes:g}}async executeDaemonSync(e,t){const i=this.plugin.pythonDaemonBridge;if(!i)return this.logger.error("Daemon bridge not available, falling back to traditional sync"),await this.executeTraditionalSync(e,t);let s=[];Array.isArray(e.notes)&&e.notes.length>0?s=e.notes:Array.isArray(e.notesPaths)&&e.notesPaths.length>0?s=e.notesPaths:typeof e.notes=="string"&&(s=[e.notes]);try{if(s.length<=1){const r=await i.executeDaemonSync(e);return this.parseDaemonSyncResult(r)}else{let r=0,o=0,a=0,l=0;const d=[],p=[];for(let m=0;m<s.length;m++){if(this.isCancelled)return{status:"error",processed:r,skipped:o+(s.length-m),total:s.length,batchCount:s.length,nodeTypesLoaded:a,edgeTypesLoaded:l,errors:[...d,"Sync cancelled by user"],hasErrors:!0,notes:p};const h=s[m];t==null||t({current:m,total:s.length,message:`Processing note ${m+1}/${s.length}: ${h}`,percentage:m/s.length*100});const b={...e,notes:[h],batch_size:1,notesPaths:[h]};try{const c=await i.executeDaemonSync(b),v=this.parseDaemonSyncResult(c);v.status==="success"?r++:(o++,d.push(`Note ${h}: ${v.message||"failed"}`)),typeof v.nodeTypesLoaded=="number"&&(a+=v.nodeTypesLoaded),typeof v.edgeTypesLoaded=="number"&&(l+=v.edgeTypesLoaded),p.push(v)}catch(c){o++;const v=`Daemon sync failed for note ${h}: ${c instanceof Error?c.message:String(c)}`;d.push(v),this.logger.error("Daemon sync failed for note",{note:h,error:c})}t==null||t({current:m+1,total:s.length,message:`Completed ${h}`,percentage:(m+1)/s.length*100}),await new Promise(c=>setTimeout(c,500))}return{status:r>0?"success":"error",processed:r,skipped:o,total:s.length,batchCount:s.length,nodeTypesLoaded:a,edgeTypesLoaded:l,errors:d,hasErrors:d.length>0,notes:p}}}catch(r){return this.logger.error("Daemon sync failed, falling back to traditional sync",r),await this.executeTraditionalSync(e,t)}}parseDaemonSyncResult(e){if(typeof e=="string")try{e=JSON.parse(e)}catch(t){return{status:"error",processed:0,skipped:1,total:1,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:"Failed to parse daemon result"}}return{status:e.status||"error",processed:e.status==="success"?1:0,skipped:e.status==="success"?0:1,total:1,batchCount:1,nodeTypesLoaded:e.nodeTypesLoaded||0,edgeTypesLoaded:e.edgeTypesLoaded||0,message:e.message,notes:[e]}}async executeTraditionalSync(e,t){const{bridgeDir:i}=this.getVaultAwarePaths();Ge.join(i,"sync.py");let s=[];Array.isArray(e.notes)&&e.notes.length>0?s=e.notes:Array.isArray(e.notesPaths)&&e.notesPaths.length>0?s=e.notesPaths:typeof e.notes=="string"&&(s=[e.notes]);const r=h=>new Promise(b=>{var c,v,w,_;try{const{pluginDir:C}=this.getVaultAwarePaths(),x=this.getPythonExecutable(),N=this.getPythonEnv();this.pythonProcess=Nt.spawn(x,["-m","graphiti_bridge.sync","--vault-path",h.vault_path,"--plugin-data-path",C],{cwd:C,stdio:["pipe","pipe","pipe"],env:N}),this.activeProcesses.add(this.pythonProcess),(c=this.pythonProcess.stdin)==null||c.write(JSON.stringify(h)),(v=this.pythonProcess.stdin)==null||v.end();let k="",T="";(w=this.pythonProcess.stdout)==null||w.on("data",D=>{const A=D.toString();k+=A,this.settings.enableDebugLogging&&this.logger.logPythonOutput("stdout",A)}),(_=this.pythonProcess.stderr)==null||_.on("data",D=>{const A=D.toString();T+=A,this.logger.logPythonOutput("stderr",A)}),this.pythonProcess.on("close",D=>{if(this.activeProcesses.delete(this.pythonProcess),this.pythonProcess=null,D===0)try{const A=JSON.parse(k.trim());if(A._diagnostics&&Array.isArray(A._diagnostics))for(const O of A._diagnostics)this.logger.info(`[PYTHON-DIAGNOSTICS] ${O}`);b({success:!0,result:A,stdout:k,stderr:T,exitCode:D})}catch(A){b({success:!1,stdout:k,stderr:T||String(A),exitCode:D})}else b({success:!1,stdout:k,stderr:T,exitCode:D})}),this.pythonProcess.on("error",D=>{this.pythonProcess&&this.activeProcesses.delete(this.pythonProcess),this.pythonProcess=null,b({success:!1,stdout:void 0,stderr:D.message,exitCode:-1})})}catch(C){this.pythonProcess=null,b({success:!1,stdout:void 0,stderr:C instanceof Error?C.message:String(C),exitCode:-1})}});if(s.length<=1){const h=s.length===1?s[0]:Array.isArray(e.notes)&&e.notes.length>0?e.notes[0]:void 0;let b;if(h)try{b=await this.syncRegistryService.generateGroupId(h,this.plugin.app.vault.getName())}catch(w){}const c={...e,...b?{group_id:b}:{},notes:s.length===1?s:e.notes},v=await r(c);if(v.success&&v.result){if(v.result.status==="rate_limited"){const w=v.result.retry_after||60,_=v.result.reset_time,C=v.result.provider_message||"API rate limit exceeded";let x="Rate limit exceeded - sync paused";if(_){const N=new Date(_);x+=` until ${N.toLocaleString()}`}else x+=` for ${Math.round(w/60)} minutes`;return this.logger.warn("Rate limit detected in single sync - pausing",{retryAfter:w,resetTime:_,providerMessage:C,pauseMessage:x}),{status:"error",processed:0,skipped:1,total:1,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:x}}return v.result}else{const w=`Python sync failed${v.exitCode!==void 0?` with exit code ${v.exitCode}`:""}: ${v.stderr||v.stdout||"Unknown error"}`,_=v.stderr?v.stderr.split(`
`)[0]:"Unknown error";return this.logger.error("Python sync process failed",{exitCode:v.exitCode,stderr:_,stderrLength:v.stderr?v.stderr.length:0}),{status:"error",processed:0,skipped:s.length||1,total:s.length||1,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:w}}}let o=0,a=0,l=0,d=0;const p=[],g=[];for(let h=0;h<s.length;h++){if(this.isCancelled)return this.logger.info("[CANCEL] Sequential sync cancelled by user"),{status:"error",processed:o,skipped:a+(s.length-h),total:s.length,batchCount:s.length,nodeTypesLoaded:l,edgeTypesLoaded:d,errors:[...p,"Sync cancelled by user"],hasErrors:!0,notes:g};const b=s[h];t==null||t({current:h,total:s.length,message:`Processing note ${h+1}/${s.length}: ${b}`,percentage:h/s.length*100});let c;try{c=await this.syncRegistryService.generateGroupId(b,this.plugin.app.vault.getName())}catch(_){}const v={...e,...c?{group_id:c}:{},notes:[b],batch_size:1,notesPaths:[b]},w=await r(v);if(w.success&&w.result){const _=w.result;if(_.status==="rate_limited"){a++;const C=_.retry_after||60,x=_.reset_time,N=_.provider_message||"API rate limit exceeded";let k="Rate limit exceeded - sync paused";if(x){const D=new Date(x);k+=` until ${D.toLocaleString()}`}else k+=` for ${Math.round(C/60)} minutes`;p.push(`Note ${b}: ${k}`),this.logger.warn("Rate limit detected - sync pausing",{note:b,retryAfter:C,resetTime:x,providerMessage:N,pauseMessage:k}),t==null||t({current:h,total:s.length,message:k,percentage:h/s.length*100}),g.push(_);const T=C>300?3e4:Math.min(C*1e3,1e4);await new Promise(D=>setTimeout(D,T)),t==null||t({current:h,total:s.length,message:"Resuming sync after rate limit pause...",percentage:h/s.length*100})}else _.status==="success"?o++:(a++,p.push(`Note ${b}: ${_.message||"failed"}`));typeof _.nodeTypesLoaded=="number"&&(l+=_.nodeTypesLoaded),typeof _.edgeTypesLoaded=="number"&&(d+=_.edgeTypesLoaded),g.push(_)}else{a++;const _=`Python sync failed for note ${b} (exitCode=${w.exitCode}): ${w.stderr||w.stdout||""}`;p.push(_);const C=w.stderr?w.stderr.split(`
`)[0]:"Unknown error";this.logger.error("Python sync failed for note",{note:b,exitCode:w.exitCode,stderr:C,stderrLength:w.stderr?w.stderr.length:0})}t==null||t({current:h+1,total:s.length,message:`Completed ${b}`,percentage:(h+1)/s.length*100}),await new Promise(_=>setTimeout(_,500))}return{status:o>0?"success":"error",processed:o,skipped:a,total:s.length,batchCount:s.length,nodeTypesLoaded:l,edgeTypesLoaded:d,errors:p,hasErrors:p.length>0,notes:g}}async executePythonCommand(e){return new Promise(t=>{var l,d;const i=this.getPythonExecutable(),s=this.getPythonEnv(),r=Nt.spawn(i,e,{stdio:["pipe","pipe","pipe"],env:s});let o="",a="";(l=r.stdout)==null||l.on("data",p=>{o+=p.toString()}),(d=r.stderr)==null||d.on("data",p=>{a+=p.toString()}),r.on("close",p=>{t({success:p===0,output:o.trim(),error:a.trim()})}),r.on("error",p=>{t({success:!1,error:p.message})})})}async executePythonConnectionTest(e,t){return new Promise(i=>{var s,r;try{const{pluginDir:o,bridgeDir:a}=this.getVaultAwarePaths(),l=Ge.join(a,"test_connections.py");if(!require("fs").existsSync(l)){i({success:!1,message:`Test script not found at: ${l}`});return}this.logger.info("Executing connection test",{testType:e});const p=this.getPythonExecutable(),g=this.getPythonEnv(),m=Nt.spawn(p,["-m","graphiti_bridge.test_connections","--test-type",e,"--config",JSON.stringify(t)],{cwd:o,stdio:["pipe","pipe","pipe"],env:g});let h="",b="";(s=m.stdout)==null||s.on("data",c=>{const v=c.toString();h+=v,this.logger.logPythonOutput("stdout",v)}),(r=m.stderr)==null||r.on("data",c=>{const v=c.toString();b+=v,this.logger.logPythonOutput("stderr",v)}),m.on("close",c=>{if(this.logger.debug("Connection test process completed",{exitCode:c}),c===0)try{const v=JSON.parse(h.trim()),w={success:v.success,message:v.message,latency:v.latency};v.cross_encoder&&(w.cross_encoder=v.cross_encoder),i(w)}catch(v){this.logger.error("Failed to parse connection test result",v),i({success:!1,message:`Failed to parse test result: ${h||b}`})}else this.logger.error("Connection test failed",{exitCode:c,stderr:b,stdout:h}),i({success:!1,message:`Connection test failed (exit code ${c}): ${b||h||"Unknown error"}`})}),m.on("error",c=>{this.logger.error("Failed to start connection test process",c);let v=c.message;c.message.includes("ENOENT")&&(v="Python not found. Please ensure Python 3.10+ is installed and in your PATH."),i({success:!1,message:`Failed to start connection test: ${v}`})})}catch(o){this.logger.error("Connection test exception",o),i({success:!1,message:`Connection test error: ${o instanceof Error?o.message:String(o)}`})}})}async testDatabaseConnection(){var e;try{const t={database_type:this.settings.databaseType,...this.prepareDatabaseConfig()},i=this.getDatabaseConfig();return this.logger.debug("Testing database connection",{databaseType:this.settings.databaseType,databaseConfig:i,hasPassword:!!(i!=null&&i.password),passwordLength:((e=i==null?void 0:i.password)==null?void 0:e.length)||0}),await this.executePythonConnectionTest("database",t)}catch(t){return this.logger.error("Database connection test error",t),{success:!1,message:`Database test error: ${t instanceof Error?t.message:String(t)}`}}}async testLLMConnection(){try{const e={llm_provider:this.settings.llmProvider,api_keys:this.settings.apiKeys,llm_model:this.settings.llmModel,azure_endpoint:this.settings.azureEndpoint,azure_api_version:this.settings.azureApiVersion,ollama_base_url:this.settings.ollamaBaseUrl,database_type:this.settings.databaseType,...this.prepareDatabaseConfig()};return this.logger.debug("Testing LLM connection",{llmProvider:this.settings.llmProvider,hasApiKeys:Object.keys(this.settings.apiKeys).length>0,sanitizedConfig:this.sanitizeConfigForLogging(e)}),await this.executePythonConnectionTest("llm",e)}catch(e){return this.logger.error("LLM connection test error",e),{success:!1,message:`LLM test error: ${e instanceof Error?e.message:String(e)}`}}}async testEmbeddingConnection(){try{const e={embedder_provider:this.settings.embedderProvider,api_keys:this.settings.apiKeys,embedding_model:this.settings.embeddingModel,database_type:this.settings.databaseType,...this.prepareDatabaseConfig()};return this.logger.debug("Testing embedding connection",{embedderProvider:this.settings.embedderProvider,embeddingModel:this.settings.embeddingModel,hasApiKeys:Object.keys(this.settings.apiKeys).length>0,sanitizedConfig:this.sanitizeConfigForLogging(e)}),await this.executePythonConnectionTest("embedding",e)}catch(e){return this.logger.error("Embedding connection test error",e),{success:!1,message:`Embedding test error: ${e instanceof Error?e.message:String(e)}`}}}async testEmbeddingWithDimensions(){try{const e={embedder_provider:this.settings.embedderProvider,api_keys:this.settings.apiKeys,embedding_model:this.settings.embeddingModel,database_type:this.settings.databaseType,...this.prepareDatabaseConfig()};return this.logger.debug("Testing embedding connection with dimensions",{embedderProvider:this.settings.embedderProvider,embeddingModel:this.settings.embeddingModel,hasApiKeys:Object.keys(this.settings.apiKeys).length>0,sanitizedConfig:this.sanitizeConfigForLogging(e)}),await this.executePythonConnectionTest("embedding-test",e)}catch(e){return this.logger.error("Enhanced embedding connection test error",e),{success:!1,message:`Enhanced embedding test error: ${e instanceof Error?e.message:String(e)}`}}}async testProviderCombination(){try{const e={llm_provider:this.settings.llmProvider,llm_model:this.settings.llmModel,azure_endpoint:this.settings.azureEndpoint,azure_api_version:this.settings.azureApiVersion,ollama_base_url:this.settings.ollamaBaseUrl,embedder_provider:this.settings.embedderProvider,embedding_model:this.settings.embeddingModel,api_keys:this.settings.apiKeys,database_type:this.settings.databaseType,...this.prepareDatabaseConfig()};return this.logger.debug("Testing provider combination",{llmProvider:this.settings.llmProvider,embedderProvider:this.settings.embedderProvider,llmModel:this.settings.llmModel,embeddingModel:this.settings.embeddingModel,hasApiKeys:Object.keys(this.settings.apiKeys).length>0,sanitizedConfig:this.sanitizeConfigForLogging(e)}),await this.executePythonConnectionTest("combination",e)}catch(e){return this.logger.error("Provider combination test error",e),{success:!1,message:`Provider combination test error: ${e instanceof Error?e.message:String(e)}`}}}async testFullPipeline(){try{const e={llm_provider:this.settings.llmProvider,api_keys:this.settings.apiKeys,llm_model:this.settings.llmModel,azure_endpoint:this.settings.azureEndpoint,azure_api_version:this.settings.azureApiVersion,ollama_base_url:this.settings.ollamaBaseUrl,embedder_provider:this.settings.embedderProvider,embedding_model:this.settings.embeddingModel,cross_encoder_client:this.settings.crossEncoderClient||"none",cross_encoder_model:this.settings.crossEncoderClient==="bge"||this.settings.crossEncoderClient==="none"?void 0:this.settings.crossEncoderModel,database_type:this.settings.databaseType,...this.prepareDatabaseConfig()};return this.logger.debug("Testing full LLM + embedding pipeline",{llmProvider:this.settings.llmProvider,embedderProvider:this.settings.embedderProvider,llmModel:this.settings.llmModel,embeddingModel:this.settings.embeddingModel,hasApiKeys:Object.keys(this.settings.apiKeys).length>0,sanitizedConfig:this.sanitizeConfigForLogging(e)}),await this.executePythonConnectionTest("combination-pipeline",e)}catch(e){return this.logger.error("Full pipeline test error",e),{success:!1,message:`Pipeline test error: ${e instanceof Error?e.message:String(e)}`}}}async validateAPIKeys(){try{const e=[],t=[],i=this.getApiKeyForProvider(this.settings.llmProvider);if(this.settings.llmProvider==="ollama"?e.push(`${this.settings.llmProvider}: Local provider (no API key required)`):i?i.length<10?t.push(`API key for ${this.settings.llmProvider} appears too short (${i.length} chars)`):e.push(`${this.settings.llmProvider}: API key present (${i.length} chars)`):t.push(`Missing API key for LLM provider: ${this.settings.llmProvider}`),this.settings.embedderProvider!==this.settings.llmProvider){const s=this.getApiKeyForProvider(this.settings.embedderProvider);this.settings.embedderProvider==="ollama"?e.push(`${this.settings.embedderProvider}: Local provider (no API key required)`):s?s.length<10?t.push(`API key for ${this.settings.embedderProvider} appears too short (${s.length} chars)`):e.push(`${this.settings.embedderProvider}: API key present (${s.length} chars)`):t.push(`Missing API key for embedder provider: ${this.settings.embedderProvider}`)}return t.length>0?(this.logger.error("API key validation failed",{errors:t,validationResults:e}),{success:!1,message:`Validation failed: ${t.join(", ")}`}):(this.logger.info("API key validation successful",{validationResults:e}),{success:!0,message:`All API keys valid: ${e.join(", ")}`})}catch(e){return this.logger.error("API key validation error",e),{success:!1,message:`Validation error: ${e instanceof Error?e.message:String(e)}`}}}async initializeDatabaseSchema(){try{const e={database_type:this.settings.databaseType,...this.prepareDatabaseConfig(),llm_provider:this.settings.llmProvider,api_keys:this.settings.apiKeys,llm_model:this.settings.llmModel,azure_endpoint:this.settings.azureEndpoint,azure_api_version:this.settings.azureApiVersion,ollama_base_url:this.settings.ollamaBaseUrl},t=this.getDatabaseConfig();return this.logger.info("Initializing database schema",{databaseType:this.settings.databaseType,databaseConfig:t,llmProvider:this.settings.llmProvider}),await this.executePythonSchemaInitialization(e)}catch(e){return this.logger.error("Database schema initialization error",e),{success:!1,message:`Schema initialization error: ${e instanceof Error?e.message:String(e)}`}}}async executePythonSchemaInitialization(e){return new Promise(t=>{var i,s;try{const{pluginDir:r,bridgeDir:o}=this.getVaultAwarePaths(),a=Ge.join(o,"test_connections.py");if(!require("fs").existsSync(a)){t({success:!1,message:`Test script not found at: ${a}`});return}this.logger.info("Executing schema initialization");const d=this.getPythonExecutable(),p=this.getPythonEnv(),g=Nt.spawn(d,["-m","graphiti_bridge.test_connections","--test-type","schema-init","--config",JSON.stringify(e)],{cwd:r,stdio:["pipe","pipe","pipe"],env:p});let m="",h="";(i=g.stdout)==null||i.on("data",b=>{const c=b.toString();m+=c,this.logger.logPythonOutput("stdout",c)}),(s=g.stderr)==null||s.on("data",b=>{const c=b.toString();h+=c,this.logger.logPythonOutput("stderr",c)}),g.on("close",b=>{if(this.logger.debug("Schema initialization process completed",{exitCode:b}),b===0)try{const c=JSON.parse(m.trim());t({success:c.success,message:c.message})}catch(c){this.logger.error("Failed to parse schema initialization result",c),t({success:!1,message:`Failed to parse initialization result: ${m||h}`})}else this.logger.error("Schema initialization failed",{exitCode:b,stderr:h,stdout:m}),t({success:!1,message:`Schema initialization failed (exit code ${b}): ${h||m||"Unknown error"}`})}),g.on("error",b=>{this.logger.error("Failed to start schema initialization process",b);let c=b.message;b.message.includes("ENOENT")&&(c="Python not found. Please ensure Python 3.10+ is installed and in your PATH."),t({success:!1,message:`Failed to start schema initialization: ${c}`})})}catch(r){this.logger.error("Schema initialization exception",r),t({success:!1,message:`Schema initialization error: ${r instanceof Error?r.message:String(r)}`})}})}async testManualSync(e,t="obsidian_mm_individual"){var s,r,o;const i=Date.now();try{this.logger.info(`Starting manual sync test for file: ${e}, Source: ${t}`);try{const x=this.settings.embeddingModel,N=this.getCurrentEmbeddingDimensions(),k=await this.vaultRegistryService.hasEmbeddingModelChanged(x,N);if(k){const T=await this.vaultRegistryService.getEmbeddingModelMismatchDetails(x,N);this.logger.warn("[TEST_SYNC] Embedding model change detected before test sync",{hasChanged:k,storedModel:T==null?void 0:T.storedModel,storedDimensions:T==null?void 0:T.storedDimensions,currentModel:x,currentDimensions:N,noteFile:e});const D=`Embedding model changed from ${(T==null?void 0:T.storedModel)||"unknown"} to ${x}. This may affect vector similarity in your knowledge graph.`;new P.Notice(D,8e3)}}catch(x){this.logger.debug("[TEST_SYNC] Failed to validate embedding model (test sync continues)",{error:x,noteFile:e})}if(!require("fs").existsSync(e))throw new Error(`Note file not found: ${e}`);const l={notesPaths:[e],batchSize:1,debug:this.settings.enableDebugLogging,source_description:t,crossEncoderClient:this.settings.crossEncoderClient,crossEncoderModel:this.settings.crossEncoderModel,use_custom_ontology:this.settings.useCustomOntology},d=await this.syncNotes(l,x=>{this.logger.debug("Manual sync progress",x),new P.Notice(`Manual sync: ${x.message} (${x.percentage.toFixed(1)}%)`)},t),p=(o=(r=d.processing_duration_seconds)!=null?r:d.notes&&Array.isArray(d.notes)&&((s=d.notes[0])==null?void 0:s.processing_duration_seconds))!=null?o:Math.round((Date.now()-i)/1e3),g=1,m=0,h=1,b=1,c=d!=null&&d.notes&&Array.isArray(d.notes)?d.notes[0]:null,v=d.note_name||(c==null?void 0:c.note_name)||"unknown",w=await this.syncRegistryService.generateGroupId(e,this.plugin.app.vault.getName()),_=d.episode_uuid||(c==null?void 0:c.episode_uuid)||"unknown",C=d.status||(c==null?void 0:c.status)||"unknown";return this.logger.info(`ManualSyncResult: note_name:${v}, status: ${C}, processed: ${g}, skipped: ${m}, total: ${h}, batches: ${b}, processed_in: ${p}s, group_id: ${w}, uuid: ${_}, source_description: ${t}`),d}catch(a){return this.logger.error("[ERROR] Manual sync test failed",a),{status:"error",processed:0,skipped:0,total:1,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:a instanceof Error?a.message:String(a)}}}getPlugin(){return typeof window.app!="undefined"?window.app.plugins.plugins["megamem-mcp"]:null}async addEntityDefinition(e,t){const i=this.getPlugin();if(!(i!=null&&i.settings))throw new Error("Plugin settings not available");i.settings.entityDescriptions||(i.settings.entityDescriptions={}),i.settings.entityDescriptions[e]={className:e.replace(/\s+/g,"").replace(/[^a-zA-Z0-9]/g,""),description:t,isUserDefined:!0,source:"user",lastModified:new Date().toISOString()},await i.saveSettings(),this.logger.info("Added entity definition",{entityName:e})}async removeEntityDefinition(e){var i;const t=this.getPlugin();(i=t==null?void 0:t.settings)!=null&&i.entityDescriptions&&(delete t.settings.entityDescriptions[e],await t.saveSettings(),this.logger.info("Removed entity definition",{entityName:e}))}async updateEntityDescription(e,t){var s,r;const i=this.getPlugin();if(!((r=(s=i==null?void 0:i.settings)==null?void 0:s.entityDescriptions)!=null&&r[e]))throw new Error(`Entity ${e} not found`);i.settings.entityDescriptions[e]={...i.settings.entityDescriptions[e],description:t,lastModified:new Date().toISOString()},await i.saveSettings(),this.logger.info("Updated entity description",{entityName:e})}async addPropertyDefinition(e,t,i){const s=this.getPlugin();if(!(s!=null&&s.settings))throw new Error("Plugin settings not available");s.settings.propertyDescriptions||(s.settings.propertyDescriptions={}),s.settings.propertyDescriptions[e]||(s.settings.propertyDescriptions[e]={}),s.settings.propertyDescriptions[e][t]={description:i,fieldType:"str",isUserDefined:!0,source:"user",lastModified:new Date().toISOString()},await s.saveSettings(),this.logger.info("Added property definition",{entityName:e,propertyName:t})}async removePropertyDefinition(e,t){var s,r;const i=this.getPlugin();(r=(s=i==null?void 0:i.settings)==null?void 0:s.propertyDescriptions)!=null&&r[e]&&(delete i.settings.propertyDescriptions[e][t],Object.keys(i.settings.propertyDescriptions[e]).length===0&&delete i.settings.propertyDescriptions[e],await i.saveSettings(),this.logger.info("Removed property definition",{entityName:e,propertyName:t}))}async updatePropertyDescription(e,t,i){var r,o,a;const s=this.getPlugin();if(!((a=(o=(r=s==null?void 0:s.settings)==null?void 0:r.propertyDescriptions)==null?void 0:o[e])!=null&&a[t]))throw new Error(`Property ${e}.${t} not found`);s.settings.propertyDescriptions[e][t]={...s.settings.propertyDescriptions[e][t],description:i,lastModified:new Date().toISOString()},await s.saveSettings(),this.logger.info("Updated property description",{entityName:e,propertyName:t})}async loadAllDefaultEntityDescriptions(){const e=this.getPlugin();if(!(e!=null&&e.settings))throw new Error("Plugin settings not available");e.settings.entityDescriptions||(e.settings.entityDescriptions={});const t=this.schemaService.getAvailableDefaultEntityTypes();let i=0,s=0;for(const r of t){const o=this.schemaService.getDefaultEntityDescription(r);if(o)if(e.settings.entityDescriptions[r]){const a=e.settings.entityDescriptions[r];a.source!=="user"&&(e.settings.entityDescriptions[r]={...a,description:o,source:"discovery",lastModified:new Date().toISOString()},s++)}else e.settings.entityDescriptions[r]={className:r.replace(/\s+/g,"").replace(/[^a-zA-Z0-9]/g,""),description:o,isUserDefined:!1,source:"discovery",lastModified:new Date().toISOString()},i++}await e.saveSettings(),this.logger.info("Loaded all default entity descriptions",{addedCount:i,updatedCount:s})}async loadAllDefaultPropertyDescriptions(){const e=this.getPlugin();if(!(e!=null&&e.settings))throw new Error("Plugin settings not available");e.settings.propertyDescriptions||(e.settings.propertyDescriptions={});let t=0,i=0;const s=await this.schemaService.discoverAllSchemas();for(const r of s){const o=r.typeName;e.settings.propertyDescriptions[o]||(e.settings.propertyDescriptions[o]={});for(const a of r.properties){const l=a.name,d=this.schemaService.getDefaultPropertyDescription(l);if(d)if(e.settings.propertyDescriptions[o][l]){const p=e.settings.propertyDescriptions[o][l];p.source!=="user"&&(e.settings.propertyDescriptions[o][l]={...p,description:d,source:"discovery",lastModified:new Date().toISOString()},i++)}else e.settings.propertyDescriptions[o][l]={description:d,fieldType:a.inferredType==="string"?"str":a.inferredType==="number"?"float":a.inferredType==="boolean"?"bool":a.inferredType==="date"?"datetime":a.inferredType==="array"?"List[str]":"str",isUserDefined:!1,source:"discovery",lastModified:new Date().toISOString()},t++}}await e.saveSettings(),this.logger.info("Loaded all default property descriptions",{addedCount:t,updatedCount:i})}async saveData(){const e=this.getPlugin();if(!(e!=null&&e.settings))throw new Error("Plugin settings not available");await e.saveSettings(),this.logger.info("Saved data to data.json")}logCacheMetrics(e){const t=yn.performance.now();if(t-this.lastCacheLogTime>5e3||(this.cacheHits+this.cacheMisses)%10===0){const r=this.cacheHits+this.cacheMisses,o=r>0?(this.cacheHits/r*100).toFixed(2):"0.00",a=this.pathCache.size,d=(a*200/1024).toFixed(2);this.logger.debug(`[CACHE_HEALTH] Vault: ${e}, Hits: ${this.cacheHits}, Misses: ${this.cacheMisses}, Hit Ratio: ${o}%, Cache Size: ${a} entries, Est. Memory: ${d} KB`),this.cacheHits=0,this.cacheMisses=0,this.lastCacheLogTime=t}}async generateWithLLM(e,t){return this.logger.info("LLM generation (stub)",{promptLength:e.length,hasSystemPrompt:!!t,provider:this.settings.llmProvider}),JSON.stringify({response:"Mock LLM response - backend integration pending",provider:this.settings.llmProvider,model:this.settings.llmModel,timestamp:new Date().toISOString()})}async startMcpServer(){try{if(this.mcpServerProcess&&!this.mcpServerProcess.killed)return{success:!1,message:"MCP server is already running",pid:this.mcpServerProcess.pid};const{pluginDir:e}=this.getVaultAwarePaths(),t=Ge.join(e,"mcp-server","megamem_mcp_server.py");if(!require("fs").existsSync(t))return{success:!1,message:`MCP server not found at: ${t}`};this.logger.info("Starting MCP server process",{mcpServerPath:t});const s=this.getPythonExecutable(),r=this.getPythonEnv();return this.mcpServerProcess=Nt.spawn(s,[t],{stdio:["pipe","pipe","pipe"],cwd:Ge.join(e,"mcp-server"),env:r}),new Promise(o=>{var l,d;const a=setTimeout(()=>{this.mcpServerProcess&&(this.mcpServerProcess.kill(),this.mcpServerProcess=null),o({success:!1,message:"MCP server startup timeout"})},1e4);this.mcpServerProcess.on("spawn",()=>{clearTimeout(a),this.logger.info("MCP server started successfully",{pid:this.mcpServerProcess.pid}),o({success:!0,message:"MCP server started successfully",pid:this.mcpServerProcess.pid})}),this.mcpServerProcess.on("error",p=>{clearTimeout(a),this.mcpServerProcess=null,this.logger.error("Failed to start MCP server",p),o({success:!1,message:`Failed to start MCP server: ${p.message}`})}),this.mcpServerProcess.on("exit",(p,g)=>{this.mcpServerProcess=null,this.logger.warn("MCP server process exited",{code:p,signal:g})}),(l=this.mcpServerProcess.stdout)==null||l.on("data",p=>{this.logger.debug("MCP server stdout",{output:p.toString().trim()})}),(d=this.mcpServerProcess.stderr)==null||d.on("data",p=>{this.logger.warn("MCP server stderr",{output:p.toString().trim()})})})}catch(e){return this.logger.error("Error starting MCP server",e),{success:!1,message:`Error starting MCP server: ${e instanceof Error?e.message:String(e)}`}}}async stopMcpServer(){try{if(!this.mcpServerProcess||this.mcpServerProcess.killed)return{success:!0,message:"MCP server is not running"};const e=this.mcpServerProcess.pid;return this.logger.info("Stopping MCP server process",{pid:e}),new Promise(t=>{var s;const i=setTimeout(()=>{this.mcpServerProcess&&!this.mcpServerProcess.killed&&(this.logger.warn("Force killing MCP server process"),this.mcpServerProcess.kill("SIGKILL"))},5e3);this.mcpServerProcess.on("exit",()=>{clearTimeout(i),this.mcpServerProcess=null,this.logger.info("MCP server stopped successfully"),t({success:!0,message:"MCP server stopped successfully"})}),(s=this.mcpServerProcess)==null||s.kill("SIGTERM")})}catch(e){return this.logger.error("Error stopping MCP server",e),{success:!1,message:`Error stopping MCP server: ${e instanceof Error?e.message:String(e)}`}}}isMcpServerRunning(){return this.mcpServerProcess!==null&&!this.mcpServerProcess.killed}getMcpServerStatus(){return this.mcpServerProcess?this.mcpServerProcess.killed?{running:!1,status:"stopped",message:"MCP server process was killed"}:{running:!0,pid:this.mcpServerProcess.pid,status:"running",message:`MCP server is running (PID: ${this.mcpServerProcess.pid})`}:{running:!1,status:"stopped",message:"MCP server is not running"}}generateClaudeDesktopConfig(){try{const{pluginDir:e}=this.getVaultAwarePaths(),t=Ge.join(e,"mcp-server","megamem_mcp_server.py"),i=Ge.join(e,"data.json"),s=require("fs");if(!s.existsSync(t))return{success:!1,message:`MCP server not found at: ${t}`};const r=this.pythonInstaller.getPythonExecutable(),a={mcpServers:{megamem:{command:r&&s.existsSync(r)?r.replace(/\\/g,"/"):"python",args:[t.replace(/\\/g,"/")],env:{OBSIDIAN_CONFIG_PATH:i.replace(/\\/g,"/")}}}},l=require("os"),d=require("path"),p=d.join(l.homedir(),"AppData","Roaming","Claude"),g=d.join(p,"claude_desktop_config.json");return{success:!0,config:a,message:"Claude Desktop configuration generated successfully",configPath:g}}catch(e){return this.logger.error("Error generating Claude Desktop config",e),{success:!1,message:`Error generating config: ${e instanceof Error?e.message:String(e)}`}}}}class qd{constructor(e,t,i,s){this.daemonProcess=null,this.commandQueue=[],this.isProcessing=!1,this.isShuttingDown=!1,this.startupPromise=null,this.plugin=e,this.settings=t,this.logger=i,this.vaultRegistry=s,this.pythonInstaller=new gn(e,this.getPluginDirectory(),{pythonPath:t.pythonPath})}async preloadDaemon(){return this.startDaemon()}async startDaemon(){if(!(this.daemonProcess&&!this.daemonProcess.killed))return this.startupPromise?this.startupPromise:(this.startupPromise=this._startDaemonInternal(),this.startupPromise)}async _startDaemonInternal(){return new Promise((e,t)=>{var i,s;try{const r=this.getPluginDirectory(),o=this.getBridgePath(),a=Ge.join(o,"sync_daemon.py"),l=require("fs");this.logger.debug("[DAEMON] Resolved paths",{pluginDir:r,bridgePath:o,daemonScript:a,exists:l.existsSync(a)}),this.logger.info("[DAEMON] Starting Python daemon process");const d=this.getPythonExecutable(),g={...this.getPythonEnv()};this.settings.logPerformance&&(g.GRAPHITI_LOG_PERFORMANCE="true"),this.daemonProcess=Nt.spawn(d,["-m","graphiti_bridge.sync_daemon"],{stdio:["pipe","pipe","pipe"],cwd:r,env:g});let m=!1;const h=setTimeout(()=>{m||(this.logger.error("[DAEMON] Startup timeout"),t(new Error("Daemon startup timeout")))},12e4);this.logger.debug("[DAEMON] Waiting up to 120s for daemon readiness"),(i=this.daemonProcess.stdout)==null||i.on("data",b=>{const c=b.toString().trim();this.logger.logPythonOutput("stdout",c),c.includes('"status": "ready"')&&!m&&(m=!0,clearTimeout(h),this.logger.info("[DAEMON] Process ready - BGE model loaded"),this.startupPromise=null,e())}),(s=this.daemonProcess.stderr)==null||s.on("data",b=>{const c=b.toString().trim();this.logger.logPythonOutput("stderr",c)}),this.daemonProcess.on("error",b=>{this.logger.error("[DAEMON] Process error:",b),this.startupPromise=null,m||(clearTimeout(h),t(b))}),this.daemonProcess.on("exit",(b,c)=>{this.logger.info(`[DAEMON] Process exited with code ${b}, signal ${c}`),this.daemonProcess=null,this.startupPromise=null,m||(clearTimeout(h),t(new Error(`Daemon process exited with code ${b}`)))})}catch(r){this.logger.error("[DAEMON] Failed to start process:",r),this.startupPromise=null,t(r)}})}async executeDaemonSync(e){try{await this.startDaemon();const i={command:"sync",config:{...e,logPerformance:this.settings.logPerformance}};return await this.executeCommand(i)}catch(t){throw this.logger.error("[DAEMON] Sync execution failed:",t),t}}async executeCommand(e){if(this.isShuttingDown)throw new Error("Daemon is shutting down");return new Promise((t,i)=>{const s=setTimeout(()=>{i(new Error("Command timeout - daemon may be unresponsive"))},6e5),r={command:e,resolve:o=>{clearTimeout(s),t(o)},reject:o=>{clearTimeout(s),i(o)},timeout:s};this.commandQueue.push(r),this.processQueue()})}async processQueue(){if(!(this.isProcessing||this.commandQueue.length===0)){for(this.isProcessing=!0;this.commandQueue.length>0&&!this.isShuttingDown;){const e=this.commandQueue.shift();try{const t=await this.sendCommandToDaemon(e.command);e.resolve(t)}catch(t){e.reject(t)}}this.isProcessing=!1}}async sendCommandToDaemon(e){const t=this.daemonProcess;if(!t||t.killed)throw new Error("Daemon process not available");return new Promise((i,s)=>{var d,p;let r="",o=!1;const a=g=>{var m;r+=g.toString();try{const h=r.split(`
`);for(const b of h)if(b.trim()&&!o){const c=JSON.parse(b.trim());o=!0,(m=t.stdout)==null||m.removeListener("data",a),i(c);return}}catch(h){}};(d=t.stdout)==null||d.on("data",a);const l=JSON.stringify(e)+`
`;(p=t.stdin)==null||p.write(l),setTimeout(()=>{var g;o||((g=t.stdout)==null||g.removeListener("data",a),s(new Error("Command response timeout")))},6e5)})}async shutdown(){var t;if(this.isShuttingDown)return;this.isShuttingDown=!0,this.logger.info("[DAEMON] Shutting down daemon process"),this.commandQueue.forEach(i=>{clearTimeout(i.timeout),i.reject(new Error("Daemon shutting down"))}),this.commandQueue=[];const e=this.daemonProcess;if(e&&!e.killed)try{const i={command:"shutdown"};(t=e.stdin)==null||t.write(JSON.stringify(i)+`
`),await new Promise(s=>setTimeout(s,2e3)),e&&!e.killed&&e.kill("SIGTERM")}catch(i){this.logger.error("[DAEMON] Error during shutdown:",i),e&&!e.killed&&e.kill("SIGKILL")}this.daemonProcess=null,this.isShuttingDown=!1,this.startupPromise=null}getBridgePath(){var o,a,l,d,p;const e=require("fs");let t=this.vaultRegistry.getActiveVault();if(t||(this.vaultRegistry.ensureActiveVault(),t=this.vaultRegistry.getActiveVault()),t!=null&&t.path){const g=Ge.join(t.path,".obsidian","plugins","megamem-mcp","graphiti_bridge");if(e.existsSync(Ge.join(g,"sync_daemon.py")))return this.logger.debug("[DAEMON] Using vault-aware bridge path",{path:g}),g}const i=((a=(o=this.plugin)==null?void 0:o.manifest)==null?void 0:a.dir)||"",s=((p=(d=(l=this.plugin.app)==null?void 0:l.vault)==null?void 0:d.adapter)==null?void 0:p.basePath)||"",r=s?Ge.join(s,i,"graphiti_bridge"):Ge.join(i,"graphiti_bridge");return this.logger.debug("[DAEMON] Using fallback bridge path",{path:r,vaultPath:(t==null?void 0:t.path)||"none",manifestDir:i,currentVaultPath:s}),r}getPluginDirectory(){var r,o,a,l,d;const e=require("fs");let t=this.vaultRegistry.getActiveVault();if(t||(this.vaultRegistry.ensureActiveVault(),t=this.vaultRegistry.getActiveVault()),t!=null&&t.path){const p=Ge.join(t.path,".obsidian","plugins","megamem-mcp");if(e.existsSync(p))return p}const i=((o=(r=this.plugin)==null?void 0:r.manifest)==null?void 0:o.dir)||"",s=((d=(l=(a=this.plugin.app)==null?void 0:a.vault)==null?void 0:l.adapter)==null?void 0:d.basePath)||"";return s?Ge.join(s,i):i}getPythonExecutable(){const t=this.pythonInstaller.getPythonEnv().PYTHON_EXECUTABLE;if(!t)throw new P.Notice("Python environment not configured. Please run Python installation from settings."),new Error("Python environment not configured");return t}getPythonEnv(){return this.pythonInstaller.getPythonEnv()}isRunning(){return!!(this.daemonProcess&&!this.daemonProcess.killed)}getStatus(){return{running:this.isRunning(),queueLength:this.commandQueue.length,processing:this.isProcessing}}}class Wd{constructor(e){this.plugin=e,this.settings=e.settings,this.logger=new Gt(e,this.settings.enableDebugLogging)}async generateEntityDescription(e,t){if(!this.validateAPIKey())throw new Error(`API key not configured for ${this.settings.llmProvider}`);const i="You are a knowledge graph schema designer. Generate a concise, clear description (1-2 sentences) for entity types.";let s=`Generate a description for the entity type "${e}".`;return t&&t.length>0&&(s+=`

Example instances:
${t.slice(0,3).join(`
`)}`),s+=`

Respond with only the description, no preamble.`,await this.callLLM(s,i)}async generatePropertyDescription(e,t,i){if(!this.validateAPIKey())throw new Error(`API key not configured for ${this.settings.llmProvider}`);const s="You are a knowledge graph schema designer. Generate concise descriptions (1 sentence) for entity properties.";let r=`Generate a description for the property "${t}" on entity type "${e}".`;return i&&i.length>0&&(r+=`

Example values:
${i.slice(0,5).join(`
`)}`),r+=`

Respond with only the description, no preamble.`,await this.callLLM(r,s)}async suggestEdgeTypes(e,t){if(!this.validateAPIKey())throw new Error(`API key not configured for ${this.settings.llmProvider}`);const i="You are a knowledge graph designer. Suggest edge types that could connect two entity types.",s=`Suggest 1-3 edge types from "${e}" to "${t}".

Respond with JSON only (no markdown):
[
  {"className": "EdgeName", "description": "Brief description", "confidence": 0.9}
]`,r=await this.callLLM(s,i);try{const o=r.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();return JSON.parse(o)}catch(o){return this.logger.error("Failed to parse edge type suggestions",o),[]}}async suggestEdgeMappings(e){if(!this.validateAPIKey())throw new Error(`API key not configured for ${this.settings.llmProvider}`);const t="You are a knowledge graph designer. Create relationship mappings between entity types.",i=`Create edge mappings for these entity types: ${e.join(", ")}.

Respond with JSON only (no markdown):
[
  {"source": "EntityA", "target": "EntityB", "edgeTypes": ["EdgeType1", "EdgeType2"]}
]`,s=await this.callLLM(i,t);try{const r=s.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();return JSON.parse(r)}catch(r){return this.logger.error("Failed to parse edge mappings",r),[]}}async generateCompleteOntology(e){if(!this.validateAPIKey())throw new Error(`API key not configured for ${this.settings.llmProvider}`);const t="You are a knowledge graph architect. Design complete ontologies with entities, properties, and relationships.",i=`Design a complete ontology for these entity types: ${e.join(", ")}.

For each entity, provide:
1. A description
2. Common properties with descriptions and field types (str, int, float, bool, datetime, List[str])
3. Edge types that connect entities
4. Entity-to-entity mappings

Respond with JSON only (no markdown):
{
  "entities": {
    "EntityName": {"description": "...", "confidence": 0.9}
  },
  "properties": {
    "EntityName": {
      "propertyName": {"description": "...", "fieldType": "str", "confidence": 0.9}
    }
  },
  "edgeTypes": {
    "EdgeTypeName": {"description": "...", "confidence": 0.9}
  },
  "mappings": [
    {"source": "Entity1", "target": "Entity2", "edgeTypes": ["EdgeType"]}
  ]
}`,s=await this.callLLM(i,t);try{const r=s.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();return JSON.parse(r)}catch(r){throw this.logger.error("Failed to parse complete ontology",r),new Error("Failed to generate ontology: Invalid LLM response format")}}async callLLM(e,t){const i=this.settings.llmProvider,s=this.settings.llmModel,r=i==="ollama"?"":this.settings.apiKeys[i]||"";if(!r&&i!=="ollama")throw new Error(`No API key configured for ${i}`);this.logger.debug("Calling LLM",{provider:i,model:s});const o=[];t&&o.push({role:"system",content:t}),o.push({role:"user",content:e});try{switch(i){case"openai":return await this.callOpenAI(o,s,r);case"anthropic":return await this.callAnthropic(o,s,r);case"google":return await this.callGoogle(o,s,r);case"ollama":return await this.callOllama(o,s);case"openrouter":return await this.callOpenRouter(o,s,r);default:throw new Error(`Unsupported LLM provider: ${i}`)}}catch(a){throw this.logger.error("LLM call failed",a),a}}async callOpenAI(e,t,i){const s=await P.requestUrl({url:"https://api.openai.com/v1/chat/completions",method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:t,messages:e,temperature:.7,max_tokens:1e3})});if(s.status!==200)throw new Error(`OpenAI API error: ${s.status} ${s.text}`);return s.json.choices[0].message.content}async callAnthropic(e,t,i){const s=e.find(l=>l.role==="system"),r=e.filter(l=>l.role!=="system"),o=await P.requestUrl({url:"https://api.anthropic.com/v1/messages",method:"POST",headers:{"Content-Type":"application/json","x-api-key":i,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:t,max_tokens:1e3,system:s==null?void 0:s.content,messages:r})});if(o.status!==200)throw new Error(`Anthropic API error: ${o.status} ${o.text}`);return o.json.content[0].text}async callGoogle(e,t,i){const s=e.map(a=>({role:a.role==="user"?"user":"model",parts:[{text:a.content}]})),r=await P.requestUrl({url:`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent?key=${i}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:s,generationConfig:{temperature:.7,maxOutputTokens:1e3}})});if(r.status!==200)throw new Error(`Google API error: ${r.status} ${r.text}`);return r.json.candidates[0].content.parts[0].text}async callOllama(e,t){const i=this.settings.ollamaBaseUrl||"http://localhost:11434",s=await P.requestUrl({url:`${i}/api/chat`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,messages:e,stream:!1})});if(s.status!==200)throw new Error(`Ollama API error: ${s.status} ${s.text}`);return s.json.message.content}async callOpenRouter(e,t,i){const s=await P.requestUrl({url:"https://openrouter.ai/api/v1/chat/completions",method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"HTTP-Referer":"https://obsidian.md","X-Title":"Obsidian MegaMem"},body:JSON.stringify({model:t,messages:e,temperature:.7,max_tokens:1e3})});if(s.status!==200)throw new Error(`OpenRouter API error: ${s.status} ${s.text}`);return s.json.choices[0].message.content}validateAPIKey(){const e=this.settings.llmProvider;if(e==="ollama")return!0;const t=this.settings.apiKeys[e];return!!t&&t.length>0}async getSampleNotes(e,t=5){try{const i=this.plugin.app.vault.getMarkdownFiles(),s=[];for(const r of i){if(s.length>=t)break;if(e){const o=this.plugin.app.metadataCache.getFileCache(r),a=o==null?void 0:o.frontmatter;if((a==null?void 0:a.type)===e||(a==null?void 0:a.entity_type)===e){const l=await this.plugin.app.vault.read(r);s.push(l.substring(0,500))}}else{const o=await this.plugin.app.vault.read(r);s.push(o.substring(0,500))}}return this.logger.info("Extracted sample notes",{entityType:e,count:s.length}),s}catch(i){return this.logger.error("Failed to extract sample notes",i),[]}}updateSettings(e){this.settings=e,this.logger.setDebug(e.enableDebugLogging)}}function we(){}function Kd(n){return!!n&&(typeof n=="object"||typeof n=="function")&&typeof n.then=="function"}function lo(n){return n()}function Fi(){return Object.create(null)}function Qe(n){n.forEach(lo)}function co(n){return typeof n=="function"}function ai(n,e){return n!=n?e==e:n!==e||n&&typeof n=="object"||typeof n=="function"}function Hd(n){return Object.keys(n).length===0}function u(n,e){n.appendChild(e)}function z(n,e,t){n.insertBefore(e,t||null)}function j(n){n.parentNode&&n.parentNode.removeChild(n)}function et(n,e){for(let t=0;t<n.length;t+=1)n[t]&&n[t].d(e)}function y(n){return document.createElement(n)}function Tn(n){return document.createElementNS("http://www.w3.org/2000/svg",n)}function $(n){return document.createTextNode(n)}function E(){return $(" ")}function rn(){return $("")}function ne(n,e,t,i){return n.addEventListener(e,t,i),()=>n.removeEventListener(e,t,i)}function It(n){return function(e){return e.stopPropagation(),n.call(this,e)}}function Jd(n){return function(e){e.target===this&&n.call(this,e)}}function f(n,e,t){t==null?n.removeAttribute(e):n.getAttribute(e)!==t&&n.setAttribute(e,t)}function Qd(n){let e;return{p(...t){e=t,e.forEach(i=>n.push(i))},r(){e.forEach(t=>n.splice(n.indexOf(t),1))}}}function Zd(n){return Array.from(n.childNodes)}function ae(n,e){e=""+e,n.data!==e&&(n.data=e)}function Ie(n,e){n.value=e==null?"":e}function Mn(n,e,t,i){t==null?n.style.removeProperty(e):n.style.setProperty(e,t,i?"important":"")}function kt(n,e,t){for(let i=0;i<n.options.length;i+=1){const s=n.options[i];if(s.__value===e){s.selected=!0;return}}(!t||e!==void 0)&&(n.selectedIndex=-1)}function on(n){const e=n.querySelector(":checked");return e&&e.__value}let fn;function At(n){fn=n}function li(){if(!fn)throw new Error("Function called outside component initialization");return fn}function ci(n){li().$$.on_mount.push(n)}function uo(n){li().$$.on_destroy.push(n)}const Zt=[],Zn=[];let nn=[];const $i=[],Xd=Promise.resolve();let Xn=!1;function eu(){Xn||(Xn=!0,Xd.then(di))}function jt(n){nn.push(n)}const jn=new Set;let Ht=0;function di(){if(Ht!==0)return;const n=fn;do{try{for(;Ht<Zt.length;){const e=Zt[Ht];Ht++,At(e),tu(e.$$)}}catch(e){throw Zt.length=0,Ht=0,e}for(At(null),Zt.length=0,Ht=0;Zn.length;)Zn.pop()();for(let e=0;e<nn.length;e+=1){const t=nn[e];jn.has(t)||(jn.add(t),t())}nn.length=0}while(Zt.length);for(;$i.length;)$i.pop()();Xn=!1,jn.clear(),At(n)}function tu(n){if(n.fragment!==null){n.update(),Qe(n.before_update);const e=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,e),n.after_update.forEach(jt)}}function nu(n){const e=[],t=[];nn.forEach(i=>n.indexOf(i)===-1?e.push(i):t.push(i)),t.forEach(i=>i()),nn=e}const wn=new Set;let Bt;function Ue(){Bt={r:0,c:[],p:Bt}}function je(){Bt.r||Qe(Bt.c),Bt=Bt.p}function G(n,e){n&&n.i&&(wn.delete(n),n.i(e))}function Z(n,e,t,i){if(n&&n.o){if(wn.has(n))return;wn.add(n),Bt.c.push(()=>{wn.delete(n),i&&(t&&n.d(1),i())}),n.o(e)}else i&&i()}function Ui(n,e){const t=e.token={};function i(s,r,o,a){if(e.token!==t)return;e.resolved=a;let l=e.ctx;o!==void 0&&(l=l.slice(),l[o]=a);const d=s&&(e.current=s)(l);let p=!1;e.block&&(e.blocks?e.blocks.forEach((g,m)=>{m!==r&&g&&(Ue(),Z(g,1,1,()=>{e.blocks[m]===g&&(e.blocks[m]=null)}),je())}):e.block.d(1),d.c(),G(d,1),d.m(e.mount(),e.anchor),p=!0),e.block=d,e.blocks&&(e.blocks[r]=d),p&&di()}if(Kd(n)){const s=li();if(n.then(r=>{At(s),i(e.then,1,e.value,r),At(null)},r=>{if(At(s),i(e.catch,2,e.error,r),At(null),!e.hasCatch)throw r}),e.current!==e.pending)return i(e.pending,0),!0}else{if(e.current!==e.then)return i(e.then,1,e.value,n),!0;e.resolved=n}}function iu(n,e,t){const i=e.slice(),{resolved:s}=n;n.current===n.then&&(i[n.value]=s),n.current===n.catch&&(i[n.error]=s),n.block.p(i,t)}function xe(n){return(n==null?void 0:n.length)!==void 0?n:Array.from(n)}function Pe(n){n&&n.c()}function Ee(n,e,t){const{fragment:i,after_update:s}=n.$$;i&&i.m(e,t),jt(()=>{const r=n.$$.on_mount.map(lo).filter(co);n.$$.on_destroy?n.$$.on_destroy.push(...r):Qe(r),n.$$.on_mount=[]}),s.forEach(jt)}function Ce(n,e){const t=n.$$;t.fragment!==null&&(nu(t.after_update),Qe(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function su(n,e){n.$$.dirty[0]===-1&&(Zt.push(n),eu(),n.$$.dirty.fill(0)),n.$$.dirty[e/31|0]|=1<<e%31}function ui(n,e,t,i,s,r,o=null,a=[-1]){const l=fn;At(n);const d=n.$$={fragment:null,ctx:[],props:r,update:we,not_equal:s,bound:Fi(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(l?l.$$.context:[])),callbacks:Fi(),dirty:a,skip_bound:!1,root:e.target||l.$$.root};o&&o(d.root);let p=!1;if(d.ctx=t?t(n,e.props||{},(g,m,...h)=>{const b=h.length?h[0]:m;return d.ctx&&s(d.ctx[g],d.ctx[g]=b)&&(!d.skip_bound&&d.bound[g]&&d.bound[g](b),p&&su(n,g)),m}):[],d.update(),p=!0,Qe(d.before_update),d.fragment=i?i(d.ctx):!1,e.target){if(e.hydrate){const g=Zd(e.target);d.fragment&&d.fragment.l(g),g.forEach(j)}else d.fragment&&d.fragment.c();e.intro&&G(n.$$.fragment),Ee(n,e.target,e.anchor),di()}At(l)}class pi{constructor(){Rn(this,"$$");Rn(this,"$$set")}$destroy(){Ce(this,1),this.$destroy=we}$on(e,t){if(!co(t))return we;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(t),()=>{const s=i.indexOf(t);s!==-1&&i.splice(s,1)}}$set(e){this.$$set&&!Hd(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const ru="4";typeof window!="undefined"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(ru);function ou(n){let e,t;return{c(){e=y("span"),f(e,"class",t="obsidian-icon inline-flex items-center justify-center "+n[3][n[0]]+" "+n[1]),f(e,"aria-hidden","true")},m(i,s){z(i,e,s),n[5](e)},p(i,[s]){s&3&&t!==(t="obsidian-icon inline-flex items-center justify-center "+i[3][i[0]]+" "+i[1])&&f(e,"class",t)},i:we,o:we,d(i){i&&j(e),n[5](null)}}}function au(n,e,t){let{icon:i}=e,{size:s="medium"}=e,{extraClasses:r=""}=e,o,a=null;const l={small:"w-3 h-3",medium:"w-4 h-4",large:"w-5 h-5",inherit:""};function d(){o&&i&&(P.setIcon(o,i),s==="inherit"?(t(2,o.style.width="1em",o),t(2,o.style.height="1em",o)):(t(2,o.style.width="",o),t(2,o.style.height="",o)))}ci(()=>{d(),a=new MutationObserver(g=>{g.forEach(m=>{m.type==="attributes"&&(m.attributeName==="class"||m.attributeName==="style")&&d()})}),o&&(a.observe(o,{attributes:!0}),o.parentElement&&a.observe(o.parentElement,{attributes:!0}))}),uo(()=>{a==null||a.disconnect()});function p(g){Zn[g?"unshift":"push"](()=>{o=g,t(2,o)})}return n.$$set=g=>{"icon"in g&&t(4,i=g.icon),"size"in g&&t(0,s=g.size),"extraClasses"in g&&t(1,r=g.extraClasses)},d(),[s,r,o,l,i,p]}class De extends pi{constructor(e){super(),ui(this,e,au,ou,ai,{icon:4,size:0,extraClasses:1})}}function ji(n,e,t){const i=n.slice();return i[205]=e[t],i}function zi(n,e,t){const i=n.slice();return i[208]=e[t],i}function Bi(n,e,t){const i=n.slice();return i[208]=e[t],i}function Vi(n,e,t){const i=n.slice();return i[213]=e[t],i}function Gi(n,e,t){const i=n.slice();return i[205]=e[t],i}function Yi(n,e,t){const i=n.slice();return i[218]=e[t],i[220]=t,i}function qi(n,e,t){const i=n.slice();return i[205]=e[t],i}function Wi(n,e,t){const i=n.slice();return i[205]=e[t],i}function Ki(n,e,t){const i=n.slice();return i[208]=e[t],i}function Hi(n,e,t){const i=n.slice();return i[208]=e[t],i}function Ji(n,e,t){const i=n.slice();return i[213]=e[t],i}function Qi(n,e,t){const i=n.slice();return i[231]=e[t][0],i[232]=e[t][1],i}function Zi(n,e,t){const i=n.slice();return i[231]=e[t],i}function Xi(n,e,t){const i=n.slice();return i[237]=e[t][0],i[238]=e[t][1],i}function es(n,e,t){const i=n.slice();return i[213]=e[t],i}function ts(n,e,t){var o,a;const i=n.slice();i[243]=e[t],i[247]=t;const s=((o=i[243].properties)==null?void 0:o.filter(function(...d){return n[136](i[243],...d)}))||[];i[244]=s;const r=((a=i[243].properties)==null?void 0:a.length)||0;return i[245]=r,i}function ns(n,e,t){var p,g,m,h,b,c,v,w,_,C,x,N,k;const i=n.slice();i[248]=e[t],i[256]=t;const s=(m=(p=i[3])==null?void 0:p.globallyIgnoredFields)==null?void 0:m.includes((g=i[248])==null?void 0:g.name);i[249]=s;const r=i[79](i[243].typeName,(h=i[248])==null?void 0:h.name);i[250]=r;const o=(w=(v=(c=(b=i[3])==null?void 0:b.propertySelections)==null?void 0:c[i[243].typeName])==null?void 0:v[i[250]])!=null?w:!1;i[251]=o;const a=i[81](i[243].typeName,(_=i[248])==null?void 0:_.name);i[252]=a;const l=i[80](i[243].typeName,(C=i[248])==null?void 0:C.name);i[253]=l;const d=!!((k=(N=i[37][i[243].typeName])==null?void 0:N[((x=i[248])==null?void 0:x.name)||""])!=null&&k.description);return i[254]=d,i}function is(n,e,t){const i=n.slice();i[243]=e[t],i[258]=e,i[220]=t;const s=Cp(i[243]);return i[257]=s,i}function zn(n){const e=n.slice(),t=e[86]();return e[259]=t,e}function Bn(n){const e=n.slice(),t=e[0].reduce((i,s)=>{var r;return i+(((r=s.properties)==null?void 0:r.length)||0)},0);return e[260]=t,e}function ss(n){let e,t,i=n[0].length+"",s,r;return{c(){e=y("span"),t=$("("),s=$(i),r=$(")"),f(e,"class","text-xs opacity-80 font-normal")},m(o,a){z(o,e,a),u(e,t),u(e,s),u(e,r)},p(o,a){a[0]&1&&i!==(i=o[0].length+"")&&ae(s,i)},d(o){o&&j(e)}}}function rs(n){let e,t,i=n[260]+"",s,r;return{c(){e=y("span"),t=$("("),s=$(i),r=$(")"),f(e,"class","text-xs opacity-80 font-normal")},m(o,a){z(o,e,a),u(e,t),u(e,s),u(e,r)},p(o,a){a[0]&1&&i!==(i=o[260]+"")&&ae(s,i)},d(o){o&&j(e)}}}function os(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F,L,V,Y,W,K,H,U;function X(Q,ue){return Q[15]&&Q[21]==="entities"?cu:lu}let I=X(n),J=I(n);function fe(Q,ue){return Q[15]&&Q[21]==="properties"?uu:du}let Te=fe(n),ye=Te(n);function ve(Q,ue){return Q[15]&&Q[21]==="complete"?gu:pu}let ge=ve(n),me=ge(n),Me=n[15]&&as(n),ie=n[0].length>0&&ls(zn(n)),se=n[0].length>0&&cs(n);return{c(){e=y("div"),t=y("div"),i=y("h3"),i.textContent="LLM Automatic Ontologies",s=E(),r=y("p"),r.textContent=`Use AI to automatically generate entity descriptions, property\r
            definitions, and relationships from your vault content.`,o=E(),a=y("div"),l=y("button"),J.c(),d=E(),p=y("button"),ye.c(),g=E(),m=y("button"),me.c(),h=E(),b=y("button"),b.textContent="Load All Default Entity Descriptions",c=E(),Me&&Me.c(),v=E(),ie&&ie.c(),w=E(),_=y("div"),C=y("h3"),C.textContent="Base Entity Type",x=E(),N=y("div"),k=y("div"),T=y("h4"),T.textContent="BaseEntity",D=E(),A=y("div"),O=y("button"),O.textContent="View Properties",B=E(),R=y("span"),R.textContent="SYSTEM",F=E(),L=y("div"),L.innerHTML=`<p class="text-[var(--text-default)] text-sm leading-relaxed">Base entity class that provides core properties inherited by all
                other entity types. Contains fundamental metadata for knowledge
                graph processing.</p>`,V=E(),Y=y("div"),Y.innerHTML='<span class="flex items-center gap-1">Inherited by all entities</span> <span class="flex items-center gap-1">3 core properties</span> <span class="flex items-center gap-1">Always enabled</span>',W=E(),se&&se.c(),f(i,"class","text-xl font-semibold mb-2 flex items-center gap-2"),f(r,"class","mb-4 opacity-90 leading-relaxed text-[var(--text-on-accent)]"),f(l,"class","px-4 py-2 bg-[rgba(255,255,255,0.06)] border border-[rgba(255,255,255,0.08)] rounded-md text-sm transition-all duration-200 backdrop-blur-sm hover:bg-[rgba(255,255,255,0.09)] disabled:opacity-50 disabled:cursor-not-allowed text-[var(--text-on-accent)]"),l.disabled=n[15],f(p,"class","px-4 py-2 bg-[rgba(255,255,255,0.06)] border border-[rgba(255,255,255,0.08)] rounded-md text-sm transition-all duration-200 backdrop-blur-sm hover:bg-[rgba(255,255,255,0.09)] disabled:opacity-50 disabled:cursor-not-allowed text-[var(--text-on-accent)]"),p.disabled=n[15],f(m,"class","megamem-bulk-button px-4 py-2 bg-[rgba(255,255,255,0.06)] border border-[rgba(255,255,255,0.08)] rounded-md text-sm transition-all duration-200 backdrop-blur-sm hover:bg-[rgba(255,255,255,0.09)] disabled:opacity-50 disabled:cursor-not-allowed text-[var(--text-on-accent)] svelte-1fc521h"),m.disabled=n[15],f(b,"class","px-4 py-2 bg-[rgba(255,255,255,0.04)] border border-[rgba(255,255,255,0.06)] rounded-md text-sm transition-all duration-200 backdrop-blur-sm hover:bg-[rgba(255,255,255,0.06)] hover:border-[rgba(255,255,255,0.08)] text-[var(--text-on-accent)]"),f(b,"title","Load all default entity descriptions into data.json"),f(a,"class","flex gap-3 flex-wrap items-center"),f(t,"class","bg-gradient-to-br from-[var(--interactive-accent)] to-[var(--background-secondary)] text-[var(--text-on-accent)] p-6 rounded-xl mb-6 shadow-md"),f(C,"class","text-lg font-semibold mb-4 text-[var(--text-default)]"),f(T,"class","text-lg font-semibold text-[var(--text-default)]"),f(O,"class","px-3 py-1 bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded text-sm hover:bg-[var(--background-modifier-border)] transition-colors duration-150 text-[var(--text-default)]"),f(O,"title","View Properties"),f(R,"class","text-xs px-2 py-1 bg-[var(--background-modifier-border)] text-[var(--text-muted)] rounded font-bold uppercase tracking-wide ml-2"),f(A,"class","flex gap-1 items-center"),f(k,"class","flex justify-between items-center mb-3"),f(L,"class","mb-3"),f(Y,"class","flex gap-4 text-sm text-[var(--text-default)]"),f(N,"class","bg-[var(--background-primary-alt)] border-2 border-[var(--background-modifier-border)] rounded-lg p-4 max-w-lg"),f(_,"class","mb-8"),f(e,"class","animate-fadeIn"),f(e,"id","entities-panel")},m(Q,ue){z(Q,e,ue),u(e,t),u(t,i),u(t,s),u(t,r),u(t,o),u(t,a),u(a,l),J.m(l,null),u(a,d),u(a,p),ye.m(p,null),u(a,g),u(a,m),me.m(m,null),u(a,h),u(a,b),u(t,c),Me&&Me.m(t,null),u(e,v),ie&&ie.m(e,null),u(e,w),u(e,_),u(_,C),u(_,x),u(_,N),u(N,k),u(k,T),u(k,D),u(k,A),u(A,O),u(A,B),u(A,R),u(N,F),u(N,L),u(N,V),u(N,Y),u(e,W),se&&se.m(e,null),K=!0,H||(U=[ne(l,"click",n[110]),ne(p,"click",n[111]),ne(m,"click",n[112]),ne(b,"click",n[113]),ne(O,"click",n[114])],H=!0)},p(Q,ue){I!==(I=X(Q))&&(J.d(1),J=I(Q),J&&(J.c(),J.m(l,null))),(!K||ue[0]&32768)&&(l.disabled=Q[15]),Te!==(Te=fe(Q))&&(ye.d(1),ye=Te(Q),ye&&(ye.c(),ye.m(p,null))),(!K||ue[0]&32768)&&(p.disabled=Q[15]),ge===(ge=ve(Q))&&me?me.p(Q,ue):(me.d(1),me=ge(Q),me&&(me.c(),me.m(m,null))),(!K||ue[0]&32768)&&(m.disabled=Q[15]),Q[15]?Me?Me.p(Q,ue):(Me=as(Q),Me.c(),Me.m(t,null)):Me&&(Me.d(1),Me=null),Q[0].length>0?ie?ie.p(zn(Q),ue):(ie=ls(zn(Q)),ie.c(),ie.m(e,w)):ie&&(ie.d(1),ie=null),Q[0].length>0?se?(se.p(Q,ue),ue[0]&1&&G(se,1)):(se=cs(Q),se.c(),G(se,1),se.m(e,null)):se&&(Ue(),Z(se,1,1,()=>{se=null}),je())},i(Q){K||(G(se),K=!0)},o(Q){Z(se),K=!1},d(Q){Q&&j(e),J.d(),ye.d(),me.d(),Me&&Me.d(),ie&&ie.d(),se&&se.d(),H=!1,Qe(U)}}}function lu(n){let e;return{c(){e=$("Generate Entity Descriptions")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function cu(n){let e;return{c(){e=$(" Generating...")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function du(n){let e;return{c(){e=$("Suggest Property Descriptions")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function uu(n){let e;return{c(){e=$(" Generating...")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function pu(n){let e;return{c(){e=$(" Generate Complete Ontology")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function gu(n){let e,t=n[16].current+"",i,s,r=n[16].total+"",o,a;return{c(){e=$(" Generating... ("),i=$(t),s=$("/"),o=$(r),a=$(")")},m(l,d){z(l,e,d),z(l,i,d),z(l,s,d),z(l,o,d),z(l,a,d)},p(l,d){d[0]&65536&&t!==(t=l[16].current+"")&&ae(i,t),d[0]&65536&&r!==(r=l[16].total+"")&&ae(o,r)},d(l){l&&(j(e),j(i),j(s),j(o),j(a))}}}function as(n){let e,t,i,s,r=n[16].step+"",o;return{c(){e=y("div"),t=y("div"),i=E(),s=y("div"),o=$(r),f(t,"class","megamem-progress-fill svelte-1fc521h"),Mn(t,"width",n[16].current/n[16].total*100+"%"),f(e,"class","megamem-progress-bar svelte-1fc521h"),f(s,"class","megamem-progress-text svelte-1fc521h")},m(a,l){z(a,e,l),u(e,t),z(a,i,l),z(a,s,l),u(s,o)},p(a,l){l[0]&65536&&Mn(t,"width",a[16].current/a[16].total*100+"%"),l[0]&65536&&r!==(r=a[16].step+"")&&ae(o,r)},d(a){a&&(j(e),j(i),j(s))}}}function ls(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O=n[259].warnings>0&&fu(n);return{c(){e=y("div"),t=y("h3"),t.textContent="Graphiti Compliance Dashboard",i=E(),s=y("div"),r=y("div"),o=y("span"),o.textContent=`${n[259].score}%`,a=E(),l=y("span"),l.textContent="Compliance Score",d=E(),p=y("div"),g=y("div"),m=y("span"),m.textContent=`${n[259].valid}`,h=E(),b=y("span"),b.textContent="Valid",c=E(),v=y("div"),w=y("span"),w.textContent=`${n[259].warnings}`,_=E(),C=y("span"),C.textContent="Warnings",x=E(),N=y("div"),k=y("span"),k.textContent=`${n[259].protectedCount}`,T=E(),D=y("span"),D.textContent="Protected",A=E(),O&&O.c(),f(t,"class","text-lg font-semibold mb-4 text-[var(--text-default)] flex items-center gap-2"),f(o,"class","text-2xl font-bold text-[var(--text-default)]"),f(l,"class","text-xs text-[var(--text-muted)] uppercase tracking-wide"),f(r,"class","flex flex-col items-center p-4 rounded-lg min-w-24 "+(n[259].score>=80?"bg-[var(--background-modifier-success)] border border-[var(--background-modifier-border)]":n[259].score>=60?"bg-[var(--background-modifier-border)] border border-[var(--background-modifier-border)]":"bg-[var(--background-modifier-error)] border border-[var(--background-modifier-border)]")),f(m,"class","text-xl font-bold text-[var(--text-success)]"),f(b,"class","text-xs text-[var(--text-muted)] uppercase tracking-wide"),f(g,"class","flex flex-col items-center p-2"),f(w,"class","text-xl font-bold text-[var(--text-error)]"),f(C,"class","text-xs text-[var(--text-muted)] uppercase tracking-wide"),f(v,"class","flex flex-col items-center p-2"),f(k,"class","text-xl font-bold text-[var(--text-error)]"),f(D,"class","text-xs text-[var(--text-muted)] uppercase tracking-wide"),f(N,"class","flex flex-col items-center p-2"),f(p,"class","flex gap-6"),f(s,"class","flex items-center gap-8 mb-4"),f(e,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded-lg p-6 mb-6")},m(B,R){z(B,e,R),u(e,t),u(e,i),u(e,s),u(s,r),u(r,o),u(r,a),u(r,l),u(s,d),u(s,p),u(p,g),u(g,m),u(g,h),u(g,b),u(p,c),u(p,v),u(v,w),u(v,_),u(v,C),u(p,x),u(p,N),u(N,k),u(N,T),u(N,D),u(e,A),O&&O.m(e,null)},p(B,R){B[259].warnings>0&&O.p(B,R)},d(B){B&&j(e),O&&O.d()}}}function fu(n){let e,t,i,s;return{c(){e=y("div"),t=y("button"),t.textContent=`Apply All Naming Suggestions (${n[259].warnings})`,f(t,"class","px-4 py-2 bg-[var(--background-modifier-success)] text-[var(--text-on-accent)] rounded hover:opacity-90 font-medium"),f(e,"class","pt-4 border-t border-[var(--background-modifier-border)]")},m(r,o){z(r,e,o),u(e,t),i||(s=ne(t,"click",n[87]),i=!0)},p:we,d(r){r&&j(e),i=!1,s()}}}function cs(n){let e,t,i,s=n[0].length+"",r,o,a,l,d,p=xe(n[0]),g=[];for(let h=0;h<p.length;h+=1)g[h]=us(is(n,p,h));const m=h=>Z(g[h],1,1,()=>{g[h]=null});return{c(){e=y("div"),t=y("h3"),i=$("Custom Entity Types ("),r=$(s),o=$(")"),a=E(),l=y("div");for(let h=0;h<g.length;h+=1)g[h].c();f(t,"class","text-lg font-semibold mb-4"),f(l,"class","grid grid-cols-1 lg:grid-cols-2 gap-4 max-w-full")},m(h,b){z(h,e,b),u(e,t),u(t,i),u(t,r),u(t,o),u(e,a),u(e,l);for(let c=0;c<g.length;c+=1)g[c]&&g[c].m(l,null);d=!0},p(h,b){if((!d||b[0]&1)&&s!==(s=h[0].length+"")&&ae(r,s),b[0]&131969|b[1]&2080896|b[2]&201326592){p=xe(h[0]);let c;for(c=0;c<p.length;c+=1){const v=is(h,p,c);g[c]?(g[c].p(v,b),G(g[c],1)):(g[c]=us(v),g[c].c(),G(g[c],1),g[c].m(l,null))}for(Ue(),c=p.length;c<g.length;c+=1)m(c);je()}},i(h){if(!d){for(let b=0;b<p.length;b+=1)G(g[b]);d=!0}},o(h){g=g.filter(Boolean);for(let b=0;b<g.length;b+=1)Z(g[b]);d=!1},d(h){h&&j(e),et(g,h)}}}function hu(n){let e,t=n[49](n[243].typeName)+"",i;return{c(){e=y("p"),i=$(t),f(e,"class","text-[var(--text-default)] text-sm leading-relaxed")},m(s,r){z(s,e,r),u(e,i)},p(s,r){r[0]&1&&t!==(t=s[49](s[243].typeName)+"")&&ae(i,t)},i:we,o:we,d(s){s&&j(e)}}}function mu(n){let e,t,i,s,r=n[50](n[243].typeName),o,a,l,d,p,g,m,h,b,c,v,w,_,C;function x(){n[118].call(t,n[243])}function N(){return n[119](n[243])}let k=r&&ds(n);const T=[bu,yu],D=[];function A(R,F){return R[17]===R[243].typeName?0:1}l=A(n),d=D[l]=T[l](n);function O(){return n[121](n[243])}function B(){return n[122](n[243])}return{c(){e=y("div"),t=y("textarea"),i=E(),s=y("div"),k&&k.c(),o=E(),a=y("button"),d.c(),m=E(),h=y("div"),b=y("button"),b.textContent="Save",c=E(),v=y("button"),v.textContent="Cancel",f(t,"placeholder","Enter entity description..."),f(t,"class","w-full p-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-relaxed resize-vertical min-h-15"),f(t,"rows","3"),f(a,"class","px-3 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] border border-[var(--interactive-accent)] rounded hover:opacity-90 transition-colors duration-200 text-sm flex items-center justify-center gap-2"),a.disabled=p=n[17]===n[243].typeName,f(a,"title",g="Generate AI description for "+n[243].typeName),f(s,"class","flex flex-col gap-2 mt-2"),f(b,"class","px-3 py-1 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded text-sm font-medium hover:opacity-90 transition-colors duration-200"),f(v,"class","px-3 py-1 bg-[var(--background-modifier-border)] text-[var(--text-default)] rounded text-sm hover:opacity-90 transition-colors duration-200"),f(h,"class","flex gap-2 justify-end"),f(e,"class","flex flex-col gap-2")},m(R,F){z(R,e,F),u(e,t),Ie(t,n[8][n[243].typeName]),u(e,i),u(e,s),k&&k.m(s,null),u(s,o),u(s,a),D[l].m(a,null),u(e,m),u(e,h),u(h,b),u(h,c),u(h,v),w=!0,_||(C=[ne(t,"input",x),ne(t,"input",N),ne(a,"click",It(O)),ne(b,"click",B),ne(v,"click",n[48])],_=!0)},p(R,F){n=R,F[0]&257&&Ie(t,n[8][n[243].typeName]),F[0]&1&&(r=n[50](n[243].typeName)),r?k?(k.p(n,F),F[0]&1&&G(k,1)):(k=ds(n),k.c(),G(k,1),k.m(s,o)):k&&(Ue(),Z(k,1,1,()=>{k=null}),je());let L=l;l=A(n),l!==L&&(Ue(),Z(D[L],1,1,()=>{D[L]=null}),je(),d=D[l],d||(d=D[l]=T[l](n),d.c()),G(d,1),d.m(a,null)),(!w||F[0]&131073&&p!==(p=n[17]===n[243].typeName))&&(a.disabled=p),(!w||F[0]&1&&g!==(g="Generate AI description for "+n[243].typeName))&&f(a,"title",g)},i(R){w||(G(k),G(d),w=!0)},o(R){Z(k),Z(d),w=!1},d(R){R&&j(e),k&&k.d(),D[l].d(),_=!1,Qe(C)}}}function ds(n){let e,t,i,s,r,o,a,l;t=new De({props:{icon:"download",size:"medium"}});function d(){return n[120](n[243])}return{c(){e=y("button"),Pe(t.$$.fragment),i=E(),s=y("span"),s.textContent="Load Default",f(e,"class","px-3 py-2 bg-[var(--background-modifier-success)] text-[var(--text-success)] border border-[var(--background-modifier-success)] rounded hover:opacity-90 transition-colors duration-200 text-sm flex items-center justify-center gap-2"),f(e,"title",r="Load default description for "+n[243].typeName)},m(p,g){z(p,e,g),Ee(t,e,null),u(e,i),u(e,s),o=!0,a||(l=ne(e,"click",It(d)),a=!0)},p(p,g){n=p,(!o||g[0]&1&&r!==(r="Load default description for "+n[243].typeName))&&f(e,"title",r)},i(p){o||(G(t.$$.fragment,p),o=!0)},o(p){Z(t.$$.fragment,p),o=!1},d(p){p&&j(e),Ce(t),a=!1,l()}}}function yu(n){let e,t,i,s;return e=new De({props:{icon:"sparkles",size:"medium"}}),{c(){Pe(e.$$.fragment),t=E(),i=y("span"),i.textContent="LLM Suggest"},m(r,o){Ee(e,r,o),z(r,t,o),z(r,i,o),s=!0},i(r){s||(G(e.$$.fragment,r),s=!0)},o(r){Z(e.$$.fragment,r),s=!1},d(r){r&&(j(t),j(i)),Ce(e,r)}}}function bu(n){let e;return{c(){e=$(" Generating...")},m(t,i){z(t,e,i)},i:we,o:we,d(t){t&&j(e)}}}function us(n){let e,t,i,s=n[243].typeName+"",r,o,a,l,d,p,g,m,h=n[38][n[243].typeName]?"Enabled":"Disabled",b,c,v,w,_,C,x,N,k,T,D,A,O,B,R=n[243].fileCount+"",F,L,V,Y,W=n[243].properties.length+"",K,H,U,X=n[257].score+"",I,J,fe,Te,ye,ve,ge,me;function Me(){return n[115](n[243])}function ie(){return n[116](n[243])}C=new De({props:{icon:"pencil",size:"medium"}});function se(){return n[117](n[243])}const Q=[mu,hu],ue=[];function ze(Be,de){return Be[7]===Be[243].typeName?0:1}return k=ze(n),T=ue[k]=Q[k](n),{c(){e=y("div"),t=y("div"),i=y("button"),r=$(s),o=E(),a=y("div"),l=y("label"),d=y("input"),g=E(),m=y("span"),b=$(h),w=E(),_=y("button"),Pe(C.$$.fragment),x=E(),N=y("div"),T.c(),D=E(),A=y("div"),O=y("span"),B=$("Files: "),F=$(R),L=E(),V=y("span"),Y=$("Props: "),K=$(W),H=E(),U=y("span"),I=$(X),J=$("% compliant"),Te=E(),f(i,"class","text-lg font-semibold text-[var(--text-default)] hover:opacity-90 transition-colors duration-200 text-left"),f(d,"type","checkbox"),d.checked=p=!!n[38][n[243].typeName],f(d,"class","w-4 h-4 text-[var(--text-success)] bg-[var(--background-secondary)] border-[var(--background-modifier-border)] rounded focus:ring-[var(--text-success)] focus:ring-2"),f(m,"class",c="text-xs text-[var(--text-muted)] "+(n[38][n[243].typeName]?"text-[var(--text-success)]":"text-[var(--text-muted)]")),f(l,"class","flex items-center gap-1 cursor-pointer"),f(l,"title",v=n[38][n[243].typeName]?"Enabled in data.json - uncheck to disable":"Disabled - check to enable in data.json"),f(_,"class","p-1 rounded opacity-60 hover:opacity-100 hover:bg-[var(--background-modifier-border)] transition-all duration-200"),f(_,"title","Edit Description"),f(a,"class","flex gap-1 items-center"),f(t,"class","flex justify-between items-center mb-3"),f(N,"class","mb-3"),f(O,"class","flex items-center gap-1"),f(V,"class","flex items-center gap-1"),f(U,"class",fe="flex items-center gap-1 "+(n[257].score>=80?"text-[var(--text-success)]":n[257].score>=60?"text-[var(--text-warning)]":"text-[var(--text-error)]")),f(A,"class","flex gap-4 text-sm text-[var(--text-muted)]"),f(e,"class",ye="bg-[var(--background-secondary-alt)] border border-[var(--background-modifier-border)] rounded-lg p-4 cursor-pointer transition-all duration-200 hover:border-[var(--interactive-accent)] hover:shadow-md "+(Hs===n[243].typeName?"border-[var(--interactive-accent)] shadow-md ring-2 ring-[var(--background-modifier-border)]":""))},m(Be,de){z(Be,e,de),u(e,t),u(t,i),u(i,r),u(t,o),u(t,a),u(a,l),u(l,d),u(l,g),u(l,m),u(m,b),u(a,w),u(a,_),Ee(C,_,null),u(e,x),u(e,N),ue[k].m(N,null),u(e,D),u(e,A),u(A,O),u(O,B),u(O,F),u(A,L),u(A,V),u(V,Y),u(V,K),u(A,H),u(A,U),u(U,I),u(U,J),u(e,Te),ve=!0,ge||(me=[ne(i,"click",Me),ne(d,"change",It(ie)),ne(_,"click",It(se))],ge=!0)},p(Be,de){n=Be,(!ve||de[0]&1)&&s!==(s=n[243].typeName+"")&&ae(r,s),(!ve||de[0]&1|de[1]&128&&p!==(p=!!n[38][n[243].typeName]))&&(d.checked=p),(!ve||de[0]&1|de[1]&128)&&h!==(h=n[38][n[243].typeName]?"Enabled":"Disabled")&&ae(b,h),(!ve||de[0]&1|de[1]&128&&c!==(c="text-xs text-[var(--text-muted)] "+(n[38][n[243].typeName]?"text-[var(--text-success)]":"text-[var(--text-muted)]")))&&f(m,"class",c),(!ve||de[0]&1|de[1]&128&&v!==(v=n[38][n[243].typeName]?"Enabled in data.json - uncheck to disable":"Disabled - check to enable in data.json"))&&f(l,"title",v);let _e=k;k=ze(n),k===_e?ue[k].p(n,de):(Ue(),Z(ue[_e],1,1,()=>{ue[_e]=null}),je(),T=ue[k],T?T.p(n,de):(T=ue[k]=Q[k](n),T.c()),G(T,1),T.m(N,null)),(!ve||de[0]&1)&&R!==(R=n[243].fileCount+"")&&ae(F,R),(!ve||de[0]&1)&&W!==(W=n[243].properties.length+"")&&ae(K,W),(!ve||de[0]&1)&&X!==(X=n[257].score+"")&&ae(I,X),(!ve||de[0]&1&&fe!==(fe="flex items-center gap-1 "+(n[257].score>=80?"text-[var(--text-success)]":n[257].score>=60?"text-[var(--text-warning)]":"text-[var(--text-error)]")))&&f(U,"class",fe),(!ve||de[0]&1&&ye!==(ye="bg-[var(--background-secondary-alt)] border border-[var(--background-modifier-border)] rounded-lg p-4 cursor-pointer transition-all duration-200 hover:border-[var(--interactive-accent)] hover:shadow-md "+(Hs===n[243].typeName?"border-[var(--interactive-accent)] shadow-md ring-2 ring-[var(--background-modifier-border)]":"")))&&f(e,"class",ye)},i(Be){ve||(G(C.$$.fragment,Be),G(T),ve=!0)},o(Be){Z(C.$$.fragment,Be),Z(T),ve=!1},d(Be){Be&&j(e),Ce(C),ue[k].d(),ge=!1,Qe(me)}}}function ps(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O;s=new De({props:{icon:"sparkles"}});function B(W,K){return W[15]&&W[21]==="properties"?_u:vu}let R=B(n),F=R(n);const L=[Su,wu],V=[];function Y(W,K){return W[0].length>0?0:1}return k=Y(n),T=V[k]=L[k](n),{c(){e=y("div"),t=y("div"),i=y("h3"),Pe(s.$$.fragment),r=E(),o=y("span"),o.textContent="LLM Automatic Property Descriptions",a=E(),l=y("p"),l.textContent=`Use AI to automatically generate property descriptions and configure\r
            property settings for all entities.`,d=E(),p=y("div"),g=y("button"),F.c(),m=E(),h=y("button"),h.textContent="Load Default Descriptions",b=E(),c=y("button"),c.textContent="Enable Default Properties",v=E(),w=y("div"),_=y("h3"),_.textContent="All Entity Properties",C=E(),x=y("p"),x.textContent=`Configure property mappings, descriptions, and field types for all\r
            entity types.`,N=E(),T.c(),f(i,"class","text-xl font-semibold mb-2 flex items-center gap-2"),f(l,"class","mb-4 opacity-90 leading-relaxed"),f(g,"class","px-4 py-2 bg-[rgba(255,255,255,0.06)] border border-[rgba(255,255,255,0.08)] rounded-md text-sm transition-all duration-200 backdrop-blur-sm hover:bg-[rgba(255,255,255,0.09)] disabled:opacity-50 disabled:cursor-not-allowed text-[var(--text-on-accent)]"),g.disabled=n[15],f(h,"class","px-4 py-2 bg-[rgba(255,255,255,0.04)] border border-[rgba(255,255,255,0.06)] rounded-md text-sm transition-all duration-200 backdrop-blur-sm hover:bg-[rgba(255,255,255,0.06)] hover:border-[rgba(255,255,255,0.08)]"),f(h,"title","Load all default property descriptions into data.json"),f(c,"class","px-4 py-2 bg-[rgba(255,255,255,0.04)] border border-[rgba(255,255,255,0.06)] rounded-md text-sm transition-all duration-200 backdrop-blur-sm hover:bg-[rgba(255,255,255,0.06)] hover:border-[rgba(255,255,255,0.08)]"),f(c,"title","Enable all properties for which we have default descriptions"),f(p,"class","flex gap-3 flex-wrap items-center"),f(t,"class","bg-gradient-to-br from-[var(--interactive-accent)] to-[var(--background-secondary)] text-[var(--text-on-accent)] p-6 rounded-xl mb-6 shadow-md"),f(_,"class","text-lg font-semibold mb-2 text-[var(--text-default)]"),f(x,"class","text-[var(--text-muted)] mb-6"),f(e,"class","animate-fadeIn"),f(e,"id","properties-panel")},m(W,K){z(W,e,K),u(e,t),u(t,i),Ee(s,i,null),u(i,r),u(i,o),u(t,a),u(t,l),u(t,d),u(t,p),u(p,g),F.m(g,null),u(p,m),u(p,h),u(p,b),u(p,c),u(e,v),u(e,w),u(w,_),u(w,C),u(w,x),u(w,N),V[k].m(w,null),D=!0,A||(O=[ne(g,"click",n[123]),ne(h,"click",n[124]),ne(c,"click",n[96])],A=!0)},p(W,K){R!==(R=B(W))&&(F.d(1),F=R(W),F&&(F.c(),F.m(g,null))),(!D||K[0]&32768)&&(g.disabled=W[15]);let H=k;k=Y(W),k===H?V[k].p(W,K):(Ue(),Z(V[H],1,1,()=>{V[H]=null}),je(),T=V[k],T?T.p(W,K):(T=V[k]=L[k](W),T.c()),G(T,1),T.m(w,null))},i(W){D||(G(s.$$.fragment,W),G(T),D=!0)},o(W){Z(s.$$.fragment,W),Z(T),D=!1},d(W){W&&j(e),Ce(s),F.d(),V[k].d(),A=!1,Qe(O)}}}function vu(n){let e;return{c(){e=$("Generate All Property Descriptions")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function _u(n){let e;return{c(){e=$(" Generating...")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function wu(n){let e;return{c(){e=y("div"),e.innerHTML="<p>No entity types found. Run schema discovery first.</p>",f(e,"class","text-center py-8 text-[var(--text-muted)]")},m(t,i){z(t,e,i)},p:we,i:we,o:we,d(t){t&&j(e)}}}function Su(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v=n[6].has("BaseEntity"),w,_,C,x;const N=[ku,xu],k=[];function T(R,F){return F[0]&64&&(g=null),g==null&&(g=!!R[6].has("BaseEntity")),g?0:1}m=T(n,[-1,-1,-1,-1,-1,-1,-1,-1,-1]),h=k[m]=N[m](n);let D=v&&gs(),A=xe(n[0]),O=[];for(let R=0;R<A.length;R+=1)O[R]=Es(ts(n,A,R));const B=R=>Z(O[R],1,1,()=>{O[R]=null});return{c(){e=y("div"),t=y("div"),i=y("div"),s=y("button"),r=y("h4"),r.innerHTML='BaseEntity <span class="text-xs bg-[var(--background-modifier-border)] text-[var(--text-muted)] px-2 py-1 rounded ml-2">SYSTEM</span>',o=E(),a=y("div"),l=y("span"),l.textContent="3 of 3 enabled",d=E(),p=y("span"),h.c(),c=E(),D&&D.c(),w=E();for(let R=0;R<O.length;R+=1)O[R].c();f(r,"class","font-semibold text-[var(--text-default)]"),f(l,"class","text-xs text-[var(--text-muted)] bg-[var(--background-modifier-border)] px-2 py-1 rounded-full"),f(p,"class","text-lg text-[var(--text-muted)] font-bold ml-4"),f(a,"class","flex items-center gap-4"),f(s,"class","flex-1 flex justify-between items-center text-left cursor-pointer transition-colors duration-200 hover:opacity-90"),f(i,"class",b="flex justify-between items-center w-full p-4 bg-[var(--background-secondary)] border-none "+(n[6].has("BaseEntity")?"border-b border-[var(--background-modifier-border)]":"")),f(t,"class","bg-[var(--background-primary-alt)] border-2 border-[var(--background-modifier-border)] rounded-lg overflow-hidden"),f(t,"id","accordion-BaseEntity"),f(e,"class","flex flex-col gap-4")},m(R,F){z(R,e,F),u(e,t),u(t,i),u(i,s),u(s,r),u(s,o),u(s,a),u(a,l),u(a,d),u(a,p),k[m].m(p,null),u(t,c),D&&D.m(t,null),u(e,w);for(let L=0;L<O.length;L+=1)O[L]&&O[L].m(e,null);_=!0,C||(x=ne(s,"click",n[125]),C=!0)},p(R,F){let L=m;if(m=T(R,F),m!==L&&(Ue(),Z(k[L],1,1,()=>{k[L]=null}),je(),h=k[m],h||(h=k[m]=N[m](R),h.c()),G(h,1),h.m(p,null)),(!_||F[0]&64&&b!==(b="flex justify-between items-center w-full p-4 bg-[var(--background-secondary)] border-none "+(R[6].has("BaseEntity")?"border-b border-[var(--background-modifier-border)]":"")))&&f(i,"class",b),F[0]&64&&(v=R[6].has("BaseEntity")),v?D?F[0]&64&&G(D,1):(D=gs(),D.c(),G(D,1),D.m(t,null)):D&&(Ue(),Z(D,1,1,()=>{D=null}),je()),F[0]&262217|F[1]&6299840|F[2]&352190464|F[3]&112){A=xe(R[0]);let V;for(V=0;V<A.length;V+=1){const Y=ts(R,A,V);O[V]?(O[V].p(Y,F),G(O[V],1)):(O[V]=Es(Y),O[V].c(),G(O[V],1),O[V].m(e,null))}for(Ue(),V=A.length;V<O.length;V+=1)B(V);je()}},i(R){if(!_){G(h),G(D);for(let F=0;F<A.length;F+=1)G(O[F]);_=!0}},o(R){Z(h),Z(D),O=O.filter(Boolean);for(let F=0;F<O.length;F+=1)Z(O[F]);_=!1},d(R){R&&j(e),k[m].d(),D&&D.d(),et(O,R),C=!1,x()}}}function xu(n){let e,t;return e=new De({props:{icon:"chevron-right",size:"medium"}}),{c(){Pe(e.$$.fragment)},m(i,s){Ee(e,i,s),t=!0},i(i){t||(G(e.$$.fragment,i),t=!0)},o(i){Z(e.$$.fragment,i),t=!1},d(i){Ce(e,i)}}}function ku(n){let e,t;return e=new De({props:{icon:"chevron-down",size:"medium"}}),{c(){Pe(e.$$.fragment)},m(i,s){Ee(e,i,s),t=!0},i(i){t||(G(e.$$.fragment,i),t=!0)},o(i){Z(e.$$.fragment,i),t=!1},d(i){Ce(e,i)}}}function gs(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F,L,V,Y,W,K,H,U,X;return p=new De({props:{icon:"lock",size:"medium"}}),C=new De({props:{icon:"lock",size:"medium"}}),R=new De({props:{icon:"lock",size:"medium"}}),V=new De({props:{icon:"info",size:"medium"}}),{c(){e=y("div"),t=y("div"),i=y("div"),s=y("div"),s.innerHTML=`<input type="checkbox" checked="${!0}" disabled="${!0}" class="rounded border-[var(--background-modifier-border)] text-[var(--interactive-accent)] focus:ring-[var(--interactive-accent)] disabled:opacity-50 disabled:cursor-not-allowed" title="Base Entity properties are always enabled"/> <span class="font-medium text-[var(--text-default)]">type</span> <span class="text-[var(--text-muted)] text-sm">(string)</span> <span class="text-xs px-2 py-1 bg-[var(--background-modifier-border)] text-[var(--text-muted)] rounded font-bold uppercase tracking-wide ml-auto">SYSTEM</span>`,r=E(),o=y("div"),a=y("input"),l=E(),d=y("button"),Pe(p.$$.fragment),g=E(),m=y("div"),h=y("div"),h.innerHTML=`<input type="checkbox" checked="${!0}" disabled="${!0}" class="rounded border-[var(--background-modifier-border)] text-[var(--interactive-accent)] focus:ring-[var(--interactive-accent)] disabled:opacity-50 disabled:cursor-not-allowed" title="Base Entity properties are always enabled"/> <span class="font-medium text-[var(--text-default)]">tags</span> <span class="text-[var(--text-muted)] text-sm">(List[str])</span> <span class="text-xs px-2 py-1 bg-[var(--background-modifier-border)] text-[var(--text-muted)] rounded font-bold uppercase tracking-wide ml-auto">SYSTEM</span>`,b=E(),c=y("div"),v=y("input"),w=E(),_=y("button"),Pe(C.$$.fragment),x=E(),N=y("div"),k=y("div"),k.innerHTML=`<input type="checkbox" checked="${!0}" disabled="${!0}" class="rounded border-[var(--background-modifier-border)] text-[var(--interactive-accent)] focus:ring-[var(--interactive-accent)] disabled:opacity-50 disabled:cursor-not-allowed" title="Base Entity properties are always enabled"/> <span class="font-medium text-[var(--text-default)]">created</span> <span class="text-[var(--text-muted)] text-sm">(datetime)</span> <span class="text-xs px-2 py-1 bg-[var(--background-modifier-border)] text-[var(--text-muted)] rounded font-bold uppercase tracking-wide ml-auto">SYSTEM</span>`,T=E(),D=y("div"),A=y("input"),O=E(),B=y("button"),Pe(R.$$.fragment),F=E(),L=y("div"),Pe(V.$$.fragment),Y=E(),W=y("strong"),W.textContent="Base Entity Properties:",K=$(`\r
                      These core properties are inherited by all custom entity types\r
                      and are always enabled.\r
                      `),H=y("br"),U=y("span"),U.textContent=`All generated Pydantic models automatically include\r
                        these foundational fields.`,f(s,"class","flex items-center gap-2 flex-wrap"),f(a,"type","text"),a.value="Entity type identifier for classification and model selection",a.disabled=!0,f(a,"class","flex-1 px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm min-w-48 disabled:opacity-50 bg-[var(--background-modifier-border)]"),f(d,"class","px-2 py-2 bg-[var(--background-modifier-border)] border border-[var(--background-modifier-border)] rounded text-sm opacity-50 cursor-not-allowed"),f(d,"title","System properties cannot be edited"),d.disabled=!0,f(o,"class","flex items-center gap-2"),f(i,"class","flex flex-col gap-2 p-3 bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded-md"),f(h,"class","flex items-center gap-2 flex-wrap"),f(v,"type","text"),v.value="Tags and labels for categorization and organization",v.disabled=!0,f(v,"class","flex-1 px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm min-w-48 disabled:opacity-50 bg-[var(--background-modifier-border)]"),f(_,"class","px-2 py-2 bg-[var(--background-modifier-border)] border border-[var(--background-modifier-border)] rounded text-sm opacity-50 cursor-not-allowed"),f(_,"title","System properties cannot be edited"),_.disabled=!0,f(c,"class","flex items-center gap-2"),f(m,"class","flex flex-col gap-2 p-3 bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded-md"),f(k,"class","flex items-center gap-2 flex-wrap"),f(A,"type","text"),A.value="Timestamp when the entity was first created or discovered",A.disabled=!0,f(A,"class","flex-1 px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm min-w-48 disabled:opacity-50 bg-[var(--background-modifier-border)]"),f(B,"class","px-2 py-2 bg-[var(--background-modifier-border)] border border-[var(--background-modifier-border)] rounded text-sm opacity-50 cursor-not-allowed"),f(B,"title","System properties cannot be edited"),B.disabled=!0,f(D,"class","flex items-center gap-2"),f(N,"class","flex flex-col gap-2 p-3 bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded-md"),f(t,"class","flex flex-col gap-3"),f(U,"class","text-xs text-[var(--text-muted)]"),f(L,"class","mt-4 p-3 bg-[var(--background-modifier-border)] border border-[var(--background-modifier-border)] rounded text-sm leading-relaxed text-[var(--text-default)] flex items-center gap-2"),f(e,"class","p-4 bg-[var(--background-secondary-alt)]")},m(I,J){z(I,e,J),u(e,t),u(t,i),u(i,s),u(i,r),u(i,o),u(o,a),u(o,l),u(o,d),Ee(p,d,null),u(t,g),u(t,m),u(m,h),u(m,b),u(m,c),u(c,v),u(c,w),u(c,_),Ee(C,_,null),u(t,x),u(t,N),u(N,k),u(N,T),u(N,D),u(D,A),u(D,O),u(D,B),Ee(R,B,null),u(e,F),u(e,L),Ee(V,L,null),u(L,Y),u(L,W),u(L,K),u(L,H),u(L,U),X=!0},i(I){X||(G(p.$$.fragment,I),G(C.$$.fragment,I),G(R.$$.fragment,I),G(V.$$.fragment,I),X=!0)},o(I){Z(p.$$.fragment,I),Z(C.$$.fragment,I),Z(R.$$.fragment,I),Z(V.$$.fragment,I),X=!1},d(I){I&&j(e),Ce(p),Ce(C),Ce(R),Ce(V)}}}function Eu(n){let e,t;return e=new De({props:{icon:"chevron-right",size:"medium"}}),{c(){Pe(e.$$.fragment)},m(i,s){Ee(e,i,s),t=!0},i(i){t||(G(e.$$.fragment,i),t=!0)},o(i){Z(e.$$.fragment,i),t=!1},d(i){Ce(e,i)}}}function Cu(n){let e,t;return e=new De({props:{icon:"chevron-down",size:"medium"}}),{c(){Pe(e.$$.fragment)},m(i,s){Ee(e,i,s),t=!0},i(i){t||(G(e.$$.fragment,i),t=!0)},o(i){Z(e.$$.fragment,i),t=!1},d(i){Ce(e,i)}}}function fs(n){let e,t,i,s,r,o;function a(){return n[128](n[243])}function l(){return n[129](n[243])}return{c(){e=y("div"),t=y("button"),t.textContent="Select All",i=E(),s=y("button"),s.textContent="Deselect All",f(t,"class","px-2 py-1 text-xs bg-[var(--background-modifier-success)] text-[var(--text-success)] border border-green-300 rounded hover:bg-green-200 transition-colors duration-200"),f(t,"title","Enable all non-protected, non-ignored properties"),f(s,"class","px-2 py-1 text-xs bg-[var(--background-modifier-error)] text-[var(--text-error)] border border-[var(--background-modifier-error)] rounded hover:bg-[var(--background-modifier-error)] transition-colors duration-200"),f(s,"title","Disable all properties"),f(e,"class","flex gap-2 ml-4")},m(d,p){z(d,e,p),u(e,t),u(e,i),u(e,s),r||(o=[ne(t,"click",It(a)),ne(s,"click",It(l))],r=!0)},p(d,p){n=d},d(d){d&&j(e),r=!1,Qe(o)}}}function hs(n){let e,t,i,s,r;const o=[Du,Pu],a=[];function l(p,g){return p[243].properties&&p[243].properties.length>0?0:1}t=l(n),i=a[t]=o[t](n);let d=n[243].properties&&n[243].properties.length>0&&ks(n);return{c(){e=y("div"),i.c(),s=E(),d&&d.c(),f(e,"class","p-4")},m(p,g){z(p,e,g),a[t].m(e,null),u(e,s),d&&d.m(e,null),r=!0},p(p,g){let m=t;t=l(p),t===m?a[t].p(p,g):(Ue(),Z(a[m],1,1,()=>{a[m]=null}),je(),i=a[t],i?i.p(p,g):(i=a[t]=o[t](p),i.c()),G(i,1),i.m(e,s)),p[243].properties&&p[243].properties.length>0?d?(d.p(p,g),g[0]&1&&G(d,1)):(d=ks(p),d.c(),G(d,1),d.m(e,null)):d&&(Ue(),Z(d,1,1,()=>{d=null}),je())},i(p){r||(G(i),G(d),r=!0)},o(p){Z(i),Z(d),r=!1},d(p){p&&j(e),a[t].d(),d&&d.d()}}}function Pu(n){let e;return{c(){e=y("p"),e.textContent="No properties found for this entity type.",f(e,"class","text-[var(--text-muted)] italic text-center py-4")},m(t,i){z(t,e,i)},p:we,i:we,o:we,d(t){t&&j(e)}}}function Du(n){let e,t,i=xe(n[243].properties),s=[];for(let o=0;o<i.length;o+=1)s[o]=xs(ns(n,i,o));const r=o=>Z(s[o],1,1,()=>{s[o]=null});return{c(){e=y("div");for(let o=0;o<s.length;o+=1)s[o].c();f(e,"class","flex flex-col gap-3")},m(o,a){z(o,e,a);for(let l=0;l<s.length;l+=1)s[l]&&s[l].m(e,null);t=!0},p(o,a){if(a[0]&262153|a[1]&6291520|a[2]&285081600|a[3]&16){i=xe(o[243].properties);let l;for(l=0;l<i.length;l+=1){const d=ns(o,i,l);s[l]?(s[l].p(d,a),G(s[l],1)):(s[l]=xs(d),s[l].c(),G(s[l],1),s[l].m(e,null))}for(Ue(),l=i.length;l<s.length;l+=1)r(l);je()}},i(o){if(!t){for(let a=0;a<i.length;a+=1)G(s[a]);t=!0}},o(o){s=s.filter(Boolean);for(let a=0;a<s.length;a+=1)Z(s[a]);t=!1},d(o){o&&j(e),et(s,o)}}}function ms(n){let e,t,i=n[253]+"",s,r;return{c(){e=y("span"),t=$("MAPPED FROM: "),s=$(i),f(e,"class","text-xs px-2 py-1 bg-[var(--background-modifier-border)] text-[var(--text-muted)] rounded font-medium"),f(e,"title",r="This property is the result of a mapping from: "+n[253])},m(o,a){z(o,e,a),u(e,t),u(e,s)},p(o,a){a[0]&1&&i!==(i=o[253]+"")&&ae(s,i),a[0]&1&&r!==(r="This property is the result of a mapping from: "+o[253])&&f(e,"title",r)},d(o){o&&j(e)}}}function ys(n){let e,t,i,s,r,o=n[254]?"Property Defined":"Property Not Defined",a,l,d,p,g;function m(){return n[131](n[243],n[248])}return{c(){e=y("label"),t=y("input"),s=E(),r=y("span"),a=$(o),f(t,"type","checkbox"),t.checked=i=n[254],f(t,"class","w-4 h-4 text-[var(--text-success)] bg-[var(--background-secondary)] border-[var(--background-modifier-border)] rounded focus:ring-[var(--text-success)] focus:ring-2"),f(r,"class",l="text-xs "+(n[254]?"text-[var(--text-success)]":"text-[var(--text-muted)]")),f(e,"class","flex items-center gap-1 cursor-pointer"),f(e,"title",d=n[254]?"Property defined in data.json - uncheck to remove definition":"Property not defined - check to add definition to data.json")},m(h,b){z(h,e,b),u(e,t),u(e,s),u(e,r),u(r,a),p||(g=ne(t,"change",It(m)),p=!0)},p(h,b){n=h,b[0]&1|b[1]&64&&i!==(i=n[254])&&(t.checked=i),b[0]&1|b[1]&64&&o!==(o=n[254]?"Property Defined":"Property Not Defined")&&ae(a,o),b[0]&1|b[1]&64&&l!==(l="text-xs "+(n[254]?"text-[var(--text-success)]":"text-[var(--text-muted)]"))&&f(r,"class",l),b[0]&1|b[1]&64&&d!==(d=n[254]?"Property defined in data.json - uncheck to remove definition":"Property not defined - check to add definition to data.json")&&f(e,"title",d)},d(h){h&&j(e),p=!1,g()}}}function Tu(n){let e;return{c(){e=y("span"),e.textContent="DISABLED",f(e,"class","text-xs px-2 py-1 bg-[var(--background-modifier-border)] text-[var(--text-muted)] rounded font-bold uppercase tracking-wide ml-auto")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function Mu(n){let e;return{c(){e=y("span"),e.textContent="ENABLED",f(e,"class","text-xs px-2 py-1 bg-[var(--background-modifier-success)] text-[var(--text-on-accent)] rounded font-bold uppercase tracking-wide ml-auto")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function Nu(n){let e;return{c(){e=y("span"),e.textContent="NAMING",f(e,"class","text-xs px-2 py-1 bg-[var(--background-modifier-warning)] text-[var(--text-on-accent)] rounded font-bold uppercase tracking-wide ml-auto")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function Au(n){let e;return{c(){e=y("span"),e.textContent="IGNORED",f(e,"class","text-xs px-2 py-1 bg-[var(--background-modifier-border)] text-[var(--text-muted)] rounded font-bold uppercase tracking-wide ml-auto")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function Ou(n){let e;return{c(){e=y("span"),e.textContent="PROTECTED",f(e,"class","text-xs px-2 py-1 bg-[var(--background-modifier-error)] text-[var(--text-on-accent)] rounded font-bold uppercase tracking-wide ml-auto")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function bs(n){var v;let e=n[52](((v=n[248])==null?void 0:v.name)||""),t,i,s,r,o,a,l,d,p,g=e&&vs(n);const m=[Lu,Iu],h=[];function b(w,_){var C;return w[18]===`${w[243].typeName}.${((C=w[248])==null?void 0:C.name)||""}`?0:1}s=b(n),r=h[s]=m[s](n);function c(){return n[134](n[243],n[248])}return{c(){var w,_;g&&g.c(),t=E(),i=y("button"),r.c(),f(i,"class","px-2 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] border border-[var(--interactive-accent)] rounded hover:opacity-90 transition-colors duration-200 text-sm whitespace-nowrap flex items-center gap-1"),i.disabled=o=n[18]===`${n[243].typeName}.${((w=n[248])==null?void 0:w.name)||""}`,f(i,"title",a="Generate AI description for "+((_=n[248])==null?void 0:_.name))},m(w,_){g&&g.m(w,_),z(w,t,_),z(w,i,_),h[s].m(i,null),l=!0,d||(p=ne(i,"click",c),d=!0)},p(w,_){var x,N,k;n=w,_[0]&1&&(e=n[52](((x=n[248])==null?void 0:x.name)||"")),e?g?(g.p(n,_),_[0]&1&&G(g,1)):(g=vs(n),g.c(),G(g,1),g.m(t.parentNode,t)):g&&(Ue(),Z(g,1,1,()=>{g=null}),je());let C=s;s=b(n),s!==C&&(Ue(),Z(h[C],1,1,()=>{h[C]=null}),je(),r=h[s],r||(r=h[s]=m[s](n),r.c()),G(r,1),r.m(i,null)),(!l||_[0]&262145&&o!==(o=n[18]===`${n[243].typeName}.${((N=n[248])==null?void 0:N.name)||""}`))&&(i.disabled=o),(!l||_[0]&1&&a!==(a="Generate AI description for "+((k=n[248])==null?void 0:k.name)))&&f(i,"title",a)},i(w){l||(G(g),G(r),l=!0)},o(w){Z(g),Z(r),l=!1},d(w){w&&(j(t),j(i)),g&&g.d(w),h[s].d(),d=!1,p()}}}function vs(n){let e,t,i,s,r,o,a,l;t=new De({props:{icon:"download",size:"medium"}});function d(){return n[133](n[243],n[248])}return{c(){var p;e=y("button"),Pe(t.$$.fragment),i=E(),s=y("span"),s.textContent="Load Default",f(e,"class","px-2 py-2 bg-[var(--background-modifier-success)] text-[var(--text-success)] border border-[var(--background-modifier-success)] rounded hover:opacity-90 transition-colors duration-200 text-sm whitespace-nowrap flex items-center gap-1"),f(e,"title",r="Load default description for "+((p=n[248])==null?void 0:p.name))},m(p,g){z(p,e,g),Ee(t,e,null),u(e,i),u(e,s),o=!0,a||(l=ne(e,"click",d),a=!0)},p(p,g){var m;n=p,(!o||g[0]&1&&r!==(r="Load default description for "+((m=n[248])==null?void 0:m.name)))&&f(e,"title",r)},i(p){o||(G(t.$$.fragment,p),o=!0)},o(p){Z(t.$$.fragment,p),o=!1},d(p){p&&j(e),Ce(t),a=!1,l()}}}function Iu(n){let e,t,i,s;return e=new De({props:{icon:"sparkles",size:"medium"}}),{c(){Pe(e.$$.fragment),t=E(),i=y("span"),i.textContent="LLM Suggest"},m(r,o){Ee(e,r,o),z(r,t,o),z(r,i,o),s=!0},i(r){s||(G(e.$$.fragment,r),s=!0)},o(r){Z(e.$$.fragment,r),s=!1},d(r){r&&(j(t),j(i)),Ce(e,r)}}}function Lu(n){let e;return{c(){e=$(" Generating...")},m(t,i){z(t,e,i)},i:we,o:we,d(t){t&&j(e)}}}function Ru(n){let e,t,i,s,r,o;return t=new De({props:{icon:"info",size:"medium"}}),{c(){e=y("div"),Pe(t.$$.fragment),i=E(),s=y("strong"),s.textContent="Property Disabled:",r=$(` This property\r
                                  is currently disabled and will not be included\r
                                  in the generated Pydantic model.`),f(e,"class","mt-2 p-3 bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded text-sm leading-relaxed text-[var(--text-default)] flex items-center gap-2")},m(a,l){z(a,e,l),Ee(t,e,null),u(e,i),u(e,s),u(e,r),o=!0},p:we,i(a){o||(G(t.$$.fragment,a),o=!0)},o(a){Z(t.$$.fragment,a),o=!1},d(a){a&&j(e),Ce(t)}}}function Fu(n){var C;let e,t,i,s,r,o=n[248].namingIssues.join(", ")+"",a,l,d,p,g,m,h=(((C=n[248])==null?void 0:C.suggestedName)||"Suggestion")+"",b,c,v,w;i=new De({props:{icon:"lightbulb"}});function _(){return n[135](n[247],n[256])}return{c(){e=y("div"),t=y("strong"),Pe(i.$$.fragment),s=$(" Naming Suggestion:"),r=E(),a=$(o),l=E(),d=y("br"),p=E(),g=y("button"),m=$("Apply: "),b=$(h),f(g,"class","mt-2 px-3 py-1 bg-[var(--background-modifier-warning)] text-[var(--text-on-accent)] rounded text-xs font-medium hover:opacity-90 transition-colors duration-200"),f(e,"class","mt-2 p-3 bg-orange-100 border border-orange-200 rounded text-sm leading-relaxed text-gray-900")},m(x,N){z(x,e,N),u(e,t),Ee(i,t,null),u(t,s),u(e,r),u(e,a),u(e,l),u(e,d),u(e,p),u(e,g),u(g,m),u(g,b),c=!0,v||(w=ne(g,"click",_),v=!0)},p(x,N){var k;n=x,(!c||N[0]&1)&&o!==(o=n[248].namingIssues.join(", ")+"")&&ae(a,o),(!c||N[0]&1)&&h!==(h=(((k=n[248])==null?void 0:k.suggestedName)||"Suggestion")+"")&&ae(b,h)},i(x){c||(G(i.$$.fragment,x),c=!0)},o(x){Z(i.$$.fragment,x),c=!1},d(x){x&&j(e),Ce(i),v=!1,w()}}}function $u(n){var d,p;let e,t,i,s,r,o,a=(((p=(d=n[3])==null?void 0:d.globallyIgnoredFields)==null?void 0:p.join(", "))||"none")+"",l;return{c(){e=y("div"),t=y("strong"),t.textContent=" Globally Ignored Field:",i=$(`\r
                                  This property is in the globally ignored fields\r
                                  list and will be automatically excluded from Pydantic\r
                                  model generation.\r
                                  `),s=y("br"),r=y("span"),o=$("Globally ignored fields: "),l=$(a),f(r,"class","text-xs text-[var(--text-muted)]"),f(e,"class","mt-2 p-3 bg-[var(--background-modifier-border)] border border-[var(--background-modifier-border)] rounded text-sm leading-relaxed text-[var(--text-default)]")},m(g,m){z(g,e,m),u(e,t),u(e,i),u(e,s),u(e,r),u(r,o),u(r,l)},p(g,m){var h,b;m[0]&8&&a!==(a=(((b=(h=g[3])==null?void 0:h.globallyIgnoredFields)==null?void 0:b.join(", "))||"none")+"")&&ae(l,a)},i:we,o:we,d(g){g&&j(e)}}}function Uu(n){var l;let e,t,i,s,r,o;t=new De({props:{icon:"alert-triangle",size:"medium"}});let a=((l=n[248])==null?void 0:l.suggestedName)&&n[248].suggestedName!==n[248].name&&_s(n);return{c(){e=y("div"),Pe(t.$$.fragment),i=E(),s=y("strong"),s.textContent="Protected Attribute:",r=$(` This\r
                                  is a reserved Graphiti attribute and cannot be\r
                                  used.\r
                                  `),a&&a.c(),f(e,"class","mt-2 p-3 bg-[var(--background-modifier-error)] border border-[var(--background-modifier-border)] rounded text-sm leading-relaxed text-[var(--text-on-accent)] flex items-center gap-2")},m(d,p){z(d,e,p),Ee(t,e,null),u(e,i),u(e,s),u(e,r),a&&a.m(e,null),o=!0},p(d,p){var g;(g=d[248])!=null&&g.suggestedName&&d[248].suggestedName!==d[248].name?a?a.p(d,p):(a=_s(d),a.c(),a.m(e,null)):a&&(a.d(1),a=null)},i(d){o||(G(t.$$.fragment,d),o=!0)},o(d){Z(t.$$.fragment,d),o=!1},d(d){d&&j(e),Ce(t),a&&a.d()}}}function _s(n){let e,t,i,s=n[248].suggestedName+"",r;return{c(){e=y("br"),t=$(`Consider using:\r
                                    `),i=y("code"),r=$(s),f(i,"class","bg-black/10 px-1 py-0.5 rounded font-mono text-xs")},m(o,a){z(o,e,a),z(o,t,a),z(o,i,a),u(i,r)},p(o,a){a[0]&1&&s!==(s=o[248].suggestedName+"")&&ae(r,s)},d(o){o&&(j(e),j(t),j(i))}}}function ws(n){let e,t,i,s=n[248].examples.slice(0,3).join(", ")+"",r,o,a=n[248].examples.length>3&&Ss();return{c(){e=y("div"),t=y("strong"),t.textContent="Examples:",i=E(),r=$(s),o=E(),a&&a.c(),f(e,"class","text-xs text-[var(--text-muted)] italic mt-1")},m(l,d){z(l,e,d),u(e,t),u(e,i),u(e,r),u(e,o),a&&a.m(e,null)},p(l,d){d[0]&1&&s!==(s=l[248].examples.slice(0,3).join(", ")+"")&&ae(r,s),l[248].examples.length>3?a||(a=Ss(),a.c(),a.m(e,null)):a&&(a.d(1),a=null)},d(l){l&&j(e),a&&a.d()}}}function Ss(n){let e;return{c(){e=$("...")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function xs(n){var Q,ue,ze,Be,de;let e,t,i,s,r,o,a,l,d=(((Q=n[248])==null?void 0:Q.name)||"Unknown")+"",p,g,m,h,b,c=(((ue=n[248])==null?void 0:ue.inferredType)||"string")+"",v,w,_,C,x,N,k,T,D,A,O,B,R,F,L,V,Y,W,K,H,U;function X(..._e){return n[130](n[247],n[256],..._e)}let I=n[252]&&ms(n),J=!((ze=n[248])!=null&&ze.isProtected)&&!n[249]&&ys(n);function fe(_e,Oe){var Ve,Xe;return(Ve=_e[248])!=null&&Ve.isProtected?Ou:_e[249]?Au:((Xe=_e[248])==null?void 0:Xe.complianceStatus)==="warning"?Nu:_e[251]?Mu:Tu}let Te=fe(n),ye=Te(n);function ve(..._e){return n[132](n[247],n[256],..._e)}let ge=!((Be=n[248])!=null&&Be.isProtected)&&!n[249]&&bs(n);const me=[Uu,$u,Fu,Ru],Me=[];function ie(_e,Oe){var Ve,Xe;return(Ve=_e[248])!=null&&Ve.isProtected?0:_e[249]?1:(Xe=_e[248])!=null&&Xe.namingIssues&&_e[248].namingIssues.length>0?2:_e[251]?-1:3}~(F=ie(n))&&(L=Me[F]=me[F](n));let se=((de=n[248])==null?void 0:de.examples)&&n[248].examples.length>0&&ws(n);return{c(){var _e,Oe,Ve,Xe,Ze,Fe,He;e=y("div"),t=y("div"),i=y("input"),a=E(),l=y("span"),p=$(d),m=E(),h=y("span"),b=$("("),v=$(c),w=$(")"),_=E(),I&&I.c(),C=E(),J&&J.c(),x=E(),ye.c(),N=E(),k=y("div"),T=y("input"),B=E(),ge&&ge.c(),R=E(),L&&L.c(),V=E(),se&&se.c(),Y=E(),f(i,"type","checkbox"),i.checked=s=n[251]&&!n[249],i.disabled=r=((_e=n[248])==null?void 0:_e.isProtected)||n[249],f(i,"class","rounded border-[var(--background-modifier-border)] text-[var(--interactive-accent)] focus:ring-[var(--interactive-accent)] disabled:opacity-50 disabled:cursor-not-allowed"),f(i,"title",o=n[249]?"This property is globally ignored and cannot be enabled":(Oe=n[248])!=null&&Oe.isProtected?"Protected properties cannot be enabled":"Enable/disable this property for Pydantic model generation"),f(l,"class",g="font-medium text-[var(--text-default)] "+(n[249]?"text-[var(--text-muted)] line-through":"")),f(h,"class","text-[var(--text-muted)] text-sm"),f(t,"class","flex items-center gap-2 flex-wrap"),f(T,"type","text"),T.value=D=n[84](n[243].typeName,((Ve=n[248])==null?void 0:Ve.name)||"",((Xe=n[248])==null?void 0:Xe.description)||""),f(T,"placeholder","Property description"),f(T,"class",A="flex-1 px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm min-w-48 disabled:opacity-50 "+(n[249]?"bg-[var(--background-modifier-border)]":"")),T.disabled=O=((Ze=n[248])==null?void 0:Ze.isProtected)||n[249],f(k,"class","flex items-center gap-2"),f(e,"class",W="flex flex-col gap-2 p-3 bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded-md "+((Fe=n[248])!=null&&Fe.isProtected?"border-l-4 border-l-[var(--text-error)] bg-[var(--background-modifier-error)]":((He=n[248])==null?void 0:He.complianceStatus)==="warning"?"border-l-4 border-l-[var(--text-warning)] bg-[var(--background-modifier-warning)]":n[249]?"border-l-4 border-l-[var(--text-muted)] bg-[var(--background-modifier-border)]":""))},m(_e,Oe){z(_e,e,Oe),u(e,t),u(t,i),u(t,a),u(t,l),u(l,p),u(t,m),u(t,h),u(h,b),u(h,v),u(h,w),u(t,_),I&&I.m(t,null),u(t,C),J&&J.m(t,null),u(t,x),ye.m(t,null),u(e,N),u(e,k),u(k,T),u(k,B),ge&&ge.m(k,null),u(e,R),~F&&Me[F].m(e,null),u(e,V),se&&se.m(e,null),u(e,Y),K=!0,H||(U=[ne(i,"change",X),ne(T,"input",ve)],H=!0)},p(_e,Oe){var Xe,Ze,Fe,He,Le,$e,qe,Re,tt,ct,We,Ye;n=_e,(!K||Oe[0]&9&&s!==(s=n[251]&&!n[249]))&&(i.checked=s),(!K||Oe[0]&9&&r!==(r=((Xe=n[248])==null?void 0:Xe.isProtected)||n[249]))&&(i.disabled=r),(!K||Oe[0]&9&&o!==(o=n[249]?"This property is globally ignored and cannot be enabled":(Ze=n[248])!=null&&Ze.isProtected?"Protected properties cannot be enabled":"Enable/disable this property for Pydantic model generation"))&&f(i,"title",o),(!K||Oe[0]&1)&&d!==(d=(((Fe=n[248])==null?void 0:Fe.name)||"Unknown")+"")&&ae(p,d),(!K||Oe[0]&9&&g!==(g="font-medium text-[var(--text-default)] "+(n[249]?"text-[var(--text-muted)] line-through":"")))&&f(l,"class",g),(!K||Oe[0]&1)&&c!==(c=(((He=n[248])==null?void 0:He.inferredType)||"string")+"")&&ae(v,c),n[252]?I?I.p(n,Oe):(I=ms(n),I.c(),I.m(t,C)):I&&(I.d(1),I=null),!((Le=n[248])!=null&&Le.isProtected)&&!n[249]?J?J.p(n,Oe):(J=ys(n),J.c(),J.m(t,x)):J&&(J.d(1),J=null),Te!==(Te=fe(n))&&(ye.d(1),ye=Te(n),ye&&(ye.c(),ye.m(t,null))),(!K||Oe[0]&1&&D!==(D=n[84](n[243].typeName,(($e=n[248])==null?void 0:$e.name)||"",((qe=n[248])==null?void 0:qe.description)||""))&&T.value!==D)&&(T.value=D),(!K||Oe[0]&9&&A!==(A="flex-1 px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm min-w-48 disabled:opacity-50 "+(n[249]?"bg-[var(--background-modifier-border)]":"")))&&f(T,"class",A),(!K||Oe[0]&9&&O!==(O=((Re=n[248])==null?void 0:Re.isProtected)||n[249]))&&(T.disabled=O),!((tt=n[248])!=null&&tt.isProtected)&&!n[249]?ge?(ge.p(n,Oe),Oe[0]&9&&G(ge,1)):(ge=bs(n),ge.c(),G(ge,1),ge.m(k,null)):ge&&(Ue(),Z(ge,1,1,()=>{ge=null}),je());let Ve=F;F=ie(n),F===Ve?~F&&Me[F].p(n,Oe):(L&&(Ue(),Z(Me[Ve],1,1,()=>{Me[Ve]=null}),je()),~F?(L=Me[F],L?L.p(n,Oe):(L=Me[F]=me[F](n),L.c()),G(L,1),L.m(e,V)):L=null),(ct=n[248])!=null&&ct.examples&&n[248].examples.length>0?se?se.p(n,Oe):(se=ws(n),se.c(),se.m(e,Y)):se&&(se.d(1),se=null),(!K||Oe[0]&9&&W!==(W="flex flex-col gap-2 p-3 bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded-md "+((We=n[248])!=null&&We.isProtected?"border-l-4 border-l-[var(--text-error)] bg-[var(--background-modifier-error)]":((Ye=n[248])==null?void 0:Ye.complianceStatus)==="warning"?"border-l-4 border-l-[var(--text-warning)] bg-[var(--background-modifier-warning)]":n[249]?"border-l-4 border-l-[var(--text-muted)] bg-[var(--background-modifier-border)]":"")))&&f(e,"class",W)},i(_e){K||(G(ge),G(L),K=!0)},o(_e){Z(ge),Z(L),K=!1},d(_e){_e&&j(e),I&&I.d(),J&&J.d(),ye.d(),ge&&ge.d(),~F&&Me[F].d(),se&&se.d(),H=!1,Qe(U)}}}function ks(n){let e,t,i,s;const r=[Bu,zu,ju],o=[];function a(l,d){return l[244].length===0?0:l[244].length<l[245]?1:2}return e=a(n),t=o[e]=r[e](n),{c(){t.c(),i=rn()},m(l,d){o[e].m(l,d),z(l,i,d),s=!0},p(l,d){let p=e;e=a(l),e===p?o[e].p(l,d):(Ue(),Z(o[p],1,1,()=>{o[p]=null}),je(),t=o[e],t?t.p(l,d):(t=o[e]=r[e](l),t.c()),G(t,1),t.m(i.parentNode,i))},i(l){s||(G(t),s=!0)},o(l){Z(t),s=!1},d(l){l&&j(i),o[e].d(l)}}}function ju(n){let e,t,i,s,r,o=n[244].length+"",a,l,d=n[244].length===1?"y":"ies",p,g,m,h,b;return t=new De({props:{icon:"check-circle",size:"medium"}}),{c(){e=y("div"),Pe(t.$$.fragment),i=E(),s=y("strong"),s.textContent="All Properties Enabled:",r=E(),a=$(o),l=$(" propert"),p=$(d),g=$(` ready for Pydantic model generation.\r
                            `),m=y("br"),h=y("span"),h.textContent=`This entity type is fully configured and ready to\r
                              use.`,f(h,"class","text-xs text-[var(--text-muted)]"),f(e,"class","mt-4 p-3 bg-[var(--background-modifier-success)] border border-[var(--background-modifier-border)] rounded text-sm leading-relaxed text-[var(--text-on-accent)] flex items-center gap-2")},m(c,v){z(c,e,v),Ee(t,e,null),u(e,i),u(e,s),u(e,r),u(e,a),u(e,l),u(e,p),u(e,g),u(e,m),u(e,h),b=!0},p(c,v){(!b||v[0]&9)&&o!==(o=c[244].length+"")&&ae(a,o),(!b||v[0]&9)&&d!==(d=c[244].length===1?"y":"ies")&&ae(p,d)},i(c){b||(G(t.$$.fragment,c),b=!0)},o(c){Z(t.$$.fragment,c),b=!1},d(c){c&&j(e),Ce(t)}}}function zu(n){let e,t,i,s=n[244].length+"",r,o,a=n[245]+"",l,d,p,g,m=n[245]-n[244].length+"",h,b;return{c(){e=y("div"),t=y("strong"),t.textContent="[INFO] Partial Selection:",i=E(),r=$(s),o=$(" of "),l=$(a),d=$(` properties\r
                            enabled for Pydantic model generation.\r
                            `),p=y("br"),g=y("span"),h=$(m),b=$(` properties\r
                              will be excluded from the generated model.`),f(g,"class","text-xs text-[var(--text-muted)]"),f(e,"class","mt-4 p-3 bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded text-sm leading-relaxed text-[var(--text-default)]")},m(c,v){z(c,e,v),u(e,t),u(e,i),u(e,r),u(e,o),u(e,l),u(e,d),u(e,p),u(e,g),u(g,h),u(g,b)},p(c,v){v[0]&9&&s!==(s=c[244].length+"")&&ae(r,s),v[0]&1&&a!==(a=c[245]+"")&&ae(l,a),v[0]&9&&m!==(m=c[245]-c[244].length+"")&&ae(h,m)},i:we,o:we,d(c){c&&j(e)}}}function Bu(n){let e,t,i,s,r,o,a,l;return t=new De({props:{icon:"alert-triangle",size:"medium"}}),{c(){e=y("div"),Pe(t.$$.fragment),i=E(),s=y("strong"),s.textContent="No Properties Selected:",r=$(`\r
                            This entity type has no enabled properties and will be\r
                            excluded from Pydantic model generation.\r
                            `),o=y("br"),a=y("span"),a.textContent=`Enable at least one property using the checkboxes\r
                              above, or this entity type won't appear in\r
                              generated models.`,f(a,"class","text-xs text-[var(--text-muted)]"),f(e,"class","mt-4 p-3 bg-[var(--background-modifier-warning)] border border-[var(--background-modifier-border)] rounded text-sm leading-relaxed text-[var(--text-default)] flex items-center gap-2")},m(d,p){z(d,e,p),Ee(t,e,null),u(e,i),u(e,s),u(e,r),u(e,o),u(e,a),l=!0},p:we,i(d){l||(G(t.$$.fragment,d),l=!0)},o(d){Z(t.$$.fragment,d),l=!1},d(d){d&&j(e),Ce(t)}}}function Es(n){let e,t,i,s,r,o=n[243].typeName+"",a,l,d,p,g,m,h,b=n[38][n[243].typeName]?"Entity Enabled":"Entity Disabled",c,v,w,_,C,x,N=n[244].length+"",k,T,D=n[245]+"",A,O,B,R,F,L,V,Y,W=n[6].has(n[243].typeName),K,H,U=n[6].has(n[243].typeName),X,I,J,fe,Te;function ye(){return n[126](n[243])}const ve=[Cu,Eu],ge=[];function me(Q,ue){return ue[0]&65&&(F=null),F==null&&(F=!!Q[6].has(Q[243].typeName)),F?0:1}L=me(n,[-1,-1,-1,-1,-1,-1,-1,-1,-1]),V=ge[L]=ve[L](n);function Me(){return n[127](n[243])}let ie=W&&fs(n),se=U&&hs(n);return{c(){e=y("div"),t=y("div"),i=y("button"),s=y("div"),r=y("h4"),a=$(o),l=E(),d=y("label"),p=y("input"),m=E(),h=y("span"),c=$(b),_=E(),C=y("div"),x=y("span"),k=$(N),T=$(" of "),A=$(D),O=$(" enabled"),B=E(),R=y("span"),V.c(),Y=E(),ie&&ie.c(),H=E(),se&&se.c(),X=E(),f(r,"class","font-semibold text-[var(--text-default)]"),f(p,"type","checkbox"),p.checked=g=!!n[38][n[243].typeName],f(p,"class","w-4 h-4 text-[var(--text-success)] bg-[var(--background-secondary)] border-[var(--background-modifier-border)] rounded focus:ring-[var(--text-success)] focus:ring-2"),f(h,"class",v="text-xs "+(n[38][n[243].typeName]?"text-[var(--text-success)]":"text-[var(--text-muted)]")),f(d,"class","flex items-center gap-1 cursor-pointer"),f(d,"title",w=n[38][n[243].typeName]?"Entity enabled in data.json - uncheck to disable":"Entity disabled - check to enable in data.json"),f(s,"class","flex items-center gap-3"),f(x,"class","text-xs text-[var(--text-muted)] bg-[var(--background-secondary)] px-2 py-1 rounded-full"),f(R,"class","text-lg text-[var(--text-muted)] font-bold ml-4"),f(C,"class","flex items-center gap-4"),f(i,"class","flex-1 flex justify-between items-center text-left cursor-pointer transition-colors duration-200 hover:opacity-90"),f(t,"class",K="flex justify-between items-center w-full p-4 bg-[var(--background-secondary)] border-none "+(n[6].has(n[243].typeName)?"border-b border-[var(--background-modifier-border)]":"")),f(e,"class","bg-[var(--background-secondary-alt)] border border-[var(--background-modifier-border)] rounded-lg overflow-hidden"),f(e,"id",I="accordion-"+n[243].typeName)},m(Q,ue){z(Q,e,ue),u(e,t),u(t,i),u(i,s),u(s,r),u(r,a),u(s,l),u(s,d),u(d,p),u(d,m),u(d,h),u(h,c),u(i,_),u(i,C),u(C,x),u(x,k),u(x,T),u(x,A),u(x,O),u(C,B),u(C,R),ge[L].m(R,null),u(t,Y),ie&&ie.m(t,null),u(e,H),se&&se.m(e,null),u(e,X),J=!0,fe||(Te=[ne(p,"change",It(ye)),ne(i,"click",Me)],fe=!0)},p(Q,ue){n=Q,(!J||ue[0]&1)&&o!==(o=n[243].typeName+"")&&ae(a,o),(!J||ue[0]&1|ue[1]&128&&g!==(g=!!n[38][n[243].typeName]))&&(p.checked=g),(!J||ue[0]&1|ue[1]&128)&&b!==(b=n[38][n[243].typeName]?"Entity Enabled":"Entity Disabled")&&ae(c,b),(!J||ue[0]&1|ue[1]&128&&v!==(v="text-xs "+(n[38][n[243].typeName]?"text-[var(--text-success)]":"text-[var(--text-muted)]")))&&f(h,"class",v),(!J||ue[0]&1|ue[1]&128&&w!==(w=n[38][n[243].typeName]?"Entity enabled in data.json - uncheck to disable":"Entity disabled - check to enable in data.json"))&&f(d,"title",w),(!J||ue[0]&9)&&N!==(N=n[244].length+"")&&ae(k,N),(!J||ue[0]&1)&&D!==(D=n[245]+"")&&ae(A,D);let ze=L;L=me(n,ue),L!==ze&&(Ue(),Z(ge[ze],1,1,()=>{ge[ze]=null}),je(),V=ge[L],V||(V=ge[L]=ve[L](n),V.c()),G(V,1),V.m(R,null)),ue[0]&65&&(W=n[6].has(n[243].typeName)),W?ie?ie.p(n,ue):(ie=fs(n),ie.c(),ie.m(t,null)):ie&&(ie.d(1),ie=null),(!J||ue[0]&65&&K!==(K="flex justify-between items-center w-full p-4 bg-[var(--background-secondary)] border-none "+(n[6].has(n[243].typeName)?"border-b border-[var(--background-modifier-border)]":"")))&&f(t,"class",K),ue[0]&65&&(U=n[6].has(n[243].typeName)),U?se?(se.p(n,ue),ue[0]&65&&G(se,1)):(se=hs(n),se.c(),G(se,1),se.m(e,X)):se&&(Ue(),Z(se,1,1,()=>{se=null}),je()),(!J||ue[0]&1&&I!==(I="accordion-"+n[243].typeName))&&f(e,"id",I)},i(Q){J||(G(V),G(se),J=!0)},o(Q){Z(V),Z(se),J=!1},d(Q){Q&&j(e),ge[L].d(),ie&&ie.d(),se&&se.d(),fe=!1,Qe(Te)}}}function Cs(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F,L,V,Y=Object.keys(n[40]).length>0,W,K,H,U,X,I,J;s=new De({props:{icon:"sparkles"}});function fe(de,_e){return de[15]?Gu:Vu}let Te=fe(n),ye=Te(n);_=new De({props:{icon:"lightbulb"}});function ve(de,_e){if(de[14]&&de[13].length>0)return qu;if(de[14])return Yu}let ge=ve(n),me=ge&&ge(n);D=new De({props:{icon:"link-2"}});const Me=[Ku,Wu],ie=[];function se(de,_e){return de[42]&&de[42].length>0?0:1}F=se(n),L=ie[F]=Me[F](n);let Q=Y&&Os(n);const ue=[np,tp],ze=[];function Be(de,_e){return de[10]?0:1}return H=Be(n),U=ze[H]=ue[H](n),{c(){e=y("div"),t=y("div"),i=y("h3"),Pe(s.$$.fragment),r=E(),o=y("span"),o.textContent="LLM Edge Type Generation",a=E(),l=y("p"),l.textContent=`Use AI to automatically generate edge type suggestions and property\r
            descriptions for relationships.`,d=E(),p=y("div"),g=y("button"),g.textContent="Generate Edge Type Suggestions",m=E(),h=y("button"),ye.c(),b=E(),c=y("div"),v=y("div"),w=y("h3"),Pe(_.$$.fragment),C=$(" Suggested Edge Types"),x=E(),me&&me.c(),N=E(),k=y("div"),T=y("h3"),Pe(D.$$.fragment),A=$(" Edge Types Management"),O=E(),B=y("p"),B.textContent=`Define relationship types between entities with custom properties\r
            for Pydantic model generation.`,R=E(),L.c(),V=E(),Q&&Q.c(),W=E(),K=y("div"),U.c(),f(i,"class","text-xl font-semibold mb-2 flex items-center gap-2"),f(l,"class","mb-4 opacity-90 leading-relaxed"),f(g,"class","px-4 py-2 bg-[rgba(255,255,255,0.06)] border border-[rgba(255,255,255,0.08)] rounded-md text-sm transition-all duration-200 backdrop-blur-sm hover:bg-[rgba(255,255,255,0.09)] text-[var(--text-on-accent)]"),f(h,"class","px-4 py-2 bg-[rgba(255,255,255,0.06)] border border-[rgba(255,255,255,0.08)] rounded-md text-sm transition-all duration-200 backdrop-blur-sm hover:bg-[rgba(255,255,255,0.09)] disabled:opacity-50 disabled:cursor-not-allowed text-[var(--text-on-accent)]"),h.disabled=n[15],f(p,"class","flex gap-3 flex-wrap items-center"),f(t,"class","bg-gradient-to-br from-[var(--interactive-accent)] to-[var(--background-secondary)] text-[var(--text-on-accent)] p-6 rounded-xl mb-6 shadow-md"),f(w,"class","text-lg font-semibold text-[var(--text-default)] flex items-center gap-2"),f(v,"class","megamem-section-header mb-4"),f(c,"class","megamem-settings-section mb-6"),f(T,"class","text-lg font-semibold mb-2 text-[var(--text-default)] flex items-center gap-2"),f(B,"class","text-[var(--text-muted)] mb-6"),f(K,"class","mt-6"),f(e,"class","animate-fadeIn")},m(de,_e){z(de,e,_e),u(e,t),u(t,i),Ee(s,i,null),u(i,r),u(i,o),u(t,a),u(t,l),u(t,d),u(t,p),u(p,g),u(p,m),u(p,h),ye.m(h,null),u(e,b),u(e,c),u(c,v),u(v,w),Ee(_,w,null),u(w,C),u(c,x),me&&me.m(c,null),u(e,N),u(e,k),u(k,T),Ee(D,T,null),u(T,A),u(k,O),u(k,B),u(k,R),ie[F].m(k,null),u(k,V),Q&&Q.m(k,null),u(k,W),u(k,K),ze[H].m(K,null),X=!0,I||(J=[ne(g,"click",n[137]),ne(h,"click",n[92])],I=!0)},p(de,_e){Te!==(Te=fe(de))&&(ye.d(1),ye=Te(de),ye&&(ye.c(),ye.m(h,null))),(!X||_e[0]&32768)&&(h.disabled=de[15]),ge===(ge=ve(de))&&me?me.p(de,_e):(me&&me.d(1),me=ge&&ge(de),me&&(me.c(),me.m(c,null)));let Oe=F;F=se(de),F===Oe?ie[F].p(de,_e):(Ue(),Z(ie[Oe],1,1,()=>{ie[Oe]=null}),je(),L=ie[F],L?L.p(de,_e):(L=ie[F]=Me[F](de),L.c()),G(L,1),L.m(k,V)),_e[1]&512&&(Y=Object.keys(de[40]).length>0),Y?Q?(Q.p(de,_e),_e[1]&512&&G(Q,1)):(Q=Os(de),Q.c(),G(Q,1),Q.m(k,W)):Q&&(Ue(),Z(Q,1,1,()=>{Q=null}),je());let Ve=H;H=Be(de),H===Ve?ze[H].p(de,_e):(Ue(),Z(ze[Ve],1,1,()=>{ze[Ve]=null}),je(),U=ze[H],U?U.p(de,_e):(U=ze[H]=ue[H](de),U.c()),G(U,1),U.m(K,null))},i(de){X||(G(s.$$.fragment,de),G(_.$$.fragment,de),G(D.$$.fragment,de),G(L),G(Q),G(U),X=!0)},o(de){Z(s.$$.fragment,de),Z(_.$$.fragment,de),Z(D.$$.fragment,de),Z(L),Z(Q),Z(U),X=!1},d(de){de&&j(e),Ce(s),ye.d(),Ce(_),me&&me.d(),Ce(D),ie[F].d(),Q&&Q.d(),ze[H].d(),I=!1,Qe(J)}}}function Vu(n){let e;return{c(){e=$("Generate Edge Property Descriptions")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function Gu(n){let e;return{c(){e=$(" Generating...")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function Yu(n){let e;return{c(){e=y("div"),e.textContent=`No suggestions available. Try generating with specific entity\r
              types.`,f(e,"class","megamem-info-message svelte-1fc521h")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function qu(n){let e,t=xe(n[13]),i=[];for(let s=0;s<t.length;s+=1)i[s]=Ps(es(n,t,s));return{c(){e=y("div");for(let s=0;s<i.length;s+=1)i[s].c();f(e,"class","megamem-suggestions-container svelte-1fc521h")},m(s,r){z(s,e,r);for(let o=0;o<i.length;o+=1)i[o]&&i[o].m(e,null)},p(s,r){if(r[0]&8192|r[2]&8192){t=xe(s[13]);let o;for(o=0;o<t.length;o+=1){const a=es(s,t,o);i[o]?i[o].p(a,r):(i[o]=Ps(a),i[o].c(),i[o].m(e,null))}for(;o<i.length;o+=1)i[o].d(1);i.length=t.length}},d(s){s&&j(e),et(i,s)}}}function Ps(n){let e,t,i,s=n[213].className+"",r,o,a,l=Math.round(n[213].confidence*100)+"",d,p,g,m,h=n[213].description+"",b,c,v,w,_,C;function x(){return n[138](n[213])}return{c(){e=y("div"),t=y("div"),i=y("strong"),r=$(s),o=E(),a=y("span"),d=$(l),p=$("% confidence"),g=E(),m=y("div"),b=$(h),c=E(),v=y("button"),v.textContent="+ Add to Schema",w=E(),f(a,"class","megamem-confidence svelte-1fc521h"),f(t,"class","megamem-suggestion-info svelte-1fc521h"),f(m,"class","megamem-suggestion-description svelte-1fc521h"),f(v,"class","megamem-button-small megamem-accept-button svelte-1fc521h"),f(e,"class","megamem-suggestion-item svelte-1fc521h")},m(N,k){z(N,e,k),u(e,t),u(t,i),u(i,r),u(t,o),u(t,a),u(a,d),u(a,p),u(e,g),u(e,m),u(m,b),u(e,c),u(e,v),u(e,w),_||(C=ne(v,"click",x),_=!0)},p(N,k){n=N,k[0]&8192&&s!==(s=n[213].className+"")&&ae(r,s),k[0]&8192&&l!==(l=Math.round(n[213].confidence*100)+"")&&ae(d,l),k[0]&8192&&h!==(h=n[213].description+"")&&ae(b,h)},d(N){N&&j(e),_=!1,C()}}}function Wu(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F,L,V,Y,W,K,H,U,X,I;return i=new De({props:{icon:"link-2"}}),C=new De({props:{icon:"sparkles"}}),D=new De({props:{icon:"users"}}),F=new De({props:{icon:"bar-chart-2"}}),K=new De({props:{icon:"package"}}),{c(){e=y("div"),t=y("div"),Pe(i.$$.fragment),s=E(),r=y("h4"),r.textContent="No Edge Types Defined",o=E(),a=y("p"),a.textContent=`Create relationship types like "WorksFor", "Uses", or "Creates"\r
                with custom properties.`,l=E(),d=y("div"),p=y("h5"),p.textContent="Quick Add Common Types:",g=E(),m=y("div"),h=y("button"),h.innerHTML='<span class="text-base text-[var(--text-default)]">WorksFor</span>',b=E(),c=y("button"),c.innerHTML='<span class="text-base text-[var(--text-default)]">Uses</span>',v=E(),w=y("button"),_=y("span"),Pe(C.$$.fragment),x=$(" Creates"),N=E(),k=y("button"),T=y("span"),Pe(D.$$.fragment),A=$(" MemberOf"),O=E(),B=y("button"),R=y("span"),Pe(F.$$.fragment),L=$(" Manages"),V=E(),Y=y("button"),W=y("span"),Pe(K.$$.fragment),H=$(" Contains"),f(t,"class","text-6xl mb-5 opacity-50"),f(r,"class","text-lg font-semibold mb-3 text-[var(--text-default)]"),f(a,"class","mb-10 max-w-lg mx-auto leading-relaxed text-[var(--text-muted)]"),f(p,"class","text-sm font-semibold mb-5 text-[var(--text-default)]"),f(h,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] text-[var(--text-default)] px-4 py-3 rounded-lg cursor-pointer transition-all duration-200 hover:opacity-90 hover:border-[var(--interactive-accent)] hover:shadow-md flex items-center gap-2 text-sm font-medium"),f(c,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] text-[var(--text-default)] px-4 py-3 rounded-lg cursor-pointer transition-all duration-200 hover:opacity-90 hover:border-[var(--interactive-accent)] hover:shadow-md flex items-center gap-2 text-sm font-medium"),f(_,"class","text-base text-[var(--text-default)]"),f(w,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] text-[var(--text-default)] px-4 py-3 rounded-lg cursor-pointer transition-all duration-200 hover:opacity-90 hover:border-[var(--interactive-accent)] hover:shadow-md flex items-center gap-2 text-sm font-medium"),f(T,"class","text-base text-[var(--text-default)]"),f(k,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] text-[var(--text-default)] px-4 py-3 rounded-lg cursor-pointer transition-all duration-200 hover:opacity-90 hover:border-[var(--interactive-accent)] hover:shadow-md flex items-center gap-2 text-sm font-medium"),f(R,"class","text-base text-[var(--text-default)]"),f(B,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] text-[var(--text-default)] px-4 py-3 rounded-lg cursor-pointer transition-all duration-200 hover:opacity-90 hover:border-[var(--interactive-accent)] hover:shadow-md flex items-center gap-2 text-sm font-medium"),f(W,"class","text-base text-[var(--text-default)]"),f(Y,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] text-[var(--text-default)] px-4 py-3 rounded-lg cursor-pointer transition-all duration-200 hover:opacity-90 hover:border-[var(--interactive-accent)] hover:shadow-md flex items-center gap-2 text-sm font-medium"),f(m,"class","grid grid-cols-2 md:grid-cols-3 gap-3 max-w-2xl mx-auto"),f(d,"class","mt-10 pt-8 border-t border-[var(--background-modifier-border)]"),f(e,"class","text-center py-16 text-[var(--text-muted)]")},m(J,fe){z(J,e,fe),u(e,t),Ee(i,t,null),u(e,s),u(e,r),u(e,o),u(e,a),u(e,l),u(e,d),u(d,p),u(d,g),u(d,m),u(m,h),u(m,b),u(m,c),u(m,v),u(m,w),u(w,_),Ee(C,_,null),u(w,x),u(m,N),u(m,k),u(k,T),Ee(D,T,null),u(k,A),u(m,O),u(m,B),u(B,R),Ee(F,R,null),u(B,L),u(m,V),u(m,Y),u(Y,W),Ee(K,W,null),u(Y,H),U=!0,X||(I=[ne(h,"click",n[151]),ne(c,"click",n[152]),ne(w,"click",n[153]),ne(k,"click",n[154]),ne(B,"click",n[155]),ne(Y,"click",n[156])],X=!0)},p:we,i(J){U||(G(i.$$.fragment,J),G(C.$$.fragment,J),G(D.$$.fragment,J),G(F.$$.fragment,J),G(K.$$.fragment,J),U=!0)},o(J){Z(i.$$.fragment,J),Z(C.$$.fragment,J),Z(D.$$.fragment,J),Z(F.$$.fragment,J),Z(K.$$.fragment,J),U=!1},d(J){J&&j(e),Ce(i),Ce(C),Ce(D),Ce(F),Ce(K),X=!1,Qe(I)}}}function Ku(n){let e,t,i=xe(n[42]),s=[];for(let o=0;o<i.length;o+=1)s[o]=As(Zi(n,i,o));const r=o=>Z(s[o],1,1,()=>{s[o]=null});return{c(){e=y("div");for(let o=0;o<s.length;o+=1)s[o].c();f(e,"class","flex flex-col gap-4")},m(o,a){z(o,e,a);for(let l=0;l<s.length;l+=1)s[l]&&s[l].m(e,null);t=!0},p(o,a){if(a[0]&503840834|a[1]&1979721728|a[2]&536870913){i=xe(o[42]);let l;for(l=0;l<i.length;l+=1){const d=Zi(o,i,l);s[l]?(s[l].p(d,a),G(s[l],1)):(s[l]=As(d),s[l].c(),G(s[l],1),s[l].m(e,null))}for(Ue(),l=i.length;l<s.length;l+=1)r(l);je()}},i(o){if(!t){for(let a=0;a<i.length;a+=1)G(s[a]);t=!0}},o(o){s=s.filter(Boolean);for(let a=0;a<s.length;a+=1)Z(s[a]);t=!1},d(o){o&&j(e),et(s,o)}}}function Hu(n){let e,t;return e=new De({props:{icon:"chevron-right",size:"medium"}}),{c(){Pe(e.$$.fragment)},m(i,s){Ee(e,i,s),t=!0},i(i){t||(G(e.$$.fragment,i),t=!0)},o(i){Z(e.$$.fragment,i),t=!1},d(i){Ce(e,i)}}}function Ju(n){let e,t;return e=new De({props:{icon:"chevron-down",size:"medium"}}),{c(){Pe(e.$$.fragment)},m(i,s){Ee(e,i,s),t=!0},i(i){t||(G(e.$$.fragment,i),t=!0)},o(i){Z(e.$$.fragment,i),t=!1},d(i){Ce(e,i)}}}function Ds(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k;function T(...F){return n[141](n[231],...F)}h=new De({props:{icon:"chevron-right",size:"medium"}});function D(){return n[142](n[231])}const A=[Zu,Qu],O=[];function B(F,L){var V;return L[0]&2|L[1]&2048&&(v=null),v==null&&(v=Object.keys(((V=F[1][F[231]])==null?void 0:V.properties)||{}).length>0),v?0:1}w=B(n,[-1,-1,-1,-1,-1,-1,-1,-1,-1]),_=O[w]=A[w](n);let R=n[25]===n[231]&&Ns(n);return{c(){e=y("div"),t=y("div"),i=y("strong"),i.textContent="Description:",s=E(),r=y("textarea"),a=E(),l=y("div"),d=y("div"),p=y("strong"),p.textContent="Properties:",g=E(),m=y("button"),Pe(h.$$.fragment),b=$(` Add\r
                            Property`),c=E(),_.c(),C=E(),R&&R.c(),f(i,"class","text-sm text-[var(--text-default)] block mb-2"),r.value=o=n[57](n[231]),f(r,"class","w-full px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-relaxed resize-vertical"),f(r,"placeholder","Describe this relationship type..."),f(r,"rows","2"),f(t,"class","mb-4"),f(p,"class","text-sm text-[var(--text-default)]"),f(m,"class","px-2 py-1 bg-[var(--background-modifier-border)] border border-[var(--background-modifier-border)] rounded text-xs hover:opacity-90 transition-colors duration-200"),f(d,"class","flex justify-between items-center mb-3"),f(e,"class","p-4")},m(F,L){z(F,e,L),u(e,t),u(t,i),u(t,s),u(t,r),u(e,a),u(e,l),u(l,d),u(d,p),u(d,g),u(d,m),Ee(h,m,null),u(m,b),u(l,c),O[w].m(l,null),u(l,C),R&&R.m(l,null),x=!0,N||(k=[ne(r,"input",T),ne(m,"click",D)],N=!0)},p(F,L){n=F,(!x||L[1]&2048&&o!==(o=n[57](n[231])))&&(r.value=o);let V=w;w=B(n,L),w===V?O[w].p(n,L):(Ue(),Z(O[V],1,1,()=>{O[V]=null}),je(),_=O[w],_?_.p(n,L):(_=O[w]=A[w](n),_.c()),G(_,1),_.m(l,C)),n[25]===n[231]?R?R.p(n,L):(R=Ns(n),R.c(),R.m(l,null)):R&&(R.d(1),R=null)},i(F){x||(G(h.$$.fragment,F),G(_),x=!0)},o(F){Z(h.$$.fragment,F),Z(_),x=!1},d(F){F&&j(e),Ce(h),O[w].d(),R&&R.d(),N=!1,Qe(k)}}}function Qu(n){let e;return{c(){e=y("p"),e.textContent="No properties defined",f(e,"class","text-[var(--text-muted)] italic text-center py-2 text-sm")},m(t,i){z(t,e,i)},p:we,i:we,o:we,d(t){t&&j(e)}}}function Zu(n){let e,t,i=xe(Object.entries(n[1][n[231]].properties)),s=[];for(let o=0;o<i.length;o+=1)s[o]=Ms(Xi(n,i,o));const r=o=>Z(s[o],1,1,()=>{s[o]=null});return{c(){e=y("div");for(let o=0;o<s.length;o+=1)s[o].c();f(e,"class","flex flex-col gap-2")},m(o,a){z(o,e,a);for(let l=0;l<s.length;l+=1)s[l]&&s[l].m(e,null);t=!0},p(o,a){if(a[0]&524290|a[1]&1610614784|a[2]&536870912){i=xe(Object.entries(o[1][o[231]].properties));let l;for(l=0;l<i.length;l+=1){const d=Xi(o,i,l);s[l]?(s[l].p(d,a),G(s[l],1)):(s[l]=Ms(d),s[l].c(),G(s[l],1),s[l].m(e,null))}for(Ue(),l=i.length;l<s.length;l+=1)r(l);je()}},i(o){if(!t){for(let a=0;a<i.length;a+=1)G(s[a]);t=!0}},o(o){s=s.filter(Boolean);for(let a=0;a<s.length;a+=1)Z(s[a]);t=!1},d(o){o&&j(e),et(s,o)}}}function Ts(n){let e;return{c(){e=y("span"),e.textContent="REQUIRED",f(e,"class","text-xs px-2 py-1 bg-[var(--background-modifier-warning)] text-[var(--text-on-accent)] rounded font-bold uppercase tracking-wide ml-auto")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function Xu(n){let e,t,i,s;return e=new De({props:{icon:"sparkles",size:"medium"}}),{c(){Pe(e.$$.fragment),t=E(),i=y("span"),i.textContent="LLM Suggest"},m(r,o){Ee(e,r,o),z(r,t,o),z(r,i,o),s=!0},i(r){s||(G(e.$$.fragment,r),s=!0)},o(r){Z(e.$$.fragment,r),s=!1},d(r){r&&(j(t),j(i)),Ce(e,r)}}}function ep(n){let e;return{c(){e=$(" Generating...")},m(t,i){z(t,e,i)},i:we,o:we,d(t){t&&j(e)}}}function Ms(n){let e,t,i,s=n[237]+"",r,o,a,l,d=Jt(n[238]).fieldType+"",p,g,m,h=Jt(n[238]).required,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F,L=h&&Ts();function V(...X){return n[143](n[231],n[237],...X)}x=new De({props:{icon:"trash-2",size:"medium"}});function Y(){return n[144](n[231],n[237])}const W=[ep,Xu],K=[];function H(X,I){return X[19]===`${X[231]}.${X[237]}`?0:1}T=H(n),D=K[T]=W[T](n);function U(){return n[145](n[231],n[237])}return{c(){e=y("div"),t=y("div"),i=y("span"),r=$(s),o=E(),a=y("span"),l=$("("),p=$(d),g=$(")"),m=E(),L&&L.c(),b=E(),c=y("div"),v=y("input"),_=E(),C=y("button"),Pe(x.$$.fragment),N=E(),k=y("button"),D.c(),O=E(),f(i,"class","font-medium text-[var(--text-default)]"),f(a,"class","text-[var(--text-muted)] text-sm"),f(t,"class","flex items-center gap-2 flex-wrap"),f(v,"type","text"),v.value=w=Jt(n[238]).description,f(v,"placeholder","Property description"),f(v,"class","flex-1 px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm min-w-48"),f(C,"class","px-2 py-2 bg-[var(--background-modifier-error)] text-[var(--text-on-accent)] border border-[var(--background-modifier-border)] rounded hover:opacity-90 transition-colors duration-200"),f(k,"class","px-2 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] border border-[var(--interactive-accent)] rounded hover:opacity-90 transition-colors duration-200 text-sm whitespace-nowrap flex items-center gap-1"),f(k,"title","Generate AI description for edge property"),k.disabled=A=n[19]===`${n[231]}.${n[237]}`,f(c,"class","flex items-center gap-2"),f(e,"class","flex flex-col gap-2 p-3 bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded")},m(X,I){z(X,e,I),u(e,t),u(t,i),u(i,r),u(t,o),u(t,a),u(a,l),u(a,p),u(a,g),u(t,m),L&&L.m(t,null),u(e,b),u(e,c),u(c,v),u(c,_),u(c,C),Ee(x,C,null),u(c,N),u(c,k),K[T].m(k,null),u(e,O),B=!0,R||(F=[ne(v,"input",V),ne(C,"click",Y),ne(k,"click",U)],R=!0)},p(X,I){n=X,(!B||I[0]&2|I[1]&2048)&&s!==(s=n[237]+"")&&ae(r,s),(!B||I[0]&2|I[1]&2048)&&d!==(d=Jt(n[238]).fieldType+"")&&ae(p,d),I[0]&2|I[1]&2048&&(h=Jt(n[238]).required),h?L||(L=Ts(),L.c(),L.m(t,null)):L&&(L.d(1),L=null),(!B||I[0]&2|I[1]&2048&&w!==(w=Jt(n[238]).description)&&v.value!==w)&&(v.value=w);let J=T;T=H(n),T!==J&&(Ue(),Z(K[J],1,1,()=>{K[J]=null}),je(),D=K[T],D||(D=K[T]=W[T](n),D.c()),G(D,1),D.m(k,null)),(!B||I[0]&524290|I[1]&2048&&A!==(A=n[19]===`${n[231]}.${n[237]}`))&&(k.disabled=A)},i(X){B||(G(x.$$.fragment,X),G(D),B=!0)},o(X){Z(x.$$.fragment,X),Z(D),B=!1},d(X){X&&j(e),L&&L.d(),Ce(x),K[T].d(),R=!1,Qe(F)}}}function Ns(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N;function k(){return n[149](n[231])}return{c(){e=y("div"),t=y("div"),i=y("input"),s=E(),r=y("select"),o=y("option"),o.textContent="String",a=y("option"),a.textContent="Integer",l=y("option"),l.textContent="DateTime",d=y("option"),d.textContent="Boolean",p=y("option"),p.textContent="Float",g=y("option"),g.textContent="List",m=E(),h=y("div"),b=y("input"),c=E(),v=y("div"),w=y("button"),w.textContent="Add Property",_=E(),C=y("button"),C.textContent="Cancel",f(i,"type","text"),f(i,"placeholder","Property name (e.g., jobTitle, sentiment)"),f(i,"class","flex-1 px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm"),o.__value="str",Ie(o,o.__value),a.__value="int",Ie(a,a.__value),l.__value="datetime",Ie(l,l.__value),d.__value="bool",Ie(d,d.__value),p.__value="float",Ie(p,p.__value),g.__value="List[str]",Ie(g,g.__value),f(r,"class","px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm bg-[var(--background-secondary)] appearance-none cursor-pointer hover:opacity-90 transition-colors duration-200 min-w-32"),n[27]===void 0&&jt(()=>n[147].call(r)),f(t,"class","flex gap-2 mb-3"),f(b,"type","text"),f(b,"placeholder","Property description"),f(b,"class","w-full px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm"),f(h,"class","mb-3"),f(w,"class","px-3 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded text-sm hover:opacity-90 transition-colors duration-200"),f(C,"class","px-3 py-2 bg-[var(--background-modifier-border)] text-[var(--text-default)] rounded text-sm hover:opacity-90 transition-colors duration-200"),f(v,"class","flex gap-2"),f(e,"class","mt-4 p-4 bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded")},m(T,D){z(T,e,D),u(e,t),u(t,i),Ie(i,n[26]),u(t,s),u(t,r),u(r,o),u(r,a),u(r,l),u(r,d),u(r,p),u(r,g),kt(r,n[27],!0),u(e,m),u(e,h),u(h,b),Ie(b,n[28]),u(e,c),u(e,v),u(v,w),u(v,_),u(v,C),x||(N=[ne(i,"input",n[146]),ne(r,"change",n[147]),ne(b,"input",n[148]),ne(w,"click",k),ne(C,"click",n[150])],x=!0)},p(T,D){n=T,D[0]&67108864&&i.value!==n[26]&&Ie(i,n[26]),D[0]&134217728&&kt(r,n[27]),D[0]&268435456&&b.value!==n[28]&&Ie(b,n[28])},d(T){T&&j(e),x=!1,Qe(N)}}}function As(n){var U;let e,t,i,s,r=n[231]+"",o,a,l,d,p=Object.keys(((U=n[1][n[231]])==null?void 0:U.properties)||{}).length+"",g,m,h,b,c,v,w,_,C,x,N,k,T,D=n[6].has(`edge-${n[231]}`),A,O,B,R,F;const L=[Ju,Hu],V=[];function Y(X,I){return I[0]&64|I[1]&2048&&(c=null),c==null&&(c=!!X[6].has(`edge-${X[231]}`)),c?0:1}v=Y(n,[-1,-1,-1,-1,-1,-1,-1,-1,-1]),w=V[v]=L[v](n);function W(){return n[139](n[231])}x=new De({props:{icon:"trash-2",size:"medium"}});function K(){return n[140](n[231])}let H=D&&Ds(n);return{c(){e=y("div"),t=y("div"),i=y("button"),s=y("h4"),o=$(r),a=E(),l=y("div"),d=y("span"),g=$(p),m=$(" properties"),h=E(),b=y("span"),w.c(),_=E(),C=y("button"),Pe(x.$$.fragment),T=E(),H&&H.c(),A=E(),f(s,"class","font-semibold text-[var(--text-default)]"),f(d,"class","text-xs text-[var(--text-muted)] bg-[var(--background-modifier-border)] px-2 py-1 rounded-full"),f(b,"class","text-lg text-[var(--text-muted)] font-bold ml-4"),f(l,"class","flex items-center gap-4"),f(i,"class","flex-1 flex justify-between items-center text-left cursor-pointer transition-colors duration-200 hover:opacity-90"),f(C,"class","ml-2 px-2 py-1 bg-[var(--background-modifier-error)] text-[var(--text-on-accent)] border border-[var(--background-modifier-border)] rounded hover:opacity-90 transition-colors duration-200 text-xs"),f(C,"title",N="Delete "+n[231]+" edge type"),f(t,"class",k="flex justify-between items-center w-full p-4 bg-[var(--background-secondary)] border-none "+(n[6].has(`edge-${n[231]}`)?"border-b border-[var(--background-modifier-border)]":"")),f(e,"class","bg-[var(--background-secondary-alt)] border border-[var(--background-modifier-border)] rounded-lg overflow-hidden"),f(e,"id",O="accordion-edge-"+n[231])},m(X,I){z(X,e,I),u(e,t),u(t,i),u(i,s),u(s,o),u(i,a),u(i,l),u(l,d),u(d,g),u(d,m),u(l,h),u(l,b),V[v].m(b,null),u(t,_),u(t,C),Ee(x,C,null),u(e,T),H&&H.m(e,null),u(e,A),B=!0,R||(F=[ne(i,"click",W),ne(C,"click",It(K))],R=!0)},p(X,I){var fe;n=X,(!B||I[1]&2048)&&r!==(r=n[231]+"")&&ae(o,r),(!B||I[0]&2|I[1]&2048)&&p!==(p=Object.keys(((fe=n[1][n[231]])==null?void 0:fe.properties)||{}).length+"")&&ae(g,p);let J=v;v=Y(n,I),v!==J&&(Ue(),Z(V[J],1,1,()=>{V[J]=null}),je(),w=V[v],w||(w=V[v]=L[v](n),w.c()),G(w,1),w.m(b,null)),(!B||I[1]&2048&&N!==(N="Delete "+n[231]+" edge type"))&&f(C,"title",N),(!B||I[0]&64|I[1]&2048&&k!==(k="flex justify-between items-center w-full p-4 bg-[var(--background-secondary)] border-none "+(n[6].has(`edge-${n[231]}`)?"border-b border-[var(--background-modifier-border)]":"")))&&f(t,"class",k),I[0]&64|I[1]&2048&&(D=n[6].has(`edge-${n[231]}`)),D?H?(H.p(n,I),I[0]&64|I[1]&2048&&G(H,1)):(H=Ds(n),H.c(),G(H,1),H.m(e,A)):H&&(Ue(),Z(H,1,1,()=>{H=null}),je()),(!B||I[1]&2048&&O!==(O="accordion-edge-"+n[231]))&&f(e,"id",O)},i(X){B||(G(w),G(x.$$.fragment,X),G(H),B=!0)},o(X){Z(w),Z(x.$$.fragment,X),Z(H),B=!1},d(X){X&&j(e),V[v].d(),Ce(x),H&&H.d(),R=!1,Qe(F)}}}function Os(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b;s=new De({props:{icon:"clipboard-list"}});let c=xe(Object.entries(n[40])),v=[];for(let _=0;_<c.length;_+=1)v[_]=Is(Qi(n,c,_));const w=_=>Z(v[_],1,1,()=>{v[_]=null});return{c(){e=y("div"),t=y("div"),i=y("h4"),Pe(s.$$.fragment),r=$(" Available Default Edge Types"),o=E(),a=y("button"),a.textContent="Add All",l=E(),d=y("p"),d.textContent=`Common edge types you can add with one click. These include\r
                standard properties and descriptions.`,p=E(),g=y("div");for(let _=0;_<v.length;_+=1)v[_].c();f(i,"class","text-lg font-semibold text-[var(--text-default)] flex items-center gap-2"),f(a,"class","px-3 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded hover:opacity-90 transition-colors duration-200 text-sm font-medium"),f(a,"title","Add all unused default edge types at once"),f(t,"class","flex justify-between items-center mb-4"),f(d,"class","text-[var(--text-muted)] mb-4"),f(g,"class","grid grid-cols-1 md:grid-cols-2 gap-3"),f(e,"class","mt-8 pt-8 border-t border-[var(--background-modifier-border)]")},m(_,C){z(_,e,C),u(e,t),u(t,i),Ee(s,i,null),u(i,r),u(t,o),u(t,a),u(e,l),u(e,d),u(e,p),u(e,g);for(let x=0;x<v.length;x+=1)v[x]&&v[x].m(g,null);m=!0,h||(b=ne(a,"click",n[68]),h=!0)},p(_,C){if(C[1]&134218240){c=xe(Object.entries(_[40]));let x;for(x=0;x<c.length;x+=1){const N=Qi(_,c,x);v[x]?(v[x].p(N,C),G(v[x],1)):(v[x]=Is(N),v[x].c(),G(v[x],1),v[x].m(g,null))}for(Ue(),x=c.length;x<v.length;x+=1)w(x);je()}},i(_){if(!m){G(s.$$.fragment,_);for(let C=0;C<c.length;C+=1)G(v[C]);m=!0}},o(_){Z(s.$$.fragment,_),v=v.filter(Boolean);for(let C=0;C<v.length;C+=1)Z(v[C]);m=!1},d(_){_&&j(e),Ce(s),et(v,_),h=!1,b()}}}function Is(n){let e,t,i,s=n[231]+"",r,o,a,l,d,p,g,m,h=n[232]+"",b,c,v,w,_;l=new De({props:{icon:"chevron-right",size:"medium"}});function C(){return n[157](n[231])}return{c(){e=y("div"),t=y("div"),i=y("h5"),r=$(s),o=E(),a=y("button"),Pe(l.$$.fragment),d=$(" Add"),g=E(),m=y("p"),b=$(h),c=E(),f(i,"class","font-semibold text-[var(--text-default)]"),f(a,"class","px-2 py-1 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded text-xs hover:opacity-90 transition-colors duration-200"),f(a,"title",p="Add "+n[231]+" edge type"),f(t,"class","flex justify-between items-start mb-2"),f(m,"class","text-[var(--text-muted)] text-sm leading-relaxed"),f(e,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] p-4 rounded-lg")},m(x,N){z(x,e,N),u(e,t),u(t,i),u(i,r),u(t,o),u(t,a),Ee(l,a,null),u(a,d),u(e,g),u(e,m),u(m,b),u(e,c),v=!0,w||(_=ne(a,"click",C),w=!0)},p(x,N){n=x,(!v||N[1]&512)&&s!==(s=n[231]+"")&&ae(r,s),(!v||N[1]&512&&p!==(p="Add "+n[231]+" edge type"))&&f(a,"title",p),(!v||N[1]&512)&&h!==(h=n[232]+"")&&ae(b,h)},i(x){v||(G(l.$$.fragment,x),v=!0)},o(x){Z(l.$$.fragment,x),v=!1},d(x){x&&j(e),Ce(l),w=!1,_()}}}function tp(n){let e,t,i,s,r,o;return t=new De({props:{icon:"chevron-right",size:"medium"}}),{c(){e=y("button"),Pe(t.$$.fragment),i=$(" Add Edge Type"),f(e,"class","px-4 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded hover:opacity-90 transition-colors duration-200")},m(a,l){z(a,e,l),Ee(t,e,null),u(e,i),s=!0,r||(o=ne(e,"click",n[160]),r=!0)},p:we,i(a){s||(G(t.$$.fragment,a),s=!0)},o(a){Z(t.$$.fragment,a),s=!1},d(a){a&&j(e),Ce(t),r=!1,o()}}}function np(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c;return{c(){e=y("div"),t=y("h4"),t.textContent="Add New Edge Type",i=E(),s=y("div"),r=y("input"),o=E(),a=y("div"),l=y("textarea"),d=E(),p=y("div"),g=y("button"),g.textContent="Save Edge Type",m=E(),h=y("button"),h.textContent="Cancel",f(t,"class","text-lg font-semibold mb-4 text-[var(--text-default)]"),f(r,"type","text"),f(r,"placeholder","Edge type name (e.g., WorksFor, Uses, Creates)"),f(r,"class","w-full px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm"),f(s,"class","mb-4"),f(l,"placeholder","Description of this relationship type"),f(l,"class","w-full px-3 py-2 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-relaxed resize-vertical"),f(l,"rows","2"),f(a,"class","mb-4"),f(g,"class","px-4 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded hover:opacity-90 transition-colors duration-200"),f(h,"class","px-4 py-2 bg-[var(--background-modifier-border)] text-[var(--text-default)] rounded hover:opacity-90 transition-colors duration-200"),f(p,"class","flex gap-2"),f(e,"class","bg-[var(--background-secondary-alt)] border border-[var(--background-modifier-border)] rounded-lg p-6")},m(v,w){z(v,e,w),u(e,t),u(e,i),u(e,s),u(s,r),Ie(r,n[11]),u(e,o),u(e,a),u(a,l),Ie(l,n[12]),u(e,d),u(e,p),u(p,g),u(p,m),u(p,h),b||(c=[ne(r,"input",n[158]),ne(l,"input",n[159]),ne(g,"click",n[54]),ne(h,"click",n[55])],b=!0)},p(v,w){w[0]&2048&&r.value!==v[11]&&Ie(r,v[11]),w[0]&4096&&Ie(l,v[12])},i:we,o:we,d(v){v&&j(e),b=!1,Qe(c)}}}function Ls(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F,L,V,Y,W,K,H,U;s=new De({props:{icon:"sparkles"}}),v=new De({props:{icon:"lightbulb"}});function X(ie,se){if(ie[24]&&ie[23].length>0)return sp;if(ie[24])return ip}let I=X(n),J=I&&I(n);k=new De({props:{icon:"map"}});const fe=[op,rp],Te=[];function ye(ie,se){return ie[2]&&ie[2].length>0?0:1}B=ye(n),R=Te[B]=fe[B](n);let ve=n[39].length>0&&Bs(n);const ge=[pp,up],me=[];function Me(ie,se){return ie[29]?0:1}return Y=Me(n),W=me[Y]=ge[Y](n),{c(){e=y("div"),t=y("div"),i=y("h3"),Pe(s.$$.fragment),r=E(),o=y("span"),o.textContent="LLM Edge Mapping Generation",a=E(),l=y("p"),l.textContent=`Use AI to automatically suggest which entity types can connect using\r
            which edge types.`,d=E(),p=y("div"),g=y("button"),g.textContent="Generate Edge Mapping Suggestions",m=E(),h=y("div"),b=y("div"),c=y("h3"),Pe(v.$$.fragment),w=$(" Suggested Edge Mappings"),_=E(),J&&J.c(),C=E(),x=y("div"),N=y("h3"),Pe(k.$$.fragment),T=$(" Edge Type Mappings"),D=E(),A=y("p"),A.textContent=`Define which edge types can connect which entity types. Controls\r
            relationship validation in your knowledge graph.`,O=E(),R.c(),F=E(),ve&&ve.c(),L=E(),V=y("div"),W.c(),f(i,"class","text-xl font-semibold mb-2 flex items-center gap-2"),f(l,"class","mb-4 opacity-90 leading-relaxed"),f(g,"class","px-4 py-2 bg-[rgba(255,255,255,0.06)] border border-[rgba(255,255,255,0.08)] rounded-md text-sm transition-all duration-200 backdrop-blur-sm hover:bg-[rgba(255,255,255,0.09)] text-[var(--text-on-accent)]"),f(p,"class","flex gap-3 flex-wrap items-center"),f(t,"class","bg-gradient-to-br from-[var(--interactive-accent)] to-[var(--background-secondary)] text-[var(--text-on-accent)] p-6 rounded-xl mb-6 shadow-md"),f(c,"class","text-lg font-semibold text-[var(--text-default)] flex items-center gap-2"),f(b,"class","megamem-section-header mb-4"),f(h,"class","megamem-settings-section mb-6"),f(N,"class","text-lg font-semibold mb-2 flex items-center gap-2"),f(A,"class","mb-6"),f(V,"class","mt-6"),f(e,"class","animate-fadeIn")},m(ie,se){z(ie,e,se),u(e,t),u(t,i),Ee(s,i,null),u(i,r),u(i,o),u(t,a),u(t,l),u(t,d),u(t,p),u(p,g),u(e,m),u(e,h),u(h,b),u(b,c),Ee(v,c,null),u(c,w),u(h,_),J&&J.m(h,null),u(e,C),u(e,x),u(x,N),Ee(k,N,null),u(N,T),u(x,D),u(x,A),u(x,O),Te[B].m(x,null),u(x,F),ve&&ve.m(x,null),u(x,L),u(x,V),me[Y].m(V,null),K=!0,H||(U=ne(g,"click",n[161]),H=!0)},p(ie,se){I===(I=X(ie))&&J?J.p(ie,se):(J&&J.d(1),J=I&&I(ie),J&&(J.c(),J.m(h,null)));let Q=B;B=ye(ie),B===Q?Te[B].p(ie,se):(Ue(),Z(Te[Q],1,1,()=>{Te[Q]=null}),je(),R=Te[B],R?R.p(ie,se):(R=Te[B]=fe[B](ie),R.c()),G(R,1),R.m(x,F)),ie[39].length>0?ve?(ve.p(ie,se),se[1]&256&&G(ve,1)):(ve=Bs(ie),ve.c(),G(ve,1),ve.m(x,L)):ve&&(Ue(),Z(ve,1,1,()=>{ve=null}),je());let ue=Y;Y=Me(ie),Y===ue?me[Y].p(ie,se):(Ue(),Z(me[ue],1,1,()=>{me[ue]=null}),je(),W=me[Y],W?W.p(ie,se):(W=me[Y]=ge[Y](ie),W.c()),G(W,1),W.m(V,null))},i(ie){K||(G(s.$$.fragment,ie),G(v.$$.fragment,ie),G(k.$$.fragment,ie),G(R),G(ve),G(W),K=!0)},o(ie){Z(s.$$.fragment,ie),Z(v.$$.fragment,ie),Z(k.$$.fragment,ie),Z(R),Z(ve),Z(W),K=!1},d(ie){ie&&j(e),Ce(s),Ce(v),J&&J.d(),Ce(k),Te[B].d(),ve&&ve.d(),me[Y].d(),H=!1,U()}}}function ip(n){let e;return{c(){e=y("div"),e.textContent=`No mapping suggestions available. Create more entities and edge\r
              types first.`,f(e,"class","megamem-info-message svelte-1fc521h")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function sp(n){let e,t,i,s=n[23].length+"",r,o,a,l,d,p,g=xe(n[23]),m=[];for(let h=0;h<g.length;h+=1)m[h]=Rs(Ji(n,g,h));return{c(){e=y("div"),t=y("button"),i=$("Accept All ("),r=$(s),o=$(")"),a=E(),l=y("div");for(let h=0;h<m.length;h+=1)m[h].c();f(t,"class","px-3 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded hover:opacity-90 transition-colors duration-200 text-sm"),f(e,"class","megamem-bulk-actions mb-3 svelte-1fc521h"),f(l,"class","megamem-suggestions-container svelte-1fc521h")},m(h,b){z(h,e,b),u(e,t),u(t,i),u(t,r),u(t,o),z(h,a,b),z(h,l,b);for(let c=0;c<m.length;c+=1)m[c]&&m[c].m(l,null);d||(p=ne(t,"click",n[162]),d=!0)},p(h,b){if(b[0]&8388608&&s!==(s=h[23].length+"")&&ae(r,s),b[0]&8388608|b[2]&32768){g=xe(h[23]);let c;for(c=0;c<g.length;c+=1){const v=Ji(h,g,c);m[c]?m[c].p(v,b):(m[c]=Rs(v),m[c].c(),m[c].m(l,null))}for(;c<m.length;c+=1)m[c].d(1);m.length=g.length}},d(h){h&&(j(e),j(a),j(l)),et(m,h),d=!1,p()}}}function Rs(n){let e,t,i,s=n[213].source+"",r,o,a,l,d,p=n[213].target+"",g,m,h,b,c=n[213].edgeTypes.join(", ")+"",v,w,_,C,x,N;function k(){return n[163](n[213])}return{c(){e=y("div"),t=y("div"),i=y("strong"),r=$(s),o=E(),a=y("span"),a.textContent="",l=E(),d=y("strong"),g=$(p),m=E(),h=y("div"),b=$("Suggested edge types: "),v=$(c),w=E(),_=y("button"),_.textContent="+ Add to Schema",C=E(),f(t,"class","megamem-suggestion-info svelte-1fc521h"),f(h,"class","megamem-suggestion-description svelte-1fc521h"),f(_,"class","megamem-button-small megamem-accept-button svelte-1fc521h"),f(e,"class","megamem-suggestion-item svelte-1fc521h")},m(T,D){z(T,e,D),u(e,t),u(t,i),u(i,r),u(t,o),u(t,a),u(t,l),u(t,d),u(d,g),u(e,m),u(e,h),u(h,b),u(h,v),u(e,w),u(e,_),u(e,C),x||(N=ne(_,"click",k),x=!0)},p(T,D){n=T,D[0]&8388608&&s!==(s=n[213].source+"")&&ae(r,s),D[0]&8388608&&p!==(p=n[213].target+"")&&ae(g,p),D[0]&8388608&&c!==(c=n[213].edgeTypes.join(", ")+"")&&ae(v,c)},d(T){T&&j(e),x=!1,N()}}}function rp(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F,L,V,Y,W,K,H,U,X,I,J,fe,Te,ye,ve,ge,me,Me,ie,se;return i=new De({props:{icon:"map"}}),c=new De({props:{icon:"user"}}),w=new De({props:{icon:"monitor"}}),D=new De({props:{icon:"user"}}),O=new De({props:{icon:"folder"}}),W=new De({props:{icon:"link-2"}}),fe=new De({props:{icon:"folder"}}),ye=new De({props:{icon:"monitor"}}),{c(){e=y("div"),t=y("div"),Pe(i.$$.fragment),s=E(),r=y("h4"),r.textContent="No Edge Mappings Defined",o=E(),a=y("p"),a.textContent=`Create mappings to define which relationships can exist between\r
                entity types.`,l=E(),d=y("div"),p=y("h5"),p.textContent="Quick Add Common Mappings:",g=E(),m=y("div"),h=y("button"),b=y("div"),Pe(c.$$.fragment),v=$(" Person  "),Pe(w.$$.fragment),_=$(" Technology"),C=E(),x=y("div"),x.textContent="Uses, RelatesTo",N=E(),k=y("button"),T=y("div"),Pe(D.$$.fragment),A=$(" Person  "),Pe(O.$$.fragment),B=$(" Project"),R=E(),F=y("div"),F.textContent="WorksOn, Manages, RelatesTo",L=E(),V=y("button"),Y=y("div"),Pe(W.$$.fragment),K=$(" Entity  Entity"),H=E(),U=y("div"),U.textContent="RelatesTo (Generic)",X=E(),I=y("button"),J=y("div"),Pe(fe.$$.fragment),Te=$(" Project  "),Pe(ye.$$.fragment),ve=$(" Technology"),ge=E(),me=y("div"),me.textContent="Uses, DependsOn, RelatesTo",f(t,"class","text-6xl mb-5 opacity-50"),f(r,"class","text-lg font-semibold mb-3 text-[var(--text-default)]"),f(a,"class","mb-10 max-w-lg mx-auto leading-relaxed text-[var(--text-muted)]"),f(p,"class","text-sm font-semibold mb-5 text-[var(--text-default)]"),f(b,"class","font-semibold mb-1 text-[var(--text-default)]"),f(x,"class","text-xs text-[var(--text-muted)]"),f(h,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] text-[var(--text-default)] p-4 rounded-lg cursor-pointer transition-all duration-200 hover:opacity-90 hover:border-[var(--interactive-accent)] hover:shadow-md text-sm font-medium"),f(T,"class","font-semibold mb-1 text-[var(--text-default)]"),f(F,"class","text-xs text-[var(--text-muted)]"),f(k,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] text-[var(--text-default)] p-4 rounded-lg cursor-pointer transition-all duration-200 hover:opacity-90 hover:border-[var(--interactive-accent)] hover:shadow-md text-sm font-medium"),f(Y,"class","font-semibold mb-1 text-[var(--text-default)]"),f(U,"class","text-xs text-[var(--text-muted)]"),f(V,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] text-[var(--text-default)] p-4 rounded-lg cursor-pointer transition-all duration-200 hover:opacity-90 hover:border-[var(--interactive-accent)] hover:shadow-md text-sm font-medium"),f(J,"class","font-semibold mb-1 text-[var(--text-default)]"),f(me,"class","text-xs text-[var(--text-muted)]"),f(I,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] text-[var(--text-default)] p-4 rounded-lg cursor-pointer transition-all duration-200 hover:opacity-90 hover:border-[var(--interactive-accent)] hover:shadow-md text-sm font-medium"),f(m,"class","grid grid-cols-1 md:grid-cols-2 gap-3 max-w-2xl mx-auto"),f(d,"class","mt-10 pt-8 border-t border-[var(--background-modifier-border)]"),f(e,"class","text-center py-16 text-[var(--text-muted)]")},m(Q,ue){z(Q,e,ue),u(e,t),Ee(i,t,null),u(e,s),u(e,r),u(e,o),u(e,a),u(e,l),u(e,d),u(d,p),u(d,g),u(d,m),u(m,h),u(h,b),Ee(c,b,null),u(b,v),Ee(w,b,null),u(b,_),u(h,C),u(h,x),u(m,N),u(m,k),u(k,T),Ee(D,T,null),u(T,A),Ee(O,T,null),u(T,B),u(k,R),u(k,F),u(m,L),u(m,V),u(V,Y),Ee(W,Y,null),u(Y,K),u(V,H),u(V,U),u(m,X),u(m,I),u(I,J),Ee(fe,J,null),u(J,Te),Ee(ye,J,null),u(J,ve),u(I,ge),u(I,me),Me=!0,ie||(se=[ne(h,"click",n[169]),ne(k,"click",n[170]),ne(V,"click",n[171]),ne(I,"click",n[172])],ie=!0)},p:we,i(Q){Me||(G(i.$$.fragment,Q),G(c.$$.fragment,Q),G(w.$$.fragment,Q),G(D.$$.fragment,Q),G(O.$$.fragment,Q),G(W.$$.fragment,Q),G(fe.$$.fragment,Q),G(ye.$$.fragment,Q),Me=!0)},o(Q){Z(i.$$.fragment,Q),Z(c.$$.fragment,Q),Z(w.$$.fragment,Q),Z(D.$$.fragment,Q),Z(O.$$.fragment,Q),Z(W.$$.fragment,Q),Z(fe.$$.fragment,Q),Z(ye.$$.fragment,Q),Me=!1},d(Q){Q&&j(e),Ce(i),Ce(c),Ce(w),Ce(D),Ce(O),Ce(W),Ce(fe),Ce(ye),ie=!1,Qe(se)}}}function op(n){let e,t,i=xe(n[2]),s=[];for(let o=0;o<i.length;o+=1)s[o]=zs(Yi(n,i,o));const r=o=>Z(s[o],1,1,()=>{s[o]=null});return{c(){e=y("div");for(let o=0;o<s.length;o+=1)s[o].c();f(e,"class","flex flex-col gap-4")},m(o,a){z(o,e,a);for(let l=0;l<s.length;l+=1)s[l]&&s[l].m(e,null);t=!0},p(o,a){if(a[0]&4|a[1]&3132|a[2]&3848){i=xe(o[2]);let l;for(l=0;l<i.length;l+=1){const d=Yi(o,i,l);s[l]?(s[l].p(d,a),G(s[l],1)):(s[l]=zs(d),s[l].c(),G(s[l],1),s[l].m(e,null))}for(Ue(),l=i.length;l<s.length;l+=1)r(l);je()}},i(o){if(!t){for(let a=0;a<i.length;a+=1)G(s[a]);t=!0}},o(o){s=s.filter(Boolean);for(let a=0;a<s.length;a+=1)Z(s[a]);t=!1},d(o){o&&j(e),et(s,o)}}}function ap(n){let e,t,i,s,r,o=n[218].sourceEntity+"",a,l,d,p,g,m=n[218].targetEntity+"",h,b,c,v,w,_,C=n[218].isUserDefined?"User":"Auto",x,N,k,T,D,A,O,B,R,F,L=xe(n[218].allowedEdges),V=[];for(let K=0;K<L.length;K+=1)V[K]=Fs(qi(n,L,K));T=new De({props:{icon:"pencil",size:"medium"}});function Y(){return n[167](n[220])}O=new De({props:{icon:"trash-2",size:"medium"}});function W(){return n[168](n[220])}return{c(){e=y("div"),t=y("div"),i=y("div"),s=y("div"),r=y("span"),a=$(o),l=E(),d=y("span"),d.textContent="",p=E(),g=y("span"),h=$(m),b=E(),c=y("div");for(let K=0;K<V.length;K+=1)V[K].c();v=E(),w=y("div"),_=y("span"),x=$(C),N=E(),k=y("button"),Pe(T.$$.fragment),D=E(),A=y("button"),Pe(O.$$.fragment),f(r,"class","font-semibold text-[var(--text-default)]"),f(d,"class","text-[var(--text-muted)]"),f(g,"class","font-semibold text-[var(--text-default)]"),f(s,"class","flex items-center gap-2"),f(c,"class","flex gap-1 flex-wrap"),f(i,"class","flex items-center gap-4"),f(_,"class","text-xs text-[var(--text-muted)] bg-[var(--background-modifier-border)] px-2 py-1 rounded-full"),f(k,"class","p-1 text-[var(--text-muted)] hover:opacity-90 hover:bg-[var(--background-modifier-border)] rounded transition-all duration-200"),f(k,"title","Edit Mapping"),f(A,"class","px-2 py-1 bg-[var(--background-modifier-error)] text-[var(--text-on-accent)] border border-[var(--background-modifier-border)] rounded hover:opacity-90 transition-colors duration-200 text-xs"),f(w,"class","flex items-center gap-2"),f(t,"class","flex justify-between items-center"),f(e,"class","p-4 bg-[var(--background-secondary-alt)] border-none")},m(K,H){z(K,e,H),u(e,t),u(t,i),u(i,s),u(s,r),u(r,a),u(s,l),u(s,d),u(s,p),u(s,g),u(g,h),u(i,b),u(i,c);for(let U=0;U<V.length;U+=1)V[U]&&V[U].m(c,null);u(t,v),u(t,w),u(w,_),u(_,x),u(w,N),u(w,k),Ee(T,k,null),u(w,D),u(w,A),Ee(O,A,null),B=!0,R||(F=[ne(k,"click",Y),ne(A,"click",W)],R=!0)},p(K,H){if(n=K,(!B||H[0]&4)&&o!==(o=n[218].sourceEntity+"")&&ae(a,o),(!B||H[0]&4)&&m!==(m=n[218].targetEntity+"")&&ae(h,m),H[0]&4){L=xe(n[218].allowedEdges);let U;for(U=0;U<L.length;U+=1){const X=qi(n,L,U);V[U]?V[U].p(X,H):(V[U]=Fs(X),V[U].c(),V[U].m(c,null))}for(;U<V.length;U+=1)V[U].d(1);V.length=L.length}(!B||H[0]&4)&&C!==(C=n[218].isUserDefined?"User":"Auto")&&ae(x,C)},i(K){B||(G(T.$$.fragment,K),G(O.$$.fragment,K),B=!0)},o(K){Z(T.$$.fragment,K),Z(O.$$.fragment,K),B=!1},d(K){K&&j(e),et(V,K),Ce(T),Ce(O),R=!1,Qe(F)}}}function lp(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F=xe(n[41]),L=[];for(let U=0;U<F.length;U+=1)L[U]=$s(Hi(n,F,U));let V=xe(n[41]),Y=[];for(let U=0;U<V.length;U+=1)Y[U]=Us(Ki(n,V,U));function W(U,X){return U[42].length>0?dp:cp}let K=W(n),H=K(n);return{c(){e=y("div"),t=y("h4"),t.textContent="Edit Edge Mapping",i=E(),s=y("div"),r=y("div"),o=y("label"),o.textContent="Source Entity Type",a=E(),l=y("select"),d=y("option"),d.textContent="Select source entity...";for(let U=0;U<L.length;U+=1)L[U].c();p=E(),g=y("div"),m=y("label"),m.textContent="Target Entity Type",h=E(),b=y("select"),c=y("option"),c.textContent="Select target entity...";for(let U=0;U<Y.length;U+=1)Y[U].c();v=E(),w=y("div"),_=y("span"),_.textContent="Allowed Edge Types",C=E(),H.c(),x=E(),N=y("div"),k=y("button"),T=$("Save Changes"),A=E(),O=y("button"),O.textContent="Cancel",f(t,"class","text-lg font-semibold mb-4 text-[var(--text-default)]"),f(o,"for","edit-source-entity"),f(o,"class","block text-sm font-medium text-[var(--text-default)] mb-2"),d.__value="",Ie(d,d.__value),f(l,"id","edit-source-entity"),f(l,"class","w-full px-3 py-1 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-normal bg-[var(--background-secondary)] min-w-48"),n[34]===void 0&&jt(()=>n[164].call(l)),f(m,"for","edit-target-entity"),f(m,"class","block text-sm font-medium text-[var(--text-default)] mb-2"),c.__value="",Ie(c,c.__value),f(b,"id","edit-target-entity"),f(b,"class","w-full px-3 py-1 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-normal bg-[var(--background-secondary)] min-w-48"),n[35]===void 0&&jt(()=>n[165].call(b)),f(s,"class","space-y-4 mb-4"),f(_,"class","block text-sm font-medium text-[var(--text-default)] mb-2"),f(w,"class","mb-4"),f(k,"class","px-4 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded hover:opacity-90 transition-colors duration-200"),k.disabled=D=!n[34]||!n[35]||n[36].length===0,f(O,"class","px-4 py-2 bg-[var(--background-modifier-border)] text-[var(--text-default)] rounded hover:opacity-90 transition-colors duration-200"),f(N,"class","flex gap-2"),f(e,"class","p-4 bg-[var(--background-secondary-alt)] border-none")},m(U,X){z(U,e,X),u(e,t),u(e,i),u(e,s),u(s,r),u(r,o),u(r,a),u(r,l),u(l,d);for(let I=0;I<L.length;I+=1)L[I]&&L[I].m(l,null);kt(l,n[34],!0),u(s,p),u(s,g),u(g,m),u(g,h),u(g,b),u(b,c);for(let I=0;I<Y.length;I+=1)Y[I]&&Y[I].m(b,null);kt(b,n[35],!0),u(e,v),u(e,w),u(w,_),u(w,C),H.m(w,null),u(e,x),u(e,N),u(N,k),u(k,T),u(N,A),u(N,O),B||(R=[ne(l,"change",n[164]),ne(b,"change",n[165]),ne(k,"click",n[71]),ne(O,"click",n[72])],B=!0)},p(U,X){if(X[1]&1024){F=xe(U[41]);let I;for(I=0;I<F.length;I+=1){const J=Hi(U,F,I);L[I]?L[I].p(J,X):(L[I]=$s(J),L[I].c(),L[I].m(l,null))}for(;I<L.length;I+=1)L[I].d(1);L.length=F.length}if(X[1]&1032&&kt(l,U[34]),X[1]&1024){V=xe(U[41]);let I;for(I=0;I<V.length;I+=1){const J=Ki(U,V,I);Y[I]?Y[I].p(J,X):(Y[I]=Us(J),Y[I].c(),Y[I].m(b,null))}for(;I<Y.length;I+=1)Y[I].d(1);Y.length=V.length}X[1]&1040&&kt(b,U[35]),K===(K=W(U))&&H?H.p(U,X):(H.d(1),H=K(U),H&&(H.c(),H.m(w,null))),X[1]&1080&&D!==(D=!U[34]||!U[35]||U[36].length===0)&&(k.disabled=D)},i:we,o:we,d(U){U&&j(e),et(L,U),et(Y,U),H.d(),B=!1,Qe(R)}}}function Fs(n){let e,t=n[205]+"",i;return{c(){e=y("span"),i=$(t),f(e,"class","text-xs px-2 py-1 bg-[var(--background-modifier-border)] text-[var(--text-muted)] rounded-full font-medium")},m(s,r){z(s,e,r),u(e,i)},p(s,r){r[0]&4&&t!==(t=s[205]+"")&&ae(i,t)},d(s){s&&j(e)}}}function $s(n){let e,t=n[208]+"",i,s;return{c(){e=y("option"),i=$(t),e.__value=s=n[208],Ie(e,e.__value)},m(r,o){z(r,e,o),u(e,i)},p(r,o){o[1]&1024&&t!==(t=r[208]+"")&&ae(i,t),o[1]&1024&&s!==(s=r[208])&&(e.__value=s,Ie(e,e.__value))},d(r){r&&j(e)}}}function Us(n){let e,t=n[208]+"",i,s;return{c(){e=y("option"),i=$(t),e.__value=s=n[208],Ie(e,e.__value)},m(r,o){z(r,e,o),u(e,i)},p(r,o){o[1]&1024&&t!==(t=r[208]+"")&&ae(i,t),o[1]&1024&&s!==(s=r[208])&&(e.__value=s,Ie(e,e.__value))},d(r){r&&j(e)}}}function cp(n){let e;return{c(){e=y("p"),e.textContent="No edge types defined. Create edge types first.",f(e,"class","text-sm text-[var(--text-muted)] italic")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function dp(n){let e,t=xe(n[42]),i=[];for(let s=0;s<t.length;s+=1)i[s]=js(Wi(n,t,s));return{c(){e=y("div");for(let s=0;s<i.length;s+=1)i[s].c();f(e,"class","grid grid-cols-2 md:grid-cols-3 gap-2")},m(s,r){z(s,e,r);for(let o=0;o<i.length;o+=1)i[o]&&i[o].m(e,null)},p(s,r){if(r[1]&2080|r[2]&2048){t=xe(s[42]);let o;for(o=0;o<t.length;o+=1){const a=Wi(s,t,o);i[o]?i[o].p(a,r):(i[o]=js(a),i[o].c(),i[o].m(e,null))}for(;o<i.length;o+=1)i[o].d(1);i.length=t.length}},d(s){s&&j(e),et(i,s)}}}function js(n){let e,t,i,s,r,o=n[205]+"",a,l,d,p;function g(){return n[166](n[205])}return{c(){e=y("label"),t=y("input"),s=E(),r=y("span"),a=$(o),l=E(),f(t,"type","checkbox"),t.checked=i=n[36].includes(n[205]),f(t,"class","rounded border-[var(--background-modifier-border)] text-[var(--interactive-accent)] focus:ring-[var(--interactive-accent)]"),f(r,"class","text-sm text-[var(--text-default)]"),f(e,"class","flex items-center gap-2 p-2 border border-[var(--background-modifier-border)] rounded hover:opacity-90 cursor-pointer transition-colors duration-200")},m(m,h){z(m,e,h),u(e,t),u(e,s),u(e,r),u(r,a),u(e,l),d||(p=ne(t,"change",g),d=!0)},p(m,h){n=m,h[1]&2080&&i!==(i=n[36].includes(n[205]))&&(t.checked=i),h[1]&2048&&o!==(o=n[205]+"")&&ae(a,o)},d(m){m&&j(e),d=!1,p()}}}function zs(n){let e,t,i,s,r;const o=[lp,ap],a=[];function l(d,p){return d[33]===d[220]?0:1}return t=l(n),i=a[t]=o[t](n),{c(){e=y("div"),i.c(),s=E(),f(e,"class","bg-[var(--background-secondary-alt)] border border-[var(--background-modifier-border)] rounded-lg overflow-hidden"),f(e,"id","mapping-"+n[220])},m(d,p){z(d,e,p),a[t].m(e,null),u(e,s),r=!0},p(d,p){let g=t;t=l(d),t===g?a[t].p(d,p):(Ue(),Z(a[g],1,1,()=>{a[g]=null}),je(),i=a[t],i?i.p(d,p):(i=a[t]=o[t](d),i.c()),G(i,1),i.m(e,s))},i(d){r||(G(i),r=!0)},o(d){Z(i),r=!1},d(d){d&&j(e),a[t].d()}}}function Bs(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b;s=new De({props:{icon:"lightbulb"}});let c=xe(n[39]),v=[];for(let w=0;w<c.length;w+=1)v[w]=Gs(Vi(n,c,w));return{c(){e=y("div"),t=y("div"),i=y("h4"),Pe(s.$$.fragment),r=$(" Suggested Edge Mappings"),o=E(),a=y("button"),a.textContent="Add All",l=E(),d=y("p"),d.textContent=`Recommended mappings based on your discovered entity types. Add\r
                these to enable common relationships.`,p=E(),g=y("div");for(let w=0;w<v.length;w+=1)v[w].c();f(i,"class","text-lg font-semibold text-[var(--text-default)] flex items-center gap-2"),f(a,"class","px-3 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded hover:opacity-90 transition-colors duration-200 text-sm font-medium"),f(a,"title","Add all suggested edge mappings at once"),f(t,"class","flex justify-between items-center mb-4"),f(d,"class","text-[var(--text-muted)] mb-4"),f(g,"class","grid grid-cols-1 gap-3"),f(e,"class","mt-8 pt-8 border-t border-[var(--background-modifier-border)]")},m(w,_){z(w,e,_),u(e,t),u(t,i),Ee(s,i,null),u(i,r),u(t,o),u(t,a),u(e,l),u(e,d),u(e,p),u(e,g);for(let C=0;C<v.length;C+=1)v[C]&&v[C].m(g,null);m=!0,h||(b=ne(a,"click",n[69]),h=!0)},p(w,_){if(_[1]&256|_[2]&32){c=xe(w[39]);let C;for(C=0;C<c.length;C+=1){const x=Vi(w,c,C);v[C]?v[C].p(x,_):(v[C]=Gs(x),v[C].c(),v[C].m(g,null))}for(;C<v.length;C+=1)v[C].d(1);v.length=c.length}},i(w){m||(G(s.$$.fragment,w),m=!0)},o(w){Z(s.$$.fragment,w),m=!1},d(w){w&&j(e),Ce(s),et(v,w),h=!1,b()}}}function Vs(n){let e,t=n[205]+"",i;return{c(){e=y("span"),i=$(t),f(e,"class","text-xs px-2 py-1 bg-[var(--background-modifier-success)] text-[var(--text-on-accent)] rounded-full font-medium")},m(s,r){z(s,e,r),u(e,i)},p(s,r){r[1]&256&&t!==(t=s[205]+"")&&ae(i,t)},d(s){s&&j(e)}}}function Gs(n){let e,t,i,s,r=n[213].sourceEntity+"",o,a,l,d,p,g=n[213].targetEntity+"",m,h,b,c,v,w,_,C=n[213].description+"",x,N,k,T,D=xe(n[213].allowedEdges),A=[];for(let B=0;B<D.length;B+=1)A[B]=Vs(Gi(n,D,B));function O(){return n[173](n[213])}return{c(){e=y("div"),t=y("div"),i=y("div"),s=y("span"),o=$(r),a=E(),l=y("span"),l.textContent="",d=E(),p=y("span"),m=$(g),h=E(),b=y("div");for(let B=0;B<A.length;B+=1)A[B].c();c=E(),v=y("button"),v.textContent="Add",w=E(),_=y("p"),x=$(C),N=E(),f(s,"class","font-semibold text-[var(--text-default)]"),f(l,"class","text-[var(--text-muted)]"),f(p,"class","font-semibold text-[var(--text-default)]"),f(b,"class","flex gap-1 ml-2"),f(i,"class","flex items-center gap-2"),f(v,"class","px-2 py-1 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded text-xs hover:opacity-90 transition-colors duration-200"),f(v,"title","Add this mapping"),f(t,"class","flex justify-between items-start mb-2"),f(_,"class","text-[var(--text-muted)] text-sm leading-relaxed"),f(e,"class","bg-[var(--background-secondary-alt)] border border-[var(--background-modifier-border)] p-4 rounded-lg")},m(B,R){z(B,e,R),u(e,t),u(t,i),u(i,s),u(s,o),u(i,a),u(i,l),u(i,d),u(i,p),u(p,m),u(i,h),u(i,b);for(let F=0;F<A.length;F+=1)A[F]&&A[F].m(b,null);u(t,c),u(t,v),u(e,w),u(e,_),u(_,x),u(e,N),k||(T=ne(v,"click",O),k=!0)},p(B,R){if(n=B,R[1]&256&&r!==(r=n[213].sourceEntity+"")&&ae(o,r),R[1]&256&&g!==(g=n[213].targetEntity+"")&&ae(m,g),R[1]&256){D=xe(n[213].allowedEdges);let F;for(F=0;F<D.length;F+=1){const L=Gi(n,D,F);A[F]?A[F].p(L,R):(A[F]=Vs(L),A[F].c(),A[F].m(b,null))}for(;F<A.length;F+=1)A[F].d(1);A.length=D.length}R[1]&256&&C!==(C=n[213].description+"")&&ae(x,C)},d(B){B&&j(e),et(A,B),k=!1,T()}}}function up(n){let e,t,i,s,r,o;return t=new De({props:{icon:"chevron-right",size:"medium"}}),{c(){e=y("button"),Pe(t.$$.fragment),i=$(" Add Edge Mapping"),f(e,"class","px-4 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded hover:opacity-90 transition-colors duration-200")},m(a,l){z(a,e,l),Ee(t,e,null),u(e,i),s=!0,r||(o=ne(e,"click",n[177]),r=!0)},p:we,i(a){s||(G(t.$$.fragment,a),s=!0)},o(a){Z(t.$$.fragment,a),s=!1},d(a){a&&j(e),Ce(t),r=!1,o()}}}function pp(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F=xe(n[41]),L=[];for(let U=0;U<F.length;U+=1)L[U]=Ys(Bi(n,F,U));let V=xe(n[41]),Y=[];for(let U=0;U<V.length;U+=1)Y[U]=qs(zi(n,V,U));function W(U,X){return U[42].length>0?fp:gp}let K=W(n),H=K(n);return{c(){e=y("div"),t=y("h4"),t.textContent="Add New Edge Mapping",i=E(),s=y("div"),r=y("div"),o=y("label"),o.textContent="Source Entity Type",a=E(),l=y("select"),d=y("option"),d.textContent="Select source entity...";for(let U=0;U<L.length;U+=1)L[U].c();p=E(),g=y("div"),m=y("label"),m.textContent="Target Entity Type",h=E(),b=y("select"),c=y("option"),c.textContent="Select target entity...";for(let U=0;U<Y.length;U+=1)Y[U].c();v=E(),w=y("div"),_=y("span"),_.textContent="Allowed Edge Types",C=E(),H.c(),x=E(),N=y("div"),k=y("button"),T=$("Save Mapping"),A=E(),O=y("button"),O.textContent="Cancel",f(t,"class","text-lg font-semibold mb-4 text-[var(--text-default)]"),f(o,"for","new-source-entity"),f(o,"class","block text-sm font-medium text-[var(--text-default)] mb-2"),d.__value="",Ie(d,d.__value),f(l,"id","new-source-entity"),f(l,"class","w-full px-3 py-1 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-normal bg-[var(--background-secondary)] min-w-48"),n[30]===void 0&&jt(()=>n[174].call(l)),f(m,"for","new-target-entity"),f(m,"class","block text-sm font-medium text-[var(--text-default)] mb-2"),c.__value="",Ie(c,c.__value),f(b,"id","new-target-entity"),f(b,"class","w-full px-3 py-1 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-normal bg-[var(--background-secondary)] min-w-48"),n[31]===void 0&&jt(()=>n[175].call(b)),f(s,"class","space-y-4 mb-4"),f(_,"class","block text-sm font-medium text-[var(--text-default)] mb-2"),f(w,"class","mb-4"),f(k,"class","px-4 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded hover:opacity-90 transition-colors duration-200"),k.disabled=D=!n[30]||!n[31]||n[32].length===0,f(O,"class","px-4 py-2 bg-[var(--background-modifier-border)] text-[var(--text-default)] rounded hover:opacity-90 transition-colors duration-200"),f(N,"class","flex gap-2"),f(e,"class","bg-[var(--background-secondary-alt)] border border-[var(--background-modifier-border)] rounded-lg p-6")},m(U,X){z(U,e,X),u(e,t),u(e,i),u(e,s),u(s,r),u(r,o),u(r,a),u(r,l),u(l,d);for(let I=0;I<L.length;I+=1)L[I]&&L[I].m(l,null);kt(l,n[30],!0),u(s,p),u(s,g),u(g,m),u(g,h),u(g,b),u(b,c);for(let I=0;I<Y.length;I+=1)Y[I]&&Y[I].m(b,null);kt(b,n[31],!0),u(e,v),u(e,w),u(w,_),u(w,C),H.m(w,null),u(e,x),u(e,N),u(N,k),u(k,T),u(N,A),u(N,O),B||(R=[ne(l,"change",n[174]),ne(b,"change",n[175]),ne(k,"click",n[63]),ne(O,"click",n[64])],B=!0)},p(U,X){if(X[1]&1024){F=xe(U[41]);let I;for(I=0;I<F.length;I+=1){const J=Bi(U,F,I);L[I]?L[I].p(J,X):(L[I]=Ys(J),L[I].c(),L[I].m(l,null))}for(;I<L.length;I+=1)L[I].d(1);L.length=F.length}if(X[0]&1073741824|X[1]&1024&&kt(l,U[30]),X[1]&1024){V=xe(U[41]);let I;for(I=0;I<V.length;I+=1){const J=zi(U,V,I);Y[I]?Y[I].p(J,X):(Y[I]=qs(J),Y[I].c(),Y[I].m(b,null))}for(;I<Y.length;I+=1)Y[I].d(1);Y.length=V.length}X[1]&1025&&kt(b,U[31]),K===(K=W(U))&&H?H.p(U,X):(H.d(1),H=K(U),H&&(H.c(),H.m(w,null))),X[0]&1073741824|X[1]&1027&&D!==(D=!U[30]||!U[31]||U[32].length===0)&&(k.disabled=D)},i:we,o:we,d(U){U&&j(e),et(L,U),et(Y,U),H.d(),B=!1,Qe(R)}}}function Ys(n){let e,t=n[208]+"",i,s;return{c(){e=y("option"),i=$(t),e.__value=s=n[208],Ie(e,e.__value)},m(r,o){z(r,e,o),u(e,i)},p(r,o){o[1]&1024&&t!==(t=r[208]+"")&&ae(i,t),o[1]&1024&&s!==(s=r[208])&&(e.__value=s,Ie(e,e.__value))},d(r){r&&j(e)}}}function qs(n){let e,t=n[208]+"",i,s;return{c(){e=y("option"),i=$(t),e.__value=s=n[208],Ie(e,e.__value)},m(r,o){z(r,e,o),u(e,i)},p(r,o){o[1]&1024&&t!==(t=r[208]+"")&&ae(i,t),o[1]&1024&&s!==(s=r[208])&&(e.__value=s,Ie(e,e.__value))},d(r){r&&j(e)}}}function gp(n){let e;return{c(){e=y("p"),e.textContent="No edge types defined. Create edge types first.",f(e,"class","text-sm text-[var(--text-muted)] italic")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function fp(n){let e,t=xe(n[42]),i=[];for(let s=0;s<t.length;s+=1)i[s]=Ws(ji(n,t,s));return{c(){e=y("div");for(let s=0;s<i.length;s+=1)i[s].c();f(e,"class","grid grid-cols-2 md:grid-cols-3 gap-2")},m(s,r){z(s,e,r);for(let o=0;o<i.length;o+=1)i[o]&&i[o].m(e,null)},p(s,r){if(r[1]&2050|r[2]&16){t=xe(s[42]);let o;for(o=0;o<t.length;o+=1){const a=ji(s,t,o);i[o]?i[o].p(a,r):(i[o]=Ws(a),i[o].c(),i[o].m(e,null))}for(;o<i.length;o+=1)i[o].d(1);i.length=t.length}},d(s){s&&j(e),et(i,s)}}}function Ws(n){let e,t,i,s,r,o=n[205]+"",a,l,d,p;function g(){return n[176](n[205])}return{c(){e=y("label"),t=y("input"),s=E(),r=y("span"),a=$(o),l=E(),f(t,"type","checkbox"),t.checked=i=n[32].includes(n[205]),f(t,"class","rounded border-[var(--background-modifier-border)] text-[var(--interactive-accent)] focus:ring-[var(--interactive-accent)]"),f(r,"class","text-sm text-[var(--text-default)]"),f(e,"class","flex items-center gap-2 p-2 border border-[var(--background-modifier-border)] rounded hover:opacity-90 cursor-pointer transition-colors duration-200")},m(m,h){z(m,e,h),u(e,t),u(e,s),u(e,r),u(r,a),u(e,l),d||(p=ne(t,"change",g),d=!0)},p(m,h){n=m,h[1]&2050&&i!==(i=n[32].includes(n[205]))&&(t.checked=i),h[1]&2048&&o!==(o=n[205]+"")&&ae(a,o)},d(m){m&&j(e),d=!1,p()}}}function hp(n){let e,t,i,s,r=n[0].length+"",o,a,l,d=n[0].reduce(Js,0)+"",p,g;return{c(){e=y("div"),t=y("p"),i=$("Found "),s=y("strong"),o=$(r),a=$(`\r
        types across\r
        `),l=y("strong"),p=$(d),g=$(" files"),f(s,"class","text-[var(--text-default)]"),f(l,"class","text-[var(--text-default)]"),f(t,"class","text-[var(--text-default)] text-center"),f(e,"class","bg-[var(--background-secondary)] border border-[var(--background-modifier-border)] rounded-lg p-4 mb-4")},m(m,h){z(m,e,h),u(e,t),u(t,i),u(t,s),u(s,o),u(t,a),u(t,l),u(l,p),u(t,g)},p(m,h){h[0]&1&&r!==(r=m[0].length+"")&&ae(o,r),h[0]&1&&d!==(d=m[0].reduce(Js,0)+"")&&ae(p,d)},d(m){m&&j(e)}}}function mp(n){let e;return{c(){e=y("div"),e.innerHTML='<p class="mb-2">No typed notes found in your vault.</p> <p>Add a <code class="bg-[var(--background-modifier-border)] px-2 py-1 rounded font-mono text-sm">type</code> property to your frontmatter to get started.</p>',f(e,"class","text-center py-8 text-[var(--text-muted)]")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function yp(n){let e;return{c(){e=y("div"),e.innerHTML=`<div class="w-4 h-4 border-2 border-[var(--background-modifier-border)] border-t-[var(--interactive-accent)] rounded-full animate-spin"></div>
      Discovering schemas from vault...`,f(e,"class","flex items-center gap-2 justify-center py-8 text-[var(--text-muted)]")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function Ks(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F,L,V,Y,W;function K(fe,Te){return fe[21]==="entities"?Sp:fe[21]==="properties"?wp:fe[21]==="load_default_entities"?_p:fe[21]==="load_default_properties"?vp:bp}let H=K(n),U=H(n);function X(fe,Te){return fe[21]==="load_default_entities"||fe[21]==="load_default_properties"?kp:xp}let I=X(n),J=I(n);return V=Qd(n[179][0]),{c(){e=y("div"),t=y("div"),i=y("div"),s=y("h3"),U.c(),r=E(),o=y("button"),o.textContent="",a=E(),l=y("div"),d=y("p"),J.c(),p=E(),g=y("div"),m=y("label"),h=y("input"),b=E(),c=y("div"),c.innerHTML=`<strong class="svelte-1fc521h">Skip User Defined</strong> <span class="svelte-1fc521h">Only generate for items without descriptions or with source !=
                &#39;user&#39;</span>`,v=E(),w=y("label"),_=y("input"),C=E(),x=y("div"),x.innerHTML='<strong class="svelte-1fc521h">New Only</strong> <span class="svelte-1fc521h">Only generate for completely missing descriptions</span>',N=E(),k=y("label"),T=y("input"),D=E(),A=y("div"),A.innerHTML='<strong class="svelte-1fc521h">Regenerate All</strong> <span class="text-warning svelte-1fc521h">Overwrites ALL existing descriptions including user-defined</span>',O=E(),B=y("div"),R=y("button"),R.textContent="Cancel",F=E(),L=y("button"),L.textContent="Generate",f(s,"class","svelte-1fc521h"),f(o,"class","megamem-modal-close svelte-1fc521h"),f(i,"class","megamem-modal-header svelte-1fc521h"),f(d,"class","megamem-modal-warning svelte-1fc521h"),f(h,"type","radio"),h.__value="skip_user",Ie(h,h.__value),h.checked=!0,f(h,"class","svelte-1fc521h"),f(c,"class","megamem-radio-label svelte-1fc521h"),f(m,"class","megamem-radio-option svelte-1fc521h"),f(_,"type","radio"),_.__value="new_only",Ie(_,_.__value),f(_,"class","svelte-1fc521h"),f(x,"class","megamem-radio-label svelte-1fc521h"),f(w,"class","megamem-radio-option svelte-1fc521h"),f(T,"type","radio"),T.__value="regenerate_all",Ie(T,T.__value),f(T,"class","svelte-1fc521h"),f(A,"class","megamem-radio-label svelte-1fc521h"),f(k,"class","megamem-radio-option svelte-1fc521h"),f(g,"class","megamem-radio-group svelte-1fc521h"),f(l,"class","megamem-modal-body svelte-1fc521h"),f(R,"class","megamem-button-secondary svelte-1fc521h"),f(L,"class","megamem-button-primary svelte-1fc521h"),f(B,"class","megamem-modal-footer svelte-1fc521h"),f(t,"class","megamem-modal-content svelte-1fc521h"),f(t,"role","dialog"),f(t,"aria-modal","true"),f(t,"aria-label","LLM generation options"),f(t,"aria-describedby","modal-description"),f(t,"tabindex","-1"),f(e,"class","megamem-modal-overlay svelte-1fc521h"),f(e,"role","presentation"),V.p(h,_,T)},m(fe,Te){z(fe,e,Te),u(e,t),u(t,i),u(i,s),U.m(s,null),u(i,r),u(i,o),u(t,a),u(t,l),u(l,d),J.m(d,null),u(l,p),u(l,g),u(g,m),u(m,h),h.checked=h.__value===n[22],u(m,b),u(m,c),u(g,v),u(g,w),u(w,_),_.checked=_.__value===n[22],u(w,C),u(w,x),u(g,N),u(g,k),u(k,T),T.checked=T.__value===n[22],u(k,D),u(k,A),u(t,O),u(t,B),u(B,R),u(B,F),u(B,L),Y||(W=[ne(o,"click",n[94]),ne(h,"change",n[178]),ne(_,"change",n[180]),ne(T,"change",n[181]),ne(R,"click",n[94]),ne(L,"click",n[95]),ne(e,"mousedown",Jd(n[94]))],Y=!0)},p(fe,Te){H!==(H=K(fe))&&(U.d(1),U=H(fe),U&&(U.c(),U.m(s,null))),I!==(I=X(fe))&&(J.d(1),J=I(fe),J&&(J.c(),J.m(d,null))),Te[0]&4194304&&(h.checked=h.__value===fe[22]),Te[0]&4194304&&(_.checked=_.__value===fe[22]),Te[0]&4194304&&(T.checked=T.__value===fe[22])},d(fe){fe&&j(e),U.d(),J.d(),V.r(),Y=!1,Qe(W)}}}function bp(n){let e;return{c(){e=$("Generate Complete Ontology")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function vp(n){let e;return{c(){e=$("Load Default Property Descriptions")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function _p(n){let e;return{c(){e=$("Load Default Entity Descriptions")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function wp(n){let e;return{c(){e=$("Generate Property Descriptions")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function Sp(n){let e;return{c(){e=$("Generate Entity Descriptions")},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function xp(n){let e;return{c(){e=$(`This will use your configured LLM to generate descriptions. Choose\r
            how to handle existing content:`)},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function kp(n){let e;return{c(){e=$(`Load built-in default descriptions. Choose how to handle existing\r
            content:`)},m(t,i){z(t,e,i)},d(t){t&&j(e)}}}function Ep(n){let e,t,i,s,r,o,a=n[4]?"Scanning...":"Refresh Schemas",l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F,L,V,Y=Object.keys(n[1]).length+"",W,K,H,U,X,I,J,fe,Te,ye,ve,ge=n[2].length+"",me,Me,ie,se,Q,ue,ze,Be,de,_e,Oe,Ve,Xe,Ze;m=new De({props:{icon:"box",size:"medium"}});let Fe=n[0].length>0&&ss(n);C=new De({props:{icon:"tag",size:"medium"}});let He=n[0].length>0&&rs(Bn(n));O=new De({props:{icon:"link",size:"medium"}}),I=new De({props:{icon:"map",size:"medium"}});let Le=n[5]==="entities"&&os(n),$e=n[5]==="properties"&&ps(n),qe=n[5]==="edges"&&Cs(n),Re=n[5]==="mappings"&&Ls(n);function tt(pe,Ae){return pe[4]?yp:pe[0].length===0?mp:hp}let ct=tt(n),We=ct(n),Ye=n[20]&&Ks(n);return{c(){e=y("div"),t=y("div"),i=y("h2"),i.textContent="MegaMem Ontology Management",s=E(),r=y("div"),o=y("button"),l=$(a),d=E(),p=y("div"),g=y("button"),Pe(m.$$.fragment),h=E(),b=y("span"),b.textContent="Entity Types",c=E(),Fe&&Fe.c(),w=E(),_=y("button"),Pe(C.$$.fragment),x=E(),N=y("span"),N.textContent="Properties",k=E(),He&&He.c(),D=E(),A=y("button"),Pe(O.$$.fragment),B=E(),R=y("span"),R.textContent="Edge Types",F=E(),L=y("span"),V=$("("),W=$(Y),K=$(")"),U=E(),X=y("button"),Pe(I.$$.fragment),J=E(),fe=y("span"),fe.textContent="Edge Mappings",Te=E(),ye=y("span"),ve=$("("),me=$(ge),Me=$(")"),se=E(),Q=y("div"),Le&&Le.c(),ue=E(),$e&&$e.c(),ze=E(),qe&&qe.c(),Be=E(),Re&&Re.c(),de=E(),We.c(),_e=E(),Ye&&Ye.c(),Oe=rn(),f(i,"class","text-2xl font-semibold"),o.disabled=n[4],f(o,"class","px-4 py-2 bg-[var(--interactive-accent)] rounded hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed text-[var(--text-on-accent)]"),f(r,"class","flex gap-2 items-center"),f(t,"class","flex justify-between items-center mb-6 pb-4 border-b border-[var(--background-modifier-border)]"),f(g,"class",v="flex-1 flex items-center gap-2 px-4 py-3 rounded-md whitespace-nowrap text-sm font-medium transition-all duration-200 "+(n[5]==="entities"?"bg-[var(--interactive-accent)] shadow-sm text-[var(--text-on-accent)]":"hover:opacity-90 text-[var(--text-default)]")),f(_,"class",T="flex-1 flex items-center gap-2 px-4 py-3 rounded-md whitespace-nowrap text-sm font-medium transition-all duration-200 "+(n[5]==="properties"?"bg-[var(--interactive-accent)] shadow-sm text-[var(--text-on-accent)]":"hover:opacity-90 text-[var(--text-default)]")),f(L,"class","text-xs opacity-80 font-normal"),f(A,"class",H="flex-1 flex items-center gap-2 px-4 py-3 rounded-md whitespace-nowrap text-sm font-medium transition-all duration-200 "+(n[5]==="edges"?"bg-[var(--interactive-accent)] text-[var(--text-on-accent)] shadow-sm":"text-[var(--text-muted)] hover:bg-[var(--background-secondary)] hover:text-[var(--text-muted)]")),f(ye,"class","text-xs opacity-80 font-normal"),f(X,"class",ie="flex-1 flex items-center gap-2 px-4 py-3 rounded-md whitespace-nowrap text-sm font-medium transition-all duration-200 "+(n[5]==="mappings"?"bg-[var(--interactive-accent)] text-[var(--text-on-accent)] shadow-sm":"text-[var(--text-muted)] hover:bg-[var(--background-secondary)] hover:text-[var(--text-muted)]")),f(p,"class","flex bg-[var(--background-secondary)] rounded-lg p-1 mb-6 border border-[var(--background-modifier-border)]"),f(Q,"class","min-h-96"),f(e,"class","p-4 max-w-6xl mx-auto")},m(pe,Ae){z(pe,e,Ae),u(e,t),u(t,i),u(t,s),u(t,r),u(r,o),u(o,l),u(e,d),u(e,p),u(p,g),Ee(m,g,null),u(g,h),u(g,b),u(g,c),Fe&&Fe.m(g,null),u(p,w),u(p,_),Ee(C,_,null),u(_,x),u(_,N),u(_,k),He&&He.m(_,null),u(p,D),u(p,A),Ee(O,A,null),u(A,B),u(A,R),u(A,F),u(A,L),u(L,V),u(L,W),u(L,K),u(p,U),u(p,X),Ee(I,X,null),u(X,J),u(X,fe),u(X,Te),u(X,ye),u(ye,ve),u(ye,me),u(ye,Me),u(e,se),u(e,Q),Le&&Le.m(Q,null),u(Q,ue),$e&&$e.m(Q,null),u(Q,ze),qe&&qe.m(Q,null),u(Q,Be),Re&&Re.m(Q,null),u(e,de),We.m(e,null),z(pe,_e,Ae),Ye&&Ye.m(pe,Ae),z(pe,Oe,Ae),Ve=!0,Xe||(Ze=[ne(o,"click",n[78]),ne(g,"click",n[106]),ne(_,"click",n[107]),ne(A,"click",n[108]),ne(X,"click",n[109])],Xe=!0)},p(pe,Ae){(!Ve||Ae[0]&16)&&a!==(a=pe[4]?"Scanning...":"Refresh Schemas")&&ae(l,a),(!Ve||Ae[0]&16)&&(o.disabled=pe[4]),pe[0].length>0?Fe?Fe.p(pe,Ae):(Fe=ss(pe),Fe.c(),Fe.m(g,null)):Fe&&(Fe.d(1),Fe=null),(!Ve||Ae[0]&32&&v!==(v="flex-1 flex items-center gap-2 px-4 py-3 rounded-md whitespace-nowrap text-sm font-medium transition-all duration-200 "+(pe[5]==="entities"?"bg-[var(--interactive-accent)] shadow-sm text-[var(--text-on-accent)]":"hover:opacity-90 text-[var(--text-default)]")))&&f(g,"class",v),pe[0].length>0?He?He.p(Bn(pe),Ae):(He=rs(Bn(pe)),He.c(),He.m(_,null)):He&&(He.d(1),He=null),(!Ve||Ae[0]&32&&T!==(T="flex-1 flex items-center gap-2 px-4 py-3 rounded-md whitespace-nowrap text-sm font-medium transition-all duration-200 "+(pe[5]==="properties"?"bg-[var(--interactive-accent)] shadow-sm text-[var(--text-on-accent)]":"hover:opacity-90 text-[var(--text-default)]")))&&f(_,"class",T),(!Ve||Ae[0]&2)&&Y!==(Y=Object.keys(pe[1]).length+"")&&ae(W,Y),(!Ve||Ae[0]&32&&H!==(H="flex-1 flex items-center gap-2 px-4 py-3 rounded-md whitespace-nowrap text-sm font-medium transition-all duration-200 "+(pe[5]==="edges"?"bg-[var(--interactive-accent)] text-[var(--text-on-accent)] shadow-sm":"text-[var(--text-muted)] hover:bg-[var(--background-secondary)] hover:text-[var(--text-muted)]")))&&f(A,"class",H),(!Ve||Ae[0]&4)&&ge!==(ge=pe[2].length+"")&&ae(me,ge),(!Ve||Ae[0]&32&&ie!==(ie="flex-1 flex items-center gap-2 px-4 py-3 rounded-md whitespace-nowrap text-sm font-medium transition-all duration-200 "+(pe[5]==="mappings"?"bg-[var(--interactive-accent)] text-[var(--text-on-accent)] shadow-sm":"text-[var(--text-muted)] hover:bg-[var(--background-secondary)] hover:text-[var(--text-muted)]")))&&f(X,"class",ie),pe[5]==="entities"?Le?(Le.p(pe,Ae),Ae[0]&32&&G(Le,1)):(Le=os(pe),Le.c(),G(Le,1),Le.m(Q,ue)):Le&&(Ue(),Z(Le,1,1,()=>{Le=null}),je()),pe[5]==="properties"?$e?($e.p(pe,Ae),Ae[0]&32&&G($e,1)):($e=ps(pe),$e.c(),G($e,1),$e.m(Q,ze)):$e&&(Ue(),Z($e,1,1,()=>{$e=null}),je()),pe[5]==="edges"?qe?(qe.p(pe,Ae),Ae[0]&32&&G(qe,1)):(qe=Cs(pe),qe.c(),G(qe,1),qe.m(Q,Be)):qe&&(Ue(),Z(qe,1,1,()=>{qe=null}),je()),pe[5]==="mappings"?Re?(Re.p(pe,Ae),Ae[0]&32&&G(Re,1)):(Re=Ls(pe),Re.c(),G(Re,1),Re.m(Q,null)):Re&&(Ue(),Z(Re,1,1,()=>{Re=null}),je()),ct===(ct=tt(pe))&&We?We.p(pe,Ae):(We.d(1),We=ct(pe),We&&(We.c(),We.m(e,null))),pe[20]?Ye?Ye.p(pe,Ae):(Ye=Ks(pe),Ye.c(),Ye.m(Oe.parentNode,Oe)):Ye&&(Ye.d(1),Ye=null)},i(pe){Ve||(G(m.$$.fragment,pe),G(C.$$.fragment,pe),G(O.$$.fragment,pe),G(I.$$.fragment,pe),G(Le),G($e),G(qe),G(Re),Ve=!0)},o(pe){Z(m.$$.fragment,pe),Z(C.$$.fragment,pe),Z(O.$$.fragment,pe),Z(I.$$.fragment,pe),Z(Le),Z($e),Z(qe),Z(Re),Ve=!1},d(pe){pe&&(j(e),j(_e),j(Oe)),Ce(m),Fe&&Fe.d(),Ce(C),He&&He.d(),Ce(O),Ce(I),Le&&Le.d(),$e&&$e.d(),qe&&qe.d(),Re&&Re.d(),We.d(),Ye&&Ye.d(pe),Xe=!1,Qe(Ze)}}}let Hs="";function Jt(n){const e=n!=null?n:{};return{fieldType:e.fieldType||"unknown",required:!!e.required,description:e.description||""}}function Cp(n){const e=n.properties.length,t=n.properties.filter(o=>o.complianceStatus==="valid").length,i=n.properties.filter(o=>o.complianceStatus==="warning").length,s=n.properties.filter(o=>o.complianceStatus==="protected").length,r=e>0?Math.round(t/e*100):100;return{total:e,valid:t,warnings:i,protectedCount:s,score:r}}const Js=(n,e)=>n+e.fileCount;function Pp(n,e,t){let i,s,r,o,a,l,d,p,g,m,{schemaService:h}=e,{llmService:b}=e,c,v={},w,_=[],C=!0;function x(S){console.log(`Switching to tab: ${S}, schemas.length: ${_.length}, edgeTypes: ${Object.keys(r).length}`),t(5,N=S)}let N="entities",k=new Set,T=null,D={},A={},O=!1,B="",R="",F=[],L=!1,V=!1,Y={current:0,total:0,step:""},W="",K="",H="",U=!1,X=null,I="skip_user",J=[],fe=!1,Te=null,ye="",ve="str",ge="",me=!1,Me=!1,ie="",se="",Q=[],ue=null,ze="",Be="",de=[];function _e(S){k.has(S)?k.delete(S):k.add(S),t(6,k=new Set(k))}function Oe(S){t(5,N="properties"),k.clear(),k.add(S),t(6,k=new Set(k)),setTimeout(()=>{const M=document.getElementById(`accordion-${S}`);M&&M.scrollIntoView({behavior:"smooth",block:"start"})},100)}function Ve(S){var M;if(t(7,T=S),(M=i[S])!=null&&M.description)t(8,D[S]=i[S].description,D),t(9,A[S]=i[S].source||"user",A);else{const q=h.getDefaultEntityDescription(S);t(8,D[S]=q||`Custom ${S} entity.`,D),t(9,A[S]="user",A)}}async function Xe(S){if(D[S]&&(c!=null&&c.settings)){const M=A[S]||"user";c.settings.entityDescriptions||t(102,c.settings.entityDescriptions={},c),t(102,c.settings.entityDescriptions[S]={className:S.replace(/\s+/g,"").replace(/[^a-zA-Z0-9]/g,""),description:D[S],isUserDefined:!0,source:M,lastModified:new Date().toISOString()},c),await c.saveSettings()}t(7,T=null),delete A[S]}function Ze(){t(7,T=null),t(8,D={})}function Fe(S){var q;if((q=i[S])!=null&&q.description)return i[S].description;const M=h.getDefaultEntityDescription(S);return M||`Custom ${S} entity.`}function He(S){return h.hasDefaultEntityDescription(S)}async function Le(S){const M=h.getDefaultEntityDescription(S);if(M&&(c!=null&&c.settings))try{t(8,D[S]=M,D),t(9,A[S]="default",A),c.settings.entityDescriptions||t(102,c.settings.entityDescriptions={},c),t(102,c.settings.entityDescriptions[S]={className:S.replace(/\s+/g,"").replace(/[^a-zA-Z0-9]/g,""),description:M,isUserDefined:!0,source:"default",lastModified:new Date().toISOString()},c),await c.saveSettings();const q=c;t(102,c=null),t(102,c=q),t(3,v={...c.settings})}catch(q){console.error("Failed to update entity description:",q),t(8,D[S]=M,D)}}function $e(S){return h.hasDefaultPropertyDescription(S)}async function qe(S,M){const q=h.getDefaultPropertyDescription(M);if(q&&(c!=null&&c.settings))try{const te=_.find(oe=>oe.typeName===S);if(te){const oe=te.properties.findIndex(ce=>ce.name===M);if(oe!==-1){wt(_.indexOf(te),oe,"description",q),c.settings.propertyDescriptions||t(102,c.settings.propertyDescriptions={},c),c.settings.propertyDescriptions[S]||t(102,c.settings.propertyDescriptions[S]={},c),t(102,c.settings.propertyDescriptions[S][M]={description:q,fieldType:"str",isUserDefined:!0,source:"default",lastModified:new Date().toISOString()},c),await c.saveSettings();const ce=c;t(102,c=null),t(102,c=ce),t(3,v={...c.settings})}}}catch(te){console.error("Failed to update property description:",te)}}async function Re(){if(!B.trim()||!(c!=null&&c.settings))return;const S=R||`${B} relationship type`;c.settings.edgeTypes||t(102,c.settings.edgeTypes={},c),t(102,c.settings.edgeTypes[B]={className:B,description:S,properties:{},isUserDefined:!0,source:"user",lastModified:new Date().toISOString()},c),await c.saveSettings(),t(11,B=""),t(12,R=""),t(10,O=!1)}function tt(){t(11,B=""),t(12,R=""),t(10,O=!1)}async function ct(S){var te;if(!((te=c==null?void 0:c.settings)!=null&&te.edgeTypes))return;const M={...c.settings.edgeTypes};delete M[S],t(102,c.settings.edgeTypes=M,c),await c.saveSettings();const q=c;t(102,c=null),t(102,c=q),t(3,v={...c.settings}),new P.Notice(`Deleted edge type: ${S}`)}function We(S){var M;return((M=r[S])==null?void 0:M.description)||""}async function Ye(S){if(!(c!=null&&c.settings)||(c.settings.edgeTypes||t(102,c.settings.edgeTypes={},c),c.settings.edgeTypes[S]))return;const M=h.getAvailableDefaultEdgeTypes(),q=h.getDefaultEdgeTypeProperties(),te=M[S]||`${S} relationship type`,oe=q[S]||{};t(102,c.settings.edgeTypes[S]={className:S,description:te,properties:oe,isUserDefined:!0,source:"user",lastModified:new Date().toISOString()},c),await c.saveSettings()}async function pe(S){var M,q;!ye.trim()||!((q=(M=c==null?void 0:c.settings)==null?void 0:M.edgeTypes)!=null&&q[S])||(t(102,c.settings.edgeTypes[S].properties[ye]={description:ge||`${ye} property`,fieldType:ve,required:me},c),await c.saveSettings(),t(26,ye=""),t(28,ge=""),t(27,ve="str"),me=!1,t(25,Te=null))}async function Ae(S,M){var q,te,oe;(oe=(te=(q=c==null?void 0:c.settings)==null?void 0:q.edgeTypes)==null?void 0:te[S])!=null&&oe.properties&&(delete c.settings.edgeTypes[S].properties[M],await c.saveSettings())}async function Yt(S,M,q){var te,oe,ce,be;(be=(ce=(oe=(te=c==null?void 0:c.settings)==null?void 0:te.edgeTypes)==null?void 0:oe[S])==null?void 0:ce.properties)!=null&&be[M]&&(t(102,c.settings.edgeTypes[S].properties[M].description=q,c),await c.saveSettings())}async function Ct(S,M,q){const te=q.target;await Yt(S,M,te.value)}async function ht(S,M){var oe,ce;const te=M.target.value;(ce=(oe=c==null?void 0:c.settings)==null?void 0:oe.edgeTypes)!=null&&ce[S]&&(t(102,c.settings.edgeTypes[S]={...c.settings.edgeTypes[S],description:te,lastModified:new Date().toISOString()},c),await c.saveSettings())}async function le(){if(!ie||!se||Q.length===0||!(c!=null&&c.settings))return;const S={sourceEntity:ie,targetEntity:se,allowedEdges:[...Q],isUserDefined:!0,source:"user",lastModified:new Date().toISOString()};c.settings.edgeTypeMap||t(102,c.settings.edgeTypeMap=[],c),t(102,c.settings.edgeTypeMap=[...c.settings.edgeTypeMap,S],c),await c.saveSettings(),t(30,ie=""),t(31,se=""),t(32,Q=[]),t(29,Me=!1)}function st(){t(30,ie=""),t(31,se=""),t(32,Q=[]),t(29,Me=!1)}async function re(S){c!=null&&c.settings&&(t(102,c.settings.edgeTypeMap=c.settings.edgeTypeMap.filter((M,q)=>q!==S),c),await c.saveSettings())}function dt(S){Q.includes(S)?t(32,Q=Q.filter(M=>M!==S)):t(32,Q=[...Q,S])}async function Pt(S,M,q){if(!(c!=null&&c.settings)||(c.settings.edgeTypeMap||t(102,c.settings.edgeTypeMap=[],c),c.settings.edgeTypeMap.some(ce=>ce.sourceEntity===S&&ce.targetEntity===M)))return;const oe={sourceEntity:S,targetEntity:M,allowedEdges:[...q],isUserDefined:!0,source:"user",lastModified:new Date().toISOString()};t(102,c.settings.edgeTypeMap=[...c.settings.edgeTypeMap,oe],c),await c.saveSettings()}async function ee(){if(!(!(c!=null&&c.settings)||Object.keys(g).length===0))try{for(const M of Object.keys(g))await Ye(M);const S=c;t(102,c=null),t(102,c=S),t(3,v={...c.settings})}catch(S){console.error("Failed to add all unused edge types:",S)}}async function he(){if(!(!(c!=null&&c.settings)||m.length===0))try{for(const M of m)await Pt(M.sourceEntity,M.targetEntity,M.allowedEdges);const S=c;t(102,c=null),t(102,c=S),t(3,v={...c.settings})}catch(S){console.error("Failed to add all suggested mappings:",S)}}function Se(S){var q;if(!((q=c==null?void 0:c.settings)!=null&&q.edgeTypeMap))return;t(33,ue=S);const M=c.settings.edgeTypeMap[S];t(34,ze=M.sourceEntity),t(35,Be=M.targetEntity),t(36,de=[...M.allowedEdges])}async function rt(){var S;ue===null||!ze||!Be||de.length===0||!((S=c==null?void 0:c.settings)!=null&&S.edgeTypeMap)||(t(102,c.settings.edgeTypeMap[ue]={...c.settings.edgeTypeMap[ue],sourceEntity:ze,targetEntity:Be,allowedEdges:[...de],lastModified:new Date().toISOString()},c),await c.saveSettings(),ot())}function ot(){t(33,ue=null),t(34,ze=""),t(35,Be=""),t(36,de=[])}function at(S){de.includes(S)?t(36,de=de.filter(M=>M!==S)):t(36,de=[...de,S])}async function mt(S,M){var q;try{!S||!M?t(13,F=await b.suggestEdgeTypes("Entity","Entity")):t(13,F=await b.suggestEdgeTypes(S,M)),t(14,L=!0),new P.Notice(`Generated ${F.length} edge type suggestions`)}catch(te){(q=c==null?void 0:c.logger)==null||q.error("Failed to generate edge type suggestions",te),new P.Notice("Failed to generate edge type suggestions")}}async function Dt(S){var M;try{if(c.settings.edgeTypes[S.className]){new P.Notice(`Edge type "${S.className}" already exists`);return}t(102,c.settings.edgeTypes[S.className]={className:S.className,description:S.description,properties:{},isUserDefined:!1,source:"llm",lastModified:new Date().toISOString()},c),await c.saveSettings(),t(3,v={...c.settings}),t(13,F=F.filter(q=>q.className!==S.className)),new P.Notice(`Added edge type: ${S.className}`)}catch(q){(M=c==null?void 0:c.logger)==null||M.error("Failed to accept edge type suggestion",q),new P.Notice("Failed to add edge type")}}async function vt(){var S;try{const M=Object.keys(v.entityDescriptions||{});if(M.length===0){new P.Notice("No entity types found. Create entities first.");return}t(23,J=await b.suggestEdgeMappings(M)),t(24,fe=!0),new P.Notice(`Generated ${J.length} edge mapping suggestions`)}catch(M){(S=c==null?void 0:c.logger)==null||S.error("Failed to generate edge mapping suggestions",M),new P.Notice("Failed to generate mapping suggestions")}}async function St(S){var M,q;try{if((M=c.settings.edgeTypeMap)==null?void 0:M.find(oe=>oe.sourceEntity===S.source&&oe.targetEntity===S.target)){new P.Notice(`Mapping ${S.source}  ${S.target} already exists`);return}c.settings.edgeTypeMap||t(102,c.settings.edgeTypeMap=[],c),c.settings.edgeTypeMap.push({sourceEntity:S.source,targetEntity:S.target,allowedEdges:S.edgeTypes,isUserDefined:!1,source:"llm",lastModified:new Date().toISOString()}),await c.saveSettings(),t(3,v={...c.settings}),t(23,J=J.filter(oe=>!(oe.source===S.source&&oe.target===S.target))),new P.Notice(`Added mapping: ${S.source}  ${S.target}`)}catch(te){(q=c==null?void 0:c.logger)==null||q.error("Failed to accept edge mapping suggestion",te),new P.Notice("Failed to add mapping")}}let Lt;ci(async()=>{await qt(),Lt=setInterval(async()=>{var S,M,q;if(c!=null&&c.settings)try{const te=JSON.stringify(c.settings);if(await c.loadSettings(),JSON.stringify(c.settings)!==te){try{(q=(M=(S=c==null?void 0:c.logger)!=null?S:console).info)==null||q.call(M,"Detected manual data.json changes, triggering UI refresh")}catch(be){}const ce=c;t(102,c=null),t(102,c=ce),t(3,v={...c.settings}),await qt()}}catch(te){console.error("Error during auto-refresh:",te)}},2e3)}),uo(()=>{Lt&&clearInterval(Lt)});async function qt(){t(4,C=!0);try{t(0,_=await h.discoverAllSchemas()),await On(),await nt()}catch(S){console.error("Error discovering schemas:",S)}finally{t(4,C=!1)}}function xt(S,M){if(!(v!=null&&v.propertyMappings))return M;const q=v.propertyMappings[S];return q&&q[M]||M}function An(S,M){var te;if(!((te=v==null?void 0:v.propertyMappings)!=null&&te[S]))return M;const q=v.propertyMappings[S];for(const[oe,ce]of Object.entries(q))if(ce===M)return oe;return M}function gi(S,M){var te;if(!((te=v==null?void 0:v.propertyMappings)!=null&&te[S]))return!1;const q=v.propertyMappings[S];for(const[oe,ce]of Object.entries(q))if(ce===M&&oe!==M)return!0;return!1}async function hn(S,M,q){var oe;if(!(c!=null&&c.settings))return;c.settings.propertySelections||t(102,c.settings.propertySelections={},c),c.settings.propertySelections[S]||t(102,c.settings.propertySelections[S]={},c);const te=Object.keys(((oe=c.settings.propertyMappings)==null?void 0:oe[S])||{}).find(ce=>c.settings.propertyMappings[S][ce]===M);te&&te!==M&&(delete c.settings.propertySelections[S][te],console.log(`Cleaned up duplicate property: removed ${S}.${te}, kept ${S}.${M}`)),t(102,c.settings.propertySelections[S][M]=q,c),await c.saveSettings(),t(3,v={...c.settings})}async function On(){if(!(c!=null&&c.settings))return;c.settings.propertySelections||t(102,c.settings.propertySelections={},c);let S=!1;_.forEach(M=>{c.settings.propertySelections[M.typeName]||(t(102,c.settings.propertySelections[M.typeName]={},c),S=!0),M.properties.forEach(q=>{const te=xt(M.typeName,q.name);te in c.settings.propertySelections[M.typeName]||(t(102,c.settings.propertySelections[M.typeName][te]=!1,c),S=!0)})}),S&&await c.saveSettings()}async function nt(){await h.generatePydanticModels(_)}function wt(S,M,q,te){t(0,_[S].properties[M][q]=te,_),t(0,_=[..._]),nt()}async function fi(S,M,q){const te=q.target,oe=_[S],ce=oe.properties[M],be=xt(oe.typeName,ce.name);await hn(oe.typeName,be,te.checked),wt(S,M,"enabled",te.checked)}async function hi(S,M,q){const te=q.target,oe=_[S],ce=oe.properties[M];wt(S,M,"description",te.value),await go(oe.typeName,ce.name,te.value)}async function go(S,M,q){c!=null&&c.settings&&(c.settings.propertyDescriptions||t(102,c.settings.propertyDescriptions={},c),c.settings.propertyDescriptions[S]||t(102,c.settings.propertyDescriptions[S]={},c),t(102,c.settings.propertyDescriptions[S][M]={description:q,fieldType:"str",isUserDefined:!0,source:"user",lastModified:new Date().toISOString()},c),await c.saveSettings())}function fo(S,M,q){var oe,ce,be,Ne;const te=(Ne=(be=(ce=(oe=c==null?void 0:c.settings)==null?void 0:oe.propertyDescriptions)==null?void 0:ce[S])==null?void 0:be[M])==null?void 0:Ne.description;return te||q||`${M.replace(/_/g," ")} property for ${S} entities`}async function In(S,M){const q=_[S],te=q.properties[M],oe=te.name,ce=te.suggestedName;await h.savePropertyMapping(q.typeName,oe,ce),wt(S,M,"name",ce),wt(S,M,"namingIssues",[]),wt(S,M,"complianceStatus","valid")}function ho(){const S=_.flatMap(be=>be.properties),M=S.length,q=S.filter(be=>be.complianceStatus==="valid").length,te=S.filter(be=>be.complianceStatus==="warning").length,oe=S.filter(be=>be.complianceStatus==="protected").length,ce=M>0?Math.round(q/M*100):100;return{total:M,valid:q,warnings:te,protectedCount:oe,score:ce}}async function mo(){for(let S=0;S<_.length;S++){const M=_[S];for(let q=0;q<M.properties.length;q++){const te=M.properties[q];te.complianceStatus==="warning"&&te.suggestedName!==te.name&&await In(S,q)}}}function yo(S){return!!i[S]}async function Ln(S){if(c!=null&&c.settings)try{if(yo(S)){const M={...c.settings.entityDescriptions};delete M[S],t(102,c.settings.entityDescriptions=M,c)}else{const M=h.getDefaultEntityDescription(S)||`Custom ${S} entity.`;t(102,c.settings.entityDescriptions={...c.settings.entityDescriptions,[S]:{className:S.replace(/\s+/g,"").replace(/[^a-zA-Z0-9]/g,""),description:M,isUserDefined:!0,source:"user",lastModified:new Date().toISOString()}},c)}await c.saveSettings()}catch(M){console.error(`Failed to toggle entity definition for ${S}:`,M)}}async function bo(S="new_only"){if(c!=null&&c.settings)try{const M={...c.settings.entityDescriptions};let q=0;_.forEach(oe=>{const ce=oe.typeName,be=M[ce],Ne=h.getDefaultEntityDescription(ce);Ne&&(S==="new_only"&&(be!=null&&be.description)||S==="skip_user"&&(be==null?void 0:be.source)==="user"||(M[ce]={className:ce.replace(/\s+/g,"").replace(/[^a-zA-Z0-9]/g,""),description:Ne,isUserDefined:!1,source:"default",lastModified:new Date().toISOString()},q++))}),t(102,c.settings.entityDescriptions=M,c),await c.saveSettings();const te=c;t(102,c=null),t(102,c=te),t(3,v={...c.settings}),new P.Notice(`Loaded ${q} default entity descriptions`)}catch(M){console.error("Failed to load all default entity descriptions:",M)}}async function vo(S="new_only"){if(c!=null&&c.settings)try{const M={...c.settings.propertyDescriptions};let q=0;_.forEach(oe=>{const ce=oe.typeName;M[ce]||(M[ce]={}),oe.properties.forEach(be=>{const Ne=be.name;if(h.hasDefaultPropertyDescription(Ne)){const it=M[ce][Ne],Je=h.getDefaultPropertyDescription(Ne);if(!Je||S==="new_only"&&(it!=null&&it.description)||S==="skip_user"&&(it==null?void 0:it.source)==="user")return;M[ce][Ne]={description:Je,fieldType:"str",isUserDefined:!1,source:"default",lastModified:new Date().toISOString()},q++}})}),t(102,c.settings.propertyDescriptions=M,c),await c.saveSettings();const te=c;t(102,c=null),t(102,c=te),t(3,v={...c.settings}),new P.Notice(`Loaded ${q} default property descriptions`)}catch(M){console.error("Failed to load all default property descriptions:",M)}}async function mi(S){var M;t(17,W=S);try{const q=await b.generateEntityDescription(S);t(8,D[S]=q,D),t(9,A[S]="llm",A),c.settings.entityDescriptions||t(102,c.settings.entityDescriptions={},c),t(102,c.settings.entityDescriptions[S]={className:S.replace(/\s+/g,"").replace(/[^a-zA-Z0-9]/g,""),description:q,isUserDefined:!0,source:"llm",lastModified:new Date().toISOString()},c),await c.saveSettings();const te=c;t(102,c=null),t(102,c=te),t(3,v={...c.settings}),new P.Notice("Entity description generated")}catch(q){(M=c==null?void 0:c.logger)==null||M.error("Failed to generate entity description",q),new P.Notice("Failed to generate description")}finally{t(17,W="")}}async function yi(S,M){var q;t(18,K=`${S}.${M}`);try{const te=await b.generatePropertyDescription(S,M),oe=_.find(be=>be.typeName===S);if(oe){const be=oe.properties.findIndex(Ne=>Ne.name===M);be!==-1&&wt(_.indexOf(oe),be,"description",te)}c.settings.propertyDescriptions||t(102,c.settings.propertyDescriptions={},c),c.settings.propertyDescriptions[S]||t(102,c.settings.propertyDescriptions[S]={},c),t(102,c.settings.propertyDescriptions[S][M]={description:te,fieldType:"str",isUserDefined:!0,source:"llm",lastModified:new Date().toISOString()},c),await c.saveSettings();const ce=c;t(102,c=null),t(102,c=ce),t(3,v={...c.settings}),new P.Notice("Property description generated")}catch(te){(q=c==null?void 0:c.logger)==null||q.error("Failed to generate property description",te),new P.Notice("Failed to generate description")}finally{t(18,K="")}}async function bi(S,M){var q,te,oe,ce;t(19,H=`${S}.${M}`);try{const be=await b.generatePropertyDescription(S,M);if(!((oe=(te=(q=c.settings.edgeTypes)==null?void 0:q[S])==null?void 0:te.properties)!=null&&oe[M])){new P.Notice("Edge property not found");return}t(102,c.settings.edgeTypes[S].properties[M].description=be,c),await c.saveSettings();const Ne=c;t(102,c=null),t(102,c=Ne),t(3,v={...c.settings}),new P.Notice("Edge property description generated")}catch(be){(ce=c==null?void 0:c.logger)==null||ce.error("Failed to generate edge property description",be),new P.Notice("Failed to generate description")}finally{t(19,H="")}}async function _o(){var S;try{t(15,V=!0);let M=0;const q={...c.settings.edgeTypes};for(const oe of Object.keys(q||{})){const ce=q[oe];if(ce.properties){const be={...ce.properties};for(const Ne of Object.keys(be)){const it=await b.generatePropertyDescription(oe,Ne);be[Ne]={...be[Ne],description:it},M++}q[oe]={...ce,properties:be}}}t(102,c.settings.edgeTypes=q,c),await c.saveSettings();const te=c;t(102,c=null),t(102,c=te),t(3,v={...c.settings}),new P.Notice(`Generated ${M} edge property descriptions`)}catch(M){(S=c==null?void 0:c.logger)==null||S.error("Failed to generate edge property descriptions",M),new P.Notice("Failed to generate edge property descriptions")}finally{t(15,V=!1)}}function zt(S){t(21,X=S),t(20,U=!0)}function wo(){t(20,U=!1),t(21,X=null),t(22,I="skip_user")}async function So(){t(20,U=!1),X==="entities"?await xo(I):X==="properties"?await ko(I):X==="complete"?await Eo():X==="load_default_entities"?await bo(I):X==="load_default_properties"&&await vo(I),t(21,X=null),t(22,I="skip_user")}async function xo(S="skip_user"){var M;try{t(15,V=!0);let q=0;const te={...c.settings.entityDescriptions};for(const ce of _){const be=te[ce.typeName];if(S==="new_only"&&(be!=null&&be.description)||S==="skip_user"&&(be==null?void 0:be.source)==="user")continue;const Ne=await b.generateEntityDescription(ce.typeName);te[ce.typeName]={className:ce.typeName.replace(/\s+/g,"").replace(/[^a-zA-Z0-9]/g,""),description:Ne,isUserDefined:!0,source:"llm",lastModified:new Date().toISOString()},q++}t(102,c.settings.entityDescriptions=te,c),await c.saveSettings();const oe=c;t(102,c=null),t(102,c=oe),t(3,v={...c.settings}),new P.Notice(`Generated ${q} entity descriptions`)}catch(q){(M=c==null?void 0:c.logger)==null||M.error("Failed to generate entity descriptions",q),new P.Notice("Failed to generate entity descriptions")}finally{t(15,V=!1)}}async function ko(S="skip_user"){var M,q;try{t(15,V=!0);let te=0;const oe=Object.keys(c.settings.entityDescriptions||{});if(oe.length===0){new P.Notice("No entities are enabled. Enable entities first.");return}const ce={...c.settings.propertyDescriptions};for(const Ne of _)if(oe.includes(Ne.typeName)){ce[Ne.typeName]||(ce[Ne.typeName]={});for(const it of Ne.properties)if(!it.isProtected){const Je=(M=ce[Ne.typeName])==null?void 0:M[it.name];if(S==="new_only"&&(Je!=null&&Je.description)||S==="skip_user"&&(Je==null?void 0:Je.source)==="user")continue;const _t=await b.generatePropertyDescription(Ne.typeName,it.name);ce[Ne.typeName][it.name]={description:_t,fieldType:"str",isUserDefined:!0,source:"llm",lastModified:new Date().toISOString()};const Tt=Ne.properties.findIndex(mn=>mn.name===it.name);Tt!==-1&&wt(_.indexOf(Ne),Tt,"description",_t),te++}}t(102,c.settings.propertyDescriptions=ce,c),await c.saveSettings();const be=c;t(102,c=null),t(102,c=be),t(3,v={...c.settings}),new P.Notice(`Generated ${te} property descriptions across ${oe.length} enabled entities`)}catch(te){(q=c==null?void 0:c.logger)==null||q.error("Failed to generate property descriptions",te),new P.Notice("Failed to generate property descriptions")}finally{t(15,V=!1)}}async function Eo(){var S;try{t(15,V=!0),t(16,Y={current:0,total:1,step:"Initializing..."});const M=Object.keys(v.entityDescriptions||{});if(M.length===0){new P.Notice("No entities found. Define entities first."),t(15,V=!1);return}t(16,Y={current:1,total:5,step:"Generating ontology..."});const q=await b.generateCompleteOntology(M);let te=0;const oe={...c.settings.entityDescriptions},ce={...c.settings.propertyDescriptions},be={...c.settings.edgeTypes},Ne=[...c.settings.edgeTypeMap||[]];t(16,Y={current:2,total:5,step:"Processing entities..."});for(const[Je,_t]of Object.entries(q.entities))oe[Je]||(oe[Je]={className:Je,description:"",isUserDefined:!1,source:"llm",lastModified:new Date().toISOString()}),oe[Je]={...oe[Je],description:_t.description,source:"llm",lastModified:new Date().toISOString()},te++;t(16,Y={current:3,total:5,step:"Processing properties..."});for(const[Je,_t]of Object.entries(q.properties)){ce[Je]||(ce[Je]={});for(const[Tt,mn]of Object.entries(_t))ce[Je][Tt]={description:mn.description,fieldType:mn.fieldType||"str",isUserDefined:!1,source:"llm",lastModified:new Date().toISOString()},te++}t(16,Y={current:4,total:5,step:"Processing edge types..."});for(const[Je,_t]of Object.entries(q.edgeTypes))be[Je]||(be[Je]={className:Je,description:_t.description,properties:{},isUserDefined:!1,source:"llm",lastModified:new Date().toISOString()},te++);t(16,Y={current:5,total:5,step:"Processing edge mappings..."});for(const Je of q.mappings)Ne.find(Tt=>Tt.sourceEntity===Je.source&&Tt.targetEntity===Je.target)||(Ne.push({sourceEntity:Je.source,targetEntity:Je.target,allowedEdges:Je.edgeTypes,isUserDefined:!1,source:"llm",lastModified:new Date().toISOString()}),te++);t(102,c.settings.entityDescriptions=oe,c),t(102,c.settings.propertyDescriptions=ce,c),t(102,c.settings.edgeTypes=be,c),t(102,c.settings.edgeTypeMap=Ne,c),await c.saveSettings();const it=c;t(102,c=null),t(102,c=it),t(3,v={...c.settings}),new P.Notice(`Complete ontology generated! Updated ${te} items.`)}catch(M){(S=c==null?void 0:c.logger)==null||S.error("Failed to generate complete ontology",M),new P.Notice("Failed to generate complete ontology")}finally{t(15,V=!1),t(16,Y={current:0,total:0,step:""})}}async function Co(){if(c!=null&&c.settings)try{c.settings.propertySelections||t(102,c.settings.propertySelections={},c);const S={...c.settings.propertySelections};_.forEach(q=>{const te=q.typeName;S[te]||(S[te]={}),q.properties.forEach(oe=>{var it,Je;const ce=oe.name,be=(it=c.settings.globallyIgnoredFields)==null?void 0:it.includes(ce),Ne=xt(te,ce);if(!oe.isProtected&&!be&&h.hasDefaultPropertyDescription(ce)){const _t=Object.keys(((Je=c.settings.propertyMappings)==null?void 0:Je[te])||{}).find(Tt=>c.settings.propertyMappings[te][Tt]===Ne);_t&&_t!==Ne&&delete S[te][_t],S[te][Ne]=!0}})}),t(102,c.settings.propertySelections=S,c),await c.saveSettings();const M=c;t(102,c=null),t(102,c=M),t(3,v={...c.settings})}catch(S){console.error("Failed to enable default properties:",S)}}async function vi(S,M){if(c!=null&&c.settings)try{if(c.settings.propertyDescriptions||t(102,c.settings.propertyDescriptions={},c),c.settings.propertyDescriptions[S]||t(102,c.settings.propertyDescriptions[S]={},c),Po(S,M)){const q={...c.settings.propertyDescriptions};delete q[S][M],t(102,c.settings.propertyDescriptions=q,c)}else{const te=h.getDefaultPropertyDescription(M)||`${M.replace(/_/g," ")} property for ${S} entities`;t(102,c.settings.propertyDescriptions={...c.settings.propertyDescriptions,[S]:{...c.settings.propertyDescriptions[S],[M]:{description:te,fieldType:"str",isUserDefined:!0,source:"user",lastModified:new Date().toISOString()}}},c)}await c.saveSettings()}catch(q){console.error(`Failed to toggle property definition for ${S}.${M}:`,q)}}function Po(S,M){var q,te;return!!((te=(q=s[S])==null?void 0:q[M])!=null&&te.description)}async function _i(S){if(!(c!=null&&c.settings))return;c.settings.propertySelections||t(102,c.settings.propertySelections={},c),c.settings.propertySelections[S]||t(102,c.settings.propertySelections[S]={},c);const M=_.find(q=>q.typeName===S);M&&(M.properties.forEach(q=>{var oe,ce;const te=(oe=c.settings.globallyIgnoredFields)==null?void 0:oe.includes(q.name);if(!q.isProtected&&!te){const be=xt(S,q.name),Ne=Object.keys(((ce=c.settings.propertyMappings)==null?void 0:ce[S])||{}).find(it=>c.settings.propertyMappings[S][it]===be);Ne&&Ne!==be&&delete c.settings.propertySelections[S][Ne],t(102,c.settings.propertySelections[S][be]=!0,c)}}),await c.saveSettings(),t(3,v={...c.settings}))}async function wi(S){if(!(c!=null&&c.settings))return;c.settings.propertySelections||t(102,c.settings.propertySelections={},c),c.settings.propertySelections[S]||t(102,c.settings.propertySelections[S]={},c);const M=_.find(q=>q.typeName===S);M&&(M.properties.forEach(q=>{var ce;const te=xt(S,q.name),oe=Object.keys(((ce=c.settings.propertyMappings)==null?void 0:ce[S])||{}).find(be=>c.settings.propertyMappings[S][be]===te);oe&&oe!==te&&delete c.settings.propertySelections[S][oe],t(102,c.settings.propertySelections[S][te]=!1,c)}),await c.saveSettings(),t(3,v={...c.settings}))}const Do=[[]],To=()=>x("entities"),Mo=()=>x("properties"),No=()=>x("edges"),Ao=()=>x("mappings"),Oo=()=>zt("entities"),Io=()=>zt("properties"),Lo=()=>zt("complete"),Ro=()=>zt("load_default_entities"),Fo=()=>Oe("BaseEntity"),$o=S=>Oe(S.typeName),Uo=S=>Ln(S.typeName),jo=S=>Ve(S.typeName);function zo(S){D[S.typeName]=this.value,t(8,D)}const Bo=S=>t(9,A[S.typeName]="user",A),Vo=S=>Le(S.typeName),Go=S=>mi(S.typeName),Yo=S=>Xe(S.typeName),qo=()=>zt("properties"),Wo=()=>zt("load_default_properties"),Ko=()=>_e("BaseEntity"),Ho=S=>Ln(S.typeName),Jo=S=>_e(S.typeName),Qo=S=>_i(S.typeName),Zo=S=>wi(S.typeName),Xo=(S,M,q)=>fi(S,M,q),ea=(S,M)=>vi(S.typeName,(M==null?void 0:M.name)||""),ta=(S,M,q)=>hi(S,M,q),na=(S,M)=>qe(S.typeName,(M==null?void 0:M.name)||""),ia=(S,M)=>yi(S.typeName,(M==null?void 0:M.name)||""),sa=(S,M)=>In(S,M),ra=(S,M)=>{var ce,be,Ne,it;const q=(ce=v==null?void 0:v.globallyIgnoredFields)==null?void 0:ce.includes(M.name),te=xt(S.typeName,M.name),oe=(it=(Ne=(be=v==null?void 0:v.propertySelections)==null?void 0:be[S.typeName])==null?void 0:Ne[te])!=null?it:!1;return!M.isProtected&&!q&&oe},oa=()=>mt(),aa=S=>Dt(S),la=S=>_e(`edge-${S}`),ca=S=>ct(S),da=(S,M)=>ht(S,M),ua=S=>t(25,Te=S),pa=(S,M,q)=>Ct(S,M,q),ga=(S,M)=>Ae(S,M),fa=(S,M)=>bi(S,M);function ha(){ye=this.value,t(26,ye)}function ma(){ve=on(this),t(27,ve)}function ya(){ge=this.value,t(28,ge)}const ba=S=>pe(S),va=()=>t(25,Te=null),_a=()=>Ye("WorksFor"),wa=()=>Ye("Uses"),Sa=()=>Ye("Creates"),xa=()=>Ye("MemberOf"),ka=()=>Ye("Manages"),Ea=()=>Ye("Contains"),Ca=S=>Ye(S);function Pa(){B=this.value,t(11,B)}function Da(){R=this.value,t(12,R)}const Ta=()=>t(10,O=!0),Ma=()=>vt(),Na=async()=>{for(const S of J)await St(S)},Aa=S=>St(S);function Oa(){ze=on(this),t(34,ze),t(41,p),t(104,d),t(0,_)}function Ia(){Be=on(this),t(35,Be),t(41,p),t(104,d),t(0,_)}const La=S=>at(S),Ra=S=>Se(S),Fa=S=>re(S),$a=()=>Pt("Person","Technology",["Uses","RelatesTo"]),Ua=()=>Pt("Person","Project",["WorksOn","Manages","RelatesTo"]),ja=()=>Pt("Entity","Entity",["RelatesTo"]),za=()=>Pt("Project","Technology",["Uses","DependsOn","RelatesTo"]),Ba=S=>Pt(S.sourceEntity,S.targetEntity,S.allowedEdges);function Va(){ie=on(this),t(30,ie),t(41,p),t(104,d),t(0,_)}function Ga(){se=on(this),t(31,se),t(41,p),t(104,d),t(0,_)}const Ya=S=>dt(S),qa=()=>t(29,Me=!0);function Wa(){I=this.__value,t(22,I)}function Ka(){I=this.__value,t(22,I)}function Ha(){I=this.__value,t(22,I)}return n.$$set=S=>{"schemaService"in S&&t(100,h=S.schemaService),"llmService"in S&&t(101,b=S.llmService)},n.$$.update=()=>{var S,M,q,te,oe;if(n.$$.dirty[3]&1536&&typeof window.app!="undefined"&&(t(102,c=window.app.plugins.plugins["megamem-mcp"]),t(3,v=(c==null?void 0:c.settings)||{}),c&&c.settings&&!w)){const ce=c.syncRegistryService,be=c.syncStatusManager,Ne=c.vaultRegistryService;t(103,w=new ao(c,c.settings,ce,be,Ne))}n.$$.dirty[3]&512&&t(38,i=((S=c==null?void 0:c.settings)==null?void 0:S.entityDescriptions)||{}),n.$$.dirty[3]&512&&t(37,s=((M=c==null?void 0:c.settings)==null?void 0:M.propertyDescriptions)||{}),n.$$.dirty[3]&512&&t(1,r=((q=c==null?void 0:c.settings)==null?void 0:q.edgeTypes)||{}),n.$$.dirty[3]&512&&t(2,o=((te=c==null?void 0:c.settings)==null?void 0:te.edgeTypeMap)||[]),n.$$.dirty[3]&512&&(oe=c==null?void 0:c.settings)!=null&&oe.llmSchemaSettings,n.$$.dirty[0]&2&&t(105,a=r||{}),n.$$.dirty[3]&4096&&t(42,l=Object.keys(a)),n.$$.dirty[0]&1&&t(104,d=_.map(ce=>ce.typeName)),n.$$.dirty[3]&2048&&t(41,p=[...d,"Entity"]),n.$$.dirty[3]&4224&&t(40,g=h.getUnusedDefaultEdgeTypes(a)),n.$$.dirty[0]&4|n.$$.dirty[3]&2176&&t(39,m=h.getSuggestedDefaultMappings(d,o))},[_,r,o,v,C,N,k,T,D,A,O,B,R,F,L,V,Y,W,K,H,U,X,I,J,fe,Te,ye,ve,ge,Me,ie,se,Q,ue,ze,Be,de,s,i,m,g,p,l,x,_e,Oe,Ve,Xe,Ze,Fe,He,Le,$e,qe,Re,tt,ct,We,Ye,pe,Ae,Ct,ht,le,st,re,dt,Pt,ee,he,Se,rt,ot,at,mt,Dt,vt,St,qt,xt,An,gi,fi,hi,fo,In,ho,mo,Ln,mi,yi,bi,_o,zt,wo,So,Co,vi,_i,wi,h,b,c,w,d,a,To,Mo,No,Ao,Oo,Io,Lo,Ro,Fo,$o,Uo,jo,zo,Bo,Vo,Go,Yo,qo,Wo,Ko,Ho,Jo,Qo,Zo,Xo,ea,ta,na,ia,sa,ra,oa,aa,la,ca,da,ua,pa,ga,fa,ha,ma,ya,ba,va,_a,wa,Sa,xa,ka,Ea,Ca,Pa,Da,Ta,Ma,Na,Aa,Oa,Ia,La,Ra,Fa,$a,Ua,ja,za,Ba,Va,Ga,Ya,qa,Wa,Do,Ka,Ha]}class Dp extends pi{constructor(e){super(),ui(this,e,Pp,Ep,ai,{schemaService:100,llmService:101},null,[-1,-1,-1,-1,-1,-1,-1,-1,-1])}}const ln="schema-manager";class Tp extends P.ItemView{constructor(e,t,i){super(e),this.schemaService=t,this.plugin=i}getViewType(){return ln}getDisplayText(){return"Schema Manager"}getIcon(){return"database"}async onOpen(){this.component=new Dp({target:this.contentEl,props:{schemaService:this.schemaService,llmService:this.plugin.llmService}})}async onClose(){this.component&&this.component.$destroy()}}function Qs(n,e,t){const i=n.slice();return i[85]=e[t],i}function Zs(n,e,t){const i=n.slice();return i[89]=e[t],i[90]=e,i[91]=t,i}function Xs(n,e,t){const i=n.slice();return i[89]=e[t],i}function er(n,e,t){const i=n.slice();return i[94]=e[t],i}function tr(n,e,t){const i=n.slice();return i[94]=e[t],i}function nr(n,e,t){const i=n.slice();return i[99]=e[t],i}function ir(n,e,t){const i=n.slice();return i[99]=e[t],i}function sr(n,e,t){const i=n.slice();return i[104]=e[t],i}function rr(n,e,t){const i=n.slice();return i[104]=e[t],i}function or(n,e,t){const i=n.slice();return i[82]=e[t],i}function ar(n){let e,t,i,s,r,o,a,l,d,p,g;function m(c,v){return c[17]?Np:Mp}let h=m(n),b=h(n);return{c(){e=y("div"),t=y("div"),i=y("h3"),i.textContent="Sync in Progress...",s=E(),r=y("button"),r.innerHTML='<span class="text-xl"></span>',o=E(),b.c(),a=E(),l=y("div"),d=y("button"),d.textContent="Cancel",f(i,"class","text-lg font-semibold text-[var(--text-default)]"),f(r,"class","text-[var(--text-muted)] hover:text-[var(--text-error)] transition-colors"),f(r,"aria-label","Cancel sync"),f(t,"class","flex items-center justify-between"),f(d,"class","px-4 py-2 text-sm bg-[var(--background-secondary)] text-[var(--text-default)] border border-[var(--background-modifier-border)] rounded-md hover:bg-[var(--background-modifier-hover)] hover:opacity-90 transition-all"),f(l,"class","flex justify-end"),f(e,"class","bg-[var(--background-primary)] border-b border-[var(--background-modifier-border)] p-3 space-y-3 animate-fade-in-up")},m(c,v){z(c,e,v),u(e,t),u(t,i),u(t,s),u(t,r),u(e,o),b.m(e,null),u(e,a),u(e,l),u(l,d),p||(g=[ne(r,"click",n[23]),ne(d,"click",n[23])],p=!0)},p(c,v){h===(h=m(c))&&b?b.p(c,v):(b.d(1),b=h(c),b&&(b.c(),b.m(e,a)))},d(c){c&&j(e),b.d(),p=!1,Qe(g)}}}function Mp(n){let e;return{c(){e=y("div"),e.textContent="Preparing to sync...",f(e,"class","text-sm text-[var(--text-muted)]")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function Np(n){let e,t=n[17].message+"",i,s,r,o,a,l,d,p=Math.round(n[17].percentage/2)*2+"",g,m,h=n[17].current+"",b,c,v=n[17].total+"",w,_,C,x,N;return{c(){e=y("div"),i=$(t),s=E(),r=y("div"),o=y("div"),a=E(),l=y("div"),d=y("span"),g=$(p),m=$("% ("),b=$(h),c=$("/"),w=$(v),_=$(")"),C=E(),x=y("span"),N=$(n[19]),f(e,"class","text-sm text-[var(--text-muted)]"),f(o,"class","bg-gradient-to-r from-[var(--interactive-accent)] to-[var(--interactive-accent-hover)] h-2.5 rounded-full transition-all duration-300"),Mn(o,"width",Math.round(n[17].percentage/2)*2+"%"),f(r,"class","w-full bg-[var(--background-secondary)] rounded-full h-2.5"),f(x,"class","text-[var(--text-muted)]"),f(l,"class","flex items-center justify-between text-xs text-[var(--text-muted)]")},m(k,T){z(k,e,T),u(e,i),z(k,s,T),z(k,r,T),u(r,o),z(k,a,T),z(k,l,T),u(l,d),u(d,g),u(d,m),u(d,b),u(d,c),u(d,w),u(d,_),u(l,C),u(l,x),u(x,N)},p(k,T){T[0]&131072&&t!==(t=k[17].message+"")&&ae(i,t),T[0]&131072&&Mn(o,"width",Math.round(k[17].percentage/2)*2+"%"),T[0]&131072&&p!==(p=Math.round(k[17].percentage/2)*2+"")&&ae(g,p),T[0]&131072&&h!==(h=k[17].current+"")&&ae(b,h),T[0]&131072&&v!==(v=k[17].total+"")&&ae(w,v),T[0]&524288&&ae(N,k[19])},d(k){k&&(j(e),j(s),j(r),j(a),j(l))}}}function Ap(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x,N,k,T,D,A,O,B,R,F,L,V,Y,W,K,H,U,X,I,J,fe,Te,ye,ve,ge,me,Me,ie,se,Q,ue,ze,Be,de,_e,Oe,Ve,Xe=xe(n[5]),Ze=[];for(let le=0;le<Xe.length;le+=1)Ze[le]=cr(rr(n,Xe,le));let Fe=n[14].size>0&&dr(n),He=xe(n[6]),Le=[];for(let le=0;le<He.length;le+=1)Le[le]=gr(ir(n,He,le));let $e=n[15].size>0&&fr(n),qe=xe(n[7]),Re=[];for(let le=0;le<qe.length;le+=1)Re[le]=yr(tr(n,qe,le));let tt=n[16].size>0&&br(n),ct=xe(n[13]),We=[];for(let le=0;le<ct.length;le+=1)We[le]=wr(Xs(n,ct,le));let Ye=xe(Object.keys(n[12])),pe=[];for(let le=0;le<Ye.length;le+=1)pe[le]=Sr(Zs(n,Ye,le));let Ae=n[8].length>0&&xr(n);function Yt(le,st){return le[10]?Rp:le[8].length===0?Lp:Ip}let Ct=Yt(n),ht=Ct(n);return{c(){e=y("div"),t=y("h3"),t.textContent="Advanced Note Selection",i=E(),s=y("div"),r=y("h4"),r.textContent="Filters",o=E(),a=y("div"),l=y("div"),l.innerHTML='<span class="text-sm font-medium text-[var(--text-muted)]">Note Types</span>',d=E(),p=y("select"),g=y("option"),g.textContent="Select type...";for(let le=0;le<Ze.length;le+=1)Ze[le].c();m=E(),Fe&&Fe.c(),h=E(),b=y("div"),c=y("div"),c.innerHTML='<span class="text-sm font-medium text-[var(--text-muted)]">Tags</span>',v=E(),w=y("select"),_=y("option"),_.textContent="Select tag...";for(let le=0;le<Le.length;le+=1)Le[le].c();C=E(),$e&&$e.c(),x=E(),N=y("div"),k=y("div"),k.innerHTML='<span class="text-sm font-medium text-[var(--text-muted)]">Folders</span>',T=E(),D=y("select"),A=y("option"),A.textContent="Select folder...";for(let le=0;le<Re.length;le+=1)Re[le].c();O=E(),tt&&tt.c(),B=E(),R=y("div"),F=y("div"),L=y("div"),L.textContent="Created After (date_created)",V=E(),Y=y("input"),W=E(),K=y("div"),H=y("div"),H.textContent="Updated After (date_updated)",U=E(),X=y("input"),I=E(),J=y("div"),fe=y("div"),fe.textContent="Frontmatter Properties",Te=E(),ye=y("div"),ye.textContent="Filter by any frontmatter property value",ve=E(),ge=y("select"),me=y("option"),me.textContent="Select property...";for(let le=0;le<We.length;le+=1)We[le].c();Me=E();for(let le=0;le<pe.length;le+=1)pe[le].c();ie=E(),se=y("div"),Q=y("button"),ue=$("Apply Filters"),ze=E(),Be=y("button"),Be.textContent="Clear Filters",de=E(),Ae&&Ae.c(),_e=E(),ht.c(),f(t,"class","text-lg font-semibold mb-4 text-[var(--text-default)]"),f(r,"class","font-semibold text-[var(--text-default)]"),f(l,"class","flex items-center justify-between mb-2"),g.__value="",Ie(g,g.__value),f(p,"class","w-full px-3 py-0 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-normal bg-[var(--background-secondary)] min-w-48"),f(c,"class","flex items-center justify-between mb-2"),_.__value="",Ie(_,_.__value),f(w,"class","w-full px-3 py-0 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-normal bg-[var(--background-secondary)] min-w-48"),f(k,"class","flex items-center justify-between mb-2"),A.__value="",Ie(A,A.__value),f(D,"class","w-full px-3 py-0 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-normal bg-[var(--background-secondary)] min-w-48"),f(L,"class","text-sm font-medium text-[var(--text-muted)] mb-2"),f(Y,"type","date"),f(Y,"class","w-full px-3 py-1 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-normal bg-[var(--background-secondary)] min-w-48"),f(H,"class","text-sm font-medium text-[var(--text-muted)] mb-2"),f(X,"type","date"),f(X,"class","w-full px-3 py-1 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-normal bg-[var(--background-secondary)] min-w-48"),f(R,"class","grid grid-cols-2 gap-4"),f(fe,"class","text-sm font-medium text-[var(--text-muted)] mb-2"),f(ye,"class","text-xs text-[var(--text-muted)] mb-2"),me.__value="",Ie(me,me.__value),f(ge,"class","w-full px-3 py-0 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-normal bg-[var(--background-secondary)] min-w-48 mb-2"),f(Q,"class","px-4 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded hover:opacity-90 disabled:opacity-50"),Q.disabled=n[10],f(Be,"class","px-4 py-2 bg-[var(--background-modifier-border)] text-[var(--text-default)] rounded hover:opacity-90"),f(se,"class","flex gap-2"),f(s,"class","bg-[var(--background-secondary)] p-4 rounded-lg space-y-4"),f(e,"class","advanced-sync-tab space-y-4")},m(le,st){z(le,e,st),u(e,t),u(e,i),u(e,s),u(s,r),u(s,o),u(s,a),u(a,l),u(a,d),u(a,p),u(p,g);for(let re=0;re<Ze.length;re+=1)Ze[re]&&Ze[re].m(p,null);u(a,m),Fe&&Fe.m(a,null),u(s,h),u(s,b),u(b,c),u(b,v),u(b,w),u(w,_);for(let re=0;re<Le.length;re+=1)Le[re]&&Le[re].m(w,null);u(b,C),$e&&$e.m(b,null),u(s,x),u(s,N),u(N,k),u(N,T),u(N,D),u(D,A);for(let re=0;re<Re.length;re+=1)Re[re]&&Re[re].m(D,null);u(N,O),tt&&tt.m(N,null),u(s,B),u(s,R),u(R,F),u(F,L),u(F,V),u(F,Y),u(R,W),u(R,K),u(K,H),u(K,U),u(K,X),u(s,I),u(s,J),u(J,fe),u(J,Te),u(J,ye),u(J,ve),u(J,ge),u(ge,me);for(let re=0;re<We.length;re+=1)We[re]&&We[re].m(ge,null);u(J,Me);for(let re=0;re<pe.length;re+=1)pe[re]&&pe[re].m(J,null);u(s,ie),u(s,se),u(se,Q),u(Q,ue),u(se,ze),u(se,Be),u(e,de),Ae&&Ae.m(e,null),u(e,_e),ht.m(e,null),Oe||(Ve=[ne(p,"change",n[44]),ne(w,"change",n[46]),ne(D,"change",n[48]),ne(Y,"change",n[50]),ne(X,"change",n[51]),ne(ge,"change",n[52]),ne(Q,"click",n[24]),ne(Be,"click",n[55])],Oe=!0)},p(le,st){if(st[0]&16416){Xe=xe(le[5]);let re;for(re=0;re<Xe.length;re+=1){const dt=rr(le,Xe,re);Ze[re]?Ze[re].p(dt,st):(Ze[re]=cr(dt),Ze[re].c(),Ze[re].m(p,null))}for(;re<Ze.length;re+=1)Ze[re].d(1);Ze.length=Xe.length}if(le[14].size>0?Fe?Fe.p(le,st):(Fe=dr(le),Fe.c(),Fe.m(a,null)):Fe&&(Fe.d(1),Fe=null),st[0]&32832){He=xe(le[6]);let re;for(re=0;re<He.length;re+=1){const dt=ir(le,He,re);Le[re]?Le[re].p(dt,st):(Le[re]=gr(dt),Le[re].c(),Le[re].m(w,null))}for(;re<Le.length;re+=1)Le[re].d(1);Le.length=He.length}if(le[15].size>0?$e?$e.p(le,st):($e=fr(le),$e.c(),$e.m(b,null)):$e&&($e.d(1),$e=null),st[0]&65664){qe=xe(le[7]);let re;for(re=0;re<qe.length;re+=1){const dt=tr(le,qe,re);Re[re]?Re[re].p(dt,st):(Re[re]=yr(dt),Re[re].c(),Re[re].m(D,null))}for(;re<Re.length;re+=1)Re[re].d(1);Re.length=qe.length}if(le[16].size>0?tt?tt.p(le,st):(tt=br(le),tt.c(),tt.m(N,null)):tt&&(tt.d(1),tt=null),st[0]&12288){ct=xe(le[13]);let re;for(re=0;re<ct.length;re+=1){const dt=Xs(le,ct,re);We[re]?We[re].p(dt,st):(We[re]=wr(dt),We[re].c(),We[re].m(ge,null))}for(;re<We.length;re+=1)We[re].d(1);We.length=ct.length}if(st[0]&4096){Ye=xe(Object.keys(le[12]));let re;for(re=0;re<Ye.length;re+=1){const dt=Zs(le,Ye,re);pe[re]?pe[re].p(dt,st):(pe[re]=Sr(dt),pe[re].c(),pe[re].m(J,null))}for(;re<pe.length;re+=1)pe[re].d(1);pe.length=Ye.length}st[0]&1024&&(Q.disabled=le[10]),le[8].length>0?Ae?Ae.p(le,st):(Ae=xr(le),Ae.c(),Ae.m(e,_e)):Ae&&(Ae.d(1),Ae=null),Ct===(Ct=Yt(le))&&ht?ht.p(le,st):(ht.d(1),ht=Ct(le),ht&&(ht.c(),ht.m(e,null)))},d(le){le&&j(e),et(Ze,le),Fe&&Fe.d(),et(Le,le),$e&&$e.d(),et(Re,le),tt&&tt.d(),et(We,le),et(pe,le),Ae&&Ae.d(),ht.d(),Oe=!1,Qe(Ve)}}}function Op(n){let e,t,i;function s(a,l){return a[3]?Bp:a[2].length===0?zp:jp}let r=s(n),o=r(n);return{c(){e=y("div"),t=y("h3"),t.textContent="Sync by Category",i=E(),o.c(),f(t,"class","text-lg font-semibold mb-4 text-[var(--text-default)]"),f(e,"class","quick-sync-tab")},m(a,l){z(a,e,l),u(e,t),u(e,i),o.m(e,null)},p(a,l){r===(r=s(a))&&o?o.p(a,l):(o.d(1),o=r(a),o&&(o.c(),o.m(e,null)))},d(a){a&&j(e),o.d()}}}function lr(n){let e,t=n[104]+"",i,s;return{c(){e=y("option"),i=$(t),e.__value=s=n[104],Ie(e,e.__value)},m(r,o){z(r,e,o),u(e,i)},p(r,o){o[0]&32&&t!==(t=r[104]+"")&&ae(i,t),o[0]&32&&s!==(s=r[104])&&(e.__value=s,Ie(e,e.__value))},d(r){r&&j(e)}}}function cr(n){let e=!n[14].has(n[104]),t,i=e&&lr(n);return{c(){i&&i.c(),t=rn()},m(s,r){i&&i.m(s,r),z(s,t,r)},p(s,r){r[0]&16416&&(e=!s[14].has(s[104])),e?i?i.p(s,r):(i=lr(s),i.c(),i.m(t.parentNode,t)):i&&(i.d(1),i=null)},d(s){s&&j(t),i&&i.d(s)}}}function dr(n){let e,t=xe(Array.from(n[14])),i=[];for(let s=0;s<t.length;s+=1)i[s]=ur(sr(n,t,s));return{c(){e=y("div");for(let s=0;s<i.length;s+=1)i[s].c();f(e,"class","flex flex-wrap gap-2 mt-2")},m(s,r){z(s,e,r);for(let o=0;o<i.length;o+=1)i[o]&&i[o].m(e,null)},p(s,r){if(r[0]&16384|r[1]&2){t=xe(Array.from(s[14]));let o;for(o=0;o<t.length;o+=1){const a=sr(s,t,o);i[o]?i[o].p(a,r):(i[o]=ur(a),i[o].c(),i[o].m(e,null))}for(;o<i.length;o+=1)i[o].d(1);i.length=t.length}},d(s){s&&j(e),et(i,s)}}}function ur(n){let e,t=n[104]+"",i,s,r,o,a,l,d,p;function g(){return n[45](n[104])}return{c(){e=y("span"),i=$(t),s=E(),r=y("button"),o=$(""),l=E(),f(r,"class","hover:opacity-80"),f(r,"aria-label",a="Remove "+n[104]),f(e,"class","inline-flex items-center gap-1 px-2 py-1 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded text-xs")},m(m,h){z(m,e,h),u(e,i),u(e,s),u(e,r),u(r,o),u(e,l),d||(p=ne(r,"click",g),d=!0)},p(m,h){n=m,h[0]&16384&&t!==(t=n[104]+"")&&ae(i,t),h[0]&16384&&a!==(a="Remove "+n[104])&&f(r,"aria-label",a)},d(m){m&&j(e),d=!1,p()}}}function pr(n){let e,t=n[99]+"",i,s;return{c(){e=y("option"),i=$(t),e.__value=s=n[99],Ie(e,e.__value)},m(r,o){z(r,e,o),u(e,i)},p(r,o){o[0]&64&&t!==(t=r[99]+"")&&ae(i,t),o[0]&64&&s!==(s=r[99])&&(e.__value=s,Ie(e,e.__value))},d(r){r&&j(e)}}}function gr(n){let e=!n[15].has(n[99]),t,i=e&&pr(n);return{c(){i&&i.c(),t=rn()},m(s,r){i&&i.m(s,r),z(s,t,r)},p(s,r){r[0]&32832&&(e=!s[15].has(s[99])),e?i?i.p(s,r):(i=pr(s),i.c(),i.m(t.parentNode,t)):i&&(i.d(1),i=null)},d(s){s&&j(t),i&&i.d(s)}}}function fr(n){let e,t=xe(Array.from(n[15])),i=[];for(let s=0;s<t.length;s+=1)i[s]=hr(nr(n,t,s));return{c(){e=y("div");for(let s=0;s<i.length;s+=1)i[s].c();f(e,"class","flex flex-wrap gap-2 mt-2")},m(s,r){z(s,e,r);for(let o=0;o<i.length;o+=1)i[o]&&i[o].m(e,null)},p(s,r){if(r[0]&32768|r[1]&8){t=xe(Array.from(s[15]));let o;for(o=0;o<t.length;o+=1){const a=nr(s,t,o);i[o]?i[o].p(a,r):(i[o]=hr(a),i[o].c(),i[o].m(e,null))}for(;o<i.length;o+=1)i[o].d(1);i.length=t.length}},d(s){s&&j(e),et(i,s)}}}function hr(n){let e,t=n[99]+"",i,s,r,o,a,l,d,p;function g(){return n[47](n[99])}return{c(){e=y("span"),i=$(t),s=E(),r=y("button"),o=$(""),l=E(),f(r,"class","hover:opacity-80"),f(r,"aria-label",a="Remove "+n[99]),f(e,"class","inline-flex items-center gap-1 px-2 py-1 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded text-xs")},m(m,h){z(m,e,h),u(e,i),u(e,s),u(e,r),u(r,o),u(e,l),d||(p=ne(r,"click",g),d=!0)},p(m,h){n=m,h[0]&32768&&t!==(t=n[99]+"")&&ae(i,t),h[0]&32768&&a!==(a="Remove "+n[99])&&f(r,"aria-label",a)},d(m){m&&j(e),d=!1,p()}}}function mr(n){let e,t=n[94]+"",i,s;return{c(){e=y("option"),i=$(t),e.__value=s=n[94],Ie(e,e.__value)},m(r,o){z(r,e,o),u(e,i)},p(r,o){o[0]&128&&t!==(t=r[94]+"")&&ae(i,t),o[0]&128&&s!==(s=r[94])&&(e.__value=s,Ie(e,e.__value))},d(r){r&&j(e)}}}function yr(n){let e=!n[16].has(n[94]),t,i=e&&mr(n);return{c(){i&&i.c(),t=rn()},m(s,r){i&&i.m(s,r),z(s,t,r)},p(s,r){r[0]&65664&&(e=!s[16].has(s[94])),e?i?i.p(s,r):(i=mr(s),i.c(),i.m(t.parentNode,t)):i&&(i.d(1),i=null)},d(s){s&&j(t),i&&i.d(s)}}}function br(n){let e,t=xe(Array.from(n[16])),i=[];for(let s=0;s<t.length;s+=1)i[s]=vr(er(n,t,s));return{c(){e=y("div");for(let s=0;s<i.length;s+=1)i[s].c();f(e,"class","flex flex-wrap gap-2 mt-2")},m(s,r){z(s,e,r);for(let o=0;o<i.length;o+=1)i[o]&&i[o].m(e,null)},p(s,r){if(r[0]&65536|r[1]&32){t=xe(Array.from(s[16]));let o;for(o=0;o<t.length;o+=1){const a=er(s,t,o);i[o]?i[o].p(a,r):(i[o]=vr(a),i[o].c(),i[o].m(e,null))}for(;o<i.length;o+=1)i[o].d(1);i.length=t.length}},d(s){s&&j(e),et(i,s)}}}function vr(n){let e,t=n[94]+"",i,s,r,o,a,l,d,p;function g(){return n[49](n[94])}return{c(){e=y("span"),i=$(t),s=E(),r=y("button"),o=$(""),l=E(),f(r,"class","hover:opacity-80"),f(r,"aria-label",a="Remove "+n[94]),f(e,"class","inline-flex items-center gap-1 px-2 py-1 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded text-xs")},m(m,h){z(m,e,h),u(e,i),u(e,s),u(e,r),u(r,o),u(e,l),d||(p=ne(r,"click",g),d=!0)},p(m,h){n=m,h[0]&65536&&t!==(t=n[94]+"")&&ae(i,t),h[0]&65536&&a!==(a="Remove "+n[94])&&f(r,"aria-label",a)},d(m){m&&j(e),d=!1,p()}}}function _r(n){let e,t=n[89]+"",i,s;return{c(){e=y("option"),i=$(t),e.__value=s=n[89],Ie(e,e.__value)},m(r,o){z(r,e,o),u(e,i)},p(r,o){o[0]&8192&&t!==(t=r[89]+"")&&ae(i,t),o[0]&8192&&s!==(s=r[89])&&(e.__value=s,Ie(e,e.__value))},d(r){r&&j(e)}}}function wr(n){let e,t=!n[12][n[89]]&&_r(n);return{c(){t&&t.c(),e=rn()},m(i,s){t&&t.m(i,s),z(i,e,s)},p(i,s){i[12][i[89]]?t&&(t.d(1),t=null):t?t.p(i,s):(t=_r(i),t.c(),t.m(e.parentNode,e))},d(i){i&&j(e),t&&t.d(i)}}}function Sr(n){let e,t,i=n[89]+"",s,r,o,a,l,d,p,g,m;function h(){n[53].call(a,n[89])}function b(){return n[54](n[89])}return{c(){e=y("div"),t=y("span"),s=$(i),r=$(":"),o=E(),a=y("input"),l=E(),d=y("button"),d.textContent="Remove",p=E(),f(t,"class","p-2 bg-[var(--background-modifier-hover)] rounded text-sm text-[var(--text-default)]"),f(a,"type","text"),f(a,"class","flex-1 px-3 py-1 border border-[var(--background-modifier-border)] rounded focus:outline-none focus:ring-2 focus:ring-[var(--interactive-accent)] focus:border-[var(--interactive-accent)] text-sm leading-normal bg-[var(--background-secondary)] min-w-48"),f(a,"placeholder","Filter value..."),f(d,"class","px-3 py-1 bg-[var(--text-error)] text-[var(--text-on-accent)] rounded hover:opacity-90"),f(e,"class","flex gap-2 mb-2")},m(c,v){z(c,e,v),u(e,t),u(t,s),u(t,r),u(e,o),u(e,a),Ie(a,n[12][n[89]]),u(e,l),u(e,d),u(e,p),g||(m=[ne(a,"input",h),ne(d,"click",b)],g=!0)},p(c,v){n=c,v[0]&4096&&i!==(i=n[89]+"")&&ae(s,i),v[0]&4096&&a.value!==n[12][n[89]]&&Ie(a,n[12][n[89]])},d(c){c&&j(e),g=!1,Qe(m)}}}function xr(n){let e,t,i,s,r,o,a,l;return{c(){e=y("div"),t=y("button"),t.textContent="Select New",i=E(),s=y("button"),s.textContent="Select Updated",r=E(),o=y("button"),o.textContent="Select All (New + Updated)",f(t,"class","px-3 py-1.5 text-xs bg-[var(--background-modifier-border)] text-[var(--text-default)] rounded hover:opacity-90"),f(s,"class","px-3 py-1.5 text-xs bg-[var(--background-modifier-border)] text-[var(--text-default)] rounded hover:opacity-90"),f(o,"class","px-3 py-1.5 text-xs bg-[var(--background-modifier-border)] text-[var(--text-default)] rounded hover:opacity-90"),f(e,"class","flex gap-2 mb-3")},m(d,p){z(d,e,p),u(e,t),u(e,i),u(e,s),u(e,r),u(e,o),a||(l=[ne(t,"click",n[28]),ne(s,"click",n[29]),ne(o,"click",n[30])],a=!0)},p:we,d(d){d&&j(e),a=!1,Qe(l)}}}function Ip(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C=n[9].size+"",x,N,k=n[8].length+"",T,D,A,O,B,R,F,L,V=xe(n[8]),Y=[];for(let W=0;W<V.length;W+=1)Y[W]=kr(Qs(n,V,W));return{c(){e=y("div"),t=y("table"),i=y("thead"),s=y("tr"),r=y("th"),o=y("input"),a=E(),l=y("th"),l.textContent="Path",d=E(),p=y("th"),p.textContent="Type",g=E(),m=y("th"),m.textContent="Status",h=E(),b=y("tbody");for(let W=0;W<Y.length;W+=1)Y[W].c();c=E(),v=y("div"),w=y("div"),_=y("span"),x=$(C),N=$(" of "),T=$(k),D=$(" notes selected"),A=E(),O=y("button"),B=$("Sync Selected Notes"),f(o,"type","checkbox"),f(r,"class","p-2"),f(l,"class","p-2 text-left text-sm font-semibold text-[var(--text-muted)]"),f(p,"class","p-2 text-left text-sm font-semibold text-[var(--text-muted)]"),f(m,"class","p-2 text-left text-sm font-semibold text-[var(--text-muted)]"),f(i,"class","bg-[var(--background-secondary)] border-b border-[var(--background-modifier-border)]"),f(t,"class","w-full"),f(e,"class","overflow-x-auto rounded-lg border border-[var(--background-modifier-border)]"),f(_,"class","text-sm text-[var(--text-default)]"),f(O,"class","px-4 py-2 bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded hover:opacity-90 disabled:opacity-50"),O.disabled=R=n[9].size===0||n[1],f(w,"class","flex items-center justify-between"),f(v,"class","bg-[var(--background-secondary)] p-4 rounded-lg mt-3")},m(W,K){z(W,e,K),u(e,t),u(t,i),u(i,s),u(s,r),u(r,o),o.checked=n[11],u(s,a),u(s,l),u(s,d),u(s,p),u(s,g),u(s,m),u(t,h),u(t,b);for(let H=0;H<Y.length;H+=1)Y[H]&&Y[H].m(b,null);z(W,c,K),z(W,v,K),u(v,w),u(w,_),u(_,x),u(_,N),u(_,T),u(_,D),u(w,A),u(w,O),u(O,B),F||(L=[ne(o,"change",n[56]),ne(o,"change",n[26]),ne(O,"click",n[21])],F=!0)},p(W,K){if(K[0]&2048&&(o.checked=W[11]),K[0]&167772928){V=xe(W[8]);let H;for(H=0;H<V.length;H+=1){const U=Qs(W,V,H);Y[H]?Y[H].p(U,K):(Y[H]=kr(U),Y[H].c(),Y[H].m(b,null))}for(;H<Y.length;H+=1)Y[H].d(1);Y.length=V.length}K[0]&512&&C!==(C=W[9].size+"")&&ae(x,C),K[0]&256&&k!==(k=W[8].length+"")&&ae(T,k),K[0]&514&&R!==(R=W[9].size===0||W[1])&&(O.disabled=R)},d(W){W&&(j(e),j(c),j(v)),et(Y,W),F=!1,Qe(L)}}}function Lp(n){let e;return{c(){e=y("div"),e.textContent="No notes match the current filters",f(e,"class","text-center p-4 text-[var(--text-muted)]")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function Rp(n){let e;return{c(){e=y("div"),e.textContent="Loading notes...",f(e,"class","text-center p-4 text-[var(--text-muted)]")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function Fp(n){return{c:we,m:we,p:we,d:we}}function $p(n){let e,t=n[88]+"",i,s;return{c(){e=y("span"),i=$(t),f(e,"class",s="text-xs px-2 py-1 rounded "+(n[88]==="Synced"?"bg-[var(--text-success)] text-[var(--text-on-accent)]":n[88]==="Private"?"bg-[var(--text-muted)] text-[var(--text-on-accent)]":n[88]==="Updated"?"bg-[var(--interactive-accent-hover)] text-[var(--text-on-accent)]":"bg-[var(--interactive-accent)] text-[var(--text-on-accent)]"))},m(r,o){z(r,e,o),u(e,i)},p(r,o){o[0]&256&&t!==(t=r[88]+"")&&ae(i,t),o[0]&256&&s!==(s="text-xs px-2 py-1 rounded "+(r[88]==="Synced"?"bg-[var(--text-success)] text-[var(--text-on-accent)]":r[88]==="Private"?"bg-[var(--text-muted)] text-[var(--text-on-accent)]":r[88]==="Updated"?"bg-[var(--interactive-accent-hover)] text-[var(--text-on-accent)]":"bg-[var(--interactive-accent)] text-[var(--text-on-accent)]"))&&f(e,"class",s)},d(r){r&&j(e)}}}function Up(n){let e;return{c(){e=y("span"),e.textContent="...",f(e,"class","text-[var(--text-muted)]")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function kr(n){let e,t,i,s,r,o,a=n[85].path+"",l,d,p,g=(n[85].type||"-")+"",m,h,b,c,v,w,_;function C(){return n[57](n[85])}let x={ctx:n,current:null,token:null,hasCatch:!1,pending:Up,then:$p,catch:Fp,value:88};return Ui(c=n[27](n[85]),x),{c(){e=y("tr"),t=y("td"),i=y("input"),r=E(),o=y("td"),l=$(a),d=E(),p=y("td"),m=$(g),h=E(),b=y("td"),x.block.c(),v=E(),f(i,"type","checkbox"),i.checked=s=n[9].has(n[85].path),f(t,"class","p-2"),f(o,"class","p-2 text-sm text-[var(--text-default)]"),f(p,"class","p-2 text-sm text-[var(--text-default)]"),f(b,"class","p-2 text-sm"),f(e,"class","border-b border-[var(--background-modifier-border)] hover:bg-[var(--background-modifier-hover)] transition-colors")},m(N,k){z(N,e,k),u(e,t),u(t,i),u(e,r),u(e,o),u(o,l),u(e,d),u(e,p),u(p,m),u(e,h),u(e,b),x.block.m(b,x.anchor=null),x.mount=()=>b,x.anchor=null,u(e,v),w||(_=ne(i,"change",C),w=!0)},p(N,k){n=N,k[0]&768&&s!==(s=n[9].has(n[85].path))&&(i.checked=s),k[0]&256&&a!==(a=n[85].path+"")&&ae(l,a),k[0]&256&&g!==(g=(n[85].type||"-")+"")&&ae(m,g),x.ctx=n,k[0]&256&&c!==(c=n[27](n[85]))&&Ui(c,x)||iu(x,n,k)},d(N){N&&j(e),x.block.d(),x.token=null,x=null,w=!1,_()}}}function jp(n){let e,t,i,s,r,o=xe(n[2]),a=[];for(let l=0;l<o.length;l+=1)a[l]=Cr(or(n,o,l));return{c(){e=y("div"),t=y("table"),i=y("thead"),i.innerHTML='<tr class="bg-[var(--background-secondary)] border-b border-[var(--background-modifier-border)] text-[var(--text-muted)]"><th scope="col" class="p-3 text-sm font-semibold uppercase tracking-wider">Note Type</th> <th scope="col" class="p-3 text-sm font-semibold uppercase tracking-wider">Total</th> <th scope="col" class="p-3 text-sm font-semibold uppercase tracking-wider">Synced</th> <th scope="col" class="p-3 text-sm font-semibold uppercase tracking-wider">Private</th> <th scope="col" class="p-3 text-sm font-semibold uppercase tracking-wider">SyncUpdated</th> <th scope="col" class="p-3 text-sm font-semibold uppercase tracking-wider">SyncNew</th></tr>',s=E(),r=y("tbody");for(let l=0;l<a.length;l+=1)a[l].c();f(t,"class","w-full table-auto text-left"),f(e,"class","overflow-x-auto w-full rounded-lg border border-[var(--background-modifier-border)]")},m(l,d){z(l,e,d),u(e,t),u(t,i),u(t,s),u(t,r);for(let p=0;p<a.length;p+=1)a[p]&&a[p].m(r,null)},p(l,d){if(d[0]&1048582){o=xe(l[2]);let p;for(p=0;p<o.length;p+=1){const g=or(l,o,p);a[p]?a[p].p(g,d):(a[p]=Cr(g),a[p].c(),a[p].m(r,null))}for(;p<a.length;p+=1)a[p].d(1);a.length=o.length}},d(l){l&&j(e),et(a,l)}}}function zp(n){let e;return{c(){e=y("p"),e.textContent="No syncable note types found.",f(e,"class","text-[var(--text-muted)]")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function Bp(n){let e;return{c(){e=y("p"),e.textContent="Loading sync status...",f(e,"class","text-[var(--text-muted)]")},m(t,i){z(t,e,i)},p:we,d(t){t&&j(e)}}}function Er(n){let e,t,i=n[82].updated+"",s,r,o,a;function l(){return n[42](n[82])}return{c(){e=y("button"),t=$("Update "),s=$(i),f(e,"class","w-full bg-[var(--interactive-accent-hover)] hover:opacity-90 text-[var(--text-on-accent)] px-3 py-1.5 rounded-md text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"),e.disabled=n[1],f(e,"aria-label",r=`Update ${n[82].updated} ${n[82].type} Notes`)},m(d,p){z(d,e,p),u(e,t),u(e,s),o||(a=ne(e,"click",l),o=!0)},p(d,p){n=d,p[0]&4&&i!==(i=n[82].updated+"")&&ae(s,i),p[0]&2&&(e.disabled=n[1]),p[0]&4&&r!==(r=`Update ${n[82].updated} ${n[82].type} Notes`)&&f(e,"aria-label",r)},d(d){d&&j(e),o=!1,a()}}}function Cr(n){let e,t,i=n[82].type+"",s,r,o,a=n[82].total+"",l,d,p,g=n[82].synced+"",m,h,b,c=n[82].private+"",v,w,_,C,x,N,k,T=n[82].ready+"",D,A,O,B,R,F,L=n[82].updated>0&&Er(n);function V(){return n[43](n[82])}return{c(){e=y("tr"),t=y("td"),s=$(i),r=E(),o=y("td"),l=$(a),d=E(),p=y("td"),m=$(g),h=E(),b=y("td"),v=$(c),w=E(),_=y("td"),L&&L.c(),C=E(),x=y("td"),N=y("button"),k=$("Sync "),D=$(T),B=E(),f(t,"class","p-3 text-sm"),f(o,"class","p-3 text-sm"),f(p,"class","p-3 text-sm"),f(b,"class","p-3 text-sm"),f(_,"class","p-3"),f(N,"class","w-full bg-[var(--interactive-accent)] hover:opacity-90 text-[var(--text-on-accent)] px-3 py-1.5 rounded-md text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"),N.disabled=A=n[82].ready===0||n[1],f(N,"aria-label",O=`Sync ${n[82].ready} ${n[82].type} Notes`),f(x,"class","p-3"),f(e,"class","border-b border-[var(--background-modifier-border)] hover:bg-[var(--background-modifier-hover)] hover:opacity-90 transition-colors text-[var(--text-default)]")},m(Y,W){z(Y,e,W),u(e,t),u(t,s),u(e,r),u(e,o),u(o,l),u(e,d),u(e,p),u(p,m),u(e,h),u(e,b),u(b,v),u(e,w),u(e,_),L&&L.m(_,null),u(e,C),u(e,x),u(x,N),u(N,k),u(N,D),u(e,B),R||(F=ne(N,"click",V),R=!0)},p(Y,W){n=Y,W[0]&4&&i!==(i=n[82].type+"")&&ae(s,i),W[0]&4&&a!==(a=n[82].total+"")&&ae(l,a),W[0]&4&&g!==(g=n[82].synced+"")&&ae(m,g),W[0]&4&&c!==(c=n[82].private+"")&&ae(v,c),n[82].updated>0?L?L.p(n,W):(L=Er(n),L.c(),L.m(_,null)):L&&(L.d(1),L=null),W[0]&4&&T!==(T=n[82].ready+"")&&ae(D,T),W[0]&6&&A!==(A=n[82].ready===0||n[1])&&(N.disabled=A),W[0]&4&&O!==(O=`Sync ${n[82].ready} ${n[82].type} Notes`)&&f(N,"aria-label",O)},d(Y){Y&&j(e),L&&L.d(),R=!1,F()}}}function Pr(n){let e,t,i,s,r,o,a,l,d,p=n[18].status+"",g,m,h,b=n[18].message+"",c,v;function w(x,N){return x[18].status==="success"?Gp:Vp}let _=w(n),C=_(n);return{c(){e=y("div"),t=y("div"),C.c(),i=E(),s=y("div"),r=y("h3"),r.textContent="Sync Complete",o=E(),a=y("p"),l=$("Status: "),d=y("span"),g=$(p),m=E(),h=y("p"),c=$(b),f(r,"class","text-lg font-semibold"),f(d,"class","font-bold"),f(a,"class","text-sm"),f(h,"class","text-sm"),f(t,"class","flex items-center space-x-3"),f(e,"class",v="p-4 rounded-lg shadow-md space-y-2 "+(n[18].status==="success"?"bg-[var(--text-success)] text-[var(--text-on-accent)]":"bg-[var(--text-error)] text-[var(--text-on-accent)]"))},m(x,N){z(x,e,N),u(e,t),C.m(t,null),u(t,i),u(t,s),u(s,r),u(s,o),u(s,a),u(a,l),u(a,d),u(d,g),u(s,m),u(s,h),u(h,c)},p(x,N){_!==(_=w(x))&&(C.d(1),C=_(x),C&&(C.c(),C.m(t,i))),N[0]&262144&&p!==(p=x[18].status+"")&&ae(g,p),N[0]&262144&&b!==(b=x[18].message+"")&&ae(c,b),N[0]&262144&&v!==(v="p-4 rounded-lg shadow-md space-y-2 "+(x[18].status==="success"?"bg-[var(--text-success)] text-[var(--text-on-accent)]":"bg-[var(--text-error)] text-[var(--text-on-accent)]"))&&f(e,"class",v)},d(x){x&&j(e),C.d()}}}function Vp(n){let e,t;return{c(){e=Tn("svg"),t=Tn("path"),f(t,"stroke-linecap","round"),f(t,"stroke-linejoin","round"),f(t,"d","M12 9v6m0 0v6m0-6h6m-6 0H6"),f(e,"xmlns","http://www.w3.org/2000/svg"),f(e,"fill","none"),f(e,"viewBox","0 0 24 24"),f(e,"stroke-width","1.5"),f(e,"stroke","currentColor"),f(e,"class","w-6 h-6")},m(i,s){z(i,e,s),u(e,t)},d(i){i&&j(e)}}}function Gp(n){let e,t;return{c(){e=Tn("svg"),t=Tn("path"),f(t,"stroke-linecap","round"),f(t,"stroke-linejoin","round"),f(t,"d","M4.5 12.75l6 6 12-12"),f(e,"xmlns","http://www.w3.org/2000/svg"),f(e,"fill","none"),f(e,"viewBox","0 0 24 24"),f(e,"stroke-width","1.5"),f(e,"stroke","currentColor"),f(e,"class","w-6 h-6")},m(i,s){z(i,e,s),u(e,t)},d(i){i&&j(e)}}}function Yp(n){let e,t,i,s,r,o,a,l,d,p,g,m,h,b,c,v,w,_,C,x=n[1]&&ar(n);function N(A,O){if(A[0]==="quick")return Op;if(A[0]==="advanced")return Ap}let k=N(n),T=k&&k(n),D=n[18]&&Pr(n);return{c(){e=y("div"),t=y("div"),t.innerHTML='<h2 class="text-2xl font-bold text-[var(--text-default)]">MegaMem Sync Manager</h2>',i=E(),s=y("div"),r=y("button"),o=y("span"),o.textContent="",a=$(" Quick Sync"),d=E(),p=y("button"),g=y("span"),g.textContent="",m=$(" Advanced"),b=E(),x&&x.c(),c=E(),v=y("div"),T&&T.c(),w=E(),D&&D.c(),f(t,"class","flex items-center justify-between p-4 bg-[var(--background-secondary)] border-b border-[var(--background-modifier-border)]"),f(o,"class","mr-2"),f(r,"class",l="flex-1 flex items-center justify-center px-4 py-2 text-sm font-medium transition-colors duration-200 ease-in-out "+(n[0]==="quick"?"bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded-t-lg":"text-[var(--text-muted)] hover:text-[var(--text-default)] hover:bg-[var(--background-modifier-hover)] hover:opacity-90 rounded-t-lg")),f(r,"aria-label","Quick Sync Tab"),f(g,"class","mr-2"),f(p,"class",h="flex-1 flex items-center justify-center px-4 py-2 text-sm font-medium transition-colors duration-200 ease-in-out "+(n[0]==="advanced"?"bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded-t-lg":"text-[var(--text-muted)] hover:text-[var(--text-default)] hover:bg-[var(--background-modifier-hover)] hover:opacity-90 rounded-t-lg")),f(p,"aria-label","Advanced Sync Tab"),f(s,"class","flex bg-[var(--background-secondary)] border-b border-[var(--background-modifier-border)] sticky top-0 z-10"),f(v,"class","flex-1 overflow-y-auto p-4 space-y-4 bg-[var(--background-primary)]"),f(e,"class","flex flex-col h-full bg-[var(--background-primary)] overflow-hidden")},m(A,O){z(A,e,O),u(e,t),u(e,i),u(e,s),u(s,r),u(r,o),u(r,a),u(s,d),u(s,p),u(p,g),u(p,m),u(e,b),x&&x.m(e,null),u(e,c),u(e,v),T&&T.m(v,null),u(v,w),D&&D.m(v,null),_||(C=[ne(r,"click",n[40]),ne(p,"click",n[41])],_=!0)},p(A,O){O[0]&1&&l!==(l="flex-1 flex items-center justify-center px-4 py-2 text-sm font-medium transition-colors duration-200 ease-in-out "+(A[0]==="quick"?"bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded-t-lg":"text-[var(--text-muted)] hover:text-[var(--text-default)] hover:bg-[var(--background-modifier-hover)] hover:opacity-90 rounded-t-lg"))&&f(r,"class",l),O[0]&1&&h!==(h="flex-1 flex items-center justify-center px-4 py-2 text-sm font-medium transition-colors duration-200 ease-in-out "+(A[0]==="advanced"?"bg-[var(--interactive-accent)] text-[var(--text-on-accent)] rounded-t-lg":"text-[var(--text-muted)] hover:text-[var(--text-default)] hover:bg-[var(--background-modifier-hover)] hover:opacity-90 rounded-t-lg"))&&f(p,"class",h),A[1]?x?x.p(A,O):(x=ar(A),x.c(),x.m(e,c)):x&&(x.d(1),x=null),k===(k=N(A))&&T?T.p(A,O):(T&&T.d(1),T=k&&k(A),T&&(T.c(),T.m(v,w))),A[18]?D?D.p(A,O):(D=Pr(A),D.c(),D.m(v,null)):D&&(D.d(1),D=null)},i:we,o:we,d(A){A&&j(e),x&&x.d(),T&&T.d(),D&&D.d(),_=!1,Qe(C)}}}function Dr(n,e){n.status==="success"?new window.Notice(` ${e} completed: ${n.processed} notes processed`):new window.Notice(` ${e} failed: ${n.message}`)}function qp(n,e,t){let{graphitiService:i}=e,{syncRegistryService:s}=e,r,{logger:o}=e,a,l,d="quick",p=!1,g=[],m=!1,h={},b=[],c=[],v=[],w=[],_=new Set,C=!1,x=!1,N=!1,k={},T=[],D=new Set,A=new Set,O=new Set,B=null,R=null,F=0,L=0,V=0,Y="";ci(async()=>{await W()});async function W(){o.debug("[SM-INIT] SyncModal initializing..."),await U(),d==="advanced"&&a&&await K()}async function K(){a&&(t(5,b=await a.getAvailableTypes()),t(6,c=await a.getAvailableTags()),await H(),t(8,w=await a.getAllSyncableNotes()),await ie())}async function H(){const ee=l.vault.getRoot(),he=new Set,Se=rt=>{rt.children.forEach(ot=>{ot.children&&(he.add(ot.path),Se(ot))})};Se(ee),t(7,v=Array.from(he).sort())}async function U(){try{if(t(3,m=!0),!a){o.warn("[SM-WARN] Note selection service not available");return}const ee=await a.getNotesByType(),he=await a.getPrivateNotesByFolder(),Se=await a.getAvailableTypes(),rt=[];let ot=0;for(const at of Se){const mt=ee[at]||[],Dt=he.filter(nt=>nt.type===at),vt=mt.length+Dt.length,St=Dt.length;ot+=mt.length;const Lt=await Promise.all(mt.map(async nt=>{const wt=await X(nt.path);return{notePath:nt.path,isSynced:wt.isSynced,error:wt.error,message:wt.message}})),qt=Lt.filter(nt=>nt.isSynced&&!nt.error).length,xt=Lt.filter(nt=>!nt.isSynced&&!nt.error).map(nt=>nt.notePath),An=xt.length,hn=(await a.getUpdatedNotes(mt.map(nt=>({file:nt.file,path:nt.path,type:nt.type||at,tags:[],frontmatter:{type:nt.type||at},contentLength:0,created:new Date(nt.file.stat.ctime),modified:new Date(nt.file.stat.mtime),selected:!1})))).map(nt=>nt.path),On=hn.length;rt.push({type:at,total:vt,synced:qt,private:St,ready:An,readyPaths:xt,updated:On,updatedPaths:hn})}t(2,g=rt)}catch(ee){o.error("Failed to compute quick sync stats:",ee)}finally{t(3,m=!1)}}async function X(ee){var he;try{const Se=l.vault.getAbstractFileByPath(ee);if(!Se)return{isSynced:!1,error:!1,message:"File not found"};const rt=l.metadataCache.getFileCache(Se),ot=(he=rt==null?void 0:rt.frontmatter)==null?void 0:he.mm_uid;if(!ot||typeof ot!="string")return{isSynced:!1,error:!1,message:"No mm_uid found"};const at=l.vault.getName(),mt=s.getSyncRecord(ot,at);if(!mt)return{isSynced:!1,error:!1,message:"No sync record found for mm_uid"};const Dt="neo4j",vt=mt.syncs.find(St=>St.database_id===Dt);return vt&&!vt.error_message?{isSynced:!0,error:!1}:{isSynced:!1,error:!1,message:"No valid sync found for current database"}}catch(Se){return o.warn(`[WARN] Failed to determine sync status for note ${ee}: ${Se.message}`),{isSynced:!1,error:!0,message:Se.message}}}async function I(ee,he){try{if(!a)throw new Error("Note selection service not available");t(1,p=!0),t(17,B=null),t(18,R=null),await a.selectNotes(he),await Te(),o.debug("[SYNC-MODAL] Starting category sync via syncSelectedNotes()");const Se=await fe(`Sync ${ee} Notes`);t(18,R=Se),Se.status==="success"&&(Dr(Se,`${ee} Notes`),await U())}catch(Se){o.error("Category sync failed:",Se),t(18,R={status:"error",processed:0,skipped:0,total:0,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:Se instanceof Error?Se.message:String(Se)})}finally{t(1,p=!1)}}async function J(){if(p||!a)return;await a.selectNotes(Array.from(_));const ee=await a.validateSelection();if(!ee.isValid){alert(`Cannot sync: ${ee.errors.join(", ")}`);return}t(1,p=!0),t(18,R=null),t(17,B=null);try{await Te();const he=await fe("Advanced Selection Sync");t(18,R=he),he.status==="success"&&Dr(he,"Selected Notes")}catch(he){o.error("Advanced sync failed:",he),t(18,R={status:"error",processed:0,skipped:0,total:0,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:he instanceof Error?he.message:String(he)})}finally{t(1,p=!1)}}async function fe(ee){try{o.debug(`[SM-ENHANCED-SYNC] Starting ${ee} with source_description: obsidian_mm_quicksync`);const he=await i.syncSelectedNotes(Se=>{ge(Se)},"obsidian_mm_quicksync");return o.debug(`[SM-ENHANCED-SYNC] ${ee} completed successfully: ${he.processed} notes processed`),he}catch(he){o.error(`[SM-ENHANCED-SYNC] ${ee} failed:`,he);let Se=he instanceof Error?he.message:String(he);return(Se.includes("schema validation")||Se.includes("unrecognized type")||Se.includes("invalid note type"))&&(Se=`Schema validation failed: ${Se}. Please check your note types and try again.`),(Se.includes("network")||Se.includes("connection")||Se.includes("timeout"))&&(Se=`Connection issue: ${Se}. Please check your network and try again.`),{status:"error",processed:0,skipped:0,total:0,batchCount:0,nodeTypesLoaded:0,edgeTypesLoaded:0,message:Se}}}async function Te(){if(!a)return;const ee=a.getSelectedNotePaths();await ye(ee)}async function ye(ee){var he,Se;F=0,L=0,V=0;for(const rt of ee)try{const ot=l.vault.getAbstractFileByPath(rt);if(!ot){V++;continue}const at=l.metadataCache.getFileCache(ot),mt=(he=at==null?void 0:at.frontmatter)==null?void 0:he.mm_uid;if(!mt||typeof mt!="string"){F++;continue}const Dt=l.vault.getName(),vt=s.getSyncRecord(mt,Dt);if(vt&&vt.syncs&&vt.syncs.length>0){const St=vt.syncs[vt.syncs.length-1];if(St.episode_uuid&&!St.episode_uuid.startsWith("mcp-")){const Lt=((Se=ot.stat)==null?void 0:Se.mtime)||0;new Date(St.last_sync).getTime()>Lt?V++:L++}else F++}else F++}catch(ot){o.error(`Error analyzing note ${rt}:`,ot)}}let ve=0;function ge(ee){if(o.debug(`[SM-DIAGNOSIS] Progress update frequency: ${ee.current}/${ee.total} (${ee.percentage}%)`),t(17,B=ee),ee.current===0&&ve===0&&(ve=Date.now()),ee.percentage>0||ee.current>0)if(ee.percentage<1e-4)t(19,Y="Calculating...");else{const he=Date.now()-ve,rt=(ee.total-ee.current)*r.processingDelayMs,at=he/(ee.percentage/100)+rt-he;at<1e3?t(19,Y="Almost done"):at<6e4?t(19,Y=`${Math.round(at/1e3)}s remaining`):t(19,Y=`${Math.round(at/6e4)}m remaining`)}else t(19,Y="Calculating...");(ee.current===0||ee.current===ee.total||ee.current%5===0)&&o.debug(`[SM-PROGRESS] Milestone: ${ee.current}/${ee.total} - ${Y}`)}async function me(ee){t(0,d=ee),ee==="advanced"&&a&&w.length===0&&await K()}function Me(){i&&p&&(i.cancelSync(),t(1,p=!1),t(17,B=null))}async function ie(){if(!a)return;const ee=await a.getAllSyncableNotes(),he=new Set;ee.forEach(Se=>{Object.keys(Se.frontmatter).forEach(rt=>he.add(rt))}),t(13,T=Array.from(he).sort())}async function se(){if(a){t(10,C=!0);try{const ee={includeTypes:D.size>0?Array.from(D):void 0,includeTags:A.size>0?Array.from(A):void 0,includePaths:O.size>0?Array.from(O):void 0,createdAfter:h.createdAfter,createdBefore:h.createdBefore,modifiedAfter:h.modifiedAfter,modifiedBefore:h.modifiedBefore};t(8,w=await a.filterNotes(ee)),Object.keys(k).length>0&&t(8,w=w.filter(he=>Object.entries(k).every(([Se,rt])=>{var ot;return(ot=he.frontmatter[Se])==null?void 0:ot.toString().includes(rt)}))),_.clear(),t(9,_),x=!1}finally{t(10,C=!1)}}}function Q(ee){_.has(ee)?_.delete(ee):_.add(ee),t(9,_),t(11,N=_.size===w.length),x=!1}function ue(){N?_.clear():w.forEach(ee=>_.add(ee.path)),t(9,_),t(11,N=!N),x=!1}async function ze(ee){var at;const he=i.settings;if((!he.includedFolders||he.excludedFolders)&&!(a==null?void 0:a.shouldIncludeFile(ee.path,he.includedFolders||[],he.excludedFolders||[])))return"Private";if((await X(ee.path)).isSynced)return"Synced";const rt=l.metadataCache.getFileCache(ee.file);return((at=rt==null?void 0:rt.frontmatter)==null?void 0:at.mm_uid)?"Updated":"New"}async function Be(){_.clear();for(const ee of w)await ze(ee)==="New"&&_.add(ee.path);t(9,_),t(11,N=_.size===w.length)}async function de(){_.clear();for(const ee of w)await ze(ee)==="Updated"&&_.add(ee.path);t(9,_),t(11,N=_.size===w.length)}async function _e(){_.clear();for(const ee of w){const he=await ze(ee);(he==="New"||he==="Updated")&&_.add(ee.path)}t(9,_),t(11,N=_.size===w.length)}function Oe(ee){ee&&!D.has(ee)&&(D.add(ee),t(14,D))}function Ve(ee){D.delete(ee),t(14,D)}function Xe(ee){ee&&!A.has(ee)&&(A.add(ee),t(15,A))}function Ze(ee){A.delete(ee),t(15,A)}function Fe(ee){ee&&!O.has(ee)&&(O.add(ee),t(16,O))}function He(ee){O.delete(ee),t(16,O)}const Le=()=>me("quick"),$e=()=>me("advanced"),qe=ee=>I(ee.type+" (Updated)",ee.updatedPaths),Re=ee=>I(ee.type,ee.readyPaths),tt=ee=>{const he=ee.currentTarget,Se=he.value;Se&&(Oe(Se),he.value="")},ct=ee=>Ve(ee),We=ee=>{const he=ee.currentTarget,Se=he.value;Se&&(Xe(Se),he.value="")},Ye=ee=>Ze(ee),pe=ee=>{const he=ee.currentTarget,Se=he.value;Se&&(Fe(Se),he.value="")},Ae=ee=>He(ee),Yt=ee=>{const he=ee.currentTarget;t(4,h.createdAfter=he.value?new Date(he.value):void 0,h)},Ct=ee=>{const he=ee.currentTarget;t(4,h.modifiedAfter=he.value?new Date(he.value):void 0,h)},ht=ee=>{const he=ee.currentTarget,Se=he.value;Se&&!k[Se]&&(t(12,k[Se]="",k),t(12,k),he.value="")};function le(ee){k[ee]=this.value,t(12,k)}const st=ee=>{delete k[ee],t(12,k)},re=()=>{t(4,h={}),t(12,k={}),D.clear(),A.clear(),O.clear(),t(14,D),t(15,A),t(16,O),se()};function dt(){N=this.checked,t(11,N)}const Pt=ee=>Q(ee.path);return n.$$set=ee=>{"graphitiService"in ee&&t(37,i=ee.graphitiService),"syncRegistryService"in ee&&t(38,s=ee.syncRegistryService),"logger"in ee&&t(39,o=ee.logger)},n.$$.update=()=>{n.$$.dirty[1]&64&&typeof window.app!="undefined"&&(l=window.app,i&&(a=i.getNoteSelectionService(),r=i.settings)),n.$$.dirty[0]&1|n.$$.dirty[1]&128&&s&&s.on("changed",()=>{d==="quick"&&U()})},[d,p,g,m,h,b,c,v,w,_,C,N,k,T,D,A,O,B,R,Y,I,J,me,Me,se,Q,ue,ze,Be,de,_e,Oe,Ve,Xe,Ze,Fe,He,i,s,o,Le,$e,qe,Re,tt,ct,We,Ye,pe,Ae,Yt,Ct,ht,le,st,re,dt,Pt]}class po extends pi{constructor(e){super(),ui(this,e,qp,Yp,ai,{graphitiService:37,syncRegistryService:38,logger:39},null,[-1,-1,-1,-1])}}const Sn="sync-manager";class Wp extends P.ItemView{constructor(e,t,i,s){super(e),this.graphitiService=t,this.syncRegistryService=i,this.logger=s}getViewType(){return Sn}getDisplayText(){return"MegaMem Sync Manager"}getIcon(){return"refresh-cw"}async onOpen(){this.component=new po({target:this.contentEl,props:{graphitiService:this.graphitiService,syncRegistryService:this.syncRegistryService,logger:this.logger}})}async onClose(){this.component&&this.component.$destroy()}}class Kp extends P.Modal{constructor(e,t,i,s,r,o,a){super(e),this.graphitiService=t,this.syncRegistryService=i,this.syncStatusManager=s,this.vaultRegistryService=r,this.settings=o,this.logger=a}async onOpen(){var t;const{contentEl:e}=this;e.empty(),(t=e.parentElement)==null||t.addClass("enhanced-sync-modal","hide-obsidian-modal-elements"),e.parentElement&&(e.parentElement.style.padding="0",e.parentElement.style.backgroundColor="transparent");try{this.svelteComponent=new po({target:e,props:{graphitiService:this.graphitiService,syncRegistryService:this.syncRegistryService,logger:this.logger}})}catch(i){console.error("Failed to initialize enhanced sync UI:",i),e.innerHTML=`
                <div class="p-6 text-center">
                    <h2 class="text-xl font-semibold text-red-600 mb-4">Enhanced Sync UI Error</h2>
                    <p class="text-gray-700 mb-4">Failed to load enhanced sync UI: ${i instanceof Error?i.message:String(i)}</p>
                    <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="this.closest('.modal').dispatchEvent(new Event('close'))">
                        Close
                    </button>
                </div>
            `}}onClose(){var t;const{contentEl:e}=this;this.svelteComponent&&(this.svelteComponent.$destroy(),this.svelteComponent=null),(t=e.parentElement)==null||t.removeClass("enhanced-sync-modal"),e.parentElement&&(e.parentElement.style.padding="",e.parentElement.style.backgroundColor=""),e.empty()}}function Hp(n,e,t,i,s,r,o){try{new Kp(n,e,t,i,s,r,o).open()}catch(a){throw console.error("Failed to open enhanced sync UI:",a),a}}function Jp(n){const e={llmDefaults:{openai:{"gpt-5":{desc:"Latest flagship, most capable",recommended:!0},"gpt-4o":{desc:"Previous gen, multimodal",recommended:!1},"gpt-4o-mini":{desc:"Efficient, good performance",recommended:!1}},ollama:{"deepseek-r1:8b":{desc:"Best reasoning with transparent thought chains",recommended:!0},"qwen2.5:7b":{desc:"Excellent entity extraction, 128K context",recommended:!0},"qwq:32b":{desc:"Qwen's dedicated reasoning model",recommended:!1},"llama3.2:11b":{desc:"Latest Llama, strong performance",recommended:!1},"gemma2:9b":{desc:"Google's efficient architecture",recommended:!1},"mistral:7b":{desc:"Fast, reliable baseline",recommended:!1},"phi3:14b":{desc:"Microsoft's capable model",recommended:!1},"llama3.2:3b":{desc:"Lightweight for limited hardware",recommended:!1},"qwen2.5:3b":{desc:"User added",recommended:!1}},google:{"gemini-2.5-pro":{desc:"Latest flagship, maximum capability",recommended:!0},"gemini-2.5-flash":{desc:"Fast, efficient Gemini 2.5",recommended:!1},"gemini-2.0-flash-exp":{desc:"Previous gen experimental",recommended:!1}},anthropic:{"claude-opus-4-1-20250805":{desc:"Most capable, advanced reasoning",recommended:!0},"claude-sonnet-4-20250514":{desc:"Balanced performance and speed",recommended:!1},"claude-3-7-sonnet-latest":{desc:"Previous gen, still capable",recommended:!1},"claude-3-5-haiku-latest":{desc:"Fast, economical",recommended:!1}},venice:{"dolphin-2.9.2-qwen2-72b":{desc:"High-performance dolphin fine-tune of Qwen2",recommended:!0},"mistral-31-24b":{desc:"Powerful Mistral architecture",recommended:!1},"llama-3.2-3b":{desc:"Lightweight Llama model",recommended:!1}},openrouter:{"openai/gpt-5-mini":{desc:"Cost-effective with full structured output support",recommended:!0},"meta-llama/llama-3.1-70b-instruct":{desc:"Open source alternative with verified schema support",recommended:!1},"google/gemini-2.5-flash":{desc:"Google's offering with verified structured outputs",recommended:!1},"qwen/qwen3-235b-a22b":{desc:"Qwen model with verified schema handling",recommended:!1},"deepseek/deepseek-chat-v3.1":{desc:"Recent Deepseek model with structured output",recommended:!1}}},llmSmallDefaults:{openai:{"gpt-5-nano":{desc:"Latest nano model for reranking",recommended:!0},"gpt-4o-mini":{desc:"Previous gen efficient model",recommended:!1},"gpt-5-turbo":{desc:"Fast, cost-effective GPT-5",recommended:!1}},ollama:{"qwen2.5:3b":{desc:"Excellent for structured tasks",recommended:!0},"llama3.2:3b":{desc:"Fast, reliable classifications",recommended:!0},"deepseek-r1:1.5b":{desc:"Ultra-fast, minimal resource use",recommended:!1},"mistral:7b-instruct":{desc:"Larger but very reliable",recommended:!1}},google:{"gemini-2.5-flash-lite":{desc:"Optimized for classification tasks",recommended:!0},"gemini-2.5-flash":{desc:"Fast classification, larger",recommended:!1},"gemini-1.5-flash-8b":{desc:"Previous gen, still efficient",recommended:!1}},anthropic:{"claude-4-haiku":{desc:"Fast, efficient for reranking",recommended:!0},"claude-3-5-haiku-20241022":{desc:"Previous gen, economical",recommended:!1}},venice:{"llama-3.2-3b":{desc:"Fast, efficient for classification tasks",recommended:!0},"mistral-31-24b":{desc:"Larger but very capable",recommended:!1}},openrouter:{"openai/gpt-5-mini":{desc:"Cost-effective with verified structured output support",recommended:!0},"google/gemini-2.5-flash":{desc:"Fast classification with verified structured outputs",recommended:!1},"meta-llama/llama-3.1-70b-instruct":{desc:"Open source alternative with verified schema support",recommended:!1}}},embeddingDefaults:{openai:{"text-embedding-3-small":{desc:"Efficient, good quality",dimensions:1536,recommended:!0},"text-embedding-3-large":{desc:"Highest quality, larger vectors",dimensions:3072,recommended:!1},"text-embedding-ada-002":{desc:"Legacy model, still supported",dimensions:1536,recommended:!1}},ollama:{"nomic-embed-text:latest":{desc:"Best for markdown & mixed content",dimensions:768,recommended:!0},"mxbai-embed-large":{desc:"Highest quality embeddings",dimensions:1024,recommended:!1},"snowflake-arctic-embed":{desc:"Strong retrieval performance",dimensions:1024,recommended:!1},"all-minilm":{desc:"Smallest, fastest, limited quality",dimensions:384,recommended:!1},"e5-mistral-7b":{desc:"LLM-based embeddings, highest quality",dimensions:4096,recommended:!1}},google:{"text-embedding-005":{desc:"Latest Gemini 2.5 era embeddings",dimensions:768,recommended:!0},"text-embedding-004":{desc:"Previous gen, proven performance",dimensions:768,recommended:!1},"text-multilingual-embedding-002":{desc:"Best for multiple languages",dimensions:768,recommended:!1}},voyage:{"voyage-3":{desc:"Latest generation, best quality",dimensions:1024,recommended:!0},"voyage-3-lite":{desc:"Efficient, good performance",dimensions:512,recommended:!1},"voyage-large-2-instruct":{desc:"Instruction-optimized",dimensions:1024,recommended:!1},"voyage-code-2":{desc:"Optimized for code search",dimensions:1536,recommended:!1},"voyage-finance-2":{desc:"Financial domain specialist",dimensions:1024,recommended:!1},"voyage-law-2":{desc:"Legal domain specialist",dimensions:1024,recommended:!1},"voyage-multilingual-2":{desc:"Cross-lingual retrieval",dimensions:1024,recommended:!1}}},llmCrossEncoderDefaults:{openai:{"gpt-5-nano":{desc:"Latest nano model for reranking",recommended:!0},"gpt-4.1-nano":{desc:"Previous gen efficient model",recommended:!1},"gpt-3.5-turbo":{desc:"Legacy, very fast",recommended:!1}},gemini:{"gemini-2.5-flash-lite-preview-06-17":{desc:"Optimized for classification tasks",recommended:!0},"gemini-1.5-flash-8b":{desc:"Previous gen, still efficient",recommended:!1}}}};if(n!=null&&n.openrouterPresetSlug){const t=`@preset/${n.openrouterPresetSlug}`;e.llmDefaults.openrouter[t]={desc:"Models controlled by OpenRouter Preset",recommended:!0},e.llmSmallDefaults.openrouter[t]={desc:"Models controlled by OpenRouter Preset",recommended:!0}}return e}class Qp{constructor(e,t){this.suggestEl=null,this.app=e,this.inputEl=t,this.selectedItem=-1,this.suggestions=[],this.inputEl.addEventListener("input",this.onInputChanged.bind(this)),this.inputEl.addEventListener("focus",this.onInputChanged.bind(this)),this.inputEl.addEventListener("blur",this.close.bind(this)),this.inputEl.addEventListener("keydown",this.onInputKeydown.bind(this))}onInputChanged(){const e=this.inputEl.value,t=this.getSuggestions(e);if(!t||t.length===0){this.close();return}this.suggestions=t,this.selectedItem=-1,this.open(t)}onInputKeydown(e){const t=e;!this.suggestEl||this.suggestions.length===0||(t.key==="ArrowDown"?(this.selectedItem=Math.min(this.selectedItem+1,this.suggestions.length-1),this.setSelectedItem(this.selectedItem),e.preventDefault()):t.key==="ArrowUp"?(this.selectedItem=Math.max(this.selectedItem-1,-1),this.setSelectedItem(this.selectedItem),e.preventDefault()):t.key==="Enter"?this.selectedItem>=0&&(this.selectSuggestion(this.suggestions[this.selectedItem]),e.preventDefault()):t.key==="Escape"&&(this.close(),e.preventDefault()))}open(e){if(this.close(),e.length===0)return;this.suggestEl=document.createElement("div"),this.suggestEl.classList.add("suggestion-container"),this.suggestEl.style.cssText=`
            position: absolute;
            z-index: 1000;
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            min-width: 200px;
        `;const t=this.inputEl.getBoundingClientRect();this.suggestEl.style.top=`${t.bottom+4}px`,this.suggestEl.style.left=`${t.left}px`,this.suggestEl.style.width=`${t.width}px`,e.forEach((i,s)=>{var o;const r=document.createElement("div");r.classList.add("suggestion-item"),r.style.cssText=`
                padding: 8px 12px;
                cursor: pointer;
                border-bottom: 1px solid var(--background-modifier-border-hover);
            `,this.renderSuggestion(i,r),r.addEventListener("mousedown",a=>{a.preventDefault(),this.selectSuggestion(i)}),r.addEventListener("click",a=>{a.preventDefault(),this.selectSuggestion(i)}),r.addEventListener("mouseenter",()=>{this.setSelectedItem(s)}),(o=this.suggestEl)==null||o.appendChild(r)}),document.body.appendChild(this.suggestEl)}setSelectedItem(e){var i;const t=(i=this.suggestEl)==null?void 0:i.querySelectorAll(".suggestion-item");t&&(t.forEach((s,r)=>{r===e?(s.classList.add("is-selected"),s.style.background="var(--background-modifier-hover)"):(s.classList.remove("is-selected"),s.style.background="")}),this.selectedItem=e)}close(){this.suggestEl&&(this.suggestEl.remove(),this.suggestEl=null),this.selectedItem=-1}}class xn extends Qp{constructor(e,t){super(e,t)}getSuggestions(e){const t=this.app.vault.getAllLoadedFiles(),i=[],s=e.toLowerCase();return t.forEach(r=>{r instanceof P.TFolder&&r.path.toLowerCase().contains(s)&&i.push(r)}),i.slice(0,1e3)}renderSuggestion(e,t){t.setText(e.path)}selectSuggestion(e){this.inputEl.value=e.path;const t=new Event("input",{bubbles:!0}),i=new Event("change",{bubbles:!0});this.inputEl.dispatchEvent(t),this.inputEl.dispatchEvent(i),this.close()}}const Rt=tl.promisify(Nt.exec);class tn{static getInstance(){return tn.instance||(tn.instance=new tn),tn.instance}async getMCPServerProcesses(){const e=process.platform;try{return e==="win32"?await this.getWindowsProcesses():e==="darwin"?await this.getMacProcesses():await this.getLinuxProcesses()}catch(t){return console.error("[PROCESS-DETECTION] Failed to get MCP server processes:",t),[]}}async getWindowsProcesses(){var e;try{const t=`wmic process where "name='python.exe' and commandline like '%megamem_mcp_server.py%'" get ProcessId,ParentProcessId,CreationDate,CommandLine /format:list`,{stdout:i}=await Rt(t,{shell:"cmd.exe",windowsHide:!0,encoding:"utf8"}),s=[],r=i.split(/(\r\r\n){2,}/).filter(o=>o.trim()&&!o.match(/^(\r\r\n)+$/));for(const o of r){const a={};if(o.split(/\r\r\n/).forEach(l=>{const d=l.indexOf("=");if(d>0){const p=l.substring(0,d).trim(),g=l.substring(d+1).trim();p&&g&&(a[p]=g)}}),a.ProcessId&&a.ParentProcessId&&((e=a.CommandLine)!=null&&e.includes("megamem_mcp_server.py"))){const l=await this.getWindowsParentProcessName(a.ParentProcessId),d=this.formatWindowsDate(a.CreationDate);s.push({pid:a.ProcessId,parentName:l,createdAt:d,commandLine:a.CommandLine})}}return s}catch(t){return console.error("[PROCESS-DETECTION] Windows process detection failed:",t),[]}}async getWindowsParentProcessName(e){try{const t=`wmic process where "ProcessId=${e}" get Name /value`,{stdout:i}=await Rt(t,{shell:"cmd.exe",windowsHide:!0,encoding:"utf8"}),s=i.split(/\r?\n/);for(const r of s){const o=r.indexOf("=");if(o>0){const a=r.substring(0,o).trim(),l=r.substring(o+1).trim();if(a==="Name"&&l)return l.replace(".exe","")}}return"Unknown"}catch(t){return"Unknown"}}formatWindowsDate(e){if(!e||e.length<14)return"Unknown";try{const t=e.substring(0,4),i=e.substring(4,6),s=e.substring(6,8),r=e.substring(8,10),o=e.substring(10,12),a=e.substring(12,14);return new Date(`${t}-${i}-${s}T${r}:${o}:${a}`).toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0})}catch(t){return e}}async getMacProcesses(){try{const e="ps aux | grep megamem_mcp_server.py | grep -v grep",{stdout:t}=await Rt(e),i=t.split(`
`).filter(r=>r.trim()),s=[];for(const r of i){const o=r.trim().split(/\s+/);if(o.length>=11){const a=o[1],l=await this.getMacParentInfo(a);s.push({pid:a,parentName:l.name,createdAt:l.startTime,commandLine:o.slice(10).join(" ")})}}return s}catch(e){return console.error("[PROCESS-DETECTION] Mac process detection failed:",e),[]}}async getMacParentInfo(e){try{const{stdout:t}=await Rt(`ps -p ${e} -o ppid=,lstart=`),s=t.trim().split(/\s+/);if(s.length>=6){const r=s[0],o=s.slice(1).join(" "),{stdout:a}=await Rt(`ps -p ${r} -o comm=`);return{name:a.trim().replace(/^.*\//,"")||"Unknown",startTime:new Date(o).toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0})}}return{name:"Unknown",startTime:"Unknown"}}catch(t){return{name:"Unknown",startTime:"Unknown"}}}async getLinuxProcesses(){try{const e="ps aux | grep megamem_mcp_server.py | grep -v grep",{stdout:t}=await Rt(e),i=t.split(`
`).filter(r=>r.trim()),s=[];for(const r of i){const o=r.trim().split(/\s+/);if(o.length>=11){const a=o[1],l=await this.getLinuxParentInfo(a);s.push({pid:a,parentName:l.name,createdAt:l.startTime,commandLine:o.slice(10).join(" ")})}}return s}catch(e){return console.error("[PROCESS-DETECTION] Linux process detection failed:",e),[]}}async getLinuxParentInfo(e){try{const{stdout:t}=await Rt(`ps -p ${e} -o ppid=,lstart=`),s=t.trim().split(/\s+/);if(s.length>=6){const r=s[0],o=s.slice(1).join(" "),{stdout:a}=await Rt(`ps -p ${r} -o comm=`);return{name:a.trim()||"Unknown",startTime:new Date(o).toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0})}}return{name:"Unknown",startTime:"Unknown"}}catch(t){return{name:"Unknown",startTime:"Unknown"}}}}const Zp=process.platform==="win32"||navigator.userAgent.includes("Windows");class Xp{constructor(e="http://localhost:11434",t){this.downloadCallbacks=new Map,this.modelCache={models:[],timestamp:0,ttl:3e4},this.pendingModelRequest=null,this.baseUrl=e.replace(/\/$/,""),this.logger=t}async isServerRunning(){try{return(await P.requestUrl({url:`${this.baseUrl}/api/version`,method:"GET",headers:{"Content-Type":"application/json"}})).status===200}catch(e){if(this.logger.debug("[OLLAMA] Server not running, attempting recovery",{error:e}),await this.attemptServiceRecovery()){await new Promise(i=>setTimeout(i,2e3));try{if((await P.requestUrl({url:`${this.baseUrl}/api/version`,method:"GET",headers:{"Content-Type":"application/json"}})).status===200)return this.logger.info("[OLLAMA] Service recovery successful"),!0}catch(i){this.logger.debug("[OLLAMA] Retry after service recovery failed",{retryError:i})}}return!1}}async getAvailableModels(e=!1){const t=Date.now();if(!e&&this.modelCache.models.length>0&&t-this.modelCache.timestamp<this.modelCache.ttl)return this.modelCache.models;if(this.pendingModelRequest&&!e)return this.pendingModelRequest;this.pendingModelRequest=this._fetchModelsFromServer();try{return await this.pendingModelRequest}finally{this.pendingModelRequest=null}}async _fetchModelsFromServer(){const e=Date.now();try{const t=await P.requestUrl({url:`${this.baseUrl}/api/tags`,method:"GET",headers:{"Content-Type":"application/json"}});if(t.status!==200)throw new Error(`Failed to fetch models: ${t.status}`);const r=(t.json.models||[]).map(o=>o.name);return this.logger.debug("[OLLAMA] Fetched fresh model list from server",{rawCount:r.length,normalizedCount:r.length,serverUrl:this.baseUrl}),this.modelCache={models:r,timestamp:e,ttl:this.modelCache.ttl},r}catch(t){if(await this.attemptServiceRecovery()){await new Promise(s=>setTimeout(s,2e3));try{const s=await P.requestUrl({url:`${this.baseUrl}/api/tags`,method:"GET",headers:{"Content-Type":"application/json"}});if(s.status===200){const a=(s.json.models||[]).map(l=>l.name);return this.modelCache={models:a,timestamp:e,ttl:this.modelCache.ttl},a}}catch(s){}}return[]}}async getEmbeddingModelsWithStatus(e,t=!1){const i=await this.getAvailableModels(t),r=(Array.isArray(e)&&e.length>0?e:[...i]).map(a=>{const l=i.includes(a);return{name:a,available:l}}),o=r.find(a=>a.name==="nomic-embed-text"||a.name.startsWith("nomic-embed-text:"));return o&&this.logger.info(`[OLLAMA] nomic-embed-text availability: ${o.available}`),r}async downloadModel(e,t){var i;try{t&&this.downloadCallbacks.set(e,t);const s=await fetch(`${this.baseUrl}/api/pull`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!s.ok)throw new Error(`Download request failed: ${s.status}`);const r=(i=s.body)==null?void 0:i.getReader();if(!r)throw new Error("No response body reader available");let o=!1,a=!1;for(;!o;){const{done:l,value:d}=await r.read();if(l){o=!0;break}const g=new TextDecoder().decode(d).split(`
`).filter(m=>m.trim());for(const m of g)try{const h=JSON.parse(m);if(t&&t(h),h.error)throw this.logger.error("[OLLAMA] Download error detected",{error:h.error,modelName:e}),a=!0,new Error(`Download failed: ${h.error}`);h.status==="success"&&(o=!0)}catch(h){if(h instanceof Error&&h.message.includes("Download failed:"))throw h;this.logger.debug("[OLLAMA] Non-JSON progress line",{line:m})}}return this.downloadCallbacks.delete(e),a?(this.logger.error(`[OLLAMA] Model ${e} download failed due to detected errors`),!1):(this.logger.info(`[OLLAMA] Model ${e} downloaded successfully`),!0)}catch(s){return this.logger.error("[OLLAMA] Failed to download model",{modelName:e,error:s}),this.downloadCallbacks.delete(e),t&&t({status:`error: ${s instanceof Error?s.message:"Unknown error"}`}),!1}}clearModelCache(){this.modelCache={models:[],timestamp:0,ttl:this.modelCache.ttl}}async isModelAvailable(e){return(await this.getAvailableModels()).includes(e)}async _pollForModelAvailability(e,t=3e4,i=2e3){const s=Date.now(),r=e;for(;Date.now()-s<t;){if(await this.isModelAvailable(r))return this.logger.info(`[OLLAMA] Model ${r} is now available.`),!0;await new Promise(a=>setTimeout(a,i))}return this.logger.warn(`[OLLAMA] Model ${r} did not become available within timeout.`),!1}async isModelInstalled(e){return await this.isModelAvailable(e)}async downloadModelWithProgress(e,t){const i=await this.downloadModel(e,t);return i&&(this.clearModelCache(),await this._pollForModelAvailability(e,3e4,2e3)?t({status:"Model is now available for use"}):this.logger.warn(`[OLLAMA] Model ${e} downloaded but not showing as available`)),i}async checkServerStatus(){if(!await this.isServerRunning())return{running:!1};try{return{running:!0,modelCount:(await this.getAvailableModels()).length}}catch(t){return{running:!0}}}async startService(){return await this.isServerRunning()?{success:!0,message:"Ollama service is already running"}:await this.attemptServiceRecovery()?(await new Promise(s=>setTimeout(s,3e3)),await this.isServerRunning()?{success:!0,message:"Ollama service started successfully"}:{success:!1,message:"Service recovery attempted but Ollama is not responding"}):{success:!1,message:"Service recovery not available on this platform"}}async attemptServiceRecovery(){if(!Zp)return this.logger.debug("[OLLAMA] Service recovery not applicable on non-Windows platform"),!1;try{this.logger.info("[OLLAMA] Attempting Windows service recovery using PowerShell Start-Service");const{exec:e}=require("child_process");return new Promise(t=>{e('powershell.exe "Start-Service -Name ollama -ErrorAction SilentlyContinue"',{timeout:1e4},(s,r,o)=>{s?(this.logger.debug("[OLLAMA] PowerShell service start failed",{error:s.message,stderr:o}),e('powershell.exe "Start-Service -Name OllamaService -ErrorAction SilentlyContinue"',{timeout:1e4},l=>{l?this.logger.debug("[OLLAMA] Alternative service name also failed",{altError:l.message}):this.logger.info("[OLLAMA] Alternative service recovery command executed"),t(!0)})):(this.logger.info("[OLLAMA] Service recovery command executed successfully",{stdout:r.trim()}),t(!0))})})}catch(e){return this.logger.error("[OLLAMA] Service recovery attempt failed",{error:e}),!1}}}class eg{constructor(e,t){this.ollamaService=null,this.app=e,this.plugin=t}getOllamaService(){if(!this.ollamaService){let e=this.plugin.settings.ollamaBaseUrl||"http://localhost:11434";e=e.replace(/\/v1\/?$/,""),this.ollamaService=new Xp(e,this.plugin.logger)}return this.ollamaService}getOllamaLLMModelsFromSettings(){var e,t,i;try{const s=((e=this.plugin.settings.llmDefaults)==null?void 0:e.ollama)||{},r=Object.entries(s).map(([o,a])=>({name:o,description:a&&a.desc||"",recommended:!!(a&&a.recommended)}));return r.sort((o,a)=>Number(a.recommended)-Number(o.recommended)||o.name.localeCompare(a.name)),(t=this.plugin.logger)==null||t.debug("[OLLAMA-SETTINGS] Loaded Ollama LLM models from plugin.settings",{count:r.length}),r}catch(s){return(i=this.plugin.logger)==null||i.warn("[OLLAMA-SETTINGS] Failed to load Ollama LLM defaults from settings",{error:s}),[]}}getOllamaLLMSmallModelsFromSettings(){var e,t,i;try{const s=((e=this.plugin.settings.llmSmallDefaults)==null?void 0:e.ollama)||{},r=Object.entries(s).map(([o,a])=>({name:o,description:a&&a.desc||"",recommended:!!(a&&a.recommended)}));return r.sort((o,a)=>Number(a.recommended)-Number(o.recommended)||o.name.localeCompare(a.name)),(t=this.plugin.logger)==null||t.debug("[OLLAMA-SETTINGS] Loaded Ollama LLM Small models from plugin.settings",{count:r.length}),r}catch(s){return(i=this.plugin.logger)==null||i.warn("[OLLAMA-SETTINGS] Failed to load Ollama LLM Small defaults from settings",{error:s}),[]}}getOllamaEmbeddingModelsFromSettings(){var e,t,i;try{const s=((e=this.plugin.settings.embeddingDefaults)==null?void 0:e.ollama)||{},r=Object.entries(s).map(([o,a])=>({name:o,description:a&&a.desc||"",dimensions:a&&a.dimensions||void 0,recommended:!!(a&&a.recommended)}));return r.sort((o,a)=>Number(a.recommended)-Number(o.recommended)||o.name.localeCompare(a.name)),(t=this.plugin.logger)==null||t.debug("[OLLAMA-SETTINGS] Loaded Ollama embedding models from plugin.settings",{count:r.length}),r}catch(s){return(i=this.plugin.logger)==null||i.warn("[OLLAMA-SETTINGS] Failed to load Ollama embedding defaults from settings",{error:s}),[]}}getOllamaEmbeddingModelNamesFromSettings(){var e;try{return Object.keys(((e=this.plugin.settings.embeddingDefaults)==null?void 0:e.ollama)||{})}catch(t){return[]}}async addCustomOllamaLLMToDefaults(e){var t,i;try{this.plugin.settings.llmDefaults||(this.plugin.settings.llmDefaults={}),this.plugin.settings.llmDefaults.ollama||(this.plugin.settings.llmDefaults.ollama={}),this.plugin.settings.llmDefaults.ollama[e]||(this.plugin.settings.llmDefaults.ollama[e]={desc:"User added",recommended:!1},await this.plugin.saveSettings(),(t=this.plugin.logger)==null||t.info("[OLLAMA-SETTINGS] Added custom Ollama LLM to defaults",{modelName:e}))}catch(s){(i=this.plugin.logger)==null||i.error("[OLLAMA-SETTINGS] Failed to add custom Ollama LLM to defaults",{modelName:e,error:s})}}async addCustomOllamaEmbeddingToDefaults(e){var t,i;try{this.plugin.settings.embeddingDefaults||(this.plugin.settings.embeddingDefaults={}),this.plugin.settings.embeddingDefaults.ollama||(this.plugin.settings.embeddingDefaults.ollama={}),this.plugin.settings.embeddingDefaults.ollama[e]||(this.plugin.settings.embeddingDefaults.ollama[e]={desc:"User added",dimensions:this.plugin.settings.ollamaEmbeddingDim||768,recommended:!1},await this.plugin.saveSettings(),(t=this.plugin.logger)==null||t.info("[OLLAMA-SETTINGS] Added custom Ollama embedding to defaults",{modelName:e}))}catch(s){(i=this.plugin.logger)==null||i.error("[OLLAMA-SETTINGS] Failed to add custom Ollama embedding to defaults",{modelName:e,error:s})}}async isOllamaModelInstalled(e){var t;try{return await this.getOllamaService().isModelInstalled(e)}catch(i){return(t=this.plugin.logger)==null||t.error("[OLLAMA-SETTINGS] Failed to check Ollama model installation",{modelName:e,error:i}),!1}}async downloadOllamaModelWithProgress(e,t){var l;const i=this.getOllamaService();t.empty();const s=t.createDiv();s.createEl("div",{text:`[DOWNLOADING] ${e}...`});const r=s.createEl("div");r.style.cssText=`
			width: 100%;
			height: 6px;
			background-color: var(--background-modifier-border);
			border-radius: 3px;
			margin: 4px 0;
			overflow: hidden;
		`;const o=r.createEl("div");o.style.cssText=`
			height: 100%;
			background-color: var(--color-accent);
			transition: width 0.3s ease;
			width: 0%;
		`;const a=s.createEl("div");a.style.cssText=`
			font-size: 0.8em;
			color: var(--text-muted);
			margin-top: 2px;
		`;try{const d=await i.downloadModelWithProgress(e,p=>{const g=Math.round((p.completed||0)/(p.total||1)*100)||0;o.style.width=`${g}%`,a.textContent=`${g}% - ${p.status||"Downloading..."}`});t.empty(),d?(t.createDiv().createEl("div",{text:`[SUCCESS] ${e} installed successfully!`,attr:{style:"color: var(--color-green);"}}),setTimeout(()=>t.empty(),3e3)):t.createEl("div",{text:"[ERROR] Download failed",attr:{style:"color: var(--color-red);"}})}catch(d){(l=this.plugin.logger)==null||l.error("[OLLAMA-SETTINGS] Ollama model download failed",{error:d}),t.empty();const p=d instanceof Error?d.message:"Unknown error";t.createEl("div",{text:`[ERROR] Download failed: ${p}`,attr:{style:"color: var(--color-red);"}})}}async populateOllamaModelsWithStatus(e){var i;const t=this.getOllamaService();try{if(!await t.isServerRunning()){e.addOption("","[Ollama server not running]");return}const r=this.getOllamaEmbeddingModelNamesFromSettings();(await t.getEmbeddingModelsWithStatus(r)).forEach(a=>{const l=a.name;e.addOption(a.name,l)})}catch(s){(i=this.plugin.logger)==null||i.error("[OLLAMA-SETTINGS] Failed to load Ollama models with status",{error:s}),e.addOption("","[Error loading models]")}}async handleOllamaModelSelection(e,t){var i;if(e)try{await this.getOllamaService().isModelAvailable(e)?t.empty():confirm(`Model "${e}" is not installed.

Would you like to download it now?`)&&await this.downloadOllamaModelWithProgress(e,t)}catch(s){(i=this.plugin.logger)==null||i.error("[OLLAMA-SETTINGS] Error handling Ollama model selection",{error:s}),t.empty(),t.createEl("div",{text:"[ERROR] Failed to check model availability",attr:{style:"color: var(--color-red);"}})}}async updateModelStatusIconForDropdown(e,t,i){var s;if(i)try{e.innerHTML="";const r=await this.isOllamaModelInstalled(i),o=e.createDiv();o.style.cssText="display:inline-flex; align-items:center; gap:6px; font-size:0.9em; padding:4px 6px; border-radius:4px;";const a=o.createSpan();P.setIcon(a,r?"check-circle":"download"),a.style.color=r?"var(--color-green)":"var(--color-orange)",a.style.cursor=r?"default":"pointer";const l=o.createSpan();if(l.textContent=r?"Available":"Not installed",l.style.color=r?"var(--color-green)":"var(--color-orange)",!r){const d=async p=>{var g;p.stopPropagation(),p.preventDefault();try{if(!confirm('[CONFIRM] Model "'+i+'" is not installed.\\n\\nWould you like to download it now?'))return;await this.downloadOllamaModelWithProgress(i,e),setTimeout(async()=>{await this.updateModelStatusIconForDropdown(e,t,i)},800),await this.isOllamaModelInstalled(i)&&(t==="embedding"?await this.addCustomOllamaEmbeddingToDefaults(i):await this.addCustomOllamaLLMToDefaults(i))}catch(m){(g=this.plugin.logger)==null||g.error("[OLLAMA-SETTINGS] download handler failed",{modelName:i,err:m}),new P.Notice("[ERROR] Failed to download model")}};a.addEventListener("click",d),l.addEventListener("click",d)}}catch(r){(s=this.plugin.logger)==null||s.error(`[OLLAMA-SETTINGS] Failed to update status icon for ${i}`,{error:r})}}async refreshOllamaStatus(e,t){var i,s;if(this.plugin.settings.ollamaEnabled)try{e.innerHTML="",e.style.backgroundColor="";const o=await this.getOllamaService().checkServerStatus();if(o.running){const a=o.modelCount||0;e.style.backgroundColor="var(--color-green-bg)",e.style.color="var(--color-green)",e.innerHTML=`
					<div style="display: flex; align-items: center; gap: 6px;">
						<span>[INSTALLED]</span>
						<span>Ollama is running with ${a} model(s)</span>
					</div>
					<div style="font-size: 0.8em; margin-top: 4px; opacity: 0.8;">
						Server available at ${this.plugin.settings.ollamaBaseUrl||"http://localhost:11434"}
					</div>
				`,t.textContent="Upgrade Ollama",t.style.backgroundColor="var(--interactive-accent)",(i=this.plugin.logger)==null||i.debug("[OLLAMA-SETTINGS] Installation detected successfully",{modelCount:a})}else{e.style.backgroundColor="var(--color-orange-bg)",e.style.color="var(--color-orange)",e.innerHTML=`
					<div style="display: flex; align-items: center; gap: 6px;">
						<span>[NOT RUNNING]</span>
						<span>Ollama is not running or not installed</span>
					</div>
					<div style="font-size: 0.8em; margin-top: 4px; opacity: 0.8;">
						Try starting the service or install Ollama if not present
					</div>
				`;const a=e.createDiv();a.style.cssText="margin-top: 8px; display: flex; gap: 8px; align-items: center;";const l=a.createEl("button",{text:"Start Service",cls:"mod-cta"});l.style.fontSize="0.8em",l.style.padding="4px 8px",l.onclick=async()=>{await this.startOllamaService(e,t)},t.textContent="Install/Reinstall Ollama",t.style.backgroundColor="var(--color-orange)"}}catch(r){(s=this.plugin.logger)==null||s.debug("[OLLAMA-SETTINGS] Status check failed",{error:r}),e.style.backgroundColor="var(--color-red-bg)",e.style.color="var(--color-red)",e.innerHTML=`
				<div style="display: flex; align-items: center; gap: 6px;">
					<span>[ERROR]</span>
					<span>Unable to check Ollama status</span>
				</div>
				<div style="font-size: 0.8em; margin-top: 4px; opacity: 0.8;">
					Check installation or network connection
				</div>
			`,t.textContent="Install Ollama",t.style.backgroundColor="var(--interactive-accent)"}}async startOllamaService(e,t){var i,s;try{(i=this.plugin.logger)==null||i.debug("[OLLAMA-SETTINGS] Attempting to start Ollama service");const r=e.createDiv();r.style.cssText=`
				margin-top: 8px;
				padding: 6px;
				background: var(--color-blue-bg);
				color: var(--color-blue);
				border-radius: 4px;
				font-size: 0.8em;
			`,r.textContent="[STARTING] Attempting to start Ollama service...";const a=await this.getOllamaService().startService();if(r.remove(),a.success)await new Promise(l=>setTimeout(l,2e3)),await this.refreshOllamaStatus(e,t),new P.Notice("[SUCCESS] Ollama service started successfully");else{const l=e.createDiv();l.style.cssText=`
					margin-top: 8px;
					padding: 6px;
					background: var(--color-red-bg);
					color: var(--color-red);
					border-radius: 4px;
					font-size: 0.8em;
				`,l.innerHTML=`
					<div>[FAILED] Could not start Ollama service</div>
					<div style="margin-top: 4px; opacity: 0.8;">${a.message||"Try restarting your computer or reinstalling Ollama"}</div>
				`,new P.Notice(`[ERROR] Failed to start Ollama service - ${a.message||"try restarting your computer"}`)}}catch(r){(s=this.plugin.logger)==null||s.error("[OLLAMA-SETTINGS] Service recovery failed",{error:r}),new P.Notice("[ERROR] Failed to start Ollama service - operation failed")}}async handleOllamaInstallation(){var e,t;try{(e=this.plugin.logger)==null||e.debug("[OLLAMA-SETTINGS] Opening Ollama installation page");const{shell:i}=require("electron");await i.openExternal("https://ollama.com/download"),new P.Notice("[INFO] Ollama website opened - Download and install, then restart this app",8e3),this.showOllamaInstallationModal()}catch(i){(t=this.plugin.logger)==null||t.error("[OLLAMA-SETTINGS] Failed to open installation page",{error:i}),new P.Notice("[ERROR] Could not open Ollama website - please visit https://ollama.com/download manually")}}showOllamaInstallationModal(){const e=document.createElement("div");e.style.cssText=`
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
		`;const t=document.createElement("div");t.style.cssText=`
			background: var(--background-primary);
			border: 1px solid var(--background-modifier-border);
			border-radius: 8px;
			padding: 24px;
			max-width: 500px;
			width: 90%;
			max-height: 80%;
			overflow: auto;
		`,t.innerHTML=`
			<h3 style="margin: 0 0 16px 0; color: var(--text-accent);">Ollama Installation Instructions</h3>

			<div style="margin-bottom: 16px;">
				<h4 style="margin: 0 0 8px 0;">Step 1: Download Ollama</h4>
				<p style="margin: 0 0 8px 0; font-size: 0.9em; color: var(--text-muted);">
					The Ollama website should now be open in your browser. Download the installer for your operating system.
				</p>
			</div>

			<div style="margin-bottom: 16px;">
				<h4 style="margin: 0 0 8px 0;">Step 2: Install and Restart</h4>
				<p style="margin: 0 0 8px 0; font-size: 0.9em; color: var(--text-muted);">
					Run the installer and follow the prompts. After installation, restart Obsidian completely.
				</p>
			</div>

			<div style="margin-bottom: 16px;">
				<h4 style="margin: 0 0 8px 0;">Step 3: Verify Installation</h4>
				<p style="margin: 0 0 8px 0; font-size: 0.9em; color: var(--text-muted);">
					Return to this settings page and click "Refresh Status" to verify Ollama is running.
				</p>
			</div>

			<div style="background: var(--background-secondary); padding: 12px; border-radius: 6px; margin-bottom: 16px;">
				<p style="margin: 0; font-size: 0.85em; color: var(--text-muted);">
					<strong>Note:</strong> Ollama runs completely on your local machine. No data is sent to external servers, ensuring full privacy for your AI interactions.
				</p>
			</div>

			<div style="display: flex; gap: 12px; justify-content: flex-end;">
				<button id="ollama-modal-close" style="padding: 8px 16px; border: 1px solid var(--background-modifier-border); background: var(--background-primary); border-radius: 4px; cursor: pointer;">
					Close
				</button>
			</div>
		`,e.appendChild(t);const i=t.querySelector("#ollama-modal-close");i.onclick=()=>document.body.removeChild(e),e.onclick=s=>{s.target===e&&document.body.removeChild(e)},document.body.appendChild(e)}async addCustomLLMModelEntry(e){const t=new P.Setting(e).setName("Custom LLM Model").setDesc("Download any Ollama LLM model by name (e.g., llama3.2:3b, codellama:13b)");let i,s,r;const o=t.settingEl.createDiv();o.style.cssText=`
			margin-top: 8px;
			padding: 8px;
			border-radius: 4px;
			font-size: 0.9em;
			min-height: 20px;
		`,t.addText(a=>{i=a.inputEl,a.setPlaceholder("Enter model name (e.g., llama3.2:3b)").onChange(l=>{const d=!!l.trim();r&&typeof r.setDisabled=="function"?r.setDisabled(!d):s&&(s.disabled=!d)})}),t.addButton(a=>{r=a,s=a.buttonEl,a.setButtonText(" Download").setTooltip("Download this model from Ollama registry").setDisabled(!0).onClick(async()=>{var d,p,g;const l=((i==null?void 0:i.value)||"").trim();if(!l){new P.Notice("[ERROR] Please enter a model name");return}try{(d=this.plugin.logger)==null||d.info("[OLLAMA-SETTINGS] Custom LLM download requested",{modelName:l}),r==null||r.setDisabled(!0),o.empty(),o.createEl("div",{text:`[START] Downloading ${l}...`});const m=this.getOllamaService();if(await m.isModelAvailable(l)){new P.Notice(`[INFO] Model ${l} is already installed`),o.empty(),o.createEl("div",{text:`[INFO] ${l} already available`});return}await this.downloadOllamaModelWithProgress(l,o);try{await m.isModelAvailable(l)&&(await this.addCustomOllamaLLMToDefaults(l),await this.refreshLLMDropdowns(),new P.Notice(`[SUCCESS] ${l} downloaded and added to LLM models.`))}catch(b){(p=this.plugin.logger)==null||p.warn("[OLLAMA-SETTINGS] Post-download availability check failed",{error:b,modelName:l})}i.value="",r==null||r.setDisabled(!0)}catch(m){(g=this.plugin.logger)==null||g.error("[OLLAMA-SETTINGS] Download failed",{error:m,modelName:l});const h=m instanceof Error?m.message:"Unknown error";new P.Notice(`[ERROR] Failed to download ${l}: ${h}`)}finally{const m=!!((i==null?void 0:i.value)||"").trim();r==null||r.setDisabled(!m)}})})}async addCustomEmbeddingModelEntry(e){const t=new P.Setting(e).setName("Custom Embedding Model").setDesc("Download any Ollama embedding model by name (e.g., nomic-embed-text, mxbai-embed-large)");let i,s,r;const o=t.settingEl.createDiv();o.style.cssText=`
			margin-top: 8px;
			padding: 8px;
			border-radius: 4px;
			font-size: 0.9em;
			min-height: 20px;
		`,t.addText(a=>{i=a.inputEl,a.setPlaceholder("Enter embedding model name").onChange(l=>{const d=!!l.trim();r&&typeof r.setDisabled=="function"?r.setDisabled(!d):s&&(s.disabled=!d)})}),t.addButton(a=>{r=a,s=a.buttonEl,a.setButtonText(" Download").setTooltip("Download this embedding model from Ollama registry").setDisabled(!0).onClick(async()=>{var d,p,g;const l=((i==null?void 0:i.value)||"").trim();if(!l){new P.Notice("[ERROR] Please enter a model name");return}try{(d=this.plugin.logger)==null||d.info("[OLLAMA-SETTINGS] Custom embedding download requested",{modelName:l}),r==null||r.setDisabled(!0),o.empty(),o.createEl("div",{text:`[START] Downloading ${l}...`});const m=this.getOllamaService();if(await m.isModelAvailable(l)){new P.Notice(`[INFO] Model ${l} is already installed`),o.empty(),o.createEl("div",{text:`[INFO] ${l} already available`});return}await this.downloadOllamaModelWithProgress(l,o);try{await m.isModelAvailable(l)&&(await this.addCustomOllamaEmbeddingToDefaults(l),await this.refreshEmbeddingDropdowns(),new P.Notice(`[SUCCESS] ${l} downloaded and added to embedding models.`))}catch(b){(p=this.plugin.logger)==null||p.warn("[OLLAMA-SETTINGS] Post-download availability check failed",{error:b,modelName:l})}i.value="",r==null||r.setDisabled(!0)}catch(m){(g=this.plugin.logger)==null||g.error("[OLLAMA-SETTINGS] Download failed",{error:m,modelName:l});const h=m instanceof Error?m.message:"Unknown error";new P.Notice(`[ERROR] Failed to download ${l}: ${h}`)}finally{const m=!!((i==null?void 0:i.value)||"").trim();r==null||r.setDisabled(!m)}})})}async refreshEmbeddingDropdowns(){var e,t;try{await this.getOllamaService().getAvailableModels(!0);const s=document.querySelectorAll("select");for(const r of s){const o=r.closest(".setting-item");if(o){const a=o.querySelector(".setting-item-name");a&&((e=a.textContent)!=null&&e.toLowerCase().includes("embedding"))&&await this.populateOllamaModelsWithStatus(r)}}}catch(i){(t=this.plugin.logger)==null||t.debug("[OLLAMA-SETTINGS] Error refreshing embedding dropdowns",{error:i})}}async refreshLLMDropdowns(){var e,t,i,s;try{await this.getOllamaService().getAvailableModels(!0);const o=document.querySelectorAll("select");for(const a of o){const l=a.closest(".setting-item");if(l){const d=l.querySelector(".setting-item-name");if(d&&((e=d.textContent)!=null&&e.toLowerCase().includes("llm")||(t=d.textContent)!=null&&t.toLowerCase().includes("model"))&&!((i=d.textContent)!=null&&i.toLowerCase().includes("embedding"))){const p=Array.from(a.options),g=a.value;a.innerHTML="",this.getOllamaLLMModelsFromSettings().forEach(h=>{const b=document.createElement("option");b.value=h.name,b.textContent=h.name,a.appendChild(b)}),Array.from(a.options).some(h=>h.value===g)&&(a.value=g)}}}}catch(r){(s=this.plugin.logger)==null||s.debug("[OLLAMA-SETTINGS] Error refreshing LLM dropdowns",{error:r})}}}class tg{constructor(e,t){this.app=e,this.plugin=t}addMCPToolsAccordion(e){var t;try{e.createEl("p",{text:"Configure MCP (Model Context Protocol) tools integration, default note folders, and third-party plugin connections.",cls:"setting-item-description"}),this.addMCPDefaultsSection(e),this.addMCPIntegrationsSection(e),this.addMCPToolDefinitionsSection(e)}catch(i){(t=this.plugin.logger)==null||t.error("Critical error in MCP Tools accordion",{error:i instanceof Error?i.message:String(i),stack:i instanceof Error?i.stack:void 0}),e.createEl("div",{text:`MCP Tools section failed to load: ${i instanceof Error?i.message:"Unknown error"}`,cls:"setting-item-description"})}}addMCPDefaultsSection(e){var t;try{e.createEl("h4",{text:"Defaults",cls:"setting-item-name"}),new P.Setting(e).setName("Default folder for MCP notes").setDesc("Default folder where MCP-generated notes will be created. Start typing to see folder suggestions.").addSearch(i=>{var s,r,o;try{new xn(this.app,i.inputEl),i.setPlaceholder("e.g., MCP Notes, Knowledge/MCP, or leave empty for vault root").setValue(((r=(s=this.plugin.settings.mcpTools)==null?void 0:s.defaults)==null?void 0:r.inboxFolder)||"").onChange(async a=>{var l;try{this.plugin.settings.mcpTools||(this.plugin.settings.mcpTools={defaults:{inboxFolder:"",enableSmartFolderResolution:!0},integrations:{templater:{detected:!1,enabled:!1,useTemplateFolders:!1},periodicNotes:{detected:!1,enabled:!1,usePeriodicFolders:!1}},tools:[]}),this.plugin.settings.mcpTools.defaults||(this.plugin.settings.mcpTools.defaults={inboxFolder:"",enableSmartFolderResolution:!0}),this.plugin.settings.mcpTools.defaults.inboxFolder=a,await this.plugin.saveSettings()}catch(d){(l=this.plugin.logger)==null||l.error("Error saving MCP default folder setting",{error:d})}})}catch(a){(o=this.plugin.logger)==null||o.error("Error setting up folder search input",{error:a})}})}catch(i){(t=this.plugin.logger)==null||t.error("Error in Defaults section",{error:i instanceof Error?i.message:String(i)}),e.createEl("div",{text:"Error loading Defaults section",cls:"setting-item-description"})}}addMCPIntegrationsSection(e){var t,i,s,r,o,a,l,d,p;try{e.createEl("h4",{text:"3rd Party Integrations",cls:"setting-item-name"});try{const g=!!this.app.plugins.plugins["templater-obsidian"],m=((s=(i=(t=this.plugin.settings.mcpTools)==null?void 0:t.integrations)==null?void 0:i.templater)==null?void 0:s.enabled)||!1,h=new P.Setting(e).setName("Templater Plugin Integration").setDesc("Integrate with Templater plugin for enhanced note creation"),b=h.nameEl.createSpan({cls:"mcp-status-icon",text:g?" ":" "});b.style.cssText=`
					color: ${g?"var(--color-green)":"var(--color-red)"};
					font-weight: bold;
					margin-right: 4px;
				`,h.addToggle(c=>{c.setValue(m).setDisabled(!g).onChange(async v=>{var w,_;try{this.plugin.settings.mcpTools||(this.plugin.settings.mcpTools={defaults:{inboxFolder:"",enableSmartFolderResolution:!0},integrations:{templater:{detected:!1,enabled:!1,useTemplateFolders:!1},periodicNotes:{detected:!1,enabled:!1,usePeriodicFolders:!1}},tools:[]}),this.plugin.settings.mcpTools.integrations.templater.enabled=v,await this.plugin.saveSettings(),(w=this.plugin.logger)==null||w.debug("Templater integration toggled",{enabled:v})}catch(C){(_=this.plugin.logger)==null||_.error("Failed to save Templater setting",{error:C})}})}),g||h.descEl.appendText(" (Plugin not detected - install Templater to enable this integration)")}catch(g){(r=this.plugin.logger)==null||r.error("Error setting up Templater integration",{error:g})}try{const g=!!this.app.plugins.plugins["periodic-notes"],m=((l=(a=(o=this.plugin.settings.mcpTools)==null?void 0:o.integrations)==null?void 0:a.periodicNotes)==null?void 0:l.enabled)||!1,h=new P.Setting(e).setName("Periodic Notes Plugin Integration").setDesc("Integrate with Periodic Notes plugin for time-based note organization"),b=h.nameEl.createSpan({cls:"mcp-status-icon",text:g?" ":" "});b.style.cssText=`
					color: ${g?"var(--color-green)":"var(--color-red)"};
					font-weight: bold;
					margin-right: 4px;
				`,h.addToggle(c=>{c.setValue(m).setDisabled(!g).onChange(async v=>{var w,_;try{this.plugin.settings.mcpTools||(this.plugin.settings.mcpTools={defaults:{inboxFolder:"",enableSmartFolderResolution:!0},integrations:{templater:{detected:!1,enabled:!1,useTemplateFolders:!1},periodicNotes:{detected:!1,enabled:!1,usePeriodicFolders:!1}},tools:[]}),this.plugin.settings.mcpTools.integrations.periodicNotes.enabled=v,await this.plugin.saveSettings(),(w=this.plugin.logger)==null||w.debug("Periodic Notes integration toggled",{enabled:v})}catch(C){(_=this.plugin.logger)==null||_.error("Failed to save Periodic Notes setting",{error:C})}})}),g||h.descEl.appendText(" (Plugin not detected - install Periodic Notes to enable this integration)")}catch(g){(d=this.plugin.logger)==null||d.error("Error setting up Periodic Notes integration",{error:g})}}catch(g){(p=this.plugin.logger)==null||p.error("Error in 3rd Party Integrations section",{error:g instanceof Error?g.message:String(g)}),e.createEl("div",{text:"Error loading 3rd Party Integrations section",cls:"setting-item-description"})}}addMCPToolDefinitionsSection(e){var t;try{e.createEl("h4",{text:"Tool Definitions",cls:"setting-item-name"}),new P.Setting(e).setName("Available MCP Tools").setDesc("Currently available MCP tools from megamem_mcp_server.py");const i=e.createDiv("mcp-tools-display");i.style.cssText=`
				margin: 16px 0;
				border: 1px solid var(--background-modifier-border);
				border-radius: 6px;
				max-height: 400px;
				overflow-y: auto;
			`;const s=i.createDiv();s.style.cssText=`
				background: var(--background-modifier-hover);
				padding: 8px 12px;
				font-weight: 600;
				border-bottom: 1px solid var(--background-modifier-border);
			`,s.textContent="Graphiti Memory Tools (9 tools)",[{name:"add_memory",description:"Add a memory/episode to the graph (aliases: mm, megamem, memory)"},{name:"search_memory_nodes",description:"Search for nodes in the memory graph (aliases: mm, megamem, memory)"},{name:"search_memory_facts",description:"Search for facts/relationships in the memory graph (aliases: mm, megamem, memory)"},{name:"get_episodes",description:"Get episodes from the memory graph (aliases: mm, megamem, memory)"},{name:"clear_graph",description:"Clear the entire memory graph (aliases: mm, megamem, memory)"},{name:"get_entity_edge",description:"Get entity edges from the graph (aliases: mm, megamem, memory)"},{name:"delete_entity_edge",description:"Delete entity edges from the graph (aliases: mm, megamem, memory)"},{name:"delete_episode",description:"Delete an episode from the graph (aliases: mm, megamem, memory)"},{name:"list_group_ids",description:"List all available group IDs (namespaces) in the vault (aliases: mm, megamem, memory)"}].forEach(l=>{const d=i.createDiv();d.style.cssText=`
					padding: 8px 12px;
					border-bottom: 1px solid var(--background-modifier-border-hover);
				`;const p=d.createDiv();p.style.cssText=`
					font-weight: 500;
					color: var(--text-accent);
					font-family: var(--font-monospace);
					font-size: 13px;
				`,p.textContent=l.name;const g=d.createDiv();g.style.cssText=`
					font-size: 12px;
					color: var(--text-muted);
					margin-top: 2px;
				`,g.textContent=l.description});const o=i.createDiv();o.style.cssText=`
				background: var(--background-modifier-hover);
				padding: 8px 12px;
				font-weight: 600;
				border-bottom: 1px solid var(--background-modifier-border);
				margin-top: 4px;
			`,o.textContent="Obsidian Vault Tools (7 tools)",[{name:"search_obsidian_notes",description:"Search for notes in Obsidian vault by filename and/or content (aliases: mv, my vault, obsidian)"},{name:"read_obsidian_note",description:"Read a specific note from Obsidian (aliases: mv, my vault, obsidian)"},{name:"update_obsidian_note",description:"Update content of an existing note (aliases: mv, my vault, obsidian)"},{name:"create_obsidian_note",description:"Create a new note in Obsidian (aliases: mv, my vault, obsidian)"},{name:"list_obsidian_vaults",description:"List all available Obsidian vaults (aliases: mv, my vault, obsidian)"},{name:"explore_vault_folders",description:"Explore folder structure in an Obsidian vault (query by natural language or path)"},{name:"create_note_with_template",description:"Create a new note using a templater template (fuzzy-match) in the vault"}].forEach(l=>{const d=i.createDiv();d.style.cssText=`
					padding: 8px 12px;
					border-bottom: 1px solid var(--background-modifier-border-hover);
				`;const p=d.createDiv();p.style.cssText=`
					font-weight: 500;
					color: var(--text-accent);
					font-family: var(--font-monospace);
					font-size: 13px;
				`,p.textContent=l.name;const g=d.createDiv();g.style.cssText=`
					font-size: 12px;
					color: var(--text-muted);
					margin-top: 2px;
				`,g.textContent=l.description})}catch(i){(t=this.plugin.logger)==null||t.error("Error in Tool Definitions section",{error:i instanceof Error?i.message:String(i)}),e.createEl("div",{text:"Error loading Tool Definitions section",cls:"setting-item-description"})}}async autoDetectPlugins(){var e,t,i;try{(e=this.plugin.logger)==null||e.debug("Running auto-detection for all plugins");const s=this.app.vault.adapter,r=s==null?void 0:s.basePath,o=!!this.app.plugins.plugins["templater-obsidian"],a=!!this.app.plugins.plugins["periodic-notes"];this.ensureMCPToolsSettings(),this.plugin.settings.mcpTools.integrations.templater.detected=o,this.plugin.settings.mcpTools.integrations.periodicNotes.detected=a,await this.plugin.saveSettings(),(t=this.plugin.logger)==null||t.debug("Auto-detection completed",{templater:o,periodicNotes:a})}catch(s){(i=this.plugin.logger)==null||i.error("Auto-detection failed",{error:s})}}isPluginDetected(e){var t,i,s,r;try{return((s=(i=(t=this.plugin.settings.mcpTools)==null?void 0:t.integrations)==null?void 0:i[e])==null?void 0:s.detected)||!1}catch(o){return(r=this.plugin.logger)==null||r.error("Error checking plugin detection status",{pluginName:e,error:o}),!1}}ensureMCPToolsSettings(){var e,t;try{this.plugin.settings.mcpTools||(this.plugin.settings.mcpTools={defaults:{inboxFolder:"",enableSmartFolderResolution:!0},integrations:{templater:{detected:!1,enabled:!1,useTemplateFolders:!1},periodicNotes:{detected:!1,enabled:!1,usePeriodicFolders:!1}},tools:[]}),this.plugin.settings.mcpTools.defaults||(this.plugin.settings.mcpTools.defaults={inboxFolder:"",enableSmartFolderResolution:!0}),this.plugin.settings.mcpTools.integrations||(this.plugin.settings.mcpTools.integrations={templater:{detected:!1,enabled:!1,useTemplateFolders:!1},periodicNotes:{detected:!1,enabled:!1,usePeriodicFolders:!1}}),this.plugin.settings.mcpTools.tools||(this.plugin.settings.mcpTools.tools=[]),(e=this.plugin.logger)==null||e.debug("MCP tools settings structure ensured")}catch(i){(t=this.plugin.logger)==null||t.error("Error ensuring MCP tools settings",{error:i})}}}class ng extends P.Modal{constructor(e,t,i,s){super(e),this.isInstalling=!1,this.useUv=!0,this.installer=i,this.plugin=t,this.onComplete=s,this.logger=new Gt(t,!1)}async onOpen(){const{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Python Dependencies Status"}),this.statusEl=e.createDiv({cls:"dependency-status-container"});const t=await this.installer.checkAllDependencies();this.displayStatus(t);const i=e.createDiv({cls:"dependency-log-container"});i.createEl("h3",{text:"Installation Log"}),this.logEl=i.createEl("textarea",{cls:"dependency-log-content",attr:{readonly:"true",rows:"10"}});const s=e.createDiv({cls:"dependency-install-options"});s.createEl("h3",{text:"Installation Method"});const r=s.createDiv({cls:"dependency-radio-option"});r.createEl("input",{type:"radio",attr:{name:"install-method",value:"uv",checked:"checked"}}).addEventListener("change",()=>{this.useUv=!0}),r.createEl("label",{text:" Install with UV Package Manager"});const a=s.createDiv({cls:"dependency-radio-option"});a.createEl("input",{type:"radio",attr:{name:"install-method",value:"system"}}).addEventListener("change",()=>{this.useUv=!1}),a.createEl("label",{text:" Install with System Python"}),s.createDiv({cls:"dependency-option-desc"}).setText("UV recommended for most users. System Python is more for developers");const p=e.createDiv({cls:"dependency-button-container"});this.installButton=p.createEl("button",{text:"Install Dependencies",cls:"mod-cta"}),this.installButton.addEventListener("click",()=>this.handleInstall()),p.createEl("button",{text:"Close"}).addEventListener("click",()=>this.close()),this.addCustomStyles()}displayStatus(e){if(!this.statusEl)return;if(this.statusEl.empty(),[{label:"System Python",status:e.systemPython?"[OK]":"[X]",detail:e.systemPython?`${e.systemPython.version} at ${e.systemPython.path}`:"Not found",success:!!e.systemPython},{label:"UV Package Manager",status:e.uvInstalled?"[OK]":"[X]",detail:e.uvInstalled?"Installed":"Not installed",success:e.uvInstalled},{label:"Virtual Environment",status:e.venvExists?"[OK]":"[X]",detail:e.venvExists?e.venvPath:"Not created",success:e.venvExists},{label:"Graphiti Dependencies",status:e.graphitiInstalled?"[OK]":"[X]",detail:e.graphitiInstalled?e.graphitiVersion?`v${e.graphitiVersion}`:"Installed":"Not installed",success:e.graphitiInstalled}].forEach(i=>{const s=this.statusEl.createDiv({cls:"dependency-status-item"});s.createSpan({text:i.status,cls:i.success?"status-success":"status-error"}),s.createSpan({text:` ${i.label}: `,cls:"dependency-label"}),s.createSpan({text:i.detail,cls:"dependency-detail"})}),e.mismatch.detected){const i=this.statusEl.createDiv({cls:"dependency-warning"});i.createSpan({text:"[WARNING] "}),i.createSpan({text:e.mismatch.description})}}async handleInstall(){if(this.isInstalling)return;this.isInstalling=!0,this.installButton&&(this.installButton.disabled=!0,this.installButton.setText("Installing..."));const e=this.useUv?"uv":"system";this.addLog(`[INFO] Starting installation using ${e}...`);try{await this.installer.installDependencies(e,(s,r)=>{this.addLog(`[INFO] ${s} (${r}%)`)}),this.addLog("[SUCCESS] Installation complete!");const t=this.installer.getPythonExecutable();this.plugin.settings.pythonPath=t,await this.plugin.saveSettings(),this.logger.info("[INSTALL] Saved Python path to settings",{pythonPath:t});const i=await this.installer.checkAllDependencies();this.displayStatus(i),this.addLog("[INFO] Settings updated - close and reopen Settings tab to see changes")}catch(t){const i=t instanceof Error?t.message:String(t);this.addLog(`[ERROR] Installation failed: ${i}`),this.logger.error("Installation failed",t)}finally{this.isInstalling=!1,this.installButton&&(this.installButton.disabled=!1,this.installButton.setText("Install Dependencies"))}}addLog(e){if(!this.logEl)return;const i=`[${new Date().toLocaleTimeString()}] ${e}
`;this.logEl.value+=i,this.logEl.scrollTop=this.logEl.scrollHeight}addCustomStyles(){const e=document.createElement("style");e.textContent=`
			.dependency-status-container {
				margin: 20px 0;
				padding: 15px;
				background-color: var(--background-secondary);
				border-radius: 4px;
			}

			.dependency-status-item {
				margin: 8px 0;
				font-family: var(--font-monospace);
				font-size: 13px;
			}

			.status-success {
				color: var(--text-success);
				font-weight: 600;
			}

			.status-error {
				color: var(--text-error);
				font-weight: 600;
			}

			.dependency-label {
				font-weight: 500;
				color: var(--text-normal);
			}

			.dependency-detail {
				color: var(--text-muted);
			}

			.dependency-warning {
				margin-top: 15px;
				padding: 10px;
				background-color: var(--background-modifier-error);
				border-radius: 4px;
				color: var(--text-warning);
				font-size: 13px;
			}

			.dependency-install-options {
				margin: 20px 0;
				padding: 15px;
				background-color: var(--background-secondary);
				border-radius: 4px;
			}

			.dependency-install-options h3 {
				margin: 0 0 10px 0;
				font-size: 14px;
				font-weight: 600;
			}

			.dependency-radio-option {
				margin: 8px 0;
				display: flex;
				align-items: center;
				font-size: 13px;
			}

			.dependency-radio-option input[type="radio"] {
				margin-right: 8px;
				cursor: pointer;
			}

			.dependency-radio-option label {
				cursor: pointer;
				user-select: none;
			}

			.dependency-option-desc {
				margin-top: 10px;
				padding: 8px;
				font-size: 12px;
				color: var(--text-muted);
				background-color: var(--background-primary);
				border-radius: 4px;
			}

			.dependency-log-container {
				margin-top: 20px;
			}

			.dependency-log-container h3 {
				margin: 0 0 10px 0;
				font-size: 14px;
			}

			.dependency-log-content {
				width: 100%;
				min-height: 150px;
				background-color: var(--background-secondary);
				border: 1px solid var(--background-modifier-border);
				border-radius: 4px;
				padding: 10px;
				font-family: var(--font-monospace);
				font-size: 12px;
				resize: vertical;
				color: var(--text-normal);
			}

			.dependency-button-container {
				margin-top: 20px;
				display: flex;
				gap: 10px;
				justify-content: flex-end;
			}

			.dependency-button-container button {
				padding: 8px 16px;
				border-radius: 4px;
				font-size: 14px;
			}
		`,document.head.appendChild(e)}onClose(){this.onComplete&&this.onComplete()}}class ig extends P.PluginSettingTab{constructor(e,t){super(e,t),this.defaultNamespaceInput=null,this.folderToggle=null,this.propertyToggle=null,this.previousConnectionStatus="",this.accordionStates=new Map,this.plugin=t,this.ollamaSettings=new eg(e,t),this.mcpToolSettings=new tg(e,t)}_initSharedTextDebounce(){var t;if(this._sharedTextDebounce)return;let e;this._sharedTextDebounce=i=>{e&&clearTimeout(e),e=setTimeout(async()=>{var s,r,o;try{const a=JSON.parse(i);switch(a.key){case"includedFolders":this.plugin.settings.includedFolders=a.value.split(`
`).map(l=>l.trim()).filter(l=>l.length>0);break;case"excludedFolders":this.plugin.settings.excludedFolders=a.value.split(`
`).map(l=>l.trim()).filter(l=>l.length>0);break;case"globallyIgnoredFields":this.plugin.settings.globallyIgnoredFields=a.value.split(`
`).map(l=>l.trim()).filter(l=>l.length>0);break;case"defaultNamespace":this.plugin.settings.defaultNamespace=a.value;break;default:(s=this.plugin.logger)==null||s.warn("[SETTINGS] Unknown key received by sharedTextDebounce",{key:a.key,payload:i});break}await this.plugin.saveSettings(),(r=this.plugin.logger)==null||r.debug("[SETTINGS] Shared debounced save executed",{key:a.key})}catch(a){(o=this.plugin.logger)==null||o.error("[SETTINGS] Shared debounced save error",{error:a,payload:i})}},2e3)},(t=this.plugin.logger)==null||t.debug("[SETTINGS] Shared text debouncer initialized")}ensureSharedDebounceInitialized(){this._initSharedTextDebounce()}display(){const{containerEl:e}=this;e.empty(),this.ensureSharedDebounceInitialized(),e.createEl("h1",{text:"MegaMem Plugin Settings"}),e.createEl("p",{text:"Configure your knowledge graph syncronization and mcp server.",cls:"setting-item-description"}),this.addAccordionStyles(e),this.addAccordionSectionSafely(e,"Python Environment",t=>this.addPythonAccordion(t),!1),this.addAccordionSectionSafely(e,"API Keys",t=>this.addAPIKeysAccordion(t),!1),this.addAccordionSectionSafely(e,"LLM Configuration",t=>this.addLLMAccordion(t),!1),this.addAccordionSectionSafely(e,"Database Configuration",t=>this.addDatabaseAccordion(t),!1),this.addAccordionSectionSafely(e,"Sync Configuration",t=>this.addSyncAccordion(t),!1),this.addAccordionSectionSafely(e,"Knowledge Namespacing",t=>this.addKnowledgeNamespacingAccordion(t),!1),this.addAccordionSectionSafely(e,"Servers",t=>this.addServersAccordion(t),!1),this.addAccordionSectionSafely(e,"MCP Tools",t=>this.mcpToolSettings.addMCPToolsAccordion(t),!1),this.addAccordionSectionSafely(e,"Advanced Settings",t=>this.addAdvancedAccordion(t),!1),this.addAccordionSectionSafely(e,"Actions",t=>this.addActionsAccordion(t),!1),this.addAccordionSectionSafely(e,"Development Options",t=>this.addDevelopmentAccordion(t),!1)}addAccordionStyles(e){const t=e.createEl("style");t.textContent=`
			.graphiti-accordion {
				margin-bottom: 10px;
				border: 1px solid var(--background-modifier-border);
				border-radius: 6px;
			}
			.graphiti-accordion-header {
				padding: 12px 16px;
				background: var(--background-modifier-hover);
				cursor: pointer;
				user-select: none;
				display: flex;
				justify-content: space-between;
				align-items: center;
				font-weight: 500;
				border-radius: 6px 6px 0 0;
			}
			.graphiti-accordion-header:hover {
				background: var(--background-modifier-border);
			}
			.graphiti-accordion-content {
				padding: 16px 16px 16px 16px;
				border-top: 1px solid var(--background-modifier-border);
			}
			.graphiti-accordion-arrow {
				font-size: 12px;
				transition: transform 0.2s ease;
			}
		`}addAccordionSection(e,t,i,s=!1){const r=e.createDiv("graphiti-accordion"),o=r.createDiv("graphiti-accordion-header"),a=o.createSpan("graphiti-accordion-title");a.textContent=t;const l=o.createDiv("graphiti-accordion-controls");l.style.display="flex",l.style.alignItems="center",l.style.gap="8px";const d=r.createDiv("graphiti-accordion-content"),p=this.accordionStates.get(t),g=typeof p=="boolean"?p:s;d.style.display=g?"block":"none";const m=l.createSpan("graphiti-accordion-arrow");m.textContent=g?"":"",m.style.cursor="pointer",m.setAttr("role","button"),m.addEventListener("click",h=>{h.stopPropagation(),h.preventDefault();const c=!(d.style.display!=="none");d.style.display=c?"block":"none",m.textContent=c?"":"",this.accordionStates.set(t,c)}),i.call(this,d)}addAccordionSectionSafely(e,t,i,s=!1){var r;try{this.addAccordionSection(e,t,i,s)}catch(o){(r=this.plugin.logger)==null||r.error(`[SETTINGS] Error rendering ${t} accordion`,{error:o});const a=e.createDiv("graphiti-accordion"),l=a.createDiv("graphiti-accordion-header");l.textContent=`${t} (Error)`;const d=a.createDiv("graphiti-accordion-content");d.style.display="none",d.createEl("div",{text:`Error loading ${t} section. Check console for details.`,cls:"setting-item-description"})}}addAPIKeysAccordion(e){const t=["openai","anthropic","google","azure","voyage","venice","openrouter"];for(const l of t){const d=this.getProviderDisplayName(l);new P.Setting(e).setName(`${d} API Key`).setDesc(`API key for ${d} services`).addText(p=>{p.inputEl.type="password",p.setPlaceholder(`Enter ${d} API key`).setValue(this.plugin.settings.apiKeys[l]||"").onChange(async g=>{this.plugin.settings.apiKeys[l]=g||void 0,await this.plugin.saveSettings()})})}e.createEl("h4",{text:"Local AI Models",cls:"setting-item-name"});let i;new P.Setting(e).setName("Enable Ollama Features").setDesc("Enable local AI model features using Ollama. When disabled, all Ollama settings and service checks are hidden.").addToggle(l=>l.setValue(this.plugin.settings.ollamaEnabled||!1).onChange(async d=>{this.plugin.settings.ollamaEnabled=d,await this.plugin.saveSettings(),i&&(i.style.display=d?"block":"none")})),i=e.createDiv(),i.style.display=this.plugin.settings.ollamaEnabled?"block":"none",i.style.marginLeft="24px",i.style.marginTop="8px";const s=new P.Setting(i).setName("Ollama - Fully Private Local Models").setDesc("Run AI models locally on your machine without sending data to external services"),r=s.settingEl.createDiv();r.style.cssText="margin-top: 8px; display: flex; gap: 8px; align-items: center;";const o=i.createDiv();o.style.cssText=`
			margin-top: 8px;
			margin-bottom: 16px;
			padding: 8px;
			border-radius: 4px;
			font-size: 0.9em;
			border: 1px solid var(--background-modifier-border);
		`;let a;s.addButton(l=>{a=l.buttonEl,l.setButtonText("Install Ollama").onClick(async()=>{await this.ollamaSettings.handleOllamaInstallation()})}),s.addButton(l=>{l.buttonEl,l.setButtonText("Refresh Status").onClick(async()=>{await this.ollamaSettings.refreshOllamaStatus(o,a)})}),this.plugin.settings.ollamaEnabled&&setTimeout(()=>{this.ollamaSettings.refreshOllamaStatus(o,a)},50),new P.Setting(i).setName("Ollama Base URL").setDesc("Ollama server base URL (used for both LLM and embedding when applicable)").addText(l=>l.setPlaceholder("http://localhost:11434/v1").setValue(this.plugin.settings.ollamaBaseUrl||"http://localhost:11434/v1").onChange(async d=>{this.plugin.settings.ollamaBaseUrl=d||"http://localhost:11434/v1",await this.plugin.saveSettings()})),new P.Setting(i).setName("Ollama Embedding Dimension").setDesc("Dimension size for Ollama embeddings (typically 768 for most models)").addText(l=>l.setPlaceholder("768").setValue((this.plugin.settings.ollamaEmbeddingDim||768).toString()).onChange(async d=>{const p=parseInt(d)||768;this.plugin.settings.ollamaEmbeddingDim=p,await this.plugin.saveSettings()})),new P.Setting(e).setName("Validate All API Keys").setDesc("Validate all configured API keys without testing models").addButton(l=>l.setButtonText("Validate API Keys").setCta().onClick(async()=>{await this.validateAPIKeys(l.buttonEl)}))}async addLLMAccordion(e){new P.Setting(e).setName("LLM Defaults").setDesc("Merge recommended defaults into your current settings without overwriting custom entries").addButton(l=>l.setButtonText("Load Defaults").onClick(async()=>{try{const d=Jp(),p=this.plugin.settings,g=(m,h)=>{(!p[m]||typeof p[m]!="object")&&(p[m]={});const b=p[m];for(const c of Object.keys(h||{})){if(!b[c]||typeof b[c]!="object"){b[c]={...h[c]};continue}const v=b[c],w=h[c];for(const _ of Object.keys(w))_ in v||(v[_]=w[_])}};g("llmDefaults",d.llmDefaults),g("llmSmallDefaults",d.llmSmallDefaults),g("embeddingDefaults",d.embeddingDefaults),g("llmCrossEncoderDefaults",d.llmCrossEncoderDefaults),await this.plugin.saveSettings(),this.display()}catch(d){}})),new P.Setting(e).setName("LLM Provider").setDesc("Choose your language model provider").addDropdown(l=>l.addOption("openai","OpenAI").addOption("anthropic","Anthropic").addOption("google","Google AI").addOption("azure","Azure OpenAI").addOption("ollama","Ollama (Local)").addOption("venice","Venice.ai").addOption("openrouter","OpenRouter").setValue(this.plugin.settings.llmProvider).onChange(async d=>{const p=d;this.plugin.settings.llmProvider=p,await this.plugin.saveSettings(),this.updateLLMDefaults(p)}));const t=new P.Setting(e).setName("LLM Model").setDesc("Primary language model for processing");let i;t.addDropdown(async l=>{await this.populateLLMModels(l,this.plugin.settings.llmProvider),l.setValue(this.plugin.settings.llmModel).onChange(async d=>{this.plugin.settings.llmModel=d,await this.plugin.saveSettings(),this.plugin.settings.llmProvider==="ollama"&&d&&await this.updateModelStatusIconForDropdown(i,"llm",d)})}),i=t.settingEl.createDiv(),i.style.cssText=`
			display: inline-flex;
			align-items: center;
			margin-left: 8px;
			vertical-align: middle;
		`,this.plugin.settings.llmProvider==="ollama"&&this.plugin.settings.llmModel&&setTimeout(async()=>{this.plugin.settings.llmModel&&setTimeout(async()=>{const l=await this.ollamaSettings.isOllamaModelInstalled(this.plugin.settings.llmModel);i.empty();const d=i.createDiv();d.style.cssText="display: inline-flex; align-items: center; gap: 4px; font-size: 0.9em;";const p=d.createSpan();P.setIcon(p,l?"check-circle":"download"),p.style.color=l?"var(--color-green)":"var(--color-orange)";const g=d.createSpan();g.textContent=l?"Available":"Not installed",g.style.color=l?"var(--color-green)":"var(--color-orange)"},100)},100);const s=new P.Setting(e).setName("LLM Model Small").setDesc("Smaller, faster model for re-ranking operations (optional)");let r;s.addDropdown(async l=>{await this.populateLLMModels(l,this.plugin.settings.llmProvider,!0),l.setValue(this.plugin.settings.llmSmallModel||"").onChange(async d=>{this.plugin.settings.llmSmallModel=d||void 0,await this.plugin.saveSettings(),this.plugin.settings.llmProvider==="ollama"&&d&&await this.ollamaSettings.updateModelStatusIconForDropdown(r,"llm_small",d)})}),r=s.settingEl.createDiv(),r.style.cssText=`
			display: inline-flex;
			align-items: center;
			margin-left: 8px;
			vertical-align: middle;
		`,this.plugin.settings.llmProvider==="ollama"&&this.plugin.settings.llmSmallModel&&setTimeout(async()=>{this.plugin.settings.llmSmallModel&&await this.ollamaSettings.updateModelStatusIconForDropdown(r,"llm_small",this.plugin.settings.llmSmallModel)},100),this.plugin.settings.llmProvider==="ollama"&&await this.ollamaSettings.addCustomLLMModelEntry(e),this.plugin.settings.llmProvider==="openrouter"&&(new P.Setting(e).setName("OpenRouter Preset Slug").setDesc("OpenRouter preset name to use (leave empty to disable preset usage)").addText(l=>l.setPlaceholder("e.g., ravenel-bridge").setValue(this.plugin.settings.openrouterPresetSlug||"").onChange(async d=>{this.plugin.settings.openrouterPresetSlug=d||void 0,await this.plugin.saveSettings()})).addButton(l=>l.setButtonText("Add Default").setTooltip("Add preset model to dropdowns").onClick(async()=>{var g;const d=this.plugin.settings.openrouterPresetSlug;if(!d){new P.Notice("[ERROR] Please enter a preset slug first");return}const p=l.buttonEl.textContent;l.buttonEl.textContent="Adding...",l.setDisabled(!0);try{const m=`@preset/${d}`,h={desc:"Models controlled by OpenRouter Preset",recommended:!0};this.plugin.settings.llmDefaults||(this.plugin.settings.llmDefaults={}),this.plugin.settings.llmDefaults.openrouter||(this.plugin.settings.llmDefaults.openrouter={}),this.plugin.settings.llmSmallDefaults||(this.plugin.settings.llmSmallDefaults={}),this.plugin.settings.llmSmallDefaults.openrouter||(this.plugin.settings.llmSmallDefaults.openrouter={}),this.plugin.settings.llmDefaults.openrouter[m]=h,this.plugin.settings.llmSmallDefaults.openrouter[m]=h,await this.plugin.saveSettings(),this.display(),new P.Notice(`[SUCCESS] Added ${m} to model dropdowns`)}catch(m){(g=this.plugin.logger)==null||g.error("Failed to add preset default",{error:m,presetSlug:d}),new P.Notice("[ERROR] Failed to add preset default")}finally{l.buttonEl.textContent=p,l.setDisabled(!1)}})),new P.Setting(e).setName("Use Preset with Custom Model").setDesc("When enabled, append preset to custom OpenRouter models (e.g., openai/gpt-4o@preset/your-preset)").addToggle(l=>l.setValue(this.plugin.settings.openrouterUsePresetWithCustomModel||!1).onChange(async d=>{this.plugin.settings.openrouterUsePresetWithCustomModel=d,await this.plugin.saveSettings()}))),new P.Setting(e).setName("Test LLM Connection").setDesc("Test your language model provider configuration").addButton(l=>l.setButtonText("Test LLM Connection").setCta().onClick(async()=>{await this.testLLMConnection(l.buttonEl)})),new P.Setting(e).setName("Embedding Provider").setDesc("Choose your embedding provider").addDropdown(l=>l.addOption("openai","OpenAI").addOption("google","Google AI").addOption("voyage","Voyage AI").addOption("ollama","Ollama (Local)").setValue(this.plugin.settings.embedderProvider).onChange(async d=>{var g,m,h,b;const p=d;if((g=this.plugin.logger)==null||g.debug("[EMBEDDING-PROVIDER] Provider changed",{oldProvider:this.plugin.settings.embedderProvider,newProvider:p,vaultName:this.app.vault.getName(),hasVaultRegistryService:!!this.plugin.vaultRegistryService}),this.plugin.settings.embedderProvider=p,await this.plugin.saveSettings(),this.updateEmbedderDefaults(p),this.plugin.vaultRegistryService&&this.plugin.settings.embeddingModel)try{const c=this.app.vault.getName();(m=this.plugin.logger)==null||m.debug("[EMBEDDING-PROVIDER-CHANGE] Updating vault registry from provider dropdown",{oldProvider:this.plugin.settings.embedderProvider,newProvider:p,model:this.plugin.settings.embeddingModel,dimensions:this.plugin.settings.ollamaEmbeddingDim||768,vaultName:c}),await this.plugin.vaultRegistryService.updateVaultEmbeddingModel(c,this.plugin.settings.embeddingModel,this.plugin.settings.ollamaEmbeddingDim||768,p),(h=this.plugin.logger)==null||h.debug("[EMBEDDING-PROVIDER] Vault registry updated with new provider configuration",{vaultName:c,provider:p,model:this.plugin.settings.embeddingModel,dimensions:this.plugin.settings.ollamaEmbeddingDim||768})}catch(c){(b=this.plugin.logger)==null||b.error("[EMBEDDING-PROVIDER] Failed to update vault registry",{error:c,provider:p})}})),await this.addEnhancedEmbeddingModelSetting(e),this.plugin.settings.embedderProvider==="ollama"&&await this.ollamaSettings.addCustomEmbeddingModelEntry(e),new P.Setting(e).setName("Test Embedding Connection").setDesc("Test your embedding provider configuration").addButton(l=>l.setButtonText("Test Embedding").onClick(async()=>{await this.testEmbeddingConnection(l.buttonEl)})),new P.Setting(e).setName("Test Provider Combination").setDesc("Test that your LLM and embedding providers work together correctly with full pipeline testing").addButton(l=>l.setButtonText("Test Full Pipeline").onClick(async()=>{await this.testFullPipeline(l.buttonEl)})),this.plugin.settings.loadDaemonOnLaunch&&this.plugin.settings.experimentalDaemonMode&&new P.Setting(e).setName("Reload Sync Daemon").setDesc("Restart the sync daemon to apply new provider configuration").addButton(l=>l.setButtonText("Reload Daemon").onClick(async()=>{await this.reloadSyncDaemon(l.buttonEl)})),e.createEl("h4",{text:"Cross-Encoder / Reranker Configuration",cls:"setting-item-name"});let o;new P.Setting(e).setName("Cross-Encoder Provider").setDesc("Choose your cross-encoder/reranker provider for improved search ranking").addDropdown(l=>l.addOption("none","None - Disable reranking").addOption("openai","OpenAI Reranker").addOption("bge","BGE Reranker (Local)").addOption("gemini","Gemini Reranker").setValue(this.plugin.settings.crossEncoderClient||"none").onChange(async d=>{const p=d;this.plugin.settings.crossEncoderClient=p,(p==="bge"||p==="none")&&(this.plugin.settings.crossEncoderModel=void 0),await this.plugin.saveSettings(),this.updateCrossEncoderDefaults(p),o&&(o.style.display=p==="none"||p==="bge"?"none":"block")}));const a=new P.Setting(e).setName("Cross-Encoder Model").setDesc("Specific model for cross-encoding/reranking operations");o=a.settingEl,o.style.display=this.plugin.settings.crossEncoderClient==="none"?"none":"block",a.addDropdown(async l=>{await this.populateCrossEncoderModels(l,this.plugin.settings.crossEncoderClient||"none"),l.setValue(this.plugin.settings.crossEncoderModel||"").onChange(async d=>{this.plugin.settings.crossEncoderModel=d||void 0,await this.plugin.saveSettings()})}),this.addProviderSpecificSettings(e)}addDatabaseAccordion(e){new P.Setting(e).setName("Database Type").setDesc("Choose your graph database backend").addDropdown(t=>t.addOption("neo4j","Neo4j").addOption("falkordb","FalkorDB").setValue(this.plugin.settings.databaseType).onChange(async i=>{const s=i;this.plugin.settings.databaseType=s,await this.plugin.saveSettings(),this.display()})),this.addDatabaseSpecificFields(e),new P.Setting(e).setName("Test Database Connection").setDesc("Verify your database connection settings").addButton(t=>t.setButtonText("Test Connection").setCta().onClick(async()=>{await this.testDatabaseConnection(t.buttonEl)})),new P.Setting(e).setName("Initialize Database Schema").setDesc("Set up the required Graphiti schema in your database (run this after successful connection test)").addButton(t=>t.setButtonText("Initialize Schema").onClick(async()=>{await this.initializeDatabaseSchema(t.buttonEl)}))}addDatabaseSpecificFields(e){const t=this.plugin.settings.databaseType;t==="neo4j"?(new P.Setting(e).setName("Neo4j URI").setDesc("Neo4j connection URI (e.g., bolt://localhost:7687)").addText(i=>i.setPlaceholder("bolt://localhost:7687").setValue(this.plugin.settings.databaseConfigs.neo4j.uri).onChange(async s=>{this.plugin.settings.databaseConfigs.neo4j.uri=s,await this.plugin.saveSettings()})),new P.Setting(e).setName("Neo4j Username").setDesc("Neo4j database username").addText(i=>i.setPlaceholder("neo4j").setValue(this.plugin.settings.databaseConfigs.neo4j.username).onChange(async s=>{this.plugin.settings.databaseConfigs.neo4j.username=s,await this.plugin.saveSettings()})),new P.Setting(e).setName("Neo4j Password").setDesc("Neo4j database password").addText(i=>{i.inputEl.type="password",i.setPlaceholder("Enter password").setValue(this.plugin.settings.databaseConfigs.neo4j.password).onChange(async s=>{this.plugin.settings.databaseConfigs.neo4j.password=s,await this.plugin.saveSettings()})}),new P.Setting(e).setName("Neo4j Database Name").setDesc("Name of the Neo4j database to use").addText(i=>i.setPlaceholder("neo4j").setValue(this.plugin.settings.databaseConfigs.neo4j.database).onChange(async s=>{this.plugin.settings.databaseConfigs.neo4j.database=s,await this.plugin.saveSettings()}))):t==="falkordb"&&(new P.Setting(e).setName("FalkorDB Host").setDesc("FalkorDB host address").addText(i=>i.setPlaceholder("localhost").setValue(this.plugin.settings.databaseConfigs.falkordb.host).onChange(async s=>{this.plugin.settings.databaseConfigs.falkordb.host=s,await this.plugin.saveSettings()})),new P.Setting(e).setName("FalkorDB Port").setDesc("FalkorDB port number").addText(i=>i.setPlaceholder("6379").setValue(this.plugin.settings.databaseConfigs.falkordb.port.toString()).onChange(async s=>{const r=parseInt(s);!isNaN(r)&&r>0&&r<65536&&(this.plugin.settings.databaseConfigs.falkordb.port=r,await this.plugin.saveSettings())})),new P.Setting(e).setName("FalkorDB Username (Optional)").setDesc("FalkorDB username (leave empty if not using authentication)").addText(i=>i.setPlaceholder("Optional").setValue(this.plugin.settings.databaseConfigs.falkordb.username||"").onChange(async s=>{this.plugin.settings.databaseConfigs.falkordb.username=s||void 0,await this.plugin.saveSettings()})),new P.Setting(e).setName("FalkorDB Password (Optional)").setDesc("FalkorDB password (leave empty if not using authentication)").addText(i=>{i.inputEl.type="password",i.setPlaceholder("Optional").setValue(this.plugin.settings.databaseConfigs.falkordb.password||"").onChange(async s=>{this.plugin.settings.databaseConfigs.falkordb.password=s||void 0,await this.plugin.saveSettings()})}),new P.Setting(e).setName("FalkorDB Database Name").setDesc("Name of the FalkorDB database to use").addText(i=>i.setPlaceholder("default_db").setValue(this.plugin.settings.databaseConfigs.falkordb.database).onChange(async s=>{this.plugin.settings.databaseConfigs.falkordb.database=s,await this.plugin.saveSettings()})))}addPythonAccordion(e){e.createEl("p",{text:"Configure Python installation and dependencies for MegaMem",cls:"setting-item-description"}),new P.Setting(e).setName("Custom Python Path").setDesc("Leave empty to auto-detect Python. Specify full path to python executable if needed.").addText(s=>s.setPlaceholder("Auto-detect").setValue(this.plugin.settings.pythonPath||"").onChange(async r=>{this.plugin.settings.pythonPath=r||void 0,await this.plugin.saveSettings()}));const t=e.createDiv();t.style.cssText=`
			margin: 16px 0;
			padding: 12px;
			border: 1px solid var(--background-modifier-border);
			border-radius: 6px;
			background: var(--background-secondary);
			font-family: var(--font-monospace);
			font-size: 0.9em;
		`;const i=async()=>{var s;t.empty(),t.createEl("div",{text:"Checking dependencies...",attr:{style:"color: var(--text-muted);"}});try{const o=this.plugin.app.vault.adapter.basePath,a=Ge.join(o,".obsidian","plugins","megamem-mcp"),d=await new gn(this.plugin,a,this.plugin.settings).checkAllDependencies();t.empty();const p=t.createDiv();p.textContent=d.systemPython?`[OK] System Python: ${d.systemPython.version} at ${d.systemPython.path}`:"[X] System Python: Not found",p.style.color=d.systemPython?"var(--color-green)":"var(--color-red)";const g=t.createDiv();g.textContent=d.uvInstalled?`[OK] uv installed: ${d.uvPythonPath||"Yes"}`:"[X] uv: Not installed",g.style.color=d.uvInstalled?"var(--color-green)":"var(--color-orange)";const m=t.createDiv();m.textContent=d.venvExists?`[OK] Virtual environment: ${d.venvPath||"Exists"}`:"[X] Virtual environment: Not found",m.style.color=d.venvExists?"var(--color-green)":"var(--color-orange)";const h=t.createDiv(),b=d.graphitiVersion?` v${d.graphitiVersion}`:"";if(h.textContent=d.graphitiInstalled?`[OK] Graphiti: Installed${b}`:"[X] Graphiti: Not installed",h.style.color=d.graphitiInstalled?"var(--color-green)":"var(--color-red)",d.mismatch.detected){const c=t.createDiv();c.textContent=`[WARNING] ${d.mismatch.description}`,c.style.color="var(--color-orange)",c.style.marginTop="8px"}}catch(r){t.empty();const o=t.createDiv();o.textContent="[ERROR] Failed to check dependencies",o.style.color="var(--color-red)",(s=this.plugin.logger)==null||s.error("[PYTHON-ACCORDION] Failed to check dependencies",{error:r})}};new P.Setting(e).setName("Manage Dependencies").setDesc("Check status and install Python dependencies").addButton(s=>s.setButtonText("Manage Dependencies").setCta().onClick(async()=>{const o=this.plugin.app.vault.adapter.basePath,a=Ge.join(o,".obsidian","plugins","megamem-mcp"),l=new gn(this.plugin,a,this.plugin.settings);new ng(this.app,this.plugin,l,async()=>{await i()}).open()})),setTimeout(()=>i(),100)}addSyncAccordion(e){let t=null;new P.Setting(e).setName("Automatically sync notes at scheduled intervals").setDesc("Automatically sync notes when they are saved or at regular intervals. Be careful with this, it is not fully tested.").addToggle(i=>{i.setValue(this.plugin.settings.autoSync).onChange(async s=>{const r=this;r._settingsDebounceTimer&&clearTimeout(r._settingsDebounceTimer),r._settingsDebounceTimer=setTimeout(async()=>{r.plugin.settings.autoSync=s,await r.plugin.saveSettings(),t&&(t.style.display=s?"block":"none")},1e3)})}),t=e.createDiv(),t.style.display=this.plugin.settings.autoSync?"block":"none",t.style.marginLeft="24px",t.style.marginTop="8px",new P.Setting(t).setName("Sync Options").setDesc("Choose which notes to include in automatic sync operations").addDropdown(i=>i.addOption("new_only","New notes only - Sync only newly created notes").addOption("new_and_updated","New and updated notes - Sync both new and modified notes").setValue(this.plugin.settings.syncOptions).onChange(async s=>{this.plugin.settings.syncOptions=s,await this.plugin.saveSettings()})),new P.Setting(e).setName("Sync Interval").setDesc("Automatic sync interval in minutes (0 to disable)").addSlider(i=>i.setLimits(0,60,1).setValue(this.plugin.settings.syncInterval).setDynamicTooltip().onChange(async s=>{this.plugin.settings.syncInterval=s,await this.plugin.saveSettings()})),e.createEl("h4",{text:"Folder Configuration",cls:"setting-item-name"}),new P.Setting(e).setName("Included Folders").setDesc("Folders to include in sync. Leave empty to include all folders."),this.plugin.settings.includedFolders.forEach((i,s)=>{const r=new P.Setting(e).addSearch(o=>{new xn(this.app,o.inputEl),o.inputEl.onmousedown=a=>a.stopPropagation(),o.setPlaceholder("Select folder or type path...").setValue(i).onChange(async a=>{this.plugin.settings.includedFolders[s]=a,await this.plugin.saveSettings()})}).addExtraButton(o=>{o.setIcon("cross").setTooltip("Delete").onClick(async a=>{a&&a.stopPropagation(),this.plugin.settings.includedFolders.splice(s,1),await this.plugin.saveSettings(),this.display()})});r.infoEl.remove(),r.controlEl.onmousedown=o=>o.stopPropagation()}),new P.Setting(e).addButton(i=>{i.setButtonText("Add Folder").setCta().onClick(async s=>{s&&s.stopPropagation(),this.plugin.settings.includedFolders.push(""),await this.plugin.saveSettings(),this.display()}),i.buttonEl.onmousedown=s=>s.stopPropagation()}),new P.Setting(e).setName("Excluded Folders").setDesc("Folders to exclude from sync (e.g., .obsidian, .trash)."),this.plugin.settings.excludedFolders.forEach((i,s)=>{const r=new P.Setting(e).addSearch(o=>{new xn(this.app,o.inputEl),o.inputEl.onmousedown=a=>a.stopPropagation(),o.setPlaceholder("Select folder or type path...").setValue(i).onChange(async a=>{this.plugin.settings.excludedFolders[s]=a,await this.plugin.saveSettings()})}).addExtraButton(o=>{o.setIcon("cross").setTooltip("Delete").onClick(async a=>{a&&a.stopPropagation(),this.plugin.settings.excludedFolders.splice(s,1),await this.plugin.saveSettings(),this.display()})});r.infoEl.remove(),r.controlEl.onmousedown=o=>o.stopPropagation()}),new P.Setting(e).addButton(i=>{i.setButtonText("Add Folder").setCta().onClick(async s=>{s&&s.stopPropagation(),this.plugin.settings.excludedFolders.push(""),await this.plugin.saveSettings(),this.display()}),i.buttonEl.onmousedown=s=>s.stopPropagation()}),new P.Setting(e).setName("Globally Ignored Fields").setDesc("YAML frontmatter fields to ignore globally across all notes."),this.plugin.settings.globallyIgnoredFields.forEach((i,s)=>{const r=new P.Setting(e).addText(o=>{o.inputEl.onmousedown=a=>a.stopPropagation(),o.setPlaceholder("Enter field name (e.g., cssclass, tags)...").setValue(i).onChange(async a=>{this.plugin.settings.globallyIgnoredFields[s]=a,await this.plugin.saveSettings()})}).addExtraButton(o=>{o.setIcon("cross").setTooltip("Delete").onClick(async a=>{a&&a.stopPropagation(),this.plugin.settings.globallyIgnoredFields.splice(s,1),await this.plugin.saveSettings(),this.display()})});r.infoEl.remove(),r.controlEl.onmousedown=o=>o.stopPropagation()}),new P.Setting(e).addButton(i=>{i.setButtonText("Add Field").setCta().onClick(async s=>{s&&s.stopPropagation(),this.plugin.settings.globallyIgnoredFields.push(""),await this.plugin.saveSettings(),this.display()}),i.buttonEl.onmousedown=s=>s.stopPropagation()})}addKnowledgeNamespacingAccordion(e){e.createEl("p",{text:"Configure how knowledge is organized and namespaced in your graph database.",cls:"setting-item-description"}),e.createEl("h4",{text:"Ontology Configuration",cls:"setting-item-name"}),new P.Setting(e).setName("Use Custom Ontology").setDesc("Enable custom entity types with pre-existing Pydantic models. When disabled, uses generic text episodes.").addToggle(r=>r.setValue(this.plugin.settings.useCustomOntology).onChange(async o=>{this.plugin.settings.useCustomOntology=o,await this.plugin.saveSettings()})),e.createEl("h4",{text:"Namespacing Strategy",cls:"setting-item-name"}),new P.Setting(e).setName("Namespace Strategy").setDesc("Primary strategy for organizing knowledge in the graph").addDropdown(r=>r.addOption("vault","Vault Name - Use vault as namespace").addOption("folder","Folder Path - Use note folder as namespace").addOption("property","Property Value - Use g_group_id property").addOption("custom","Custom Value - Use default namespace setting").setValue(this.plugin.settings.namespaceStrategy).onChange(async o=>{const a=o;this.plugin.settings.namespaceStrategy=a,a==="vault"?(this.plugin.settings.defaultNamespace=this.app.vault.getName(),this.defaultNamespaceInput&&this.defaultNamespaceInput.setValue(this.app.vault.getName())):a==="folder"?(this.plugin.settings.enableFolderNamespacing=!0,this.folderToggle&&this.folderToggle.setValue(!0)):a==="property"&&(this.plugin.settings.enablePropertyNamespacing=!0,this.propertyToggle&&this.propertyToggle.setValue(!0)),await this.plugin.saveSettings()})),new P.Setting(e).setName("Default Namespace").setDesc('Default namespace when strategy is "custom" or when other strategies fail').addText(r=>{this.defaultNamespaceInput=r,r.setPlaceholder("my-vault").setValue(this.plugin.settings.defaultNamespace).onChange(o=>{var a;this.ensureSharedDebounceInitialized(),(a=this._sharedTextDebounce)==null||a.call(this,JSON.stringify({key:"defaultNamespace",value:o}))})}),new P.Setting(e).setName("Enable Folder Namespacing").setDesc("Use top-level folder names as namespaces. Subfolders are not supported.").addToggle(r=>{this.folderToggle=r,r.setValue(this.plugin.settings.enableFolderNamespacing).onChange(async o=>{this.plugin.settings.enableFolderNamespacing=o,await this.plugin.saveSettings()})});const t=new P.Setting(e).setName("Generate Folder Namespaces").setDesc("Click to scan vault folders and generate the list of available namespaces."),i=t.descEl.createDiv();i.style.marginTop="8px",i.style.fontSize="0.9em",i.style.color="var(--text-muted)";const s=()=>{const r=this.plugin.settings.availableNamespaces||[];r.length>0?i.textContent=`Current namespaces: ${r.join(", ")}`:i.textContent='No namespaces discovered yet. Click "Generate" to scan the vault.'};s(),t.addButton(r=>r.setButtonText("Generate").setCta().onClick(async()=>{var a;const o=r.buttonEl.textContent;r.buttonEl.textContent="Generating...",r.setDisabled(!0);try{await this.plugin.updateAvailableNamespaces(),s(),new P.Notice("[SUCCESS] Namespaces updated successfully")}catch(l){const d=l instanceof Error?l.message:"Unknown error";new P.Notice(`[ERROR] Failed to update namespaces: ${d}`),(a=this.plugin.logger)==null||a.error("Failed to update namespaces",{error:l})}finally{r.buttonEl.textContent=o,r.setDisabled(!1)}})),new P.Setting(e).setName("Custom Folder Mappings").setDesc("Map specific folders to custom group_id namespaces. Leave empty to use automatic folder names."),this.plugin.settings.folderNamespaceMappings.forEach((r,o)=>{const a=new P.Setting(e).addSearch(l=>{new xn(this.app,l.inputEl),l.inputEl.addEventListener("mousedown",d=>d.stopPropagation()),l.setPlaceholder("Select folder or type path...").setValue(r.folderPath).onChange(async d=>{this.plugin.settings.folderNamespaceMappings[o].folderPath=d,await this.plugin.saveSettings()}),l.inputEl.addEventListener("blur",async()=>{const d=l.getValue();if(!this.plugin.settings.folderNamespaceMappings[o].groupId&&d.trim()){this.plugin.settings.folderNamespaceMappings[o].groupId=d.replace(/\//g,"_");const p=a.controlEl.querySelector('input[placeholder="Enter group_id..."]');p&&(p.value=this.plugin.settings.folderNamespaceMappings[o].groupId),await this.plugin.saveSettings()}})}).addText(l=>{l.inputEl.addEventListener("mousedown",d=>d.stopPropagation()),l.inputEl.addEventListener("input",d=>d.stopPropagation()),l.inputEl.addEventListener("keydown",d=>d.stopPropagation()),l.inputEl.addEventListener("keyup",d=>d.stopPropagation()),l.inputEl.addEventListener("focus",d=>d.stopPropagation()),l.setPlaceholder("Enter group_id...").setValue(r.groupId).onChange(async d=>{this.plugin.settings.folderNamespaceMappings[o].groupId=d,await this.plugin.saveSettings()})}).addExtraButton(l=>{l.setIcon("cross").setTooltip("Delete").onClick(async d=>{d&&(d.stopPropagation(),d.preventDefault()),this.plugin.settings.folderNamespaceMappings.splice(o,1),await this.plugin.saveSettings(),this.display()}),l.extraSettingsEl.addEventListener("mousedown",d=>d.stopPropagation())});a.infoEl.remove(),a.controlEl.addEventListener("mousedown",l=>l.stopPropagation())}),new P.Setting(e).addButton(r=>{r.setButtonText("Add Folder Mapping").setCta().onClick(async o=>{o&&o.stopPropagation(),this.plugin.settings.folderNamespaceMappings.push({folderPath:"",groupId:""}),await this.plugin.saveSettings(),this.display()}),r.buttonEl.onmousedown=o=>o.stopPropagation()}),new P.Setting(e).setName("Enable Property Namespacing").setDesc("Use g_group_id frontmatter property as namespace when available").addToggle(r=>{this.propertyToggle=r,r.setValue(this.plugin.settings.enablePropertyNamespacing).onChange(async o=>{this.plugin.settings.enablePropertyNamespacing=o,await this.plugin.saveSettings()})}),e.createEl("h4",{text:"Multi-Vault Configuration",cls:"setting-item-name"}),e.createEl("p",{text:"Be careful with this, it is not fully tested.",cls:"setting-item-description",attr:{style:"color: var(--text-warning); font-weight: 500; margin-bottom: 16px;"}}),new P.Setting(e).setName("Enable Multi-Vault Mode").setDesc("Enable advanced features for managing multiple Obsidian vaults").addToggle(r=>r.setValue(this.plugin.settings.enableMultiVaultMode).onChange(async o=>{this.plugin.settings.enableMultiVaultMode=o,await this.plugin.saveSettings()})),new P.Setting(e).setName("Current Vault Priority").setDesc("Priority level for this vault in multi-vault scenarios (higher numbers = higher priority)").addSlider(r=>r.setLimits(1,10,1).setValue(this.plugin.settings.currentVaultPriority).setDynamicTooltip().onChange(async o=>{this.plugin.settings.currentVaultPriority=o,await this.plugin.saveSettings()})),new P.Setting(e).setName("Vault Configurations").setDesc("View and manage vault registry configuration from vaults.json").addButton(r=>r.setButtonText("Manage Vaults").onClick(async()=>{await this.showVaultManagementModal()}))}addServersAccordion(e){e.createEl("p",{text:"Server architecture: The first MCP process automatically starts the shared WebSocket server. Subsequent processes connect as clients. Server ownership transfers automatically when the host process exits.",cls:"setting-item-description"}),e.createEl("h4",{text:"Shared WebSocket Server",cls:"setting-item-name"}),new P.Setting(e).setName("Enable WebSocket Server").setDesc("Enable WebSocket server for MCP communication. Required for MCP tools to work.").addToggle(g=>g.setValue(this.plugin.settings.wsEnabled).onChange(async m=>{this.plugin.settings.wsEnabled=m,await this.plugin.saveSettings(),m?(await this.plugin.wsService.start(),new P.Notice("[INFO] WebSocket server started")):(await this.plugin.wsService.stop(),new P.Notice("[INFO] WebSocket server stopped"))})),e.createEl("p",{text:"Server lifecycle is managed automatically by MCP processes. Manual control is not needed.",cls:"setting-item-description",attr:{style:"font-size: 0.9em; color: var(--text-muted); margin-bottom: 16px;"}}),new P.Setting(e).setName("WebSocket Port").setDesc("Port number for the shared WebSocket server (configured via MCP)").addText(g=>g.setPlaceholder("8765").setValue(this.plugin.settings.wsPort.toString()).setDisabled(!0));const t=new P.Setting(e).setName("Authentication Token").setDesc("Authentication token for secure WebSocket connections (managed by MCP)");t.addText(g=>{g.setDisabled(!0).setValue(this.plugin.settings.wsAuthToken)}),t.addButton(g=>g.setButtonText("Copy").onClick(async m=>{m==null||m.stopPropagation(),await navigator.clipboard.writeText(this.plugin.settings.wsAuthToken),new P.Notice("Auth token copied to clipboard")}));const i=e.createDiv();i.style.cssText=`
			margin: 16px 0;
			padding: 12px;
			border: 1px solid var(--background-modifier-border);
			border-radius: 6px;
			background: var(--background-secondary);
		`,i.createEl("h5",{text:"Current Connections",attr:{style:"margin: 0 0 8px 0; font-size: 0.9em; font-weight: 600;"}});const s=i.createDiv();s.style.cssText=`
			font-size: 0.8em;
			color: var(--text-muted);
			line-height: 1.4;
		`;const r=async()=>{if(!this.plugin.settings.enableDebugLogging){const m=this.plugin.settings.wsPort||8765;s.textContent=`Health checks disabled (port ${m})`;return}const g=this.plugin.settings.wsPort||8765;try{(await fetch(`http://127.0.0.1:${g}/health`,{headers:{Authorization:`Bearer ${this.plugin.settings.wsAuthToken||""}`}})).ok?s.textContent=`Connected to port ${g}`:s.textContent=`Failed to connect to port ${g}`}catch(m){s.textContent=`Trying to connect to port ${g}`}};r();const o=setInterval(r,5e3);this.connectionUpdateInterval=o,e.createEl("h4",{text:"MCP Server",cls:"setting-item-name"});const a=e.createDiv();a.style.cssText=`
			margin: 16px 0;
			padding: 12px;
			border: 1px solid var(--background-modifier-border);
			border-radius: 6px;
			background: var(--background-secondary);
		`,a.createEl("h5",{text:"Current Instances",attr:{style:"margin: 0 0 8px 0; font-size: 0.9em; font-weight: 600;"}});const l=a.createDiv();l.style.cssText=`
			font-size: 0.8em;
			color: var(--text-muted);
			line-height: 1.4;
		`;const d=async()=>{var g;try{const h=await tn.getInstance().getMCPServerProcesses();if(h.length>0){const b=h.map(c=>`Process ${c.pid} | ${c.parentName} | ${c.createdAt}`);l.innerHTML=b.join("<br>")}else l.textContent="No active instances detected"}catch(m){l.textContent="Status check failed",(g=this.plugin.logger)==null||g.error("Failed to update instances display",{error:m})}};d();const p=setInterval(d,5e3);this.instanceUpdateInterval=p,new P.Setting(e).setName("Generate MCP Config").setDesc("Generate configuration for MCP clients to connect to the MCP server").addButton(g=>g.setButtonText("Generate Config").onClick(async()=>{await this.generateMcpConfig(g.buttonEl)}))}addAdvancedAccordion(e){new P.Setting(e).setName("View Logs").setDesc("Open the plugin logs directory").addButton(t=>t.setButtonText("View Logs").onClick(async()=>{await this.viewLogFile()})),new P.Setting(e).setName("Max Retry Attempts").setDesc("Maximum number of retry attempts for failed operations").addSlider(t=>t.setLimits(1,10,1).setValue(this.plugin.settings.maxRetryAttempts).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxRetryAttempts=i,await this.plugin.saveSettings()})),new P.Setting(e).setName("Connection Timeout").setDesc("Connection timeout in seconds").addSlider(t=>t.setLimits(5,120,5).setValue(this.plugin.settings.connectionTimeout).setDynamicTooltip().onChange(async i=>{this.plugin.settings.connectionTimeout=i,await this.plugin.saveSettings()})),e.createEl("h4",{text:"Schema Discovery Options",cls:"setting-item-name"}),new P.Setting(e).setName("Auto-discover Schemas").setDesc("Automatically scan vault for schema patterns").addToggle(t=>t.setValue(this.plugin.settings.autoDiscoverSchemas).onChange(async i=>{this.plugin.settings.autoDiscoverSchemas=i,await this.plugin.saveSettings()})),new P.Setting(e).setName("Validate Naming Conventions").setDesc("Check property names against Graphiti best practices").addToggle(t=>t.setValue(this.plugin.settings.validateNamingConventions).onChange(async i=>{this.plugin.settings.validateNamingConventions=i,await this.plugin.saveSettings()})),new P.Setting(e).setName("Suggest Property Descriptions").setDesc("Auto-generate descriptions for common property names").addToggle(t=>t.setValue(this.plugin.settings.suggestPropertyDescriptions).onChange(async i=>{this.plugin.settings.suggestPropertyDescriptions=i,await this.plugin.saveSettings()})),new P.Setting(e).setName("Protected Attribute Warnings").setDesc("Show warnings for Graphiti protected attribute names").addToggle(t=>t.setValue(this.plugin.settings.enableProtectedAttributeWarnings).onChange(async i=>{this.plugin.settings.enableProtectedAttributeWarnings=i,await this.plugin.saveSettings()})),e.createEl("h4",{text:"UI Preferences",cls:"setting-item-name"}),new P.Setting(e).setName("Show Sync Status").setDesc("Display sync status in the status bar").addToggle(t=>t.setValue(this.plugin.settings.showSyncStatus).onChange(async i=>{this.plugin.settings.showSyncStatus=i,await this.plugin.saveSettings()})),new P.Setting(e).setName("Show Notifications").setDesc("Display notifications for sync operations").addToggle(t=>t.setValue(this.plugin.settings.showNotifications).onChange(async i=>{this.plugin.settings.showNotifications=i,await this.plugin.saveSettings()}))}addActionsAccordion(e){new P.Setting(e).setName("Export Settings").setDesc("Export your current settings to a file").addButton(t=>t.setButtonText("Export Settings").onClick(async()=>{await this.exportSettings()})),new P.Setting(e).setName("Import Settings").setDesc("Import settings from a file").addButton(t=>t.setButtonText("Import Settings").onClick(async()=>{await this.importSettings()})),new P.Setting(e).setName("Reset to Defaults").setDesc("Reset all settings to their default values").addButton(t=>t.setButtonText("Reset to Defaults").setWarning().onClick(async()=>{await this.resetToDefaults()}))}async generateMcpConfig(e){var i,s;const t=e.textContent;e.textContent="Generating...",e.setAttribute("disabled","true");try{if((i=this.plugin.logger)==null||i.debug("[MCP-CONFIG] Generating MCP configuration"),this.plugin.graphitiService){const r=await this.plugin.graphitiService.generateClaudeDesktopConfig(),o=JSON.stringify(r.config,null,2),a=document.createElement("div");a.style.cssText=`
					position: fixed;
					top: 0;
					left: 0;
					width: 100%;
					height: 100%;
					background: rgba(0, 0, 0, 0.8);
					display: flex;
					align-items: center;
					justify-content: center;
					z-index: 1000;
				`;const l=document.createElement("div");l.style.cssText=`
					background: var(--background-primary);
					border: 1px solid var(--background-modifier-border);
					border-radius: 8px;
					padding: 20px;
					max-width: 600px;
					width: 90%;
					max-height: 80%;
					overflow: auto;
				`;const d=document.createElement("h3");d.textContent="MCP Configuration",d.style.margin="0 0 15px 0";const p=document.createElement("p");p.textContent="Copy this configuration for your MCP client:",p.style.margin="0 0 10px 0";const g=document.createElement("textarea");g.value=o,g.readOnly=!0,g.style.cssText=`
					width: 100%;
					height: 300px;
					font-family: var(--font-monospace);
					font-size: 12px;
					background: var(--background-secondary);
					border: 1px solid var(--background-modifier-border);
					border-radius: 4px;
					padding: 8px;
					resize: vertical;
					box-sizing: border-box;
				`;const m=document.createElement("div");m.style.cssText=`
					margin-top: 15px;
					display: flex;
					gap: 10px;
					justify-content: flex-end;
				`;const h=document.createElement("button");h.textContent="Copy",h.className="mod-cta",h.onclick=async()=>{try{await navigator.clipboard.writeText(o);const c=h.textContent;h.textContent="Copied!",setTimeout(()=>h.textContent=c,2e3),new P.Notice("[SUCCESS] MCP configuration copied to clipboard")}catch(c){g.select(),document.execCommand("copy"),new P.Notice("[SUCCESS] MCP configuration copied to clipboard")}};const b=document.createElement("button");b.textContent="Close",b.onclick=()=>document.body.removeChild(a),m.append(h,b),l.append(d,p,g,m),a.appendChild(l),a.onclick=c=>{c.target===a&&document.body.removeChild(a)},document.body.appendChild(a),g.focus(),g.select(),new P.Notice("[SUCCESS] MCP configuration generated")}else new P.Notice("[ERROR] GraphitiService not available")}catch(r){(s=this.plugin.logger)==null||s.error("[MCP-CONFIG] Failed to generate MCP config",{error:r});const o=r instanceof Error?r.message:"Unknown error";new P.Notice(`[ERROR] Failed to generate config: ${o}`)}finally{e.textContent=t,e.removeAttribute("disabled")}}addDevelopmentAccordion(e){new P.Setting(e).setName("Debug Logging").setDesc("Enable detailed logging for troubleshooting").addToggle(t=>t.setValue(this.plugin.settings.enableDebugLogging).onChange(async i=>{this.plugin.settings.enableDebugLogging=i,this.plugin.logger.setDebug(i),this.plugin.logger.info(`Debug mode ${i?"enabled":"disabled"} from settings`),await this.plugin.saveSettings()})),new P.Setting(e).setName("Experimental Daemon Mode").setDesc("Use persistent Python daemon to eliminate BGE model loading overhead (reduces sync time by ~60%)").addToggle(t=>t.setValue(this.plugin.settings.experimentalDaemonMode).onChange(async i=>{this.plugin.settings.experimentalDaemonMode=i,await this.plugin.saveSettings()})),new P.Setting(e).setName("Load Daemon on Launch").setDesc("Start Python daemon when plugin loads to eliminate first-sync delay (requires Experimental Daemon Mode)").addToggle(t=>t.setValue(this.plugin.settings.loadDaemonOnLaunch).onChange(async i=>{this.plugin.settings.loadDaemonOnLaunch=i,await this.plugin.saveSettings()})),new P.Setting(e).setName("Log Performance").setDesc("Enable detailed timing analysis for sync performance debugging").addToggle(t=>t.setValue(this.plugin.settings.logPerformance).onChange(async i=>{this.plugin.settings.logPerformance=i,await this.plugin.saveSettings()}))}getProviderDisplayName(e){return{openai:"OpenAI",anthropic:"Anthropic",google:"Google",azure:"Azure OpenAI",voyage:"Voyage AI",venice:"Venice.ai"}[e]||e}addProviderSpecificSettings(e){this.plugin.settings.llmProvider==="azure"&&(new P.Setting(e).setName("Azure Endpoint").setDesc("Your Azure OpenAI endpoint URL").addText(i=>i.setPlaceholder("https://your-resource.openai.azure.com/").setValue(this.plugin.settings.azureEndpoint||"").onChange(async s=>{this.plugin.settings.azureEndpoint=s,await this.plugin.saveSettings()})),new P.Setting(e).setName("Azure API Version").setDesc("Azure OpenAI API version").addText(i=>i.setPlaceholder("2024-02-01").setValue(this.plugin.settings.azureApiVersion||"").onChange(async s=>{this.plugin.settings.azureApiVersion=s,await this.plugin.saveSettings()})))}async populateLLMModels(e,t,i=!1){var r,o,a,l,d,p,g;e.selectEl.empty(),i&&e.addOption("","None");let s=[];try{const m=this.plugin.settings,h=i?"llmSmallDefaults":"llmDefaults",b=(r=m==null?void 0:m[h])==null?void 0:r[t];if(b&&typeof b=="object"){const c=Object.entries(b);c.sort((v,w)=>{const _=v[1]&&v[1].recommended?1:0;return(w[1]&&w[1].recommended?1:0)-_||v[0].localeCompare(w[0])}),s=c.map(([v])=>v),(o=this.plugin.logger)==null||o.debug(`[SETTINGS] Using ${h} from plugin.settings for ${t}`,{count:s.length})}else if(i&&((a=m==null?void 0:m.llmDefaults)!=null&&a[t])){const c=Object.entries(m.llmDefaults[t]);c.sort((v,w)=>{const _=v[1]&&v[1].recommended?1:0;return(w[1]&&w[1].recommended?1:0)-_||v[0].localeCompare(w[0])}),s=c.map(([v])=>v),(l=this.plugin.logger)==null||l.debug(`[SETTINGS] Fallback to llmDefaults from plugin.settings for ${t}`,{count:s.length})}}catch(m){(d=this.plugin.logger)==null||d.warn("[SETTINGS] Failed reading LLM defaults from plugin.settings",{error:m})}if(s.length===0&&t!=="ollama"&&((p=this.plugin.logger)==null||p.debug(`[SETTINGS] No LLM defaults found in plugin.settings for ${t}; leaving dropdown empty`)),t==="ollama")try{const m=i?this.ollamaSettings.getOllamaLLMSmallModelsFromSettings():this.ollamaSettings.getOllamaLLMModelsFromSettings();for(const h of m){const b=h.description||"",c=b.length>50?b.substring(0,50)+"...":b,v=c?`${h.name} - ${c}`:h.name;e.addOption(h.name,v)}}catch(m){(g=this.plugin.logger)==null||g.error("[SETTINGS] Failed to load Ollama LLM models from settings",{error:m})}else s.forEach(m=>e.addOption(m,m))}async populateEmbeddingModels(e,t){var s,r,o,a,l;e.selectEl.empty();let i=[];try{const d=this.plugin.settings,p=(s=d==null?void 0:d.embeddingDefaults)==null?void 0:s[t];if(p&&typeof p=="object"){const g=Object.entries(p);g.sort((m,h)=>{const b=m[1]&&m[1].recommended?1:0;return(h[1]&&h[1].recommended?1:0)-b||m[0].localeCompare(h[0])}),i=g.map(([m])=>m),(r=this.plugin.logger)==null||r.debug(`[SETTINGS] Using embeddingDefaults from plugin.settings for ${t}`,{count:i.length})}}catch(d){(o=this.plugin.logger)==null||o.warn("[SETTINGS] Failed reading embedding defaults from plugin.settings",{error:d})}if(i.length===0&&t!=="ollama"&&((a=this.plugin.logger)==null||a.debug(`[SETTINGS] No embedding defaults found in plugin.settings for ${t}; leaving dropdown empty`)),t==="ollama")try{const d=this.ollamaSettings.getOllamaEmbeddingModelNamesFromSettings(),p=this.ollamaSettings.getOllamaEmbeddingModelsFromSettings(),g=await this.ollamaSettings.getOllamaService().getEmbeddingModelsWithStatus(d)||[],m=new Map;for(const h of g)m.set(h.name,!!h.available);for(const h of p){const b=m.get(h.name)||!1,c=typeof h.dimensions=="number"?h.dimensions:this.plugin.settings.ollamaEmbeddingDim||768,v=h.description||"",w=v.length>35?v.substring(0,35)+"...":v,_=`${h.name} (${c}d) - ${w}`;e.addOption(h.name,_)}}catch(d){(l=this.plugin.logger)==null||l.error("[SETTINGS] Failed to load Ollama embedding models",{error:d});const p=this.ollamaSettings.getOllamaEmbeddingModelsFromSettings();for(const g of p){const m=typeof g.dimensions=="number"?g.dimensions:this.plugin.settings.ollamaEmbeddingDim||768,h=g.description||"",b=h.length>40?h.substring(0,40)+"...":h,c=`${g.name} (${m}d) - ${b}`;e.addOption(g.name,c)}}else i.forEach(d=>e.addOption(d,d))}async addEnhancedEmbeddingModelSetting(e){if(this.plugin.settings.embedderProvider==="ollama"){const t=new P.Setting(e).setName("Embedding Model").setDesc("Model for generating embeddings with availability checking");let i,s;t.addDropdown(async r=>{i=r,await this.ollamaSettings.populateOllamaModelsWithStatus(i),i.setValue(this.plugin.settings.embeddingModel).onChange(async o=>{var a;try{await this.plugin.vaultRegistryService.hasEmbeddingModelChanged(o,String(this.plugin.settings.ollamaEmbeddingDim||768))&&(new P.Notice("You are changing the embedding model for this vault. You must clear the database to avoid conflicts."),this.plugin.logger.warn("[SETTINGS] Embedding model change detected",{newModel:o,newDimensions:this.plugin.settings.ollamaEmbeddingDim||768})),this.plugin.settings.embeddingModel=o,await this.plugin.saveSettings(),(a=this.plugin.logger)==null||a.debug("[OLLAMA-EMBEDDING-MODEL-CHANGE] Updating vault registry from Ollama model dropdown",{model:o,dimensions:this.plugin.settings.ollamaEmbeddingDim||768,provider:"ollama",vaultName:this.app.vault.getName()}),await this.plugin.vaultRegistryService.updateVaultEmbeddingModel(this.app.vault.getName(),o,this.plugin.settings.ollamaEmbeddingDim||768,"ollama"),o&&await this.ollamaSettings.updateModelStatusIconForDropdown(s,"embedding",o)}catch(l){this.plugin.logger.error("[SETTINGS] Error handling Ollama embedding model change",{error:l}),new P.Notice("Error checking embedding model configuration")}})}),s=t.settingEl.createDiv(),s.style.cssText=`
				margin-top: 8px;
				padding: 8px;
				border-radius: 4px;
				font-size: 0.9em;
			`,this.plugin.settings.embeddingModel&&setTimeout(async()=>{await this.ollamaSettings.updateModelStatusIconForDropdown(s,"embedding",this.plugin.settings.embeddingModel)},100)}else new P.Setting(e).setName("Embedding Model").setDesc("Model for generating embeddings").addDropdown(t=>{this.populateEmbeddingModels(t,this.plugin.settings.embedderProvider),t.setValue(this.plugin.settings.embeddingModel).onChange(async i=>{var s,r,o,a;if(this.plugin.vaultRegistryService)try{await this.plugin.vaultRegistryService.hasEmbeddingModelChanged(i,String(this.plugin.settings.ollamaEmbeddingDim||768))&&(new P.Notice("You are changing the embedding model for this vault. You must clear the database to avoid conflicts."),(s=this.plugin.logger)==null||s.warn("[EMBEDDING-WARNING] Embedding model changed for vault",{oldModel:this.plugin.settings.embeddingModel,newModel:i,vaultName:this.app.vault.getName()}))}catch(l){(r=this.plugin.logger)==null||r.error("[EMBEDDING-WARNING] Failed to check embedding model changes",{error:l})}if(this.plugin.settings.embeddingModel=i,await this.plugin.saveSettings(),this.plugin.vaultRegistryService)try{const l=this.app.vault.getName();(o=this.plugin.logger)==null||o.debug("[NON-OLLAMA-EMBEDDING-MODEL-CHANGE] Updating vault registry from embedding model dropdown",{model:i,dimensions:this.plugin.settings.ollamaEmbeddingDim||768,provider:this.plugin.settings.embedderProvider,vaultName:l}),await this.plugin.vaultRegistryService.updateVaultEmbeddingModel(l,i,this.plugin.settings.ollamaEmbeddingDim||768,this.plugin.settings.embedderProvider)}catch(l){(a=this.plugin.logger)==null||a.error("[NON-OLLAMA-EMBEDDING-MODEL] Failed to update vault registry",{error:l,model:i})}})})}async populateOllamaModelsWithStatus(e){await this.ollamaSettings.populateOllamaModelsWithStatus(e)}async handleOllamaModelSelection(e,t){await this.ollamaSettings.handleOllamaModelSelection(e,t)}async downloadOllamaModelWithProgress(e,t){await this.ollamaSettings.downloadOllamaModelWithProgress(e,t)}async isOllamaModelInstalled(e){return await this.ollamaSettings.isOllamaModelInstalled(e)}async updateLLMModelStatusIcon(e,t){await this.ollamaSettings.updateModelStatusIconForDropdown(e,"llm_small",t)}async addCustomLLMModelEntry(e){const t=new P.Setting(e).setName("Custom LLM Model").setDesc("Download any Ollama LLM model by name (e.g., llama3.2:3b, codellama:13b)");let i,s,r;t.addText(o=>{i=o.inputEl,o.setPlaceholder("Enter model name (e.g., llama3.2:3b)").onChange(a=>{s&&(s.disabled=!a.trim())})}),t.addButton(o=>{s=o.buttonEl,o.setButtonText(" Download").setTooltip("Download this model from Ollama registry").setDisabled(!0).onClick(async()=>{var l,d;const a=i.value.trim();if(!a){new P.Notice("[ERROR] Please enter a model name");return}try{if(await this.ollamaSettings.isOllamaModelInstalled(a)){new P.Notice(`[INFO] Model ${a} is already installed`);return}await this.ollamaSettings.downloadOllamaModelWithProgress(a,r);try{await this.ollamaSettings.isOllamaModelInstalled(a)&&(await this.ollamaSettings.addCustomOllamaLLMToDefaults(a),await this.ollamaSettings.refreshLLMDropdowns(),new P.Notice(`[SUCCESS] ${a} downloaded and added to LLM models.`))}catch(g){(l=this.plugin.logger)==null||l.warn("[CUSTOM-LLM] Post-download availability check failed",{error:g,modelName:a})}i.value="",s.disabled=!0}catch(p){(d=this.plugin.logger)==null||d.error("[CUSTOM-LLM] Download failed",{error:p,modelName:a});const g=p instanceof Error?p.message:"Unknown error";new P.Notice(`[ERROR] Failed to download ${a}: ${g}`)}})}),r=t.settingEl.createDiv(),r.style.cssText=`
			margin-top: 8px;
			padding: 8px;
			border-radius: 4px;
			font-size: 0.9em;
			min-height: 20px;
		`}async addCustomEmbeddingModelEntry(e){const t=new P.Setting(e).setName("Custom Embedding Model").setDesc("Download any Ollama embedding model by name (e.g., nomic-embed-text, mxbai-embed-large)");let i,s,r;t.addText(o=>{i=o.inputEl,o.setPlaceholder("Enter embedding model name").onChange(a=>{s&&(s.disabled=!a.trim())})}),t.addButton(o=>{s=o.buttonEl,o.setButtonText(" Download").setTooltip("Download this embedding model from Ollama registry").setDisabled(!0).onClick(async()=>{var l,d;const a=i.value.trim();if(!a){new P.Notice("[ERROR] Please enter a model name");return}try{if(await this.ollamaSettings.isOllamaModelInstalled(a)){new P.Notice(`[INFO] Model ${a} is already installed`);return}await this.downloadOllamaModelWithProgress(a,r);try{await this.ollamaSettings.isOllamaModelInstalled(a)&&await this.ollamaSettings.addCustomOllamaEmbeddingToDefaults(a)}catch(g){(l=this.plugin.logger)==null||l.warn("[CUSTOM-EMBEDDING] Post-download availability check failed",{error:g,modelName:a})}i.value="",s.disabled=!0}catch(p){(d=this.plugin.logger)==null||d.error("[CUSTOM-EMBEDDING] Download failed",{error:p,modelName:a});const g=p instanceof Error?p.message:"Unknown error";new P.Notice(`[ERROR] Failed to download ${a}: ${g}`)}})}),r=t.settingEl.createDiv(),r.style.cssText=`
			margin-top: 8px;
			padding: 8px;
			border-radius: 4px;
			font-size: 0.9em;
			min-height: 20px;
		`}async refreshOllamaDropdownAndStatus(){this.display()}updateLLMDefaults(e){var r,o,a,l,d,p,g,m,h;const t=this.plugin.settings;let i,s;try{const b=(r=t==null?void 0:t.llmDefaults)==null?void 0:r[e];if(b&&typeof b=="object"){const w=Object.entries(b).find(([,_])=>_&&_.recommended);i=w&&w[0]||Object.keys(b)[0],(o=this.plugin.logger)==null||o.debug("[SETTINGS] Selected LLM default from plugin.settings",{provider:e,model:i})}const c=(a=t==null?void 0:t.llmSmallDefaults)==null?void 0:a[e];if(c&&typeof c=="object"){const w=Object.entries(c).find(([,_])=>_&&_.recommended);s=w&&w[0]||Object.keys(c)[0],(l=this.plugin.logger)==null||l.debug("[SETTINGS] Selected LLM Small default from plugin.settings",{provider:e,model:s})}else!s&&((d=t==null?void 0:t.llmDefaults)!=null&&d[e])&&(s=Object.keys(t.llmDefaults[e])[0])}catch(b){(p=this.plugin.logger)==null||p.warn("[SETTINGS] Failed deriving LLM defaults from plugin.settings",{error:b})}if(!i){const b={openai:{model:"gpt-4o",smallModel:"gpt-4o-mini"},anthropic:{model:"claude-sonnet-4-20250514",smallModel:"claude-3-5-haiku-20241022"},google:{model:"gemini-2.0-flash",smallModel:"gemini-2.0-flash-exp"},azure:{model:"gpt-4o",smallModel:"gpt-4o-mini"},ollama:{model:"deepseek-r1:7b",smallModel:"llama3.1:8b"}};i=(g=b[e])==null?void 0:g.model,s=s||((m=b[e])==null?void 0:m.smallModel),(h=this.plugin.logger)==null||h.debug("[SETTINGS] Falling back to internal LLM defaults",{provider:e,model:i,small:s})}i&&(this.plugin.settings.llmModel=i),s&&(this.plugin.settings.llmSmallModel=s),this.plugin.saveSettings(),this.display()}updateCrossEncoderDefaults(e){var t,i,s,r;if(e==="none"||e==="bge"){this.plugin.settings.crossEncoderModel=void 0,this.plugin.saveSettings(),this.display();return}try{const o=this.plugin.settings,a=(t=o==null?void 0:o.llmCrossEncoderDefaults)==null?void 0:t[e];if(a&&typeof a=="object"){const l=Object.entries(a),d=l.find(([,g])=>g&&g.recommended),p=d&&d[0]||((i=l[0])==null?void 0:i[0]);p&&(this.plugin.settings.crossEncoderModel=p,(s=this.plugin.logger)==null||s.debug("[SETTINGS] Selected cross-encoder default from plugin.settings",{provider:e,model:p}))}}catch(o){(r=this.plugin.logger)==null||r.warn("[SETTINGS] Failed deriving cross-encoder defaults from plugin.settings",{error:o})}this.plugin.saveSettings(),this.display()}async populateCrossEncoderModels(e,t){var s,r,o;if(e.selectEl.empty(),t==="none"){e.addOption("","No reranking model needed");return}let i=[];try{const a=this.plugin.settings,l=(s=a==null?void 0:a.llmCrossEncoderDefaults)==null?void 0:s[t];if(l&&typeof l=="object"){const d=Object.entries(l);d.sort((p,g)=>{const m=p[1]&&p[1].recommended?1:0;return(g[1]&&g[1].recommended?1:0)-m||p[0].localeCompare(g[0])}),i=d.map(([p])=>p),(r=this.plugin.logger)==null||r.debug("[SETTINGS] Using llmCrossEncoderDefaults from plugin.settings for "+t,{count:i.length})}}catch(a){(o=this.plugin.logger)==null||o.warn("[SETTINGS] Failed reading cross-encoder defaults from plugin.settings",{error:a})}if(i.length===0){e.addOption("",`No models configured for ${t}`);return}i.forEach(a=>{e.addOption(a,a)})}updateEmbedderDefaults(e){var s,r,o,a;const t=this.plugin.settings;let i;try{const l=(s=t==null?void 0:t.embeddingDefaults)==null?void 0:s[e];if(l&&typeof l=="object"){const p=Object.entries(l).find(([,g])=>g&&g.recommended);i=p&&p[0]||Object.keys(l)[0],(r=this.plugin.logger)==null||r.debug("[SETTINGS] Selected Embedding default from plugin.settings",{provider:e,model:i})}}catch(l){(o=this.plugin.logger)==null||o.warn("[SETTINGS] Failed deriving embedding defaults from plugin.settings",{error:l})}i||(i={openai:"text-embedding-3-small",google:"text-embedding-004",voyage:"voyage-3.5-lite",ollama:"nomic-embed-text"}[e],(a=this.plugin.logger)==null||a.debug("[SETTINGS] Falling back to internal embedding defaults",{provider:e,model:i})),i&&(this.plugin.settings.embeddingModel=i),this.plugin.saveSettings(),this.display()}async testLLMConnection(e){var i,s,r,o;const t=e.textContent;e.textContent="Testing...",e.addClass("is-loading");try{(i=this.plugin.logger)==null||i.debug("Testing LLM connection");const a=await this.plugin.graphitiService.testLLMConnection();if(a.success){(s=this.plugin.logger)==null||s.debug("LLM connection test successful",{message:a.message,latency:a.latency});const l=a.latency?` (${a.latency}ms)`:"";new P.Notice(`[SUCCESS] LLM connection successful${l}`)}else(r=this.plugin.logger)==null||r.error("LLM connection test failed",{message:a.message}),new P.Notice(`[ERROR] LLM connection failed: ${a.message}`)}catch(a){(o=this.plugin.logger)==null||o.error("LLM connection test error",{error:a});const l=a instanceof Error?a.message:"Unknown error";new P.Notice(`[ERROR] LLM connection failed: ${l}`)}finally{e.textContent=t,e.removeClass("is-loading")}}async testEmbeddingConnection(e){var i,s,r,o;const t=e.textContent;e.textContent="Testing...",e.addClass("is-loading");try{(i=this.plugin.logger)==null||i.debug("Testing embedding connection");const a=await this.plugin.graphitiService.testEmbeddingConnection();if(a.success){(s=this.plugin.logger)==null||s.debug("Embedding connection test successful",{message:a.message,latency:a.latency});const l=a.latency?` (${a.latency}ms)`:"";new P.Notice(`[SUCCESS] Embedding connection successful${l}`)}else(r=this.plugin.logger)==null||r.error("Embedding connection test failed",{message:a.message}),new P.Notice(`[ERROR] Embedding connection failed: ${a.message}`)}catch(a){(o=this.plugin.logger)==null||o.error("Embedding connection test error",{error:a});const l=a instanceof Error?a.message:"Unknown error";new P.Notice(`[ERROR] Embedding connection failed: ${l}`)}finally{e.textContent=t,e.removeClass("is-loading")}}async testProviderCombination(e){var i,s,r,o;const t=e.textContent;e.textContent="Testing...",e.addClass("is-loading");try{(i=this.plugin.logger)==null||i.debug("Testing provider combination");const a=await this.plugin.graphitiService.testProviderCombination();if(a.success){(s=this.plugin.logger)==null||s.debug("Provider combination test successful",{message:a.message,latency:a.latency});const l=a.latency?` (${a.latency}ms)`:"";new P.Notice(`[SUCCESS] Provider combination working${l}`)}else(r=this.plugin.logger)==null||r.error("Provider combination test failed",{message:a.message}),new P.Notice(`[ERROR] Provider combination failed: ${a.message}`)}catch(a){(o=this.plugin.logger)==null||o.error("Provider combination test error",{error:a});const l=a instanceof Error?a.message:"Unknown error";new P.Notice(`[ERROR] Provider combination failed: ${l}`)}finally{e.textContent=t,e.removeClass("is-loading")}}async testFullPipeline(e){var i,s,r;const t=e.textContent;e.textContent="Testing...",e.addClass("is-loading");try{const o=await this.plugin.graphitiService.testFullPipeline();if(o.success){(i=this.plugin.logger)==null||i.debug("Full pipeline test successful",{message:o.message,latency:o.latency});const a=o.latency?` (${o.latency}ms)`:"";new P.Notice(`[SUCCESS] Full pipeline test successful${a}`)}else(s=this.plugin.logger)==null||s.error("Full pipeline test failed",{message:o.message}),new P.Notice(`[ERROR] Full pipeline test failed: ${o.message}`)}catch(o){(r=this.plugin.logger)==null||r.error("Full pipeline test error",{error:o});const a=o instanceof Error?o.message:"Unknown error";new P.Notice(`[ERROR] Full pipeline test failed: ${a}`)}finally{e.textContent=t,e.removeClass("is-loading")}}async validateAPIKeys(e){var i,s,r,o;const t=e.textContent;e.textContent="Validating...",e.addClass("is-loading");try{(i=this.plugin.logger)==null||i.debug("Validating API keys");const a=await this.plugin.graphitiService.validateAPIKeys();a.success?((s=this.plugin.logger)==null||s.debug("API key validation successful",{message:a.message}),new P.Notice(`[SUCCESS] API keys valid: ${a.message}`)):((r=this.plugin.logger)==null||r.error("API key validation failed",{message:a.message}),new P.Notice(`[ERROR] API key validation failed: ${a.message}`))}catch(a){(o=this.plugin.logger)==null||o.error("API key validation error",{error:a});const l=a instanceof Error?a.message:"Unknown error";new P.Notice(`[ERROR] API key validation failed: ${l}`)}finally{e.textContent=t,e.removeClass("is-loading")}}updateDatabaseDefaults(e){this.plugin.saveSettings(),this.display()}async testDatabaseConnection(e){var i,s,r,o;const t=e.textContent;e.textContent="Testing...",e.addClass("is-loading");try{(i=this.plugin.logger)==null||i.debug("[DATABASE] Testing database connection...");const a=await this.plugin.graphitiService.testDatabaseConnection();if(a.success){(s=this.plugin.logger)==null||s.debug("[DATABASE] Database connection test successful",{message:a.message,latency:a.latency});const l=a.latency?` (${a.latency}ms)`:"";new P.Notice(`[SUCCESS] Database connection successful${l}`)}else(r=this.plugin.logger)==null||r.error("[DATABASE] Database connection test failed",{message:a.message}),new P.Notice(`[ERROR] Database connection failed: ${a.message}`)}catch(a){(o=this.plugin.logger)==null||o.error("[DATABASE] Database connection test error",{error:a});const l=a instanceof Error?a.message:"Unknown error";new P.Notice(`[ERROR] Database connection failed: ${l}`)}finally{e.textContent=t,e.removeClass("is-loading")}}async initializeDatabaseSchema(e){var i,s,r,o;const t=e.textContent;e.textContent="Initializing...",e.addClass("is-loading");try{(i=this.plugin.logger)==null||i.debug("[DATABASE] Initializing database schema...");const a=await this.plugin.graphitiService.initializeDatabaseSchema();a.success?((s=this.plugin.logger)==null||s.debug("[DATABASE] Database schema initialization successful",{message:a.message}),new P.Notice("[SUCCESS] Database schema initialized successfully")):((r=this.plugin.logger)==null||r.error("[DATABASE] Database schema initialization failed",{message:a.message}),new P.Notice(`[ERROR] Schema initialization failed: ${a.message}`))}catch(a){(o=this.plugin.logger)==null||o.error("[DATABASE] Database schema initialization error",{error:a});const l=a instanceof Error?a.message:"Unknown error";new P.Notice(`[ERROR] Schema initialization failed: ${l}`)}finally{e.textContent=t,e.removeClass("is-loading")}}async testMCPConnection(e){var i,s,r;const t=e.textContent;e.textContent="Testing...",e.addClass("is-loading");try{(i=this.plugin.logger)==null||i.debug("[MCP] Testing MCP server connection..."),await new Promise(a=>setTimeout(a,1e3));const o={success:!0,message:"MCP server responding [MOCK]",latency:23};o.success&&((s=this.plugin.logger)==null||s.debug("[MCP] MCP server connection test successful",{message:o.message,latency:o.latency}),new P.Notice(`[SUCCESS] MCP server connection successful (${o.latency}ms)`))}catch(o){(r=this.plugin.logger)==null||r.error("[MCP] MCP server connection test error",{error:o});const a=o instanceof Error?o.message:"Unknown error";new P.Notice(`[ERROR] MCP server connection failed: ${a}`)}finally{e.textContent=t,e.removeClass("is-loading")}}async exportSettings(){try{const e=JSON.stringify(this.plugin.settings,null,2),t=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(t),s=document.createElement("a");s.href=i,s.download="megamem-settings.json",s.click(),URL.revokeObjectURL(i),new P.Notice("[SUCCESS] Settings exported successfully")}catch(e){const t=e instanceof Error?e.message:"Unknown error";new P.Notice(`[ERROR] Failed to export settings: ${t}`)}}async importSettings(){try{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async t=>{var o;const i=(o=t.target.files)==null?void 0:o[0];if(!i)return;const s=await i.text(),r=JSON.parse(s);this.plugin.settings={...this.plugin.settings,...r},await this.plugin.saveSettings(),this.display(),new P.Notice("[SUCCESS] Settings imported successfully")},e.click()}catch(e){const t=e instanceof Error?e.message:"Unknown error";new P.Notice(`[ERROR] Failed to import settings: ${t}`)}}async resetToDefaults(){await this.confirmReset()&&(await this.plugin.loadSettings(),this.display(),new P.Notice("[INFO] Settings reset to defaults"))}async confirmReset(){return new Promise(e=>{const t=document.createElement("div");t.className="modal",t.innerHTML=`
				<div class="modal-container">
					<div class="modal-bg"></div>
					<div class="modal-content">
						<div class="modal-header">
							<h3>Reset Settings</h3>
						</div>
						<div class="modal-body">
							<p>Are you sure you want to reset all settings to their default values? This action cannot be undone.</p>
						</div>
						<div class="modal-footer">
							<button class="mod-cta" id="confirm-reset">Reset</button>
							<button id="cancel-reset">Cancel</button>
						</div>
					</div>
				</div>
			`,document.body.appendChild(t);const i=t.querySelector("#confirm-reset"),s=t.querySelector("#cancel-reset");i.onclick=()=>{document.body.removeChild(t),e(!0)},s.onclick=()=>{document.body.removeChild(t),e(!1)},t.onclick=r=>{(r.target===t||r.target===t.querySelector(".modal-bg"))&&(document.body.removeChild(t),e(!1))}})}async checkPythonDependencies(e){var i,s,r,o;const t=e.textContent;e.textContent="Checking...",e.setAttribute("disabled","true");try{(i=this.plugin.logger)==null||i.debug("Checking Python dependencies");const a=await this.plugin.graphitiService.testConnection();a.success?((s=this.plugin.logger)==null||s.debug("Python dependencies check successful",{message:a.message}),new P.Notice("[SUCCESS] Python dependencies are installed and up to date")):((r=this.plugin.logger)==null||r.error("Python dependencies check failed",{message:a.message}),new P.Notice(`[ERROR] Dependencies missing or outdated: ${a.message}`,5e3))}catch(a){(o=this.plugin.logger)==null||o.error("Failed to check Python dependencies",{error:a});const l=a instanceof Error?a.message:"Unknown error";new P.Notice(`[ERROR] Failed to check dependencies: ${l}`,5e3)}finally{e.textContent=t,e.removeAttribute("disabled")}}async viewLogFile(){var e;try{const i=this.plugin.app.vault.adapter.basePath,s=Ge.join(i,".obsidian","plugins","megamem-mcp"),r=Ge.join(s,"logs"),{shell:o}=require("electron");o.openPath(r),new P.Notice("[INFO] Log files directory opened in file explorer")}catch(t){(e=this.plugin.logger)==null||e.error("[LOGS] Failed to open log directory",{error:t});const i=t instanceof Error?t.message:"Unknown error";new P.Notice(`[ERROR] Failed to open log directory: ${i}`)}}async installPythonDependencies(e){var i,s,r,o;const t=e.textContent;e.textContent="Installing...",e.setAttribute("disabled","true");try{(i=this.plugin.logger)==null||i.debug("Installing Python dependencies");const a=await this.plugin.graphitiService.installDependencies(l=>{var p;(p=this.plugin.logger)==null||p.debug("Installation progress",{message:l});const d=l.length>30?l.substring(0,30)+"...":l;e.textContent=d,new P.Notice(`[INFO] ${l}`,2e3)});a.success?((s=this.plugin.logger)==null||s.debug("Python dependencies installation successful",{message:a.message}),new P.Notice("[SUCCESS] Python dependencies installed successfully",5e3)):((r=this.plugin.logger)==null||r.error("Python dependencies installation failed",{message:a.message}),new P.Notice(`[ERROR] Installation failed: ${a.message}`,8e3))}catch(a){(o=this.plugin.logger)==null||o.error("Failed to install Python dependencies",{error:a});const l=a instanceof Error?a.message:"Unknown error";new P.Notice(`[ERROR] Installation failed: ${l}`,8e3)}finally{e.textContent=t,e.removeAttribute("disabled")}}async runManualSyncTest(e){var i,s,r,o;const t=e.textContent;e.textContent="Selecting Note...",e.setAttribute("disabled","true");try{const a=this.app.vault.getMarkdownFiles();if(a.length===0){new P.Notice("[INFO] No markdown files found in vault");return}const l=await this.selectNoteForSync(a);if(!l){new P.Notice("[INFO] No note selected for sync test");return}e.textContent="Syncing...",(i=this.plugin.logger)==null||i.debug("Starting manual sync test for note",{path:l.path});const d=this.app.vault.adapter.path.resolve(this.app.vault.adapter.basePath,l.path),p=await this.plugin.graphitiService.testManualSync(d);p.status==="success"?((s=this.plugin.logger)==null||s.debug("Manual sync test successful",p),new P.Notice(`[SUCCESS] Manual sync successful! Processed ${p.processed} note(s), ${p.nodeTypesLoaded} node types, ${p.edgeTypesLoaded} edge types`,8e3)):((r=this.plugin.logger)==null||r.error("Manual sync test failed",p),new P.Notice(`[ERROR] Manual sync failed: ${p.message}`,8e3))}catch(a){(o=this.plugin.logger)==null||o.error("Manual sync test error",{error:a});const l=a instanceof Error?a.message:"Unknown error";new P.Notice(`[ERROR] Manual sync test failed: ${l}`,8e3)}finally{e.textContent=t,e.removeAttribute("disabled")}}async selectNoteForSync(e){return new Promise(t=>{const i=document.createElement("div");i.className="modal",i.innerHTML=`
				<div class="modal-container">
					<div class="modal-bg"></div>
					<div class="modal-content">
						<div class="modal-header">
							<h3>Select Note for Manual Sync Test</h3>
						</div>
						<div class="modal-body">
							<p>Choose a note to test the manual sync process:</p>
							<div style="max-height: 300px; overflow-y: auto;">
								${e.map((o,a)=>`<div style="padding: 8px; border: 1px solid var(--background-modifier-border); margin: 4px 0; cursor: pointer; border-radius: 4px;" data-file-index="${a}">
										<strong>${o.basename}</strong><br>
										<small style="color: var(--text-muted);">${o.path}</small>
									</div>`).join("")}
							</div>
						</div>
						<div class="modal-footer">
							<button id="cancel-select">Cancel</button>
						</div>
					</div>
				</div>
			`,document.body.appendChild(i),i.querySelectorAll("[data-file-index]").forEach(o=>{o.addEventListener("click",()=>{const a=parseInt(o.getAttribute("data-file-index")||"0"),l=e[a];document.body.removeChild(i),t(l)})});const r=i.querySelector("#cancel-select");r.onclick=()=>{document.body.removeChild(i),t(null)},i.onclick=o=>{(o.target===i||o.target===i.querySelector(".modal-bg"))&&(document.body.removeChild(i),t(null))}})}async updateModelStatusIconForDropdown(e,t,i){await this.ollamaSettings.updateModelStatusIconForDropdown(e,t,i)}async refreshOllamaStatus(e,t){await this.ollamaSettings.refreshOllamaStatus(e,t)}async startOllamaService(e,t){await this.ollamaSettings.startOllamaService(e,t)}async handleOllamaInstallation(){await this.ollamaSettings.handleOllamaInstallation()}showOllamaInstallationModal(){this.ollamaSettings.showOllamaInstallationModal()}async reloadSyncDaemon(e){var i,s,r,o,a,l,d,p,g,m,h;const t=e.textContent;e.textContent="Reloading...",e.addClass("is-loading"),e.setAttribute("disabled","true");try{if((i=this.plugin.logger)==null||i.info("[DAEMON-RELOAD] Starting daemon reload"),!this.plugin.settings.loadDaemonOnLaunch||!this.plugin.settings.experimentalDaemonMode){(s=this.plugin.logger)==null||s.error("[DAEMON-RELOAD] Daemon preloading not enabled",{loadDaemonOnLaunch:this.plugin.settings.loadDaemonOnLaunch,experimentalDaemonMode:this.plugin.settings.experimentalDaemonMode}),new P.Notice("[ERROR] Daemon preloading is not enabled");return}const b=this.plugin.pythonDaemonBridge;if((r=this.plugin.logger)==null||r.debug("[DAEMON-RELOAD] Bridge access check",{bridgeExists:!!b,bridgeRunning:b==null?void 0:b.isRunning()}),!b){(o=this.plugin.logger)==null||o.error("[DAEMON-RELOAD] Daemon bridge not available",{pluginKeys:Object.keys(this.plugin).filter(w=>w.includes("daemon")||w.includes("bridge"))}),new P.Notice("[ERROR] Daemon bridge not available");return}const c=b.getStatus();(a=this.plugin.logger)==null||a.info("[DAEMON-RELOAD] Current daemon status",c),e.textContent="Stopping daemon...",(l=this.plugin.logger)==null||l.info("[DAEMON-RELOAD] Initiating daemon shutdown"),await b.shutdown(),(d=this.plugin.logger)==null||d.info("[DAEMON-RELOAD] Daemon shutdown complete"),e.textContent="Starting daemon...",await new Promise(w=>setTimeout(w,1e3)),(p=this.plugin.logger)==null||p.info("[DAEMON-RELOAD] Initiating daemon preload"),await b.preloadDaemon(),(g=this.plugin.logger)==null||g.info("[DAEMON-RELOAD] Daemon preload complete");const v=b.getStatus();(m=this.plugin.logger)==null||m.info("[DAEMON-RELOAD] New daemon status",v),new P.Notice("[SUCCESS] Sync daemon reloaded successfully")}catch(b){(h=this.plugin.logger)==null||h.error("[DAEMON-RELOAD] Failed to reload daemon",{error:b});const c=b instanceof Error?b.message:"Unknown error";new P.Notice(`[ERROR] Failed to reload daemon: ${c}`)}finally{e.textContent=t,e.removeClass("is-loading"),e.removeAttribute("disabled")}}async showVaultManagementModal(){var e;try{const t=this.plugin.vaultRegistryService.getAllVaults(),i=document.createElement("div");i.style.cssText=`
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.8);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 1000;
			`;const s=document.createElement("div");s.style.cssText=`
				background: var(--background-primary);
				border: 1px solid var(--background-modifier-border);
				border-radius: 8px;
				padding: 24px;
				max-width: 800px;
				width: 90%;
				max-height: 80%;
				overflow: auto;
			`,s.innerHTML=`
				<h3 style="margin: 0 0 16px 0;">Vault Registry (vaults.json)</h3>
				<p style="margin: 0 0 16px 0; color: var(--text-muted); font-size: 0.9em;">
					Current vault configuration from vaults.json. This file is auto-generated and managed by the plugin.
				</p>
			`,t.length===0?s.innerHTML+=`
					<div style="padding: 16px; background: var(--background-secondary); border-radius: 6px; color: var(--text-muted);">
						No vaults registered yet. The current vault will be auto-registered when WebSocket connects.
					</div>
				`:t.forEach(a=>{var d,p;const l=s.createDiv();l.style.cssText=`
						padding: 12px;
						margin-bottom: 12px;
						background: var(--background-secondary);
						border: 1px solid var(--background-modifier-border);
						border-radius: 6px;
					`,l.innerHTML=`
						<div style="font-weight: 600; margin-bottom: 8px;">${a.name}</div>
						<div style="font-size: 0.9em; color: var(--text-muted); line-height: 1.6;">
							<div><strong>Path:</strong> ${a.path}</div>
							<div><strong>Database:</strong> ${a.configuration.database.type} (${a.configuration.database.host}:${a.configuration.database.port}/${a.configuration.database.database})</div>
							<div><strong>Embedding:</strong> ${((d=a.configuration.embedding)==null?void 0:d.provider)||"not set"} - ${((p=a.configuration.embedding)==null?void 0:p.model)||"not set"}</div>
							<div><strong>Status:</strong> ${a.status.connected?"Connected":"Disconnected"}</div>
						</div>
					`});const r=s.createDiv();r.style.cssText=`
				margin-top: 16px;
				display: flex;
				gap: 12px;
				justify-content: flex-end;
			`;const o=r.createEl("button",{text:"Close"});o.className="mod-cta",o.onclick=()=>document.body.removeChild(i),i.appendChild(s),i.onclick=a=>{a.target===i&&document.body.removeChild(i)},document.body.appendChild(i)}catch(t){(e=this.plugin.logger)==null||e.error("[VAULT-MODAL] Failed to show vault management modal",{error:t}),new P.Notice("[ERROR] Failed to load vault configuration")}}}const Tr={databaseType:"neo4j",databaseConfigs:{neo4j:{uri:"bolt://localhost:7687",username:"neo4j",password:"",database:"neo4j"},falkordb:{host:"localhost",port:6379,username:void 0,password:void 0,database:"default_db"}},llmProvider:"openai",llmModel:"gpt-4o",llmSmallModel:"gpt-4o-mini",crossEncoderClient:"openai",crossEncoderModel:"gpt-4o-mini",apiKeys:{openai:"",anthropic:"",google:"",azure:"",groq:"",voyage:"",venice:"",openrouter:""},embedderProvider:"openai",embeddingModel:"text-embedding-3-small",llmDefaults:{},llmSmallDefaults:{},embeddingDefaults:{},azureEndpoint:"",azureApiVersion:"2024-02-01",ollamaEnabled:!1,ollamaBaseUrl:"http://localhost:11434",ollamaEmbeddingDim:768,openrouterPresetSlug:"",openrouterUsePresetWithCustomModel:!1,pythonPath:"",mcpServerUrl:"http://localhost",mcpServerPort:8e3,mcpServerEnabled:!0,mcpAuthToken:"",mcpServerApiKey:"",includedFolders:[],excludedFolders:[".obsidian",".trash"],globallyIgnoredFields:["cssclass","mm_uid"],autoSync:!1,syncOptions:"new_and_updated",syncInterval:5,batchSize:10,processingDelayMs:500,enableDebugLogging:!1,enablePerformanceMetrics:!1,maxRetryAttempts:3,connectionTimeout:30,experimentalDaemonMode:!1,loadDaemonOnLaunch:!1,logPerformance:!1,showSyncStatus:!0,showNotifications:!0,compactMode:!1,showSchemaValidation:!0,autoDiscoverSchemas:!0,validateNamingConventions:!0,suggestPropertyDescriptions:!0,enableProtectedAttributeWarnings:!0,useCustomOntology:!1,defaultNamespace:"my-vault",enableFolderNamespacing:!1,enablePropertyNamespacing:!1,namespaceStrategy:"vault",folderNamespaceMappings:[],vaultConfigurations:[],enableMultiVaultMode:!1,currentVaultPriority:1,availableNamespaces:[],mcpTools:{defaults:{inboxFolder:"",enableSmartFolderResolution:!0},integrations:{templater:{detected:!1,enabled:!1,useTemplateFolders:!1},periodicNotes:{detected:!1,enabled:!1,usePeriodicFolders:!1}},tools:[]},wsEnabled:!0,wsPort:41484,wsAuthToken:"",propertyMappings:{},propertySelections:{},baseEntityProperties:["type","tags","created"],entityDescriptions:{},propertyDescriptions:{},edgeTypes:{},edgeTypeMap:[],llmSchemaSettings:{autoSuggestEntityDescriptions:!1,autoSuggestPropertyDescriptions:!1,autoSuggestEdgeTypes:!1,autoSuggestEdgeTypeMappings:!1,enableBulkGeneration:!1,suggestionApprovalRequired:!0}};function Vn(n){if(!n)return"";try{return P.normalizePath(n)}catch(e){return n.replace(/\\\\/g,"/").replace(/\\/g,"/")}}function Gn(n){const e=[],t=[n];for(;t.length>0;){const i=t.pop();e.push(i);for(const s of i.children)s instanceof P.TFolder&&t.push(s)}return e}function ei(n,e){const t={path:n.path,name:n.name,parentPath:n.parent&&n.parent.path||""};if(e===0)return t;const i=[];return n.children.forEach(s=>{s instanceof P.TFolder&&i.push(ei(s,e>0?e-1:e))}),i.length>0&&(t.children=i),t}function Mr(n){return{path:n.path,name:n.name,parentPath:n.parent&&n.parent.path||""}}function sg(n,e){const t=e.trim().toLowerCase();if(!t)return{matched:!1};const i=n.name.toLowerCase(),s=n.path.toLowerCase();if(i.includes(t)){const r=n.name.toLowerCase().indexOf(t);return{matched:!0,reason:"name",highlight:n.name.substring(r,r+t.length)}}if(s.includes(t)){const r=n.path.toLowerCase().indexOf(t);return{matched:!0,reason:"path",highlight:n.path.substring(r,r+t.length)}}return{matched:!1}}function rg(n,e){if(!n&&e||!n&&!e)return"tree";const t=(n||"").toLowerCase();return t.includes("/")||t.includes("where")||t.includes("path")||t.startsWith("find ")?"paths":"flat"}class og extends P.Plugin{constructor(){super(...arguments),this.services=[],this.syncIntervalId=null,this.syncJsonWatcher=!1,this.needsDefaultsPersist=!1}async loadSettings(){var t,i,s,r,o,a;const e=await this.loadData();if(!e||Object.keys(e).length===0){const l=`[CRITICAL] data.json was ${e?"empty":"null"} - loading defaults. This should NEVER happen in production.`;this.logger?this.logger.error(l,{timestamp:new Date().toISOString(),vaultName:this.app.vault.getName()}):console.error(l)}this.settings=Object.assign({},Tr,e);try{const l=e||{},d=this.settings,p=m=>!m||typeof m=="object"&&Object.keys(m).length===0;let g=!1;if(p(d.llmDefaults)){const m=l.llmDefaults,h=(t=l.mcpServers)==null?void 0:t.llmDefaults;p(m)?p(h)||(d.llmDefaults=h,g=!0):(d.llmDefaults=m,g=!0)}if(p(d.llmSmallDefaults)){const m=l.llmSmallDefaults,h=(i=l.mcpServers)==null?void 0:i.llmSmallDefaults;p(m)?p(h)||(d.llmSmallDefaults=h,g=!0):(d.llmSmallDefaults=m,g=!0)}if(p(d.embeddingDefaults)){const m=l.embeddingDefaults,h=(s=l.mcpServers)==null?void 0:s.embeddingDefaults,b=(r=l.mcpServers)==null?void 0:r.embedderDefaults;p(m)?p(h)?p(b)||(d.embeddingDefaults=b,g=!0):(d.embeddingDefaults=h,g=!0):(d.embeddingDefaults=m,g=!0)}if(g)try{await this.saveSettings(),this.needsDefaultsPersist=!1}catch(m){this.needsDefaultsPersist=!0}}catch(l){}e&&"syncOnSave"in e&&!("autoSync"in e)&&((o=this.logger)==null||o.debug("Migrating syncOnSave setting to autoSync",{oldValue:e.syncOnSave}),this.settings.autoSync=e.syncOnSave,this.settings.syncOptions="new_and_updated",delete e.syncOnSave,await this.saveSettings(),(a=this.logger)==null||a.info("Successfully migrated sync settings",{autoSync:this.settings.autoSync,syncOptions:this.settings.syncOptions}))}async saveSettings(){await this.saveData(this.settings),this.logger&&this.logger.setDebug(this.settings.enableDebugLogging),this.graphitiService&&this.graphitiService.updateSettings(this.settings),this.syncStatusManager&&this.syncStatusManager.updateSettings(this.settings),this.settings.useCustomOntology||this.app.workspace.getLeavesOfType(ln).forEach(t=>t.detach()),this.updateSyncScheduling()}async onload(){try{await this.loadSettings(),this.settings.defaultNamespace==="my-vault"&&(this.settings.defaultNamespace=this.app.vault.getName(),await this.saveSettings()),this.settings.wsAuthToken||(this.settings.wsAuthToken=crypto.randomUUID(),await this.saveSettings()),this.logger=new Gt(this,this.settings.enableDebugLogging),this.logger.init();{const t=this.settings,i={llmProviders:t!=null&&t.llmDefaults?Object.keys(t.llmDefaults).length:0,llmSmallProviders:t!=null&&t.llmSmallDefaults?Object.keys(t.llmSmallDefaults).length:0,embeddingProviders:t!=null&&t.embeddingDefaults?Object.keys(t.embeddingDefaults).length:0};this.logger.debug("[SETTINGS] Defaults providers discovered",i)}this.needsDefaultsPersist&&(this.logger.debug("[SETTINGS] Persisting migrated defaults to top-level"),await this.saveSettings(),this.needsDefaultsPersist=!1),this.syncRegistryService=new dl(this.app,this,this.logger),this.vaultRegistryService=new ul(this.app,this,this.logger),this.schemaService=new Lr(this.app,this),this.llmService=new Wd(this),this.pythonDaemonBridge=new qd(this,this.settings,this.logger,this.vaultRegistryService),this.graphitiService=new ao(this,this.settings,this.syncRegistryService,null,this.vaultRegistryService),this.syncStatusManager=new Bd(this.app,this.settings,this.graphitiService,this.syncRegistryService,this.logger),this.graphitiService.syncStatusManager=this.syncStatusManager,this.debouncedSyncCurrentNote=sl(()=>this.syncCurrentNote(),1e3),this.wsService=new cl(this,this.settings,this.syncRegistryService,this.vaultRegistryService),this.services=[this.syncRegistryService,this.vaultRegistryService,this.wsService,this.pythonDaemonBridge],await this.syncRegistryService.load(),await this.vaultRegistryService.load(),this.settings.wsEnabled?(this.logger.debug("[PLUGIN] Starting WebSocket service - vault registration will occur on connection"),await this.wsService.start()):this.logger.debug("[PLUGIN] WebSocket disabled in settings - no automatic vault registration"),this.registerView(ln,t=>new Tp(t,this.schemaService,this)),this.registerView(Sn,t=>new Wp(t,this.graphitiService,this.syncRegistryService,this.logger)),this.addSettingTab(new ig(this.app,this)),this.settings.useCustomOntology&&this.addRibbonIcon("database","Open Schema Manager",()=>{this.activateView()}),this.addRibbonIcon("refresh-cw","Open Graphiti Sync",()=>{this.activateSyncView()}),this.settings.useCustomOntology&&this.addCommand({id:"open-schema-manager",name:"Open Schema Manager",callback:()=>{this.activateView()}}),this.addCommand({id:"discover-schemas",name:"Discover Schemas from Vault",callback:()=>{this.discoverSchemas()}}),this.addCommand({id:"sync-current-note",name:"Sync Current Note to Knowledge Graph",callback:()=>{var t;(t=this.debouncedSyncCurrentNote)==null||t.call(this)}}),this.addCommand({id:"open-sync-ui",name:"Open Graphiti Sync Interface",callback:()=>{this.activateSyncView()}}),this.addCommand({id:"toggle-debug-mode",name:"Toggle Debug Mode",callback:()=>{this.toggleDebugMode()}}),this.settings.showSyncStatus&&(this.registerSyncStatusIcons(),this.setupSyncJsonWatcher()),this.setupSyncScheduling(),this.settings.experimentalDaemonMode&&this.settings.loadDaemonOnLaunch?(this.logger.info("[DAEMON-PRELOAD] Starting daemon preload during plugin initialization"),setTimeout(async()=>{try{await this.pythonDaemonBridge.preloadDaemon(),this.logger.info("[DAEMON-PRELOAD] Daemon preloaded successfully")}catch(t){this.logger.error("[DAEMON-PRELOAD] Failed to preload daemon, sync will start daemon on demand",{error:t})}},100)):this.logger.debug("[DAEMON-PRELOAD] Daemon preloading disabled",{experimentalDaemonMode:this.settings.experimentalDaemonMode,loadDaemonOnLaunch:this.settings.loadDaemonOnLaunch});const e=await(async()=>{try{const i=this.app.vault.adapter.basePath,s=Ge.join(i,".obsidian","plugins","megamem-mcp");return(await new gn(this,s,this.settings).checkAllDependencies()).graphitiVersion||"not installed"}catch(t){return"check failed"}})();this.logger.debug("[PLUGIN] MegaMem loaded",{pluginVersion:this.manifest.version,obsidianVersion:this.manifest.minAppVersion||"unknown",nodeVersion:process.version,platform:process.platform,graphitiVersion:e}),this.settings.enableDebugLogging&&new P.Notice("MegaMem plugin loaded in debug mode")}catch(e){this.logger?this.logger.error("Failed to load MegaMem plugin",{error:e}):console.error("[ERROR] Failed to load MegaMem plugin:",e),new P.Notice("[ERROR] Failed to load MegaMem plugin. Check developer console for details.")}}onunload(){this.wsService&&this.wsService.stop(),this.pythonDaemonBridge&&this.pythonDaemonBridge.shutdown(),this.cleanupSyncScheduling(),this.logger?this.logger.info("MegaMem plugin unloaded"):console.log("[INFO] MegaMem Knowledge Graph Integration plugin unloaded")}setupSyncScheduling(){if(this.cleanupSyncScheduling(),!!this.settings.autoSync&&this.settings.syncInterval&&this.settings.syncInterval>0){const e=this.settings.syncInterval*60*1e3;this.syncIntervalId=this.registerInterval(window.setInterval(async()=>{try{this.logger.debug("Scheduled sync triggered",{intervalMinutes:this.settings.syncInterval});const t=await this.graphitiService.autoSync("scheduled");t.status==="success"?this.logger.info("Scheduled sync completed successfully",{processed:t.processed}):this.logger.error("Scheduled sync failed",{result:t})}catch(t){this.logger.error("Scheduled sync error",{error:t})}},e)),this.logger.debug("Sync scheduling enabled",{intervalMinutes:this.settings.syncInterval,intervalMs:e})}}cleanupSyncScheduling(){this.syncIntervalId!==null&&(window.clearInterval(this.syncIntervalId),this.syncIntervalId=null)}async updateSyncScheduling(){this.setupSyncScheduling()}async activateView(){if(!this.settings.useCustomOntology){new P.Notice('[INFO] Schema Manager requires "Use Custom Ontology" to be enabled in settings');return}const{workspace:e}=this.app;let t=e.getLeavesOfType(ln).first();t||(t=e.getRightLeaf(!1),await t.setViewState({type:ln,active:!0})),e.revealLeaf(t)}async activateSyncView(){const{workspace:e}=this.app;let t=e.getLeavesOfType(Sn).first();t||(t=e.getRightLeaf(!1),await t.setViewState({type:Sn,active:!0})),e.revealLeaf(t)}async discoverSchemas(){try{new P.Notice("[INFO] Discovering schemas from vault...");const e=await this.schemaService.discoverAllSchemas();new P.Notice(`[INFO] Found ${e.length} schema types in your vault`),this.logger?this.logger.debug("Discovered schemas",{count:e.length}):console.log("[DEBUG] Discovered schemas count:",e.length)}catch(e){const t=e instanceof Error?e.message:"Unknown error";new P.Notice(`Error discovering schemas: ${t}`)}}async syncCurrentNote(){const e=this.app.workspace.getActiveFile();if(!e){new P.Notice("No active file to sync");return}try{this.logger.info("Sync Current Note command triggered",{activeFile:e.path,fileName:e.name});const t=await this.syncStatusManager.enqueue(e,"obsidian_mm_individual");t.status==="success"?(new P.Notice(`[SUCCESS] Successfully synced ${e.name}`),this.logger.info("Sync Current Note completed successfully",{file:e.path})):(new P.Notice(`[ERROR] Failed to sync ${e.name}: ${t.message}`),this.logger.error("Sync Current Note failed",{file:e.path,result:t}))}catch(t){const i=t instanceof Error?t.message:"Unknown error";new P.Notice(`[ERROR] Error syncing ${e.name}: ${i}`),this.logger.error("Sync Current Note error",{file:e.path,error:t})}}async savePropertyMapping(e,t,i){this.settings.propertyMappings[e]||(this.settings.propertyMappings[e]={}),this.settings.propertyMappings[e][t]=i,await this.saveSettings()}async removePropertyMapping(e,t){this.settings.propertyMappings[e]&&(delete this.settings.propertyMappings[e][t],Object.keys(this.settings.propertyMappings[e]).length===0&&delete this.settings.propertyMappings[e],await this.saveSettings())}getPropertyMapping(e,t){var i;return(i=this.settings.propertyMappings[e])==null?void 0:i[t]}getAllPropertyMappings(){return this.settings.propertyMappings}async savePropertySelection(e,t,i){this.settings.propertySelections[e]||(this.settings.propertySelections[e]={}),this.settings.propertySelections[e][t]=i,await this.saveSettings()}getPropertySelection(e,t){var i;return(i=this.settings.propertySelections[e])==null?void 0:i[t]}getAllPropertySelections(){return this.settings.propertySelections}async updateAvailableNamespaces(){var t;const e=new Set;if(this.settings.defaultNamespace&&e.add(this.settings.defaultNamespace),this.settings.enableFolderNamespacing&&this.app.vault.getRoot().children.forEach(i=>{i instanceof P.TFolder&&e.add(i.name)}),this.settings.enablePropertyNamespacing){const i=this.app.vault.getMarkdownFiles();for(const s of i){const r=this.app.metadataCache.getFileCache(s),o=(t=r==null?void 0:r.frontmatter)==null?void 0:t.g_group_id;o&&typeof o=="string"&&e.add(o)}}this.settings.availableNamespaces=Array.from(e).sort(),await this.saveSettings(),this.logger.debug("Graphiti: Updated available namespaces:",this.settings.availableNamespaces)}async toggleDebugMode(){this.settings.enableDebugLogging=!this.settings.enableDebugLogging,await this.saveSettings();const e=this.settings.enableDebugLogging?"enabled":"disabled";new P.Notice(`Debug mode ${e}`),this.logger.info(`Debug mode toggled via command: ${e}`)}async resetSettings(){this.settings=Object.assign({},Tr),await this.saveSettings()}registerSyncStatusIcons(){this.app.workspace.iterateAllLeaves(e=>{e.view instanceof P.MarkdownView&&e.view.file&&this.addSyncStatusIcon(e.view)}),this.registerEvent(this.app.workspace.on("file-open",e=>{e&&e.extension==="md"&&setTimeout(()=>{this.app.workspace.iterateAllLeaves(t=>{var i;if(t.view instanceof P.MarkdownView){const s=t.view,r=(i=s.actionsEl)==null?void 0:i.querySelector(".sync-status-icon");if(r&&s.file){const o=this.syncStatusManager.getStatus(s.file);this.updateIconAppearance(r,o,s.file.name)}else!r&&s.file&&this.addSyncStatusIcon(s)}})},100)}))}addSyncStatusIcon(e){var r;if(!e.file)return;const t=(r=e.actionsEl)==null?void 0:r.querySelector(".sync-status-icon");if(t){const o=this.syncStatusManager.getStatus(e.file);this.updateIconAppearance(t,o,e.file.name);return}const i=this.syncStatusManager.getStatus(e.file),s=e.addAction(this.getIconForStatus(i),this.getTooltipForStatus(i,e.file.name),async()=>{const o=e.file;if(!o){new P.Notice("No file to sync");return}try{this.updateIconAppearance(s,"SYNCING",o.name);const a=await this.syncStatusManager.enqueue(o,"obsidian_mm_individual");setTimeout(()=>{const l=this.syncStatusManager.getStatus(o);this.updateIconAppearance(s,l,o.name)},500)}catch(a){this.logger.error("[SYNC-ERROR] Sync failed:",a);const l=this.syncStatusManager.getStatus(o);this.updateIconAppearance(s,l,o.name)}});s&&(s.addClass("sync-status-icon"),s.setAttribute("data-file-path",e.file.path),this.updateIconAppearance(s,i,e.file.name))}updateIconAppearance(e,t,i){e.empty(),P.setIcon(e,this.getIconForStatus(t)),e.className=e.className.replace(/sync-status-\w+/g,""),e.addClass("sync-status-icon"),e.addClass(`sync-status-${t.toLowerCase()}`),e.setAttribute("aria-label",this.getTooltipForStatus(t,i))}getIconForStatus(e){switch(e){case"SYNCED":return"check-circle";case"PRIVATE":return"lock";case"SYNCING":return"loader";case"NOT_SYNCED":default:return"refresh-cw"}}getTooltipForStatus(e,t){const i=t?`${t}: `:"";switch(e){case"SYNCED":return`${i}synced with Graphiti`;case"PRIVATE":return`${i}marked private (excluded from sync)`;case"SYNCING":return`${i}sync in progress...`;case"NOT_SYNCED":default:return`${i}not synced - click to sync`}}setupSyncJsonWatcher(){if(this.syncJsonWatcher)return;const e=P.normalizePath(Ge.join(this.manifest.dir||".obsidian/plugins/megamem-mcp","sync.json"));this.registerEvent(this.app.vault.on("modify",async t=>{t.path===e&&await this.handleSyncJsonChanged()})),this.registerEvent(this.app.vault.on("create",async t=>{t.path===e&&await this.handleSyncJsonChanged()})),this.registerEvent(this.syncRegistryService.on("changed",()=>{this.updateAllSyncIcons()})),this.syncJsonWatcher=!0}async handleSyncJsonChanged(){try{await this.syncRegistryService.reload(),this.updateAllSyncIcons()}catch(e){this.logger.error("[SYNC-WATCHER] Error handling sync.json change:",e)}}updateAllSyncIcons(){this.app.workspace.iterateAllLeaves(e=>{var t;if(e.view instanceof P.MarkdownView&&e.view.file){const i=(t=e.view.actionsEl)==null?void 0:t.querySelector(".sync-status-icon");if(i){const s=this.syncStatusManager.getStatus(e.view.file);this.updateIconAppearance(i,s,e.view.file.name)}}})}async openSyncUI(){try{this.graphitiService.updateSettings(this.settings),Hp(this.app,this.graphitiService,this.syncRegistryService,this.syncStatusManager,this.vaultRegistryService,this.settings,this.logger)}catch(e){const t=e instanceof Error?e.message:"Unknown error";new P.Notice(`[ERROR] Error opening sync UI: ${t}`),this.logger?this.logger.error("Error opening sync UI",{error:e}):console.error("[ERROR] Error opening sync UI:",e)}}async exploreVaultFoldersHandler(e){const{query:t,path:i,depth:s=-1,format:r="smart"}=e||{},o=Vn(i||""),a=r==="smart"?rg(t,o):r,l=[];try{if(o){const h=this.app.vault.getRoot();let b;if(b=h.children.find(c=>c instanceof P.TFolder&&Vn(c.path)===o),b||(b=Gn(this.app.vault.getRoot()).find(v=>Vn(v.path)===o)),!b)return{results:[],totalFolders:0,searchQuery:t,format:a};if(a==="tree"){const c=s<0?-1:s;return l.push(ei(b,c)),{results:l,totalFolders:l.length,searchQuery:t,format:a}}if(a==="flat"||a==="paths"){const c=Gn(this.app.vault.getRoot()).filter(v=>v.path.startsWith(b.path));for(const v of c){const w=Mr(v);a==="paths"?l.push({path:w.path,name:w.name}):l.push(w)}return{results:l,totalFolders:l.length,searchQuery:t,format:a}}}if(t){const h=Gn(this.app.vault.getRoot());for(const b of h){const c=sg(b,t);if(c.matched){const v=Mr(b);v.matchReason=c.reason,v.highlightMatch=c.highlight,a==="paths"?l.push({path:v.path,name:v.name}):l.push(v)}}return{results:l,totalFolders:l.length,searchQuery:t,format:a}}const d=this.app.vault.getRoot(),p=s<0?-1:s,m=ei(d,p).children||[];return{results:m,totalFolders:m.length,format:a}}catch(d){return this.logger&&this.logger.error("[MCP] explore_vault_folders error",{error:d}),{results:[],totalFolders:0,searchQuery:t,format:a}}}registerMcpTools(){var e,t;try{this.wsService&&typeof this.wsService.registerTool=="function"?(this.wsService.registerTool("explore_vault_folders",async i=>await this.exploreVaultFoldersHandler(i)),(e=this.logger)==null||e.info("[MCP] Registered explore_vault_folders via WebSocketService")):(this.vaultRegistryService.explore_vault_folders=async i=>await this.exploreVaultFoldersHandler(i),(t=this.logger)==null||t.debug("[MCP] Registered explore_vault_folders on vaultRegistryService (fallback)"))}catch(i){this.logger&&this.logger.error("[MCP] Failed to register explore_vault_folders",{error:i})}}}module.exports=og;
